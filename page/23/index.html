<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"helongquan.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="日记">
<meta property="og:type" content="website">
<meta property="og:title" content="鸢尾花序">
<meta property="og:url" content="https://helongquan.github.io/page/23/index.html">
<meta property="og:site_name" content="鸢尾花序">
<meta property="og:description" content="日记">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="泉哥">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://helongquan.github.io/page/23/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>鸢尾花序</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">鸢尾花序</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-schedule">

    <a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>Schedule</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://helongquan.github.io/2018/04/25/%E4%BA%91%E5%B9%B3%E5%8F%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%9B%86%E7%BE%A4%E7%9A%84%E6%96%B9%E6%A1%88%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="泉哥">
      <meta itemprop="description" content="日记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鸢尾花序">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/04/25/%E4%BA%91%E5%B9%B3%E5%8F%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%9B%86%E7%BE%A4%E7%9A%84%E6%96%B9%E6%A1%88%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">云平台分布式集群的方案实践笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-04-25 18:27:41" itemprop="dateCreated datePublished" datetime="2018-04-25T18:27:41+08:00">2018-04-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 11:52:51" itemprop="dateModified" datetime="2020-10-11T11:52:51+08:00">2020-10-11</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>前一段时间，实践了下关于云平台的分布式集群方案，需求是这样的：想要一创建一个web环境，通常我们直接购买一个服务器，然后通过安装环境和配置包括：php、mysql、apache、nginx、tp5(这里笔者根据自己的需求进行的选择)等等，把所有需要的东西都放在一个云服务器里面。</p>
<p>但是，客户不想要这样，客户想把彼此都分开，客户提供的是一个IP为（104.111.23.76）的云平台，想让不同的虚拟机提供不同的服务，这样就可以减少虚拟机的负担。</p>
<p><strong>针对这个需求，我们进行了如下的尝试：</strong></p>
<p>先创建四台虚拟机，假设虚拟机都安装好了，内网IP分别如下：</p>
<p>nginx的ip:15.1.1.3</p>
<p>tp5的ip:15.1.1.4</p>
<p>mysql的ip:15.1.1.5</p>
<p>html的ip:15.1.1.6</p>
<p>好了，这里我们的策略是：</p>
<p>先设置出口规则，确保这四台虚拟机都可以访问外部的资源，因此设置如下：</p>
<p><img src="https://i.imgur.com/gsbdj1C.jpg"></p>
<p>这里的意思就是内网中的网络为C网，所有的IP都可以访问外部。</p>
<p>好的，设置如下后，我们再来看下防火墙的设置：</p>
<p>防火墙的设置就是为了让外部访问受到一定的制约，只有在允许的端口范围下才能访问，所以这里的设置如下：</p>
<p><img src="https://i.imgur.com/8FmtGIk.jpg"></p>
<p>这里的意思就是外部想要访问内部的资源，只能通过104.111.23.76：1000x的方式进行访问，端口不在这个区间的都不能访问，为了能够通过https的方式访问因此这里把443端口也开着。</p>
<p>好的，这里的访问端口这里设置好了后，我们再进行一个端口转发的设置，设置如下：</p>
<p><img src="https://i.imgur.com/kLkduy4.jpg"></p>
<p><img src="https://i.imgur.com/EQ8gJJb.jpg"></p>
<p>这里的意思，笔者这里做个介绍：</p>
<p>这里进行一个端口转发的分配，ssl的请求，直接转发到内网的443端口，如果是外部的1000x端口的请求，都转发到内网22端口，不同的服务对应不同的端口，这里从上面的图片就可以看到。</p>
<p>我们可以这样理解，把这四个虚拟主机当做在家里局域网中的四台电脑，连接的都是内网，别人是没法通过互联网的方式访问这4台电脑的，而这四个内网的IP就相当于本地电脑的192.168.1.x，端口就是别人从外部访问的时候，根据不同端口映射到不同的服务。这样应该够清楚的了。而至于为什么需要设置这个端口，前面已经说了，为了暴露在某个区间的端口可以被访问，而且端口不能取得太小，以防与默认的一些端口发生冲突。</p>
<p>这里分配如下：</p>
<ul>
<li><p>数据库单独作为一个服务器（mysql）提供数据存储服务。</p>
</li>
<li><p>后端作为一个服务为前台提供一个api的服务，也单独放在一个服务器上（tp5）</p>
</li>
<li><p>用一个nginx作为反向代理，作为一个总枢纽，所有访问的，都通过这个代理服务器进行转发，这里用（nginx）命名。</p>
</li>
<li><p>前端的静态资源放在单独的虚拟机上，这里命名为（html）。</p>
</li>
</ul>
<p>好的，整个思路是很清楚的，接下来我们就要用远程登录工具进行登录Xshell，当然你还可以用别的，不一定非得跟着我用这个客户端。</p>
<p>我们获取这个云平台的账号和密码后，我们进行登录：</p>
<p><img src="https://i.imgur.com/m9G73Eq.jpg"></p>
<p>这里我把其中一台的虚拟机mysql先连起来，名称随便命名，根据端口号，我们可以看到，这里是连接mysql的虚拟机。</p>
<p>然后输入账号信息，就可以登录成功了。</p>
<p>好的解决这个以后，我们就可以像登录我们购买的阿里云服务器那样管理我们的虚拟机了。用同样的方法，只是端口不同，我们登录另外的三台虚拟机。然后针对不同的服务，安装不同的环境。</p>
<p><strong>安装各自虚拟机的环境</strong></p>
<p>mysql服务器，我这里就安装mysql，和一些必要的依赖。</p>
<p>nginx的话，就直接安装nginx，然后做一个配置，这个配置我接下来再说。</p>
<p>html这个静态的资源，这里我选择nginx作为服务器，因为nginx毕竟适合静态的资源。而apache适合动态的资源，例如php。</p>
<p>tp5的话，这里笔者不采用它自带的后端服务，选择安装php和apache作为解决方案。</p>
<hr>
<p>环境配置好了后，我们先确保我们在本地能够访问本地的资源，比如html这个虚拟机，先确保本地能够访问，当我们安装好nginx后，我们运行代码：</p>
<pre><code>links http://15.1.1.3</code></pre>
<p>如果服务已经启动或者是安装没问题的话，应该是有欢迎界面的。如果没有的话，就自己再配置下，或者重装一下。</p>
<p>这里说一下，当我们修改了nginx的配置后，要重启下服务，运行代码：</p>
<pre><code>sudo /etc/init.d/nginx restart</code></pre>
<p>好的，html这台虚拟机没问题后，这里我们再把其他的虚拟机也配置好，确保本地能够访问。</p>
<p>假设，你已经都能让这四台虚拟机都能本地访问没问题的话，我们进行下一步。</p>
<p><span style="color:red"><strong>重点来了！</strong></span></p>
<p>还记得前面说的那个nginx的虚拟机吗？我们需要对这个做一下配置，做个反向代理。</p>
<p>我们去/etc/nginx/conf.d/里面创建一个自定义的配置文件，命名为mynginx.conf，里面的代码如下：</p>
<pre><code>server&#123;
        listen 443;
        charset utf-8;
        #把ssl证书加入进来
        ssl on;
        ssl_certificate   cert/214551314040845.pem;
        ssl_certificate_key  cert/214551314040845.key;
        ssl_session_timeout 5m;
        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
        ssl_prefer_server_ciphers on;

        server_name www.youdomain.com;
        # server_name localhost;  #如果没有进行域名解析的话，那么就直接用localhost，而不是IP地址

        location ^~/api/ &#123;

                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header REMOTE-HOST $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                #禁用缓存
                proxy_buffering off;

                proxy_pass http://15.1.1.4/api/;   #后端tp5服务
        &#125;
        location / &#123;

                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header REMOTE-HOST $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                #禁用缓存
                proxy_buffering off;

                proxy_pass http://15.1.1.6/;  #前端的html服务

        &#125;
        location /phpmyadmin/ &#123;

                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header REMOTE-HOST $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                #禁用缓存
                proxy_buffering off;

               proxy_pass http://15.1.1.5/;  #数据库服务

        &#125;
&#125;</code></pre>
<p>上面的配置，这里进行一个解释，443端口开启，这里实现一个https的访问。</p>
<p>然后把ssl证书放进来，具体的方法，笔者写了一篇文章专门说如何为网站配置ssl的证书服务，如果没有证书的话，可以去网上找一些免费的证书，比如阿里云，西部数码等都有免费的证书。</p>
<p>然后，接下来有三个location，分别代理到不同的地方去，大家可要看清楚哦，这里都是内网地址，这里就是为什么当初要确保内网能够访问的原因。</p>
<p>这样我们就做到了只需要一个nginx的端口开启，通过域名的解析，我们就可以访问域名达到访问内部的html的资源的目的了。</p>
<p>好的，如果你顺利的话应该可以访问你的静态资源了，然后就是通过转发的方式，我们也可以获取内网中的其他两个服务，一个是mysql，另外一个是tp5提供的api服务。</p>
<p>该笔记会继续更新，敬请关注。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://helongquan.github.io/2018/04/25/contact-form-7%E7%9A%84%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95%E5%92%8C%E8%B7%B3%E8%BD%AC%E7%9A%84%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="泉哥">
      <meta itemprop="description" content="日记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鸢尾花序">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/04/25/contact-form-7%E7%9A%84%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95%E5%92%8C%E8%B7%B3%E8%BD%AC%E7%9A%84%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/" class="post-title-link" itemprop="url">contact form 7的高级用法和跳转的问题解决方案</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-04-25 18:18:12" itemprop="dateCreated datePublished" datetime="2018-04-25T18:18:12+08:00">2018-04-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 11:53:35" itemprop="dateModified" datetime="2020-10-11T11:53:35+08:00">2020-10-11</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>1，邮件发送接收功能</p>
<p>当读者填写好信息点击提交后,你就可以收到一封邮件，我们在消息正文中输入如下代码,就可以显示相应信息：</p>
<pre><code>读者名字:[your-name]
电子邮件:[your-email]
来信主题: [your-subject]
备注信息:[your-message]</code></pre>
<p>下面是如何实现收邮件：<br>首先，你要保证你的博客所在虚拟主机支持mail()函数，不支持的请安装Cimy Swift SMTP插件。<br>在收件人中填写好收件人的邮箱，这里填我们自己的就行。<br>还要添加好寄件人<a href="mailto:&#x61;&#x64;&#x6d;&#x69;&#110;&#x40;&#119;&#x61;&#x69;&#x73;&#105;&#114;&#46;&#99;&#111;&#109;">&#x61;&#x64;&#x6d;&#x69;&#110;&#x40;&#119;&#x61;&#x69;&#x73;&#105;&#114;&#46;&#99;&#111;&#109;</a>,注意,在使用Cimy Swift SMTP插件辅助发信的朋友尖括号里面和外面都要写Cimy Swift SMTP中配置的邮箱，不然无法发信。<br>这样你就可以收到按你的格式的邮件了。</p>
<p>紧接着下面分别是邮件2</p>
<p>可以设置多个收件箱,比如还需要给读者发送感谢信之类的</p>
<p>紧接着下面分别是消息</p>
<p>可以自定义显示提示消息,一般不作修改,随意.</p>
<p>紧接着下面分别是附加设定</p>
<p>附加设定可以添加附加的设定，比如我们想要提交后跳转到指定页面,可以输入如下内容：</p>
<pre><code>&lt;script type=”text/javascript”&gt;
$(document).ready(function() &#123;
if ($(‘.wpcf7-form.sent’).length) &#123;
$(location).attr(‘href’, ‘http://www.habotalk.com’); // Redirect to OK page
alert(‘Thank you for your message. It has been sent.’); // Alert Info
&#125;
&#125;);
&lt;/script&gt;</code></pre>
<p>这种方法貌似不行，还得依赖jquery，不建议使用，笔者貌似采纳的时候，不成功。</p>
<p>或在 扩展设置里，添加下面的代码：</p>
<pre><code>on_sent_ok: “location = ‘http://www.habotalk.com’;”   //这个已经被这个插件给抛弃了，不能使用</code></pre>
<p>根据联系表单提交成功后，跳转的问题这里给出官方，而且经过笔者实践成功的代码，这里由于客户需要不同的表单提交成功后跳转到不同的地址，这里直接采用ID的形式，进行判断，我们先去contact form 7里面新建的联系表单列表那里，找到每个表单的ID，接着实现的纯javascript代码如下，把这个代码放在header.php里面或者footer.php里面都行：</p>
<pre><code>&lt;script type=&quot;text/javascript&quot;&gt;
document.addEventListener( &#39;wpcf7mailsent&#39;, function( event ) &#123;
if ( &#39;9253&#39; == event.detail.contactFormId ) &#123;
alert(&quot;send email success !&quot;);
location = &#39;http://www.163.com/&#39;;
&#125;else if( &#39;9504&#39; == event.detail.contactFormId )&#123;
alert(&quot;send email success !&quot;);
location = &#39;http://www.baidu.com/&#39;;
&#125;else if( &#39;9503&#39; == event.detail.contactFormId )&#123;
alert(&quot;send email success !&quot;);
location = &#39;http://www.taobao.com/&#39;;
&#125;
&#125;, false );
&lt;/script&gt;</code></pre>
<p>后来客户又说什么GA的东西，查了后发现这个是谷歌的一个统计分析的东西。根据contact form 7的官网的方案，说明如下，也可以把以下的代码放在functions.php中，不过，经过实践发现这个报错：ga这个东西没有定义。看来还是得先去定义下ga.</p>
<p>原因在于，ga没有定义是因为我们没有添加谷歌代码，参考链接：<a target="_blank" rel="noopener" href="https://contactform7.com/tracking-form-submissions-with-google-analytics/">https://contactform7.com/tracking-form-submissions-with-google-analytics/</a></p>
<p>所以需要添加谷歌分析代码：</p>
<pre><code>&lt;!-- Google Analytics --&gt;
&lt;script&gt;
(function(i,s,o,g,r,a,m)&#123;i[&#39;GoogleAnalyticsObject&#39;]=r;i[r]=i[r]||function()&#123;
(i[r].q=i[r].q||[]).push(arguments)&#125;,i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
&#125;)(window,document,&#39;script&#39;,&#39;//www.google-analytics.com/analytics.js&#39;,&#39;ga&#39;);

ga(&#39;create&#39;, &#39;UA-XXXXX-Y&#39;, &#39;auto&#39;);
ga(&#39;send&#39;, &#39;pageview&#39;);
&lt;/script&gt;
&lt;!-- End Google Analytics --&gt;</code></pre>
<p>在这里面我们就可以看到ga创建了一个ID：UA-XXXXX-Y，但是这个只是示例，这个ID号，需要去谷歌账号里面自己根据自己域名进行生成。这样，我们的解决方案就是：</p>
<pre><code>&lt;!-- Google Analytics --&gt;
&lt;script&gt;
(function(i,s,o,g,r,a,m)&#123;i[&#39;GoogleAnalyticsObject&#39;]=r;i[r]=i[r]||function()&#123;
(i[r].q=i[r].q||[]).push(arguments)&#125;,i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
&#125;)(window,document,&#39;script&#39;,&#39;//www.google-analytics.com/analytics.js&#39;,&#39;ga&#39;);

ga(&#39;create&#39;, &#39;UA-XXXXX-Y&#39;, &#39;auto&#39;);
ga(&#39;send&#39;, &#39;pageview&#39;);
&lt;/script&gt;
&lt;!-- End Google Analytics --&gt;

&lt;script type=&quot;text/javascript&quot;&gt;
document.addEventListener( &#39;wpcf7mailsent&#39;, function( event ) &#123;
if ( &#39;9253&#39; == event.detail.contactFormId ) &#123;
ga( &#39;send&#39;, &#39;event&#39;, &#39;Contact Form&#39;, &#39;submit&#39; );
alert(&quot;send email success !&quot;);
location = &#39;http://www.163.com/&#39;;
&#125;else if( &#39;9504&#39; == event.detail.contactFormId )&#123;
ga( &#39;send&#39;, &#39;event&#39;, &#39;Contact Form&#39;, &#39;submit&#39; );
alert(&quot;send email success !&quot;);
location = &#39;http://www.baidu.com/&#39;;
&#125;else if( &#39;9503&#39; == event.detail.contactFormId )&#123;
ga( &#39;send&#39;, &#39;event&#39;, &#39;Contact Form&#39;, &#39;submit&#39; );
alert(&quot;send email success !&quot;);
location = &#39;http://www.taobao.com/&#39;;
&#125;
&#125;, false );
&lt;/script&gt;</code></pre>
<p>然后把ID改成自己的谷歌分析代码ID即可。这样当提交contact form 7表单后就会被谷歌分析工具收集。</p>
<p>Targeting a Specific Contact Form<br>If you have several contact forms and want to run the function only for a specific contact form, check the ID of the contact form like the following:</p>
<pre><code>add_action( &#39;wp_footer&#39;, &#39;mycustom_wp_footer&#39; );
function mycustom_wp_footer() &#123;
?&gt;
&lt;script type=&quot;text/javascript&quot;&gt;
document.addEventListener( &#39;wpcf7mailsent&#39;, function( event ) &#123;
    if ( &#39;123&#39; == event.detail.contactFormId ) &#123;
        ga( &#39;send&#39;, &#39;event&#39;, &#39;Contact Form&#39;, &#39;submit&#39; );
    &#125;
&#125;, false );
&lt;/script&gt;
&lt;?php
&#125;</code></pre>
<p>In this case, the ga() function will be executed only if the ID of the contact form (event.detail.contactFormId) is “123”.</p>
<p>如果想要方便的话，针对电邮成功发送后要跳转，还有采用插件的方式，安装插件：contact form 7 redirection，然后进入到contact form 7里面设置一下就行了。</p>
<p>2，什么是Cc和Bcc</p>
<blockquote>
<p>CC 英文全称是 Carbon Copy(抄送);BCC英文全称是 Blind CarbonCopy(暗抄送)。 两者的区别在于在BCC栏中的收件人可以看到所有的收件人名(TO,CC,BCC)，而在TO 和CC栏中的收件人看不到BBC的收件人名。</p>
</blockquote>
<p>3，Contact Form 7如何添加抄送和暗送<br>在 邮件栏 – 另外的标头( Additional headers )下填写如下格式代码即可</p>
<pre><code>Cc:test001@waisir.com
Bcc:test002@waisir.com</code></pre>
<p>4，Contact Form CheckBox多选标签如何将选择框放在后面<br>添加label_first 这个tag即可<br>选框在前：</p>
<pre><code>[checkbox your-cb “Option 1” “Option 2” “Option 3”]</code></pre>
<p>选框在后：</p>
<pre><code>[checkbox your-cb label_first “Option 1” “Option 2” “Option 3”]</code></pre>
<p>5，如何CheckBox多选标签竖着排列<br>在主题CSS层叠样式表中添加如下代码即可</p>
<pre><code>span.wpcf7-list-item &#123; display: block; &#125;</code></pre>
<p>6，Contact Form如何调整提示信息栏的位置<br>当点击提交后,默认情况下在表单最下方会看到恭喜,提交成功类似文字.<br>我们可以随意改变提示信息的位置,使用[response]标签即可,如：</p>
<pre><code>[response]
Your Name (required)
[text* your-name]
Subject
[text your-subject]
Your Message
[textarea your-message]
[response]
[submit “Send”]</code></pre>
<p>7，Contact Form解决关于SEO邮件暴露问题<br>如,你需要一个下拉框让读者选择给谁发送邮件,不如可以选择(站长,销售员,客服),一般情况下,我们这样写就行</p>
<pre><code>[select your-recipient “ceo@example.com”
“sales@example.com”
“support@example.com”]</code></pre>
<p>再将自定义的[your-recipient]字段填写到收件人即可.这样就可以将邮件发送到选择的邮箱中<br>毋庸置疑,这样会暴露邮箱地址, 而带来垃圾邮件,而且对于用户来说也不方便.<br>做如下处理即可</p>
<pre><code>[select your-recipient “CEO|ceo@example.com”
“Sales|sales@example.com”
“Support|support@example.com”]</code></pre>
<p>相当于为每个邮件地址设置了一个用于显示的别名</p>
<p>8，Contact Form如何返回表单所在POST的url和文章名称/用户IP等参数<br>通过引用以下这些tag就可以实现了</p>
<blockquote>
<p>[_remote_ip]访者IP</p>
<p>[_url]返回页面url</p>
<p>[_date]返回日期</p>
<p>[_time]返回时间</p>
<p>[_post_id]返回postID</p>
<p>[_post_title]返回文章名称</p>
<p>[_post_url]返回文章URL</p>
<p>[_post_author]返回文章作者</p>
<p>[_post_author_email]返回文章作者邮件</p>
</blockquote>
<p>9，Contact Form如何让用户上传附件并发送附件<br>和添加其他文本域便签一样,添加一个[file]标签,如：</p>
<pre><code>[file file-torrent limit:1000000 filetypes:torrent]</code></pre>
<p>然后在邮件栏-附件下填写[file-torrent]即可<br>有多个附件时并列填写即可[file-torrent1][file-torrent2]</p>
<p>10，怎么将contact form 7直接插入到主题中<br>需要注意的是不能用短代码,用do_shortcode()函数调用：</p>
<pre><code>&lt;?php echo do_shortcode( ‘[contact-form-7 id=”1234″ title=”Contact form 1″]’ ); ?&gt;</code></pre>
<p>11，Contact Form验证码CAPTCHA无法输入,这个应该在火狐下才会出现,应该的位置没放正确<br>这是正确的写法</p>
<pre><code>[captchac your-captcha]
&lt;label&gt;Enter the code: [captchar your-captcha]&lt;/label&gt;</code></pre>
<p>这是不好的写好</p>
<pre><code>&lt;label&gt;[captchac your-captcha]
Enter the code: [captchar your-captcha]&lt;/label&gt;</code></pre>
<p>12, 更多 Contact Form 7 参数：</p>
<p>提交询盘时间：[_date] [_time]</p>
<p>客户访问IP：&lt;a href=”<a target="_blank" rel="noopener" href="http://www.ip138.com/ips138.asp?ip=%5B_remote_ip%5D%E2%80%9D&gt;%5B_remote_ip%5D">http://www.ip138.com/ips138.asp?ip=[_remote_ip]”&gt;[_remote_ip]</a></a> （点击打开可看到ip所属国家）</p>
<p>客户访问产品：[_url]</p>
<p>客户访问日期：[_date]</p>
<p>客户访问者有没有facebook：&lt;a href=”<a target="_blank" rel="noopener" href="https://www.facebook.com/search/top/?q=%5Byour-email%5D%E2%80%9D&gt;%5Byour-email%5D">https://www.facebook.com/search/top/?q=[your-email]”&gt;[your-email]</a></a></p>
<hr>
<p>**更新：2019/4/25 16:47:16 **</p>
<p>笔者在一个网站中安装了contact form 7，然后在contact form 7的联系表单中点击留言发送后，不显示发送成功或者发送失败的提示信息，默认情况应该是有提示的，比如发送成功后就提示：</p>
<blockquote>
<p>Thank you for your message. It has been sent.</p>
</blockquote>
<p>如果还有东西没有填写就发送的话就提示如下信息：</p>
<blockquote>
<p>One or more fields have an error. Please check and try again.</p>
</blockquote>
<p>当初笔者怀疑是吧提示信息用css隐藏了，经过排查发现并没有隐藏，后台设置也没有隐藏这个信息，那么如何解决这个问题呢？</p>
<blockquote>
<p>我的思路：放弃contact form 7原本自带的提示信息，用弹窗来取而代之。</p>
</blockquote>
<p><strong>不用jquery</strong>,用javascript，这个是笔者第一个需要提示的，原因前面已经说了，代码如下：</p>
<pre><code>&lt;script type=&quot;text/javascript&quot;&gt;
    document.addEventListener( &#39;wpcf7mailsent&#39;, function( event ) &#123;
        if ( &#39;13514&#39; == event.detail.contactFormId ) &#123;
            alert(&quot;send email success !&quot;);
        &#125;
    &#125;, false );
&lt;/script&gt;</code></pre>
<p>说明：13514是contact form 7联系表单的id号，每个联系表单都有一个唯一的id号，意思就是说，当发送成功后（wpcf7mailsent），如果联系表单的id为13514，那么弹出发送成功的提示窗口。</p>
<p>这样就可以解决发送成功后的提示信息了，至于发送不成功为何不加呢？那是因为发送不成联系表单本身有提示。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://helongquan.github.io/2018/04/19/WordPress%E6%96%87%E7%AB%A0%E5%86%85%E5%AE%B9%E5%8A%A0%E5%AF%86%E8%BE%93%E5%85%A5%E5%AF%86%E7%A0%81%E5%8F%AF%E8%A7%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="泉哥">
      <meta itemprop="description" content="日记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鸢尾花序">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/04/19/WordPress%E6%96%87%E7%AB%A0%E5%86%85%E5%AE%B9%E5%8A%A0%E5%AF%86%E8%BE%93%E5%85%A5%E5%AF%86%E7%A0%81%E5%8F%AF%E8%A7%81/" class="post-title-link" itemprop="url">WordPress文章内容加密输入密码可见</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-04-19 18:18:38" itemprop="dateCreated datePublished" datetime="2018-04-19T18:18:38+08:00">2018-04-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 11:53:10" itemprop="dateModified" datetime="2020-10-11T11:53:10+08:00">2020-10-11</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>WordPress文章输入密码可见</strong></p>
<p>跟注册登录后显示隐藏内容不一样的是，这篇文章解决一个输入密码显示局部内容的问题。</p>
<p>将以下代码放入主题的函数模板（functions.php）</p>
<pre><code>// WordPress文章输入密码可见 开始
function e_secret($atts, $content=null)&#123;
 extract(shortcode_atts(array(&#39;key&#39;=&gt;null), $atts));
 if(isset($_POST[&#39;e_secret_key&#39;]) &amp;&amp; $_POST[&#39;e_secret_key&#39;]==$key)&#123;
 return &#39;
&lt;div class=&quot;e-secret&quot;&gt;&#39;.$content.&#39;&lt;/div&gt;
&#39;;
 &#125;
 else&#123;
 return &#39;
&lt;form class=&quot;e-secret&quot; action=&quot;&#39;.get_permalink().&#39;&quot; method=&quot;post&quot; name=&quot;e-secret&quot;&gt;&lt;label&gt;输入密码查看加密内容：&lt;/label&gt;&lt;input type=&quot;password&quot; name=&quot;e_secret_key&quot; class=&quot;euc-y-i&quot; maxlength=&quot;50&quot;&gt;&lt;input type=&quot;submit&quot; class=&quot;euc-y-s&quot; value=&quot;确定&quot;&gt;
&lt;div class=&quot;euc-clear&quot;&gt;&lt;/div&gt;
&lt;/form&gt;
&#39;;
 &#125;
&#125;
add_shortcode(&#39;secret&#39;,&#39;e_secret&#39;);
// WordPress文章输入密码可见 结束</code></pre>
<p>下面是css样式代码，需要的自己添加主题文件中：</p>
<pre><code>/*e-secret*/
.e-secret &#123;
 margin: 20px 0;
 padding: 20px;
 background: #f8f8f8;
&#125;
.e-secret input.euc-y-i[type=&quot;password&quot;] &#123;
 float: left;
 background: #fff;
 width: 100%;
 line-height: 36px;
 margin-top: 5px;
 border-radius: 3px;
&#125;
.e-secret input.euc-y-s[type=&quot;submit&quot;] &#123;
 float: right;
 margin-top: -47px;
 width: 30%;
 margin-right: 1px;
 border-radius: 0 3px 3px 0;
&#125;
input.euc-y-s[type=&quot;submit&quot;]&#123;background-color:#3498db;color:#fff;font-size:21px;box-shadow:none;-webkit-transition: .4s;-moz-transition: .4s;-o-transition: .4s;transition:.4s;-webkit-backface-visibility:hidden;position:relative;cursor:pointer;padding: 13px 20px;text-align: center;border-radius: 50px;-webkit-box-shadow: none; -moz-box-shadow: none; box-shadow: none;border: 0;height: auto;outline: medium;line-height: 20px;margin: 0;&#125;
input.euc-y-s[type=&quot;submit&quot;]:hover&#123;background-color:#5dade2;&#125;
input.euc-y-i[type=&quot;text&quot;],input.euc-y-i[type=&quot;password&quot;]&#123;border:1px solid #F2EFEF;color:#777;display:block;background: #FCFCFC;font-size:18px;transition:all .5s ease 0;outline:0;box-sizing:border-box;-webkit-border-radius:25px;-moz-border-radius:25px;border-radius:25px;padding:5px 16px; margin: 0;height: auto;line-height: 30px;&#125;
input.euc-y-i[type=&quot;text&quot;]:hover,input.euc-y-i[type=&quot;password&quot;]:hover&#123;border:1px solid #56b4ef;</code></pre>
<p>注意：调用代码，在文章中切换到<span style="color:red">代码模式</span>写入即可：</p>
<blockquote>
<p>[secret key=”密码”]<br>要加密的内容<br>[/secret]</p>
</blockquote>
<p>最后的效果：</p>
<p><img src="https://i.imgur.com/HG8C9Jq.jpg"></p>
<p>当我们输入我们设置的密码后，将会显示出来内容。这个问题起初是用来解决一个邮箱是否有人在用的问题，客户想要让某个资源需要先输入邮箱后才能下载，问题是客户又想要用户输入的都是他们自己的邮箱，而不是随便写的一个邮箱地址。这个时候笔者给出这么一个方案。</p>
<p>就是先让一个下载中心页面，一打开就弹出发送电邮的窗口，不发电邮打死不让访问，如果不输入的，就没法提交，如果输入成功后，再次打开是不会弹出输入电邮的窗口的。然后就是通过设置邮箱自动回复作为密码的发送，就是当用户提交了电邮，那么就会有一个自动回复的密码附加到电邮里面，只有用户输入的是自己的电邮的话，才能收到密码。</p>
<p>然后把下载资源的下载按钮加密，如果没有输入电邮里的密码就不能下载。这样就可以解决用户需要验证电邮是否有人在用的需求。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://helongquan.github.io/2018/04/16/%E8%A7%A3%E5%86%B3wordpress%E7%BD%91%E7%AB%99%E7%95%99%E8%A8%80%E5%BF%85%E9%A1%BB%E9%80%9A%E8%BF%87%E5%AE%A1%E6%A0%B8%E5%90%8E%E6%89%8D%E8%83%BD%E6%98%BE%E7%A4%BA%E7%9A%84%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="泉哥">
      <meta itemprop="description" content="日记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鸢尾花序">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/04/16/%E8%A7%A3%E5%86%B3wordpress%E7%BD%91%E7%AB%99%E7%95%99%E8%A8%80%E5%BF%85%E9%A1%BB%E9%80%9A%E8%BF%87%E5%AE%A1%E6%A0%B8%E5%90%8E%E6%89%8D%E8%83%BD%E6%98%BE%E7%A4%BA%E7%9A%84%E9%97%AE%E9%A2%98/" class="post-title-link" itemprop="url">解决wordpress网站留言必须通过审核后才能显示的问题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-04-16 16:55:04" itemprop="dateCreated datePublished" datetime="2018-04-16T16:55:04+08:00">2018-04-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 11:53:00" itemprop="dateModified" datetime="2020-10-11T11:53:00+08:00">2020-10-11</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>需求千变万化，我们要做的就是消化掉来自客户的所有需求。这是作为一个资深网站设计，网站建设等相关领域的使命和基本的能力。</p>
<p>今天就来说下，wordpress的评论的问题，问题是这样的：</p>
<p>客户想要让wordpress文章的留言板那里，只允许让只有通过审核的评论才能显示出来，没有经过审批的不能显示。</p>
<p>这个其实在wordpress后台可以设置的，但是很恶心的是，有的时候，待评审的留言也能够被其他用户看得到。</p>
<p><img src="https://i.imgur.com/GstZrzZ.png"></p>
<p>勾选这里之后，用户在前台留言，需经过管理员审核才能显示出来，通常是用户本人能够看到待审核的内容，事情本来应该在这里就结束了的，可是不知道怎么搞的，有些主题或者一些莫名其妙的问题，是直接显示出来了。就是A留言了，待审核状态，当B打开这个博客的时候，也能看到，这个可不是网站管理想要的结果。</p>
<p>也有可能，设置不当，导致留言自动审核，批准，然后就显示出来了，好吧，不管怎么样，这里笔者分享一个终极的方法，直接消灭所有这种情况的再次发生。</p>
<p>先来看下，当我们在留言提交后，如果没有经过审核，通常会有这么一句话：</p>
<blockquote>
<p>Your comment is awaiting moderation</p>
</blockquote>
<p>这个时候我们搜索源码，找到这句话的出处，是来自enfold的主题的：enfold/includes/loop-comments.php</p>
<p>好的，我们打开这个文件。</p>
<p><img src="https://i.imgur.com/ncweudB.png"></p>
<p>代码如下：</p>
<pre><code>&lt;div class=&#39;comment_text entry-content-wrapper clearfix&#39; &lt;?php /* avia_markup_helper(array(&#39;context&#39; =&gt; &#39;comment_text&#39;)); */ ?&gt;&gt;
&lt;?php comment_text(); ?&gt;
&lt;?php if ($comment-&gt;comment_approved == &#39;0&#39;) : ?&gt;
&lt;em&gt;&lt;?php _e(&#39;Your comment is awaiting moderation.&#39;,&#39;avia_framework&#39;) ?&gt;&lt;/em&gt;
&lt;?php endif; ?&gt;
&lt;?php comment_reply_link(array_merge( $args, array(&#39;depth&#39; =&gt; $depth, &#39;max_depth&#39; =&gt; $args[&#39;max_depth&#39;]))) ?&gt;
&lt;/div&gt;</code></pre>
<p>这里我们添加一个判断语句，判断如果评论没有被批准的话，就不显示，否则就显示。代码如下：</p>
<pre><code>&lt;div class=&#39;comment_text entry-content-wrapper clearfix&#39; &lt;?php /* avia_markup_helper(array(&#39;context&#39; =&gt; &#39;comment_text&#39;)); */ ?&gt;&gt;
    &lt;?php if ($comment-&gt;comment_approved == &#39;0&#39;) : ?&gt;
        &lt;p style=&quot;display: none&quot;&gt;&lt;?php comment_text(); ?&gt;&lt;/p&gt;
        &lt;em style=&quot;display:none&quot;&gt;&lt;?php _e(&#39;Your comment is awaiting moderation.&#39;,&#39;avia_framework&#39;) ?&gt;&lt;/em&gt;
    &lt;?php endif; ?&gt;
    &lt;?php comment_text(); ?&gt;
    &lt;?php comment_reply_link(array_merge( $args, array(&#39;depth&#39; =&gt; $depth, &#39;max_depth&#39; =&gt; $args[&#39;max_depth&#39;]))) ?&gt;
&lt;/div&gt;</code></pre>
<p>好的，保存后完事了。建议我们在对源码修改的时候，先把旧的重命名备份一下，然后再做修改。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://helongquan.github.io/2018/04/13/%E4%BB%A5tp5%E4%BD%9C%E4%B8%BA%E5%90%8E%E7%AB%AF%E6%9C%8D%E5%8A%A1%E7%9A%84%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0%E5%8B%98%E8%AF%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="泉哥">
      <meta itemprop="description" content="日记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鸢尾花序">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/04/13/%E4%BB%A5tp5%E4%BD%9C%E4%B8%BA%E5%90%8E%E7%AB%AF%E6%9C%8D%E5%8A%A1%E7%9A%84%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0%E5%8B%98%E8%AF%AF/" class="post-title-link" itemprop="url">以tp5作为后端服务的微信公众号开发笔记勘误</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-04-13 23:42:55" itemprop="dateCreated datePublished" datetime="2018-04-13T23:42:55+08:00">2018-04-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 11:52:52" itemprop="dateModified" datetime="2020-10-11T11:52:52+08:00">2020-10-11</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>配置微信公众号的开发者选项那里的时候，总是报错：获取token失败。类似这样的问题，一直让我头痛不已，基本算是尝遍全球的所有解决方案了。</p>
<p>后来在这里的某个角落找到启发：<a target="_blank" rel="noopener" href="https://bbs.csdn.net/topics/390991193">https://bbs.csdn.net/topics/390991193</a></p>
<p>帖子有个人是这样答复的：</p>
<p>其实呢，大家都说把ob_clean();放在echo $echostr;前面，但是却还是报错，这个时候很可能是写的时候某个不可见的空格，这个时候部分把原来的全部铲除掉，把下面这段贴上去。</p>
<blockquote>
<p>ob_clean() 正解！！！！</p>
</blockquote>
<blockquote>
<p>另外贴上我写的一个微信对接接口，如果使用ob_clean()还是没用的同学可以尝试用下我写的，万一你哪里写错了呢。</p>
</blockquote>
<pre><code>public  function wx_api()&#123;
        //1.将 timestamp,nonce,token 按字典序排序
        $timestamp = $_GET[&#39;timestamp&#39;];
        $nonce = $_GET[&#39;nonce&#39;];
        $token = &#39;weixin&#39;;
        $signature = $_GET[&#39;signature&#39;];
        $echostr = $_GET[&#39;echostr&#39;];
        $array = array($timestamp,$nonce,$token);
        sort($array);

        //2.将排序好的三个参数拼接之后按sha1加密
        $tmpstr = implode(&#39;&#39;,$array);
        $tmpstr = sha1($tmpstr);

        //3.将加密后的字符串与signature进行对比，判断请求是否来自于微信
        if($tmpstr == $signature &amp;&amp; $echostr)&#123;
            //1.第一次接入微信api接口，
            ob_clean();
            echo $echostr;
            exit;
        &#125;else&#123;
            $this-&gt;reponseMsg();//这是没用的，我写的自动回复啊那些事件不需要看
        &#125;
    &#125;</code></pre>
<p>本人用的是tp5，所以这里把我这个分享下：</p>
<pre><code>&lt;?php
namespace app\weixin\controller;
use think\Controller;
use think\Loader;
use think\Request;

class Tte extends Controller&#123;

    public function wx_api()&#123;
        //1.将 timestamp,nonce,token 按字典序排序
        $timestamp = $_GET[&#39;timestamp&#39;];
        $nonce = $_GET[&#39;nonce&#39;];
        $token = &#39;zuijiadaxueweixin&#39;;
        $signature = $_GET[&#39;signature&#39;];
        $echostr = $_GET[&#39;echostr&#39;];
        $array = array($timestamp,$nonce,$token);
        sort($array);

        //2.将排序好的三个参数拼接之后按sha1加密
        $tmpstr = implode(&#39;&#39;,$array);
        $tmpstr = sha1($tmpstr);

        //3.将加密后的字符串与signature进行对比，判断请求是否来自于微信
        if($tmpstr == $signature &amp;&amp; $echostr)&#123;
            //1.第一次接入微信api接口，
            ob_clean();
            echo $echostr;

            exit;
        &#125;else&#123;
            $this-&gt;reponseMsg();
        &#125;
    &#125;

&#125;

?&gt;</code></pre>
<p>这个基本不会报错了，但是我们不能仅仅满足于此，还得继续往前走，比如基本接口的消息回复等一系列的交互，这个时候怎么搞呢？</p>
<p>笔者这里不采用上面的了，直接把微信示例的代码贴上会很长，下载地址：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1lNxurH8yysxjw7_D6hp7qg">https://pan.baidu.com/s/1lNxurH8yysxjw7_D6hp7qg</a>，密码：m1t4</p>
<p>打开基础接口，我们会发现大概长这样的：</p>
<p><img src="https://i.imgur.com/Aaly8XO.jpg"></p>
<p>但是我们发现这个写法跟tp5里面的写法是有点不一样的，那么我们如何把这个示例文件写成tp5里面的样子呢？根据上面的写法：</p>
<pre><code>&lt;?php
namespace app\weixin\controller;
use think\Controller;
use think\Loader;
use think\Request;

class Tte extends Controller&#123;

    public function wx_api()&#123;
    //这里面写内容
    &#125;

&#125;
?&gt;</code></pre>
<p>是这样的，就是说所有的逻辑写在类里面，上面这个就是Tte类，常量写在类外面。这个是全局调用。</p>
<p>这里很重要，首先：</p>
<pre><code>define(&quot;TOKEN&quot;, &quot;weixin&quot;);</code></pre>
<p>这个是常量，写在外面。</p>
<p>然后这里有个class wechatCallbackapiTest{….},里面包含一些内容，新手要注意了，这里是要跟上面那个：</p>
<pre><code>&lt;?php
namespace app\weixin\controller;
use think\Controller;
use think\Loader;
use think\Request;

class Tte extends Controller&#123;

    public function wx_api()&#123;
    //这里面写内容
    &#125;

&#125;
?&gt;</code></pre>
<p>并列的，意思就是说不能写在Tte这个class里面，正确的写法应该是这样的：</p>
<pre><code>&lt;?php
namespace app\weixin\controller;
use think\Controller;
use think\Loader;
use think\Request;

class Tte extends Controller&#123;

    public function wx_api()&#123;
    //这里面写内容
    &#125;

&#125;

class wechatCallbackapiTest extends Controller&#123;

    .....

&#125;
?&gt;</code></pre>
<p>这个对于很多php程序员来说是个常识，但是新手可能很容掉坑里去。</p>
<p>最后来个总体的写法：</p>
<p><img src="https://i.imgur.com/kM1h7fI.jpg"></p>
<p>看到了吧，层次很清楚。</p>
<p>好的，本日记为系列日记，后面会继续更新，敬请关注与支持笔者的原创之路。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://helongquan.github.io/2018/04/12/wordpress%E4%B8%BB%E9%A2%98enfold%E4%B8%AD%E5%85%B3%E4%BA%8EInstaram-Widget-Issue%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="泉哥">
      <meta itemprop="description" content="日记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鸢尾花序">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/04/12/wordpress%E4%B8%BB%E9%A2%98enfold%E4%B8%AD%E5%85%B3%E4%BA%8EInstaram-Widget-Issue%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/" class="post-title-link" itemprop="url">wordpress主题enfold中关于Instagram Widget Issue问题的解决方案</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-04-12 15:59:50" itemprop="dateCreated datePublished" datetime="2018-04-12T15:59:50+08:00">2018-04-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 11:53:07" itemprop="dateModified" datetime="2020-10-11T11:53:07+08:00">2020-10-11</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>当我们在处理wordpress的社交媒体的时候，我们有的时候可能在侧边栏添加Instagram这个东西，但是有的时候，我们发现报错了，比如如下：</p>
<p><img src="https://i.imgur.com/RIHMOQI.jpg"></p>
<p><img src="https://i.imgur.com/EBnqSpe.jpg"></p>
<p>当我们在侧边栏调用Instagram的时候，报这个错误，该怎么办呢？我们这里给出解决方案。</p>
<p>找到这个目录：wp-content/themes/enfold/framework/php/class-framework-widgets.php</p>
<p>重命名这个文件，根据自己的喜好，我这里重命名为class-framework-widgets.php.bak</p>
<p>然后把这个文件上传上去，命名为class-framework-widgets.php，代码如下：</p>
<pre><code>&lt;?php  if ( ! defined(&#39;AVIA_FW&#39;)) exit(&#39;No direct script access allowed&#39;);
/**
 * This file holds several widgets exclusive to the framework
 *
 * @author      Christian &quot;Kriesi&quot; Budschedl
 * @copyright   Copyright (c) Christian Budschedl
 * @link        http://Kriesi.at
 * @link        http://aviathemes.com
 * @since       Version 1.0
 * @package     AviaFramework
 */



/**
 * AVIA FACEBOOK WIDGET
 */

if (!class_exists(&#39;avia_fb_likebox&#39;))
&#123;
    class avia_fb_likebox extends WP_Widget &#123;

        static $script_loaded = 0;

        function __construct() &#123;
            //Constructor
            $widget_ops = array(&#39;classname&#39; =&gt; &#39;avia_fb_likebox&#39;, &#39;description&#39; =&gt; __(&#39;A widget that displays a facebook Likebox to a facebook page of your choice&#39;, &#39;avia_framework&#39;) );
            parent::__construct( &#39;avia_fb_likebox&#39;, THEMENAME.&#39; Facebook Likebox&#39;, $widget_ops );
        &#125;

        function widget($args, $instance)
        &#123;
            // prints the widget

            extract($args, EXTR_SKIP);
            if(empty($instance[&#39;url&#39;])) return;
            $url        = $instance[&#39;url&#39;];
            $title = empty($instance[&#39;title&#39;]) ? &#39;&#39; : apply_filters(&#39;widget_title&#39;, $instance[&#39;title&#39;]);
            $height     = 151; 
            $faces      = &quot;true&quot;;
            $extraClass = &quot;&quot;;
            $style      = &quot;&quot;;


            if(strpos($height, &quot;%&quot;) !== false)
            &#123;
                $extraClass = &quot;av_facebook_widget_wrap_positioner&quot;;
                $style      = &quot;style=&#39;padding-bottom:&#123;$height&#125;&#39;&quot;;
                $height     = &quot;100%&quot;;
            &#125;


            echo $before_widget;

            if ( !empty( $title ) ) &#123; echo $before_title . $title . $after_title; &#125;;

            echo &quot;&lt;div class=&#39;av_facebook_widget_wrap &#123;$extraClass&#125;&#39; &#123;$style&#125;&gt;&quot;;
            echo &#39;&lt;div class=&quot;fb-page&quot; data-width=&quot;500&quot; data-href=&quot;&#39;.$url.&#39;&quot; data-small-header=&quot;false&quot; data-adapt-container-width=&quot;true&quot; data-hide-cover=&quot;false&quot; data-show-facepile=&quot;true&quot; data-show-posts=&quot;false&quot;&gt;&lt;div class=&quot;fb-xfbml-parse-ignore&quot;&gt;&lt;/div&gt;&lt;/div&gt;&#39;;
            echo &quot;&lt;/div&gt;&quot;;
            echo $after_widget;
            add_action(&#39;wp_footer&#39;, array( $this,&#39;fb_js&#39; ));
        &#125;



        function fb_js()
        &#123;
            if ( function_exists(&#39;icl_object_id&#39;) ) &#123;
                $locale = ICL_LANGUAGE_NAME_EN;
                $fbxml = @simplexml_load_file( AVIA_BASE . &#39;/config-wpml/FacebookLocales.xml&#39; );

                if(is_object($fbxml))
                &#123;
                    $langcode = array();
                    foreach($fbxml as $loc) &#123;
                        if($loc-&gt;englishName == $locale) &#123;
                            $langcode = $loc-&gt;codes-&gt;code-&gt;standard-&gt;representation;
                        &#125;
                    &#125;
                &#125;
            &#125;

            $langcode = function_exists(&#39;icl_object_id&#39;) &amp;&amp; !empty($langcode) ? $langcode : get_locale();

            if(self::$script_loaded == 1) return;
            self::$script_loaded = 1;

            echo &#39;
&lt;script&gt;(function(d, s, id) &#123;
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = &quot;//connect.facebook.net/&#39;. $langcode .&#39;/sdk.js#xfbml=1&amp;version=v2.7&quot;;
  fjs.parentNode.insertBefore(js, fjs);
&#125;(document, &quot;script&quot;, &quot;facebook-jssdk&quot;));&lt;/script&gt;&#39;;

        &#125;


        function update($new_instance, $old_instance)
        &#123;
            $instance = $old_instance;
            foreach($new_instance as $key=&gt;$value)
            &#123;
                $instance[$key] = strip_tags($new_instance[$key]);
            &#125;

            return $instance;
        &#125;

        function form($instance) &#123;
            //widgetform in backend

            $instance = wp_parse_args( (array) $instance, array(&#39;url&#39; =&gt; &#39;https://www.facebook.com/kriesi.at&#39;, &#39;title&#39; =&gt; &#39;&#39;) );
            $html = new avia_htmlhelper();


    ?&gt;

            &lt;p&gt;
            &lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;title&#39;); ?&gt;&quot;&gt;&lt;?php _e(&#39;Title:&#39;, &#39;avia_framework&#39;); ?&gt;
            &lt;input class=&quot;widefat&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;title&#39;); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name(&#39;title&#39;); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php echo esc_attr($instance[&#39;title&#39;]); ?&gt;&quot; /&gt;&lt;/label&gt;
            &lt;/p&gt;

            &lt;p&gt;
            &lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;url&#39;); ?&gt;&quot;&gt;&lt;?php _e(&#39;Enter the url to the Page. Please note that it needs to be a link to a &lt;strong&gt;facebook fanpage&lt;/strong&gt;. Personal profiles are not allowed!&#39;, &#39;avia_framework&#39;); ?&gt;
            &lt;input class=&quot;widefat&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;url&#39;); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name(&#39;url&#39;); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php echo esc_attr($instance[&#39;url&#39;]); ?&gt;&quot; /&gt;&lt;/label&gt;
            &lt;/p&gt;




        &lt;?php
        &#125;
    &#125;
&#125;
















/**
 * AVIA TWEETBOX
 *
 * Widget that creates a list of latest tweets
 *
 * @package AviaFramework
 * @todo replace the widget system with a dynamic one, based on config files for easier widget creation
 */



/*
Twitter widget only for compatibility reasons with older themes present. no onger used since API will be shut down by twitter
*/
if (!class_exists(&#39;avia_tweetbox&#39;))
&#123;
    class avia_tweetbox extends WP_Widget &#123;

        function __construct() &#123;
            //Constructor
            $widget_ops = array(&#39;classname&#39; =&gt; &#39;tweetbox&#39;, &#39;description&#39; =&gt; &#39;A widget to display your latest twitter messages&#39; );
            parent::__construct( &#39;tweetbox&#39;, THEMENAME.&#39; Twitter Widget&#39;, $widget_ops );
        &#125;

        function widget($args, $instance) &#123;
            // prints the widget

            extract($args, EXTR_SKIP);
            echo $before_widget;

            $title = empty($instance[&#39;title&#39;]) ? &#39;&#39; : apply_filters(&#39;widget_title&#39;, $instance[&#39;title&#39;]);
            $count = empty($instance[&#39;count&#39;]) ? &#39;&#39; : $instance[&#39;count&#39;];
            $username = empty($instance[&#39;username&#39;]) ? &#39;&#39; : $instance[&#39;username&#39;];
            $exclude_replies = empty($instance[&#39;exclude_replies&#39;]) ? &#39;&#39; : $instance[&#39;exclude_replies&#39;];
            $time = empty($instance[&#39;time&#39;]) ? &#39;no&#39; : $instance[&#39;time&#39;];
            $display_image = empty($instance[&#39;display_image&#39;]) ? &#39;no&#39; : $instance[&#39;display_image&#39;];

            if ( !empty( $title ) ) &#123; echo $before_title . &quot;&lt;a href=&#39;http://twitter.com/$username/&#39; title=&#39;&quot;.strip_tags($title).&quot;&#39;&gt;&quot;.$title .&quot;&lt;/a&gt;&quot;. $after_title; &#125;;

            $messages = tweetbox_get_tweet($count, $username, $widget_id, $time, $exclude_replies, $display_image);
            echo $messages;

            echo $after_widget;


        &#125;

        function update($new_instance, $old_instance) &#123;
            //save the widget
            $instance = $old_instance;
            foreach($new_instance as $key=&gt;$value)
            &#123;
                $instance[$key] = strip_tags($new_instance[$key]);
            &#125;

            delete_transient(THEMENAME.&#39;_tweetcache_id_&#39;.$instance[&#39;username&#39;].&#39;_&#39;.$this-&gt;id_base.&quot;-&quot;.$this-&gt;number);
            return $instance;
        &#125;

        function form($instance) &#123;
            //widgetform in backend

            $instance = wp_parse_args( (array) $instance, array( &#39;title&#39; =&gt; &#39;Latest Tweets&#39;, &#39;count&#39; =&gt; &#39;3&#39;, &#39;username&#39; =&gt; avia_get_option(&#39;twitter&#39;) ) );
            $title =            isset($instance[&#39;title&#39;]) ? strip_tags($instance[&#39;title&#39;]): &quot;&quot;;
            $count =            isset($instance[&#39;count&#39;]) ? strip_tags($instance[&#39;count&#39;]): &quot;&quot;;
            $username =         isset($instance[&#39;username&#39;]) ? strip_tags($instance[&#39;username&#39;]): &quot;&quot;;
            $exclude_replies =  isset($instance[&#39;exclude_replies&#39;]) ? strip_tags($instance[&#39;exclude_replies&#39;]): &quot;&quot;;
            $time =             isset($instance[&#39;time&#39;]) ? strip_tags($instance[&#39;time&#39;]): &quot;&quot;;
            $display_image =    isset($instance[&#39;display_image&#39;]) ? strip_tags($instance[&#39;display_image&#39;]): &quot;&quot;;
    ?&gt;
            &lt;p&gt;
            &lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;title&#39;); ?&gt;&quot;&gt;&lt;?php _e(&#39;Title:&#39;, &#39;avia_framework&#39;); ?&gt;
            &lt;input class=&quot;widefat&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;title&#39;); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name(&#39;title&#39;); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php echo esc_attr($title); ?&gt;&quot; /&gt;&lt;/label&gt;&lt;/p&gt;

            &lt;p&gt;&lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;username&#39;); ?&gt;&quot;&gt;Enter your twitter username:
            &lt;input class=&quot;widefat&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;username&#39;); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name(&#39;username&#39;); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php echo esc_attr($username); ?&gt;&quot; /&gt;&lt;/label&gt;&lt;/p&gt;

            &lt;p&gt;
                &lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;count&#39;); ?&gt;&quot;&gt;How many entries do you want to display: &lt;/label&gt;
                &lt;select class=&quot;widefat&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;count&#39;); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name(&#39;count&#39;); ?&gt;&quot;&gt;
                    &lt;?php
                    $list = &quot;&quot;;
                    for ($i = 1; $i &lt;= 20; $i++ )
                    &#123;
                        $selected = &quot;&quot;;
                        if($count == $i) $selected = &#39;selected=&quot;selected&quot;&#39;;

                        $list .= &quot;&lt;option $selected value=&#39;$i&#39;&gt;$i&lt;/option&gt;&quot;;
                    &#125;
                    $list .= &quot;&lt;/select&gt;&quot;;
                    echo $list;
                    ?&gt;


            &lt;/p&gt;

            &lt;p&gt;
                &lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;exclude_replies&#39;); ?&gt;&quot;&gt;Exclude @replies: &lt;/label&gt;
                &lt;select class=&quot;widefat&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;exclude_replies&#39;); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name(&#39;exclude_replies&#39;); ?&gt;&quot;&gt;
                    &lt;?php
                    $list = &quot;&quot;;
                    $answers = array(&#39;yes&#39;,&#39;no&#39;);
                    foreach ($answers as $answer)
                    &#123;
                        $selected = &quot;&quot;;
                        if($answer == $exclude_replies) $selected = &#39;selected=&quot;selected&quot;&#39;;

                        $list .= &quot;&lt;option $selected value=&#39;$answer&#39;&gt;$answer&lt;/option&gt;&quot;;
                    &#125;
                    $list .= &quot;&lt;/select&gt;&quot;;
                    echo $list;
                    ?&gt;


            &lt;/p&gt;

            &lt;p&gt;
                &lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;time&#39;); ?&gt;&quot;&gt;Display time of tweet&lt;/label&gt;
                &lt;select class=&quot;widefat&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;time&#39;); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name(&#39;time&#39;); ?&gt;&quot;&gt;
                    &lt;?php
                    $list = &quot;&quot;;
                    $answers = array(&#39;yes&#39;,&#39;no&#39;);
                    foreach ($answers as $answer)
                    &#123;
                        $selected = &quot;&quot;;
                        if($answer == $time) $selected = &#39;selected=&quot;selected&quot;&#39;;

                        $list .= &quot;&lt;option $selected value=&#39;$answer&#39;&gt;$answer&lt;/option&gt;&quot;;
                    &#125;
                    $list .= &quot;&lt;/select&gt;&quot;;
                    echo $list;
                    ?&gt;


            &lt;/p&gt;

            &lt;p&gt;
                &lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;display_image&#39;); ?&gt;&quot;&gt;Display Twitter User Avatar&lt;/label&gt;
                &lt;select class=&quot;widefat&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;display_image&#39;); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name(&#39;display_image&#39;); ?&gt;&quot;&gt;
                    &lt;?php
                    $list = &quot;&quot;;
                    $answers = array(&#39;yes&#39;,&#39;no&#39;);
                    foreach ($answers as $answer)
                    &#123;
                        $selected = &quot;&quot;;
                        if($answer == $display_image) $selected = &#39;selected=&quot;selected&quot;&#39;;

                        $list .= &quot;&lt;option $selected value=&#39;$answer&#39;&gt;$answer&lt;/option&gt;&quot;;
                    &#125;
                    $list .= &quot;&lt;/select&gt;&quot;;
                    echo $list;
                    ?&gt;
            &lt;/p&gt;



        &lt;?php
        &#125;
    &#125;
&#125;

if(!function_exists(&#39;tweetbox_get_tweet&#39;))
&#123;
    function tweetbox_get_tweet($count, $username, $widget_id, $time=&#39;yes&#39;, $exclude_replies=&#39;yes&#39;, $avatar = &#39;yes&#39;)
    &#123;
            $filtered_message = &quot;&quot;;
            $output = &quot;&quot;;
            $iterations = 0;

            $cache = get_transient(THEMENAME.&#39;_tweetcache_id_&#39;.$username.&#39;_&#39;.$widget_id);

            if($cache)
            &#123;
                $tweets = get_option(THEMENAME.&#39;_tweetcache_&#39;.$username.&#39;_&#39;.$widget_id);
            &#125;
            else
            &#123;
                //$response = wp_remote_get( &#39;http://api.twitter.com/1/statuses/user_timeline.xml?screen_name=&#39;.$username );
                $response = wp_remote_get( &#39;http://api.twitter.com/1/statuses/user_timeline.xml?include_rts=true&amp;screen_name=&#39;.$username );
                if (!is_wp_error($response))
                &#123;
                    $xml = @simplexml_load_string($response[&#39;body&#39;]);
                    //follower: (int) $xml-&gt;status-&gt;user-&gt;followers_count

                    if( empty( $xml-&gt;error ) )
                    &#123;
                        if ( isset($xml-&gt;status[0]))
                        &#123;

                            $tweets = array();
                            foreach ($xml-&gt;status as $tweet)
                            &#123;
                                if($iterations == $count) break;

                                $text = (string) $tweet-&gt;text;
                                if($exclude_replies == &#39;no&#39; || ($exclude_replies == &#39;yes&#39; &amp;&amp; $text[0] != &quot;@&quot;))
                                &#123;
                                    $iterations++;
                                    $tweets[] = array(
                                        &#39;text&#39; =&gt; tweetbox_filter( $text ),
                                        &#39;created&#39; =&gt;  strtotime( $tweet-&gt;created_at ),
                                        &#39;user&#39; =&gt; array(
                                            &#39;name&#39; =&gt; (string)$tweet-&gt;user-&gt;name,
                                            &#39;screen_name&#39; =&gt; (string)$tweet-&gt;user-&gt;screen_name,
                                            &#39;image&#39; =&gt; (string)$tweet-&gt;user-&gt;profile_image_url,
                                            &#39;utc_offset&#39; =&gt; (int) $tweet-&gt;user-&gt;utc_offset[0],
                                            &#39;follower&#39; =&gt; (int) $tweet-&gt;user-&gt;followers_count

                                        ));
                                &#125;
                            &#125;

                            set_transient(THEMENAME.&#39;_tweetcache_id_&#39;.$username.&#39;_&#39;.$widget_id, &#39;true&#39;, 60*30);
                            update_option(THEMENAME.&#39;_tweetcache_&#39;.$username.&#39;_&#39;.$widget_id, $tweets);
                        &#125;
                    &#125;
                &#125;
            &#125;



            if(!isset($tweets[0]))
            &#123;
                $tweets = get_option(THEMENAME.&#39;_tweetcache_&#39;.$username.&#39;_&#39;.$widget_id);
            &#125;

            if(isset($tweets[0]))
            &#123;
                $time_format = apply_filters( &#39;avia_widget_time&#39;, get_option(&#39;date_format&#39;).&quot; - &quot;.get_option(&#39;time_format&#39;), &#39;tweetbox&#39; );

                foreach ($tweets as $message)
                &#123;
                    $output .= &#39;&lt;li class=&quot;tweet&quot;&gt;&#39;;
                    if($avatar == &quot;yes&quot;) $output .= &#39;&lt;div class=&quot;tweet-thumb&quot;&gt;&lt;a href=&quot;http://twitter.com/&#39;.$username.&#39;&quot; title=&quot;&quot;&gt;&lt;img src=&quot;&#39;.$message[&#39;user&#39;][&#39;image&#39;].&#39;&quot; alt=&quot;&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&#39;;
                    $output .= &#39;&lt;div class=&quot;tweet-text avatar_&#39;.$avatar.&#39;&quot;&gt;&#39;.$message[&#39;text&#39;];
                    if($time == &quot;yes&quot;) $output .= &#39;&lt;div class=&quot;tweet-time&quot;&gt;&#39;.date_i18n( $time_format, $message[&#39;created&#39;] + $message[&#39;user&#39;][&#39;utc_offset&#39;]).&#39;&lt;/div&gt;&#39;;
                    $output .= &#39;&lt;/div&gt;&lt;/li&gt;&#39;;
                &#125;
            &#125;


            if($output != &quot;&quot;)
            &#123;
                $filtered_message = &quot;&lt;ul class=&#39;tweets&#39;&gt;$output&lt;/ul&gt;&quot;;
            &#125;
            else
            &#123;
                $filtered_message = &quot;&lt;ul class=&#39;tweets&#39;&gt;&lt;li&gt;No public Tweets found&lt;/li&gt;&lt;/ul&gt;&quot;;
            &#125;

            return $filtered_message;
    &#125;
&#125;

if(!function_exists(&#39;tweetbox_filter&#39;))
&#123;
    function tweetbox_filter($text) &#123;
        // Props to Allen Shaw &amp; webmancers.com &amp; Michael Voigt
        $text = preg_replace(&#39;/\b([a-zA-Z]+:\/\/[\w_.\-]+\.[a-zA-Z]&#123;2,6&#125;[\/\w\-~.?=&amp;%#+$*!]*)\b/i&#39;,&quot;&lt;a href=\&quot;$1\&quot; class=\&quot;twitter-link\&quot;&gt;$1&lt;/a&gt;&quot;, $text);
        $text = preg_replace(&#39;/\b(?&lt;!:\/\/)(www\.[\w_.\-]+\.[a-zA-Z]&#123;2,6&#125;[\/\w\-~.?=&amp;%#+$*!]*)\b/i&#39;,&quot;&lt;a href=\&quot;http://$1\&quot; class=\&quot;twitter-link\&quot;&gt;$1&lt;/a&gt;&quot;, $text);
        $text = preg_replace(&quot;/\b([a-zA-Z][a-zA-Z0-9\_\.\-]*[a-zA-Z]*\@[a-zA-Z][a-zA-Z0-9\_\.\-]*[a-zA-Z]&#123;2,6&#125;)\b/i&quot;,&quot;&lt;a href=\&quot;mailto://$1\&quot; class=\&quot;twitter-link\&quot;&gt;$1&lt;/a&gt;&quot;, $text);
        $text = preg_replace(&quot;/#([\p&#123;L&#125;\p&#123;Mn&#125;]+)/u&quot;, &quot;&lt;a class=\&quot;twitter-link\&quot; href=\&quot;http://search.twitter.com/search?q=\\1\&quot;&gt;#\\1&lt;/a&gt;&quot;, $text);
        $text = preg_replace(&quot;/@([\p&#123;L&#125;\p&#123;Mn&#125;]+)/u&quot;, &quot;&lt;a class=\&quot;twitter-link\&quot; href=\&quot;http://twitter.com/\\1\&quot;&gt;@\\1&lt;/a&gt;&quot;, $text);

        return $text;
    &#125;
&#125;









/**
 * AVIA NEWSBOX
 *
 * Widget that creates a list of latest news entries
 *
 * @package AviaFramework
 * @todo replace the widget system with a dynamic one, based on config files for easier widget creation
 */

if (!class_exists(&#39;avia_newsbox&#39;))
&#123;
    class avia_newsbox extends WP_Widget &#123;

        var $avia_term = &#39;&#39;;
        var $avia_post_type = &#39;&#39;;
        var $avia_new_query = &#39;&#39;;

        function __construct()
        &#123;
            $widget_ops = array(&#39;classname&#39; =&gt; &#39;newsbox&#39;, &#39;description&#39; =&gt; __(&#39;A Sidebar widget to display latest post entries in your sidebar&#39;, &#39;avia_framework&#39;) );

            parent::__construct( &#39;newsbox&#39;, THEMENAME.&#39; Latest News&#39;, $widget_ops );
        &#125;

        function widget($args, $instance)
        &#123;
            global $avia_config;

            extract($args, EXTR_SKIP);
            echo $before_widget;

            $title = empty($instance[&#39;title&#39;]) ? &#39;&#39; : apply_filters(&#39;widget_title&#39;, $instance[&#39;title&#39;]);
            $count = empty($instance[&#39;count&#39;]) ? &#39;&#39; : $instance[&#39;count&#39;];
            $cat = empty($instance[&#39;cat&#39;]) ? &#39;&#39; : $instance[&#39;cat&#39;];
            $excerpt = empty($instance[&#39;excerpt&#39;]) ? &#39;&#39; : $instance[&#39;excerpt&#39;];
            $image_size = isset($avia_config[&#39;widget_image_size&#39;]) ? $avia_config[&#39;widget_image_size&#39;] : &#39;widget&#39;;

            if ( !empty( $title ) ) &#123; echo $before_title . $title . $after_title; &#125;;


            if(empty($this-&gt;avia_term))
            &#123;
                $additional_loop = new WP_Query(&quot;cat=&quot;.$cat.&quot;&amp;posts_per_page=&quot;.$count);
            &#125;
            else
            &#123;
                $catarray = explode(&#39;,&#39;, $cat);


                if(empty($catarray[0]))
                &#123;
                    $new_query = array(&quot;posts_per_page&quot;=&gt;$count,&quot;post_type&quot;=&gt;$this-&gt;avia_post_type);
                &#125;
                else
                &#123;
                    if($this-&gt;avia_new_query)
                    &#123;
                        $new_query = $this-&gt;avia_new_query;
                    &#125;
                    else
                    &#123;
                        $new_query = array( &quot;posts_per_page&quot;=&gt;$count, &#39;tax_query&#39; =&gt; array(
                                                        array( &#39;taxonomy&#39; =&gt; $this-&gt;avia_term,
                                                               &#39;field&#39; =&gt; &#39;id&#39;,
                                                               &#39;terms&#39; =&gt; explode(&#39;,&#39;, $cat),
                                                               &#39;operator&#39; =&gt; &#39;IN&#39;)
                                                              )
                                                        );
                    &#125;
                &#125;

                $additional_loop = new WP_Query($new_query);
            &#125;

            if($additional_loop-&gt;have_posts()) :



            echo &#39;&lt;ul class=&quot;news-wrap image_size_&#39;.$image_size.&#39;&quot;&gt;&#39;;
            while ($additional_loop-&gt;have_posts()) : $additional_loop-&gt;the_post();

            $format = &quot;&quot;;
            if(empty($this-&gt;avia_post_type))     $format = $this-&gt;avia_post_type;
            if(empty($format))                  $format = get_post_format();
            if(empty($format))                  $format = &#39;standard&#39;;

            $the_id = get_the_ID();
            $link = get_post_meta( $the_id  ,&#39;_portfolio_custom_link&#39;, true) != &quot;&quot; ? get_post_meta( $the_id ,&#39;_portfolio_custom_link_url&#39;, true) : get_permalink();


            echo &#39;&lt;li class=&quot;news-content post-format-&#39;.$format.&#39;&quot;&gt;&#39;;

            //check for preview images:
            $image = &quot;&quot;;

            if(!current_theme_supports(&#39;force-post-thumbnails-in-widget&#39;))
            &#123;
                $slides = avia_post_meta(get_the_ID(), &#39;slideshow&#39;, true);

                if( $slides != &quot;&quot; &amp;&amp; !empty( $slides[0][&#39;slideshow_image&#39;] ) )
                &#123;
                    $image = avia_image_by_id($slides[0][&#39;slideshow_image&#39;], $image_size, &#39;image&#39;);
                &#125;
            &#125;

            if(current_theme_supports( &#39;post-thumbnails&#39; ) &amp;&amp; !$image )
            &#123;
                $image = get_the_post_thumbnail( $the_id, $image_size );
            &#125;

            $time_format = apply_filters( &#39;avia_widget_time&#39;, get_option(&#39;date_format&#39;).&quot; - &quot;.get_option(&#39;time_format&#39;), &#39;avia_newsbox&#39; );


            echo &quot;&lt;a class=&#39;news-link&#39; title=&#39;&quot;.get_the_title().&quot;&#39; href=&#39;&quot;.$link.&quot;&#39;&gt;&quot;;

            $nothumb = (!$image) ? &#39;no-news-thumb&#39; : &#39;&#39;;

            echo &quot;&lt;span class=&#39;news-thumb $nothumb&#39;&gt;&quot;;
            echo $image;
            echo &quot;&lt;/span&gt;&quot;;
            if(empty($avia_config[&#39;widget_image_size&#39;]) || &#39;display title and excerpt&#39; != $excerpt)
            &#123;
                echo &quot;&lt;strong class=&#39;news-headline&#39;&gt;&quot;.get_the_title();

                if($time_format)
                &#123;
                    echo &quot;&lt;span class=&#39;news-time&#39;&gt;&quot;.get_the_time($time_format).&quot;&lt;/span&gt;&quot;;   
                &#125;

                echo &quot;&lt;/strong&gt;&quot;;
            &#125;
            echo &quot;&lt;/a&gt;&quot;;

            if( &#39;display title and excerpt&#39; == $excerpt )
            &#123;
                echo &quot;&lt;div class=&#39;news-excerpt&#39;&gt;&quot;;

                if(!empty($avia_config[&#39;widget_image_size&#39;]))
                &#123;
                    echo &quot;&lt;a class=&#39;news-link-inner&#39; title=&#39;&quot;.get_the_title().&quot;&#39; href=&#39;&quot;.$link.&quot;&#39;&gt;&quot;;
                    echo &quot;&lt;strong class=&#39;news-headline&#39;&gt;&quot;.get_the_title().&quot;&lt;/strong&gt;&quot;;
                    echo &quot;&lt;/a&gt;&quot;;
                    if($time_format)
                    &#123;
                        echo &quot;&lt;span class=&#39;news-time&#39;&gt;&quot;.get_the_time($time_format).&quot;&lt;/span&gt;&quot;;   
                    &#125;

                &#125;
                the_excerpt();
                echo &quot;&lt;/div&gt;&quot;;
            &#125;

            echo &#39;&lt;/li&gt;&#39;;


            endwhile;
            echo &quot;&lt;/ul&gt;&quot;;
            wp_reset_postdata();
            endif;


            echo $after_widget;

        &#125;


        function update($new_instance, $old_instance)
        &#123;
            $instance = $old_instance;
            $instance[&#39;title&#39;] = strip_tags($new_instance[&#39;title&#39;]);
            $instance[&#39;count&#39;] = strip_tags($new_instance[&#39;count&#39;]);
            $instance[&#39;excerpt&#39;] = strip_tags($new_instance[&#39;excerpt&#39;]);
            $instance[&#39;cat&#39;] = implode(&#39;,&#39;,$new_instance[&#39;cat&#39;]);
            return $instance;
        &#125;



        function form($instance)
        &#123;
            $instance = wp_parse_args( (array) $instance, array( &#39;title&#39; =&gt; &#39;&#39;, &#39;count&#39; =&gt; &#39;&#39;, &#39;cat&#39; =&gt; &#39;&#39;, &#39;excerpt&#39;=&gt;&#39;&#39; ) );
            $title = strip_tags($instance[&#39;title&#39;]);
            $count = strip_tags($instance[&#39;count&#39;]);
            $excerpt = strip_tags($instance[&#39;excerpt&#39;]);


            $elementCat = array(&quot;name&quot;  =&gt; __(&quot;Which categories should be used for the portfolio?&quot;, &#39;avia_framework&#39;), 
                                &quot;desc&quot;  =&gt; __(&quot;You can select multiple categories here&quot;, &#39;avia_framework&#39;),
                                &quot;id&quot;    =&gt; $this-&gt;get_field_name(&#39;cat&#39;).&quot;[]&quot;,
                                &quot;type&quot;  =&gt; &quot;select&quot;,
                                &quot;std&quot;   =&gt; strip_tags($instance[&#39;cat&#39;]),
                                &quot;class&quot; =&gt; &quot;&quot;,
                                &quot;multiple&quot;=&gt;6,
                                &quot;subtype&quot; =&gt; &quot;cat&quot;);
            //check if a different taxonomy than the default is set
            if(!empty($this-&gt;avia_term))
            &#123;
                $elementCat[&#39;taxonomy&#39;] = $this-&gt;avia_term;
            &#125;




            $html = new avia_htmlhelper();

    ?&gt;
            &lt;p&gt;&lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;title&#39;); ?&gt;&quot;&gt;&lt;?php _e(&#39;Title:&#39;, &#39;avia_framework&#39;); ?&gt;
            &lt;input class=&quot;widefat&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;title&#39;); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name(&#39;title&#39;); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php echo esc_attr($title); ?&gt;&quot; /&gt;&lt;/label&gt;&lt;/p&gt;

            &lt;p&gt;
                &lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;count&#39;); ?&gt;&quot;&gt;&lt;?php _e(&#39;How many entries do you want to display: &#39;, &#39;avia_framework&#39;); ?&gt;&lt;/label&gt;
                &lt;select class=&quot;widefat&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;count&#39;); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name(&#39;count&#39;); ?&gt;&quot;&gt;
                    &lt;?php
                    $list = &quot;&quot;;
                    for ($i = 1; $i &lt;= 20; $i++ )
                    &#123;
                        $selected = &quot;&quot;;
                        if($count == $i) $selected = &#39;selected=&quot;selected&quot;&#39;;

                        $list .= &quot;&lt;option $selected value=&#39;$i&#39;&gt;$i&lt;/option&gt;&quot;;
                    &#125;
                    $list .= &quot;&lt;/select&gt;&quot;;
                    echo $list;
                    ?&gt;


            &lt;/p&gt;

            &lt;p&gt;&lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;cat&#39;); ?&gt;&quot;&gt;&lt;?php _e(&#39;Choose the categories you want to display (multiple selection possible):&#39;, &#39;avia_framework&#39;); ?&gt;
            &lt;?php echo $html-&gt;select($elementCat); ?&gt;
            &lt;/label&gt;&lt;/p&gt;

            &lt;p&gt;
                &lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;excerpt&#39;); ?&gt;&quot;&gt;&lt;?php _e(&#39;Display title only or title &amp;amp; excerpt&#39;, &#39;avia_framework&#39;); ?&gt;&lt;/label&gt;
                &lt;select class=&quot;widefat&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;excerpt&#39;); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name(&#39;excerpt&#39;); ?&gt;&quot;&gt;
                    &lt;?php
                    $list = &quot;&quot;;
                    $answers = array(
                                &#39;show title only&#39;           =&gt;   __( &#39;show title only&#39;, &#39;avia_framework&#39; ),
                                &#39;display title and excerpt&#39; =&gt;   __(&#39;display title and excerpt&#39;, &#39;avia_framework&#39;)
                                );

                    foreach ( $answers as $key =&gt; $answer )
                    &#123;
                        $selected = &quot;&quot;;
                        if( $key == $excerpt ) $selected = &#39;selected=&quot;selected&quot;&#39;;

                        $list .= &quot;&lt;option $selected value=&#39;$key&#39;&gt;$answer&lt;/option&gt;&quot;;
                    &#125;
                    $list .= &quot;&lt;/select&gt;&quot;;
                    echo $list;
                    ?&gt;


            &lt;/p&gt;


    &lt;?php
        &#125;
    &#125;
&#125;


/**
 * AVIA PORTFOLIOBOX
 *
 * Widget that creates a list of latest portfolio entries. Basically the same widget as the newsbox with some minor modifications, therefore it just extends the Newsbox
 *
 * @package AviaFramework
 * @todo replace the widget system with a dynamic one, based on config files for easier widget creation
 */

if (!class_exists(&#39;avia_portfoliobox&#39;))
&#123;
    class avia_portfoliobox extends avia_newsbox
    &#123;
        function __construct()
        &#123;
            $this-&gt;avia_term = &#39;portfolio_entries&#39;;
            $this-&gt;avia_post_type = &#39;portfolio&#39;;
            $this-&gt;avia_new_query = &#39;&#39;; //set a custom query here


            $widget_ops = array(&#39;classname&#39; =&gt; &#39;newsbox&#39;, &#39;description&#39; =&gt; __(&#39;A Sidebar widget to display latest portfolio entries in your sidebar&#39;, &#39;avia_framework&#39;) );

            WP_Widget::__construct( &#39;portfoliobox&#39;, THEMENAME.&#39; Latest Portfolio&#39;, $widget_ops );
        &#125;
    &#125;
&#125;



/**
 * AVIA SOCIALCOUNT
 *
 * Widget that retrieves, stores and displays the number of twitter and rss followers
 *
 * @package AviaFramework
 * @todo replace the widget system with a dynamic one, based on config files for easier widget creation
 */

if (!class_exists(&#39;avia_socialcount&#39;))
&#123;
    class avia_socialcount extends WP_Widget &#123;

        function __construct() &#123;
            //Constructor
            $widget_ops = array(&#39;classname&#39; =&gt; &#39;avia_socialcount&#39;, &#39;description&#39; =&gt; __(&#39;A widget to display a link to your twitter profile and rss feed&#39;, &#39;avia_framework&#39;) );
            parent::__construct( &#39;avia_socialcount&#39;, THEMENAME.&#39; RSS Link and Twitter Account&#39;, $widget_ops );
        &#125;

        function widget($args, $instance) &#123;
            // prints the widget

            extract($args, EXTR_SKIP);
            $twitter = empty($instance[&#39;twitter&#39;]) ? &#39;&#39; : $instance[&#39;twitter&#39;];
            $rss     = empty($instance[&#39;rss&#39;])     ? &#39;&#39; : $instance[&#39;rss&#39;];
            $rss = preg_replace(&#39;!https?:\/\/feeds.feedburner.com\/!&#39;,&#39;&#39;,$rss);


            if(!empty($twitter) || !empty($rss))
            &#123;
                $addClass = &quot;asc_multi_count&quot;;
                if(!isset($twitter) || !isset($rss)) $addClass = &#39;asc_single_count&#39;;

                echo $before_widget;
                $output = &quot;&quot;;
                if(!empty($twitter))
                &#123;
                    $link = &#39;http://twitter.com/&#39;.$twitter.&#39;/&#39;;
                    $before = apply_filters(&#39;avf_social_widget&#39;, &quot;&quot;, &#39;twitter&#39;);
                    $output .= &quot;&lt;a href=&#39;$link&#39; class=&#39;asc_twitter $addClass&#39;&gt;&#123;$before&#125;&lt;strong class=&#39;asc_count&#39;&gt;&quot;.__(&#39;Follow&#39;,&#39;avia_framework&#39;).&quot;&lt;/strong&gt;&lt;span&gt;&quot;.__(&#39;on Twitter&#39;,&#39;avia_framework&#39;).&quot;&lt;/span&gt;&lt;/a&gt;&quot;;

                &#125;

                if($rss)
                &#123;
                    $output .= &quot;&lt;a href=&#39;$rss&#39; class=&#39;asc_rss $addClass&#39;&gt;&quot;.apply_filters(&#39;avf_social_widget&#39;,&quot;&quot;, &#39;rss&#39;).&quot;&lt;strong class=&#39;asc_count&#39;&gt;&quot;.__(&#39;Subscribe&#39;,&#39;avia_framework&#39;).&quot;&lt;/strong&gt;&lt;span&gt;&quot;.__(&#39;to RSS Feed&#39;,&#39;avia_framework&#39;).&quot;&lt;/span&gt;&lt;/a&gt;&quot;;
                &#125;

                echo $output;
                echo $after_widget;
            &#125;
        &#125;



        function update($new_instance, $old_instance) &#123;
            //save the widget
            $instance = $old_instance;
            foreach($new_instance as $key=&gt;$value)
            &#123;
                $instance[$key] = strip_tags($new_instance[$key]);
            &#125;

            return $instance;
        &#125;

        function form($instance) &#123;
            //widgetform in backend

            $instance = wp_parse_args( (array) $instance, array(&#39;rss&#39; =&gt; avia_get_option(&#39;feedburner&#39;), &#39;twitter&#39; =&gt; avia_get_option(&#39;twitter&#39;) ) );
            $twitter = empty($instance[&#39;twitter&#39;]) ? &#39;&#39; :  strip_tags($instance[&#39;twitter&#39;]);
            $rss     = empty($instance[&#39;rss&#39;])     ? &#39;&#39; :  strip_tags($instance[&#39;rss&#39;]);
    ?&gt;
            &lt;p&gt;
            &lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;twitter&#39;); ?&gt;&quot;&gt;&lt;?php _e(&#39;Twitter Username:&#39;, &#39;avia_framework&#39;); ?&gt;
            &lt;input class=&quot;widefat&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;twitter&#39;); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name(&#39;twitter&#39;); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php echo esc_attr($twitter); ?&gt;&quot; /&gt;&lt;/label&gt;&lt;/p&gt;

            &lt;p&gt;&lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;rss&#39;); ?&gt;&quot;&gt;&lt;?php _e(&#39;Enter your feed url:&#39;, &#39;avia_framework&#39;); ?&gt;
            &lt;input class=&quot;widefat&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;rss&#39;); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name(&#39;rss&#39;); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php echo esc_attr($rss); ?&gt;&quot; /&gt;&lt;/label&gt;&lt;/p&gt;



        &lt;?php
        &#125;
    &#125;
&#125;




/**
 * AVIA ADVERTISING WIDGET
 *
 * Widget that retrieves, stores and displays the number of twitter and rss followers
 *
 * @package AviaFramework
 * @todo replace the widget system with a dynamic one, based on config files for easier widget creation
 */


//multiple images
if (!class_exists(&#39;avia_partner_widget&#39;))
&#123;
    class avia_partner_widget extends WP_Widget &#123;

        function __construct() &#123;

            $this-&gt;add_cont = 2;
            //Constructor
            $widget_ops = array(&#39;classname&#39; =&gt; &#39;avia_partner_widget&#39;, &#39;description&#39; =&gt; __(&#39;An advertising widget that displays 2 images with 125 x 125 px in size&#39;, &#39;avia_framework&#39;) );
            parent::__construct( &#39;avia_partner_widget&#39;, THEMENAME.&#39; Advertising Area&#39;, $widget_ops );
        &#125;

        function widget($args, $instance)
        &#123;
            extract($args, EXTR_SKIP);
            echo $before_widget;

            global $kriesiaddwidget, $firsttitle;
            $kriesiaddwidget ++;

            $title = empty($instance[&#39;title&#39;]) ? &#39;&#39; : apply_filters(&#39;widget_title&#39;, $instance[&#39;title&#39;]);
            $image_url = empty($instance[&#39;image_url&#39;]) ? &#39;&lt;span class=&quot;avia_parnter_empty&quot;&gt;&lt;span&gt;&#39;.__(&#39;Advertise here&#39;,&#39;avia_framework&#39;).&#39;&lt;/span&gt;&lt;/span&gt;&#39; : &#39;&lt;img class=&quot;rounded&quot; src=&quot;&#39;.$instance[&#39;image_url&#39;].&#39;&quot; title=&quot;&#39;.$title.&#39;&quot; alt=&quot;&#39;.$title.&#39;&quot;/&gt;&#39;;
            $ref_url = empty($instance[&#39;ref_url&#39;]) ? &#39;#&#39; : apply_filters(&#39;widget_comments_title&#39;, $instance[&#39;ref_url&#39;]);
            $image_url2 = empty($instance[&#39;image_url2&#39;]) ? &#39;&lt;span class=&quot;avia_parnter_empty&quot;&gt;&lt;span&gt;&#39;.__(&#39;Advertise here&#39;,&#39;avia_framework&#39;).&#39;&lt;/span&gt;&lt;/span&gt;&#39; : &#39;&lt;img class=&quot;rounded&quot; src=&quot;&#39;.$instance[&#39;image_url2&#39;].&#39;&quot; title=&quot;&#39;.$title.&#39;&quot; alt=&quot;&#39;.$title.&#39;&quot;/&gt;&#39;;
            $ref_url2 = empty($instance[&#39;ref_url2&#39;]) ? &#39;#&#39; : apply_filters(&#39;widget_comments_title&#39;, $instance[&#39;ref_url2&#39;]);

            if ( !empty( $title ) ) &#123; echo $before_title . $title . $after_title; &#125;;
            echo &#39;&lt;a target=&quot;_blank&quot; href=&quot;&#39;.$ref_url.&#39;&quot; class=&quot;preloading_background  avia_partner1 link_list_item&#39;.$kriesiaddwidget.&#39; &#39;.$firsttitle.&#39;&quot; &gt;&#39;.$image_url.&#39;&lt;/a&gt;&#39;;
            if($this-&gt;add_cont == 2) echo &#39;&lt;a target=&quot;_blank&quot; href=&quot;&#39;.$ref_url2.&#39;&quot; class=&quot;preloading_background avia_partner2 link_list_item&#39;.$kriesiaddwidget.&#39; &#39;.$firsttitle.&#39;&quot; &gt;&#39;.$image_url2.&#39;&lt;/a&gt;&#39;;
            echo $after_widget;

            if($title == &#39;&#39;)
            &#123;
                $firsttitle = &#39;no_top_margin&#39;;
            &#125;

        &#125;


        function update($new_instance, $old_instance) &#123;
            //save the widget
            $instance = $old_instance;
            foreach($new_instance as $key=&gt;$value)
            &#123;
                $instance[$key] = strip_tags($new_instance[$key]);
            &#125;
            return $instance;
        &#125;



        function form($instance)
        &#123;
            $instance = wp_parse_args( (array) $instance, array( &#39;title&#39; =&gt; &#39;&#39;, &#39;image_url&#39; =&gt; &#39;&#39;, &#39;ref_url&#39; =&gt; &#39;&#39;, &#39;image_url2&#39; =&gt; &#39;&#39;, &#39;ref_url2&#39; =&gt; &#39;&#39; ) );
            $title = strip_tags($instance[&#39;title&#39;]);
            $image_url = strip_tags($instance[&#39;image_url&#39;]);
            $ref_url = strip_tags($instance[&#39;ref_url&#39;]);
            $image_url2 = strip_tags($instance[&#39;image_url2&#39;]);
            $ref_url2 = strip_tags($instance[&#39;ref_url2&#39;]);
    ?&gt;
            &lt;p&gt;&lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;title&#39;); ?&gt;&quot;&gt;&lt;?php _e(&#39;Title:&#39;, &#39;avia_framework&#39;); ?&gt;
            &lt;input class=&quot;widefat&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;title&#39;); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name(&#39;title&#39;); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php echo esc_attr($title); ?&gt;&quot; /&gt;&lt;/label&gt;&lt;/p&gt;

            &lt;p&gt;&lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;image_url&#39;); ?&gt;&quot;&gt;&lt;?php _e(&#39;Image URL:&#39;, &#39;avia_framework&#39;); ?&gt; &lt;?php if($this-&gt;add_cont == 2) echo &quot;(125px * 125px):&quot;; ?&gt;
            &lt;input class=&quot;widefat&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;image_url&#39;); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name(&#39;image_url&#39;); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php echo esc_attr($image_url); ?&gt;&quot; /&gt;&lt;/label&gt;&lt;/p&gt;

            &lt;p&gt;&lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;ref_url&#39;); ?&gt;&quot;&gt;&lt;?php _e(&#39;Referal URL:&#39;, &#39;avia_framework&#39;); ?&gt;
            &lt;input class=&quot;widefat&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;ref_url&#39;); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name(&#39;ref_url&#39;); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php echo esc_attr($ref_url); ?&gt;&quot; /&gt;&lt;/label&gt;&lt;/p&gt;

            &lt;?php if($this-&gt;add_cont == 2)
            &#123; ?&gt;

                    &lt;p&gt;&lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;image_url2&#39;); ?&gt;&quot;&gt;&lt;?php _e(&#39;Image URL 2: (125px * 125px):&#39;, &#39;avia_framework&#39;); ?&gt;
            &lt;input class=&quot;widefat&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;image_url2&#39;); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name(&#39;image_url2&#39;); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php echo esc_attr($image_url2); ?&gt;&quot; /&gt;&lt;/label&gt;&lt;/p&gt;

            &lt;p&gt;&lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;ref_url2&#39;); ?&gt;&quot;&gt;&lt;?php _e(&#39;Referal URL 2:&#39;, &#39;avia_framework&#39;); ?&gt;
            &lt;input class=&quot;widefat&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;ref_url2&#39;); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name(&#39;ref_url2&#39;); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php echo esc_attr($ref_url2); ?&gt;&quot; /&gt;&lt;/label&gt;&lt;/p&gt;

            &lt;?php &#125;?&gt;

    &lt;?php
        &#125;
    &#125;
&#125;


if (!class_exists(&#39;avia_one_partner_widget&#39;))
&#123;
    //one image
    class avia_one_partner_widget extends avia_partner_widget
    &#123;
        function __construct()
        &#123;

            $this-&gt;add_cont = 1;

            $widget_ops = array(&#39;classname&#39; =&gt; &#39;avia_one_partner_widget&#39;, &#39;description&#39; =&gt; __(&#39;An advertising widget that displays 1 big image&#39;, &#39;avia_framework&#39;) );

            parent::__construct( &#39;avia_one_partner_widget&#39;, THEMENAME.&#39; Big Advertising Area&#39;, $widget_ops );
        &#125;
    &#125;
&#125;



/**
 * AVIA COMBO WIDGET
 *
 * Widget that retrieves, stores and displays the number of twitter and rss followers
 *
 * @package AviaFramework
 * @todo replace the widget system with a dynamic one, based on config files for easier widget creation
 */

if (!class_exists(&#39;avia_combo_widget&#39;))
&#123;
    class avia_combo_widget extends WP_Widget &#123;

        function __construct() &#123;
            //Constructor
            $widget_ops = array(&#39;classname&#39; =&gt; &#39;avia_combo_widget&#39;, &#39;description&#39; =&gt; __(&#39;A widget that displays your popular posts, recent posts, recent comments and a tagcloud&#39;, &#39;avia_framework&#39;) );
            parent::__construct( &#39;avia_combo_widget&#39;, THEMENAME.&#39; Combo Widget&#39;, $widget_ops );
        &#125;

        function widget($args, $instance)
        &#123;
            // prints the widget

            extract($args, EXTR_SKIP);
            $posts = empty($instance[&#39;count&#39;]) ? 4 : $instance[&#39;count&#39;];

            echo $before_widget;
            echo &quot;&lt;div class=&#39;tabcontainer border_tabs top_tab tab_initial_open tab_initial_open__1&#39;&gt;&quot;;

            echo &#39;&lt;div class=&quot;tab first_tab active_tab widget_tab_popular&quot;&gt;&lt;span&gt;&#39;.__(&#39;Popular&#39;, &#39;avia_framework&#39;).&#39;&lt;/span&gt;&lt;/div&gt;&#39;;
            echo &quot;&lt;div class=&#39;tab_content active_tab_content&#39;&gt;&quot;;
            avia_get_post_list(&#39;cat=&amp;orderby=comment_count&amp;posts_per_page=&#39;.$posts);
            echo &quot;&lt;/div&gt;&quot;;

            echo &#39;&lt;div class=&quot;tab widget_tab_recent&quot;&gt;&lt;span&gt;&#39;.__(&#39;Recent&#39;, &#39;avia_framework&#39;).&#39;&lt;/span&gt;&lt;/div&gt;&#39;;
            echo &quot;&lt;div class=&#39;tab_content&#39;&gt;&quot;;
            avia_get_post_list(&#39;showposts=&#39;. $posts .&#39;&amp;orderby=post_date&amp;order=desc&#39;);
            echo &quot;&lt;/div&gt;&quot;;

            echo &#39;&lt;div class=&quot;tab widget_tab_comments&quot;&gt;&lt;span&gt;&#39;.__(&#39;Comments&#39;, &#39;avia_framework&#39;).&#39;&lt;/span&gt;&lt;/div&gt;&#39;;
            echo &quot;&lt;div class=&#39;tab_content&#39;&gt;&quot;;
            avia_get_comment_list( array(&#39;number&#39; =&gt; $posts, &#39;status&#39; =&gt; &#39;approve&#39;, &#39;order&#39; =&gt; &#39;DESC&#39;) );
            echo &quot;&lt;/div&gt;&quot;;

            echo &#39;&lt;div class=&quot;tab last_tab widget_tab_tags&quot;&gt;&lt;span&gt;&#39;.__(&#39;Tags&#39;, &#39;avia_framework&#39;).&#39;&lt;/span&gt;&lt;/div&gt;&#39;;
            echo &quot;&lt;div class=&#39;tab_content tagcloud&#39;&gt;&quot;;
            wp_tag_cloud(&#39;smallest=12&amp;largest=12&amp;unit=px&#39;);
            echo &quot;&lt;/div&gt;&quot;;

            echo &quot;&lt;/div&gt;&quot;;
            echo $after_widget;
        &#125;


        function update($new_instance, $old_instance)
        &#123;
            $instance = $old_instance;
            foreach($new_instance as $key=&gt;$value)
            &#123;
                $instance[$key] = strip_tags($new_instance[$key]);
            &#125;

            return $instance;
        &#125;

        function form($instance) &#123;
            //widgetform in backend

            $instance = wp_parse_args( (array) $instance, array(&#39;count&#39; =&gt; 4) );
            if(!is_numeric($instance[&#39;count&#39;])) $instance[&#39;count&#39;] = 4;

    ?&gt;
            &lt;p&gt;
            &lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;count&#39;); ?&gt;&quot;&gt;&lt;?php _e(&#39;Number of posts you want to display:&#39;, &#39;avia_framework&#39;); ?&gt;
            &lt;input class=&quot;widefat&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;count&#39;); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name(&#39;count&#39;); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php echo esc_attr($instance[&#39;count&#39;]); ?&gt;&quot; /&gt;&lt;/label&gt;&lt;/p&gt;


        &lt;?php
        &#125;
    &#125;
&#125;

/*-----------------------------------------------------------------------------------
get posts posts
-----------------------------------------------------------------------------------*/
if (!function_exists(&#39;avia_get_post_list&#39;))
&#123;
    function avia_get_post_list( $avia_new_query , $excerpt = false)
    &#123;
        global $avia_config;
        $image_size = isset($avia_config[&#39;widget_image_size&#39;]) ? $avia_config[&#39;widget_image_size&#39;] : &#39;widget&#39;;
        $additional_loop = new WP_Query($avia_new_query);

        if($additional_loop-&gt;have_posts()) :
        echo &#39;&lt;ul class=&quot;news-wrap&quot;&gt;&#39;;
        while ($additional_loop-&gt;have_posts()) : $additional_loop-&gt;the_post();

        $format = &quot;&quot;;
        if(get_post_type() != &#39;post&#39;)       $format = get_post_type();
        if(empty($format))                  $format = get_post_format();
        if(empty($format))                  $format = &#39;standard&#39;;

        echo &#39;&lt;li class=&quot;news-content post-format-&#39;.$format.&#39;&quot;&gt;&#39;;

        //check for preview images:
        $image = &quot;&quot;;

        if(!current_theme_supports(&#39;force-post-thumbnails-in-widget&#39;))
            &#123;
            $slides = avia_post_meta(get_the_ID(), &#39;slideshow&#39;);

            if( $slides != &quot;&quot; &amp;&amp; !empty( $slides[0][&#39;slideshow_image&#39;] ) )
            &#123;
                $image = avia_image_by_id($slides[0][&#39;slideshow_image&#39;], &#39;widget&#39;, &#39;image&#39;);
            &#125;
        &#125;

        if(!$image &amp;&amp; current_theme_supports( &#39;post-thumbnails&#39; ))
        &#123;
            $image = get_the_post_thumbnail( get_the_ID(), $image_size );
        &#125;

        $time_format = apply_filters( &#39;avia_widget_time&#39;, get_option(&#39;date_format&#39;).&quot; - &quot;.get_option(&#39;time_format&#39;), &#39;avia_get_post_list&#39; );

        $nothumb = (!$image) ? &#39;no-news-thumb&#39; : &#39;&#39;;

        echo &quot;&lt;a class=&#39;news-link&#39; title=&#39;&quot;.get_the_title().&quot;&#39; href=&#39;&quot;.get_permalink().&quot;&#39;&gt;&quot;;
        echo &quot;&lt;span class=&#39;news-thumb $nothumb&#39;&gt;&quot;;
        echo $image;
        echo &quot;&lt;/span&gt;&quot;;
        echo &quot;&lt;strong class=&#39;news-headline&#39;&gt;&quot;.avia_backend_truncate(get_the_title(), 55,&quot; &quot;);
        echo &quot;&lt;span class=&#39;news-time&#39;&gt;&quot;.get_the_time($time_format).&quot;&lt;/span&gt;&quot;;
        echo &quot;&lt;/strong&gt;&quot;;
        echo &quot;&lt;/a&gt;&quot;;

        if(&#39;display title and excerpt&#39; == $excerpt)
        &#123;
            echo &quot;&lt;div class=&#39;news-excerpt&#39;&gt;&quot;;
            the_excerpt();
            echo &quot;&lt;/div&gt;&quot;;
        &#125;

        echo &#39;&lt;/li&gt;&#39;;


        endwhile;
        echo &quot;&lt;/ul&gt;&quot;;
        wp_reset_postdata();
        endif;
    &#125;
&#125;





if (!function_exists(&#39;avia_get_comment_list&#39;))
&#123;

    function avia_get_comment_list($avia_new_query)
    &#123;
        $time_format = apply_filters( &#39;avia_widget_time&#39;, get_option(&#39;date_format&#39;).&quot; - &quot;.get_option(&#39;time_format&#39;), &#39;avia_get_comment_list&#39; );

        global $avia_config;


        $comments = get_comments($avia_new_query);

        if(!empty($comments)) :
        echo &#39;&lt;ul class=&quot;news-wrap&quot;&gt;&#39;;
        foreach($comments as $comment)
        &#123;
            if ($comment-&gt;comment_author != &#39;ActionScheduler&#39;)
            &#123;
            $gravatar_alt = esc_html($comment-&gt;comment_author);
            echo &#39;&lt;li class=&quot;news-content&quot;&gt;&#39;;
            echo &quot;&lt;a class=&#39;news-link&#39; title=&#39;&quot;.get_the_title($comment-&gt;comment_post_ID).&quot;&#39; href=&#39;&quot;.get_comment_link($comment).&quot;&#39;&gt;&quot;;
            echo &quot;&lt;span class=&#39;news-thumb&#39;&gt;&quot;;
            echo get_avatar($comment,&#39;48&#39;, &#39;&#39;, $gravatar_alt);
            echo &quot;&lt;/span&gt;&quot;;
            echo &quot;&lt;strong class=&#39;news-headline&#39;&gt;&quot;.avia_backend_truncate($comment-&gt;comment_content, 55,&quot; &quot;);

            if($time_format)
            &#123;
                echo &quot;&lt;span class=&#39;news-time&#39;&gt;&quot;.get_comment_date($time_format, $comment-&gt;comment_ID).&quot; &quot;.__(&#39;by&#39;,&#39;avia_framework&#39;).&quot; &quot;.$comment-&gt;comment_author.&quot;&lt;/span&gt;&quot;;
            &#125;
            echo &quot;&lt;/strong&gt;&quot;;
            echo &quot;&lt;/a&gt;&quot;;
            echo &#39;&lt;/li&gt;&#39;;
            &#125;
        &#125;
        echo &quot;&lt;/ul&gt;&quot;;
        wp_reset_postdata();
        endif;
    &#125;
&#125;



/*
    Google Maps Widget

    Copyright 2009  Clark Nikdel Powell  (email : taylor@cnpstudio.com)

    This program is free software; you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation; either version 2 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program; if not, write to the Free Software
    Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
*/

if (!class_exists(&#39;avia_google_maps&#39;))
&#123;
    class avia_google_maps extends WP_Widget &#123;

        // constructor
        function __construct() &#123;
            $widget_ops = array(&#39;classname&#39; =&gt; &#39;avia_google_maps&#39;, &#39;description&#39; =&gt; __( &#39;Add a google map to your blog or site&#39;, &#39;avia_framework&#39;) );
            parent::__construct(&#39;avia_google_maps&#39;, THEMENAME.&#39; Google Maps Widget&#39;, $widget_ops);

            add_action( &#39;admin_enqueue_scripts&#39;, array(&amp;$this,&#39;helper_print_google_maps_scripts&#39;) );
        &#125;

        // output the content of the widget
        function widget($args, $instance) &#123;
            extract( $args );

            $title = empty($instance[&#39;title&#39;]) ? &#39;&#39; : apply_filters(&#39;widget_title&#39;, esc_attr($instance[&#39;title&#39;]));

            print $before_widget;
            if (!empty($instance[&#39;title&#39;])) &#123; print $before_title.$title.$after_title; &#125;
            print avia_printmap($instance[&#39;lat&#39;], $instance[&#39;lng&#39;], $instance[&#39;zoom&#39;], $instance[&#39;type&#39;], $instance[&#39;content&#39;], $instance[&#39;directionsto&#39;], $instance[&#39;width&#39;], $instance[&#39;height&#39;], $instance[&#39;icon&#39;]);
            print $after_widget;
        &#125;

        // process widget options to be saved
        function update($new_instance, $old_instance) &#123;
            print_r($old_instance);
            print_r($new_instance);
            return $new_instance;
        &#125;

        // output the options form on admin
        function form($instance) &#123;
            global $wpdb;
            $title = empty($instance[&#39;title&#39;]) ? &#39;&#39; : esc_attr($instance[&#39;title&#39;]);
            $lat = empty($instance[&#39;lat&#39;]) ? &#39;&#39; : esc_attr($instance[&#39;lat&#39;]);
            $lng = empty($instance[&#39;lng&#39;]) ? &#39;&#39; : esc_attr($instance[&#39;lng&#39;]);
            $zoom = empty($instance[&#39;zoom&#39;]) ? &#39;15&#39; : esc_attr($instance[&#39;zoom&#39;]);
            $type = empty($instance[&#39;type&#39;]) ? &#39;ROADMAP&#39; : esc_attr($instance[&#39;type&#39;]);
            $directionsto = empty($instance[&#39;directionsto&#39;]) ? &#39;&#39; : esc_attr($instance[&#39;directionsto&#39;]);
            $content = empty($instance[&#39;content&#39;]) ? &#39;&#39; : esc_attr($instance[&#39;content&#39;]);
            $width = empty($instance[&#39;width&#39;]) ? &#39;&#39; : esc_attr($instance[&#39;width&#39;]);
            $height = empty($instance[&#39;height&#39;]) ? &#39;&#39; : esc_attr($instance[&#39;height&#39;]);
            $street_address = empty($instance[&#39;street-address&#39;]) ? &#39;&#39; : esc_attr($instance[&#39;street-address&#39;]);
            $city = empty($instance[&#39;city&#39;]) ? &#39;&#39; : esc_attr($instance[&#39;city&#39;]);
            $state = empty($instance[&#39;state&#39;]) ? &#39;&#39; : esc_attr($instance[&#39;state&#39;]);
            $postcode = empty($instance[&#39;postcode&#39;]) ? &#39;&#39; : esc_attr($instance[&#39;postcode&#39;]);
            $country = empty($instance[&#39;country&#39;]) ? &#39;&#39; : esc_attr($instance[&#39;country&#39;]);
            $icon = empty($instance[&#39;icon&#39;]) ? &#39;&#39; : esc_attr($instance[&#39;icon&#39;]);
            ?&gt;
                &lt;p&gt;
                &lt;label for=&quot;&lt;?php print $this-&gt;get_field_id(&#39;title&#39;); ?&gt;&quot;&gt;&lt;?php _e(&#39;Title:&#39;,&#39;avia_framework&#39;); ?&gt;&lt;/label&gt;
                &lt;input class=&quot;widefat&quot; id=&quot;&lt;?php print $this-&gt;get_field_id(&#39;title&#39;); ?&gt;&quot; name=&quot;&lt;?php print $this-&gt;get_field_name(&#39;title&#39;); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php print $title; ?&gt;&quot; /&gt;
                &lt;/p&gt;
                &lt;p&gt;
                &lt;?php _e(&#39;Enter the latitude and longitude of the location you want to display. Need help finding the latitude and longitude?&#39;, &#39;avia_framework&#39;); ?&gt; &lt;a href=&quot;#&quot; class=&quot;avia-coordinates-help-link button&quot;&gt;&lt;?php _e(&#39;Click here to enter an address.&#39;,&#39;avia_framework&#39;); ?&gt;&lt;/a&gt;
                &lt;/p&gt;
                &lt;div class=&quot;avia-find-coordinates-wrapper&quot;&gt;
                    &lt;p&gt;
                        &lt;label for=&quot;&lt;?php print $this-&gt;get_field_id(&#39;street-address&#39;); ?&gt;&quot;&gt;&lt;?php _e(&#39;Street Address:&#39;,&#39;avia_framework&#39;); ?&gt;&lt;/label&gt;
                        &lt;input class=&#39;widefat avia-map-street-address&#39; id=&quot;&lt;?php print $this-&gt;get_field_id(&#39;street-address&#39;); ?&gt;&quot; name=&quot;&lt;?php print $this-&gt;get_field_name(&#39;street-address&#39;); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php print $street_address; ?&gt;&quot; /&gt;
                    &lt;/p&gt;
                    &lt;p&gt;
                        &lt;label for=&quot;&lt;?php print $this-&gt;get_field_id(&#39;city&#39;); ?&gt;&quot;&gt;&lt;?php _e(&#39;City:&#39;,&#39;avia_framework&#39;); ?&gt;&lt;/label&gt;
                        &lt;input class=&#39;widefat avia-map-city&#39; id=&quot;&lt;?php print $this-&gt;get_field_id(&#39;city&#39;); ?&gt;&quot; name=&quot;&lt;?php print $this-&gt;get_field_name(&#39;city&#39;); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php print $city; ?&gt;&quot; /&gt;
                    &lt;/p&gt;
                    &lt;p&gt;
                        &lt;label for=&quot;&lt;?php print $this-&gt;get_field_id(&#39;state&#39;); ?&gt;&quot;&gt;&lt;?php _e(&#39;State:&#39;,&#39;avia_framework&#39;); ?&gt;&lt;/label&gt;
                        &lt;input class=&#39;widefat avia-map-state&#39; id=&quot;&lt;?php print $this-&gt;get_field_id(&#39;state&#39;); ?&gt;&quot; name=&quot;&lt;?php print $this-&gt;get_field_name(&#39;state&#39;); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php print $state; ?&gt;&quot; /&gt;
                    &lt;/p&gt;
                    &lt;p&gt;
                        &lt;label for=&quot;&lt;?php print $this-&gt;get_field_id(&#39;postcode&#39;); ?&gt;&quot;&gt;&lt;?php _e(&#39;Postcode:&#39;,&#39;avia_framework&#39;); ?&gt;&lt;/label&gt;
                        &lt;input class=&#39;widefat avia-map-postcode&#39; id=&quot;&lt;?php print $this-&gt;get_field_id(&#39;postcode&#39;); ?&gt;&quot; name=&quot;&lt;?php print $this-&gt;get_field_name(&#39;postcode&#39;); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php print $postcode; ?&gt;&quot; /&gt;
                    &lt;/p&gt;
                    &lt;p&gt;
                        &lt;label for=&quot;&lt;?php print $this-&gt;get_field_id(&#39;country&#39;); ?&gt;&quot;&gt;&lt;?php _e(&#39;Country:&#39;,&#39;avia_framework&#39;); ?&gt;&lt;/label&gt;
                        &lt;input class=&#39;widefat avia-map-country&#39; id=&quot;&lt;?php print $this-&gt;get_field_id(&#39;country&#39;); ?&gt;&quot; name=&quot;&lt;?php print $this-&gt;get_field_name(&#39;country&#39;); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php print $country; ?&gt;&quot; /&gt;
                    &lt;/p&gt;
                    &lt;p&gt;
                        &lt;a class=&quot;button avia-populate-coordinates&quot;&gt;&lt;?php _e(&#39;Fetch coordinates!&#39;,&#39;avia_framework&#39;); ?&gt;&lt;/a&gt;
                        &lt;div class=&#39;avia-loading-coordinates&#39;&gt;&lt;?php _e(&#39;Fetching the coordinates. Please wait...&#39;,&#39;avia_framework&#39;); ?&gt;&lt;/div&gt;
                    &lt;/p&gt;
                &lt;/div&gt;
                &lt;div class=&quot;avia-coordinates-wrapper&quot;&gt;
                &lt;p&gt;
                    &lt;label for=&quot;&lt;?php print $this-&gt;get_field_id(&#39;lat&#39;); ?&gt;&quot;&gt;&lt;?php _e(&#39;Latitude:&#39;,&#39;avia_framework&#39;); ?&gt;&lt;/label&gt;
                    &lt;input class=&#39;widefat avia-map-lat&#39; id=&quot;&lt;?php print $this-&gt;get_field_id(&#39;lat&#39;); ?&gt;&quot; name=&quot;&lt;?php print $this-&gt;get_field_name(&#39;lat&#39;); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php print $lat; ?&gt;&quot; /&gt;
                &lt;/p&gt;
                &lt;p&gt;
                &lt;label for=&quot;&lt;?php print $this-&gt;get_field_id(&#39;lng&#39;); ?&gt;&quot;&gt;&lt;?php _e(&#39;Longitude:&#39;,&#39;avia_framework&#39;); ?&gt;&lt;/label&gt;
                &lt;input class=&#39;widefat avia-map-lng&#39; id=&quot;&lt;?php print $this-&gt;get_field_id(&#39;lng&#39;); ?&gt;&quot; name=&quot;&lt;?php print $this-&gt;get_field_name(&#39;lng&#39;); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php print $lng; ?&gt;&quot; /&gt;
                &lt;/p&gt;
                &lt;/div&gt;
                &lt;p&gt;
                &lt;label for=&quot;&lt;?php print $this-&gt;get_field_id(&#39;zoom&#39;); ?&gt;&quot;&gt;&lt;?php echo __(&#39;Zoom Level:&#39;,&#39;avia_framework&#39;).&#39; &lt;small&gt;&#39;.__(&#39;(1-19)&#39;,&#39;avia_framework&#39;).&#39;&lt;/small&gt;&#39;; ?&gt;&lt;/label&gt;
                &lt;select class=&quot;widefat&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;zoom&#39;); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name(&#39;zoom&#39;); ?&gt;&quot;&gt;
                    &lt;?php
                    $list = &quot;&quot;;
                    $answers = array(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19);
                    foreach ($answers as $answer)
                    &#123;
                        $selected = &quot;&quot;;
                        if($answer == $zoom) $selected = &#39;selected=&quot;selected&quot;&#39;;

                        $list .= &quot;&lt;option $selected value=&#39;$answer&#39;&gt;$answer&lt;/option&gt;&quot;;
                    &#125;
                    $list .= &quot;&lt;/select&gt;&quot;;
                    echo $list;
                    ?&gt;


                &lt;/p&gt;

                &lt;p&gt;
                &lt;label for=&quot;&lt;?php print $this-&gt;get_field_id(&#39;type&#39;); ?&gt;&quot;&gt;&lt;?php _e(&#39;Map Type:&#39;,&#39;avia_framework&#39;); ?&gt;&lt;/label&gt;

                &lt;select class=&quot;widefat&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id(&#39;type&#39;); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name(&#39;type&#39;); ?&gt;&quot;&gt;
                    &lt;?php
                    $list = &quot;&quot;;
                    $answers = array(&#39;ROADMAP&#39;, &#39;SATELLITE&#39;, &#39;HYBRID&#39;, &#39;TERRAIN&#39;);
                    foreach ($answers as $answer)
                    &#123;
                        $selected = &quot;&quot;;
                        if($answer == $type) $selected = &#39;selected=&quot;selected&quot;&#39;;

                        $list .= &quot;&lt;option $selected value=&#39;$answer&#39;&gt;$answer&lt;/option&gt;&quot;;
                    &#125;
                    $list .= &quot;&lt;/select&gt;&quot;;
                    echo $list;
                    ?&gt;

                &lt;/p&gt;
                &lt;p&gt;
                &lt;label for=&quot;&lt;?php print $this-&gt;get_field_id(&#39;directionsto&#39;); ?&gt;&quot;&gt;&lt;?php _e(&#39;Display a Route by entering a address here. (If address is added Zoom will be ignored)&#39;,&#39;avia_framework&#39;); ?&gt;&lt;/label&gt;
                &lt;input class=&quot;widefat&quot; id=&quot;&lt;?php print $this-&gt;get_field_id(&#39;directionsto&#39;); ?&gt;&quot; name=&quot;&lt;?php print $this-&gt;get_field_name(&#39;directionsto&#39;); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php print $directionsto; ?&gt;&quot; /&gt;
                &lt;/p&gt;
                &lt;p&gt;
                &lt;label for=&quot;&lt;?php print $this-&gt;get_field_id(&#39;content&#39;); ?&gt;&quot;&gt;&lt;?php _e(&#39;Info Bubble Content:&#39;,&#39;avia_framework&#39;); ?&gt;&lt;/label&gt;
                &lt;textarea rows=&quot;7&quot; class=&quot;widefat&quot; id=&quot;&lt;?php print $this-&gt;get_field_id(&#39;content&#39;); ?&gt;&quot; name=&quot;&lt;?php print $this-&gt;get_field_name(&#39;content&#39;); ?&gt;&quot;&gt;&lt;?php print $content; ?&gt;&lt;/textarea&gt;
                &lt;/p&gt;
                &lt;p&gt;
                &lt;label for=&quot;&lt;?php print $this-&gt;get_field_id(&#39;icon&#39;); ?&gt;&quot;&gt;&lt;?php _e(&#39;Custom Marker Image URL:&#39;,&#39;avia_framework&#39;); ?&gt;&lt;/label&gt;
                &lt;input class=&quot;widefat&quot; class=&quot;avia-marker-icon&quot; id=&quot;&lt;?php print $this-&gt;get_field_id(&#39;icon&#39;); ?&gt;&quot; name=&quot;&lt;?php print $this-&gt;get_field_name(&#39;icon&#39;); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php print $icon; ?&gt;&quot; /&gt;
                &lt;/p&gt;
                &lt;p&gt;
                &lt;label for=&quot;&lt;?php print $this-&gt;get_field_id(&#39;width&#39;); ?&gt;&quot;&gt;&lt;?php _e(&#39;Enter the width in px or &amp;percnt; (100&amp;percnt; width will be used if you leave this field empty)&#39;,&#39;avia_framework&#39;); ?&gt;&lt;/label&gt;
                &lt;input class=&quot;widefat&quot; id=&quot;&lt;?php print $this-&gt;get_field_id(&#39;width&#39;); ?&gt;&quot; name=&quot;&lt;?php print $this-&gt;get_field_name(&#39;width&#39;); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php print $width; ?&gt;&quot; /&gt;
                &lt;/p&gt;
                &lt;p&gt;
                &lt;label for=&quot;&lt;?php print $this-&gt;get_field_id(&#39;height&#39;); ?&gt;&quot;&gt;&lt;?php _e(&#39;Enter the height in px or &amp;percnt;&#39;,&#39;avia_framework&#39;); ?&gt;&lt;/label&gt;
                &lt;input class=&quot;widefat&quot; id=&quot;&lt;?php print $this-&gt;get_field_id(&#39;height&#39;); ?&gt;&quot; name=&quot;&lt;?php print $this-&gt;get_field_name(&#39;height&#39;); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php print $height; ?&gt;&quot; /&gt;
                &lt;/p&gt;
            &lt;?php
        &#125;

        function helper_print_google_maps_scripts()
        &#123;

            $api_key = avia_get_option(&#39;gmap_api&#39;);
            $api_url = av_google_maps::api_url( $api_key );

            wp_register_script( &#39;avia-google-maps-api&#39;, $api_url, array(&#39;jquery&#39;), NULL, true);

            $load_google_map_api = apply_filters(&#39;avf_load_google_map_api&#39;, true, &#39;avia_google_map_widget&#39;);

            if($load_google_map_api) wp_enqueue_script( &#39;avia-google-maps-api&#39; );

            $is_widget_edit_page = in_array(basename($_SERVER[&#39;PHP_SELF&#39;]), array(&#39;widgets.php&#39;));
            if($is_widget_edit_page)
            &#123;
                wp_register_script( &#39;avia-google-maps-widget&#39;, AVIA_JS_URL.&#39;conditional_load/avia_google_maps_widget.js&#39;, array( &#39;jquery&#39;,&#39;media-upload&#39;,&#39;media-views&#39; ), &#39;1.0.0&#39;, true);
                wp_enqueue_script( &#39;avia-google-maps-widget&#39; );

                $args = array(
                    &#39;toomanyrequests&#39;   =&gt; __(&quot;Too many requests at once, please refresh the page to complete geocoding&quot;,&#39;avia_framework&#39;),
                    &#39;latitude&#39;          =&gt; __(&quot;Latitude and longitude for&quot;,&#39;avia_framework&#39;),
                    &#39;notfound&#39;          =&gt; __(&quot;couldn&#39;t be found by Google, please add them manually&quot;,&#39;avia_framework&#39;),
                    &#39;insertaddress&#39;     =&gt; __(&quot;Please insert a valid address in the fields above&quot;,&#39;avia_framework&#39;)
                );

                if($load_google_map_api) wp_localize_script( &#39;avia-google-maps-api&#39;, &#39;AviaMapTranslation&#39;, $args );
            &#125;
        &#125;


    &#125; // SGMwidget widget
&#125;


if(!function_exists(&#39;avia_printmap&#39;))
&#123;
    function avia_printmap($lat, $lng, $zoom, $type, $content, $directionsto, $width, $height, $icon) &#123;

        global $avia_config;

        $SGMoptions = get_option(&#39;SGMoptions&#39;); // get options defined in admin page

        if (!$lat) &#123;$lat = &#39;0&#39;;&#125;
        if (!$lng) &#123;$lng = &#39;0&#39;;&#125;
        if (!$zoom) &#123;$zoom = $SGMoptions[&#39;zoom&#39;];&#125; // 1-19
        if (!$type) &#123;$type = $SGMoptions[&#39;type&#39;];&#125; // ROADMAP, SATELLITE, HYBRID, TERRAIN
        if (!$content) &#123;$content = $SGMoptions[&#39;content&#39;];&#125;
        $output = &quot;&quot;;
        $unique = uniqid();

        $prefix  = isset($_SERVER[&#39;HTTPS&#39;] ) ? &quot;https&quot; : &quot;http&quot;;
        $width = !empty($width) ? &#39;width:&#39;.$width.&#39;;&#39; : &#39;width:100%;&#39;;
        $height = !empty($height) ? &#39;height:&#39;.$height.&#39;;&#39; : &#39;&#39;;
        $icon = !empty($icon) ? $icon : &#39;&#39;;

        $content = htmlspecialchars($content, ENT_QUOTES);
        $content = str_replace(&#39;&amp;lt;&#39;, &#39;&lt;&#39;, $content);
        $content = str_replace(&#39;&amp;gt;&#39;, &#39;&gt;&#39;, $content);
        $content = str_replace(&#39;&amp;quot;&#39;, &#39;&quot;&#39;, $content);
        $content = str_replace(&#39;&amp;#039;&#39;, &#39;&quot;&#39;, $content);
        $content = json_encode($content);


        $directionsForm = &quot;&quot;;
        if(empty($avia_config[&#39;g_maps_widget_active&#39;]))
        &#123;
            $avia_config[&#39;g_maps_widget_active&#39;] = 0;
        &#125;


        if(apply_filters(&#39;avia_google_maps_widget_load_api&#39;, true, $avia_config[&#39;g_maps_widget_active&#39;]))
        &#123;   
            $api_key = avia_get_option(&#39;gmap_api&#39;);
            $api_url = av_google_maps::api_url( $api_key );

            wp_register_script( &#39;avia-google-maps-api&#39;, $api_url, array(&#39;jquery&#39;), NULL, true);
            wp_enqueue_script( &#39;avia-google-maps-api&#39; );
        &#125;

        $avia_config[&#39;g_maps_widget_active&#39;] ++;

    $output .= &quot;&lt;script type=&#39;text/javascript&#39;&gt;
        function makeMap_&quot;.$avia_config[&#39;g_maps_widget_active&#39;].&quot;() &#123;\n&quot;;

    $avia_maps_config = &quot;
        var directionsDisplay;
        directionsDisplay = new google.maps.DirectionsRenderer;
        var directionsService = new google.maps.DirectionsService;
        var map;
        var latlng = new google.maps.LatLng(&quot;.$lat.&quot;, &quot;.$lng.&quot;);
        var directionsto = &#39;&quot;.$directionsto.&quot;&#39;;
        var myOptions = &#123;
          zoom:&quot;.$zoom.&quot;,
          mapTypeControl:true,
          mapTypeId:google.maps.MapTypeId.&quot;.$type.&quot;,
          mapTypeControlOptions:&#123;style:google.maps.MapTypeControlStyle.DROPDOWN_MENU&#125;,
          navigationControl:true,
          navigationControlOptions:&#123;style:google.maps.NavigationControlStyle.SMALL&#125;,
          center:latlng
        &#125;;
        var map = new google.maps.Map(document.getElementById(&#39;avia_google_maps_$unique&#39;), myOptions);

        if(directionsto.length &gt; 5)
        &#123;
          directionsDisplay.setMap(map);
          var request = &#123;
             origin:directionsto,
             destination:latlng,
             travelMode:google.maps.DirectionsTravelMode.DRIVING
        &#125;;
          directionsService.route(request, function(response, status) &#123;
             if(status == google.maps.DirectionsStatus.OK) &#123;
                directionsDisplay.setDirections(response)
             &#125;
          &#125;)
        &#125;
        else
        &#123;
          var contentString = &quot;.$content.&quot;;
          var infowindow = new google.maps.InfoWindow(&#123;
             content: contentString
          &#125;);
          var marker = new google.maps.Marker(&#123;
             position: latlng,
             map: map,
             icon: &#39;&quot;.$icon.&quot;&#39;,
             title: &#39;&#39;
          &#125;);

          google.maps.event.addListener(marker, &#39;click&#39;, function() &#123;
              infowindow.open(map,marker);
          &#125;);
        &#125;&quot;;

    $output .= apply_filters(&#39;avia_google_maps_widget_config&#39;, $avia_maps_config, $lat, $lng, $directionsto, $zoom, $type, $unique, $content, $icon);

    $output .= &quot;\n&#125;\n\n
            jQuery(document).ready(function() &#123;
                makeMap_&quot;.$avia_config[&#39;g_maps_widget_active&#39;].&quot;()
            &#125;);
        &lt;/script&gt;
        &lt;div id=&#39;avia_google_maps_$unique&#39; style=&#39;$height $width&#39; class=&#39;avia_google_maps_container&#39;&gt;&lt;/div&gt;&quot;;

       return $output;
    &#125;
&#125;





/*
Modified version of instagram widget by
Author: Scott Evans
Copyright © 2013 Scott Evans

This program is free software; you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation; either version 2 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

*/

class avia_instagram_widget extends WP_Widget &#123;

    function __construct() &#123;
        parent::__construct(
            &#39;avia-instagram-feed&#39;,
            THEMENAME .&quot; &quot;. __( &#39;Instagram&#39;, &#39;avia_framework&#39; ),
            array( &#39;classname&#39; =&gt; &#39;avia-instagram-feed&#39;, &#39;description&#39; =&gt; __( &#39;Displays your latest Instagram photos&#39;, &#39;avia_framework&#39; ) )
        );
    &#125;

    function widget( $args, $instance ) &#123;

        extract( $args, EXTR_SKIP );

        $title = empty( $instance[&#39;title&#39;] ) ? &#39;&#39; : apply_filters( &#39;widget_title&#39;, $instance[&#39;title&#39;] );
        $username = empty( $instance[&#39;username&#39;] ) ? &#39;&#39; : $instance[&#39;username&#39;];
        $limit = empty( $instance[&#39;number&#39;] ) ? 9 : $instance[&#39;number&#39;];
        $columns = empty( $instance[&#39;columns&#39;] ) ? 3 : $instance[&#39;columns&#39;];
        $size = empty( $instance[&#39;size&#39;] ) ? &#39;large&#39; : $instance[&#39;size&#39;];
        $target = empty( $instance[&#39;target&#39;] ) ? &#39;_self&#39; : $instance[&#39;target&#39;];
        $link = empty( $instance[&#39;link&#39;] ) ? &#39;&#39; : $instance[&#39;link&#39;];

        echo $before_widget;
        if ( ! empty( $title ) ) &#123; echo $before_title . $title . $after_title; &#125;;

        do_action( &#39;aviw_before_widget&#39;, $instance );

        if ( $username != &#39;&#39; ) &#123;

            $media_array = $this-&gt;scrape_instagram( $username, $limit );

            if ( is_wp_error( $media_array ) ) &#123;

                echo $media_array-&gt;get_error_message();

            &#125; else &#123;

                // filter for images only?
                if ( $images_only = apply_filters( &#39;aviw_images_only&#39;, FALSE ) )
                    $media_array = array_filter( $media_array, array( $this, &#39;images_only&#39; ) );

                // filters for custom classes
                $ulclass = esc_attr( apply_filters( &#39;aviw_list_class&#39;, &#39;av-instagram-pics av-instagram-size-&#39; . $size ) );
                $rowclass = esc_attr( apply_filters( &#39;aviw_row_class&#39;, &#39;av-instagram-row&#39; ) );
                $liclass = esc_attr( apply_filters( &#39;aviw_item_class&#39;, &#39;av-instagram-item&#39; ) );
                $aclass = esc_attr( apply_filters( &#39;aviw_a_class&#39;, &#39;&#39; ) );
                $imgclass = esc_attr( apply_filters( &#39;aviw_img_class&#39;, &#39;&#39; ) );

                ?&gt;&lt;div class=&quot;&lt;?php echo esc_attr( $ulclass ); ?&gt;&quot;&gt;&lt;?php

                $last_id  = end($media_array);
                $last_id  = $last_id[&#39;id&#39;];

                $rowcount = 0;  
                foreach ( $media_array as $item ) 
                &#123;
                    if($rowcount == 0)
                    &#123;
                        echo &quot;&lt;div class=&#39;&#123;$rowclass&#125;&#39;&gt;&quot;;
                    &#125;

                    $rowcount ++ ;
                    $targeting = $target;
                    if($target == &quot;lightbox&quot;)
                    &#123;
                        $targeting = &quot;&quot;;
                        $item[&#39;link&#39;] = $item[&#39;original&#39;];
                    &#125;

                    echo &#39;&lt;div class=&quot;&#39;. $liclass .&#39;&quot;&gt;&#39;;
                    echo &#39;&lt;a href=&quot;&#39;. esc_url( $item[&#39;link&#39;] ) .&#39;&quot; target=&quot;&#39;. esc_attr( $targeting ) .&#39;&quot;  class=&quot;&#39;. $aclass .&#39;&quot;&gt;&#39;;
                    echo &#39;&lt;img src=&quot;&#39;. esc_url( $item[$size] ) .&#39;&quot;  alt=&quot;&#39;. esc_attr( $item[&#39;description&#39;] ) .&#39;&quot; title=&quot;&#39;. esc_attr( $item[&#39;description&#39;] ).&#39;&quot;  class=&quot;&#39;. $imgclass .&#39;&quot;/&gt;&#39;;
                    echo &#39;&lt;/a&gt;&lt;/div&gt;&#39;;

                    if($rowcount % $columns == 0 || $last_id == $item[&#39;id&#39;])
                    &#123;
                        echo &#39;&lt;/div&gt;&#39;;
                        $rowcount = 0;
                    &#125;

                &#125;
                echo &#39;&lt;/div&gt;&#39;;
            &#125;
        &#125;

        if ( $link != &#39;&#39; ) &#123;
            ?&gt;
            &lt;a class=&quot;av-instagram-follow avia-button&quot; href=&quot;//instagram.com/&lt;?php echo esc_attr( trim( $username ) ); ?&gt;&quot; rel=&quot;me&quot; target=&quot;&lt;?php echo esc_attr( $target ); ?&gt;&quot;&gt;&lt;?php echo $link; ?&gt;&lt;/a&gt;&lt;?php
        &#125;

        do_action( &#39;aviw_after_widget&#39;, $instance );

        echo $after_widget;
    &#125;



    function form( $instance ) 
    &#123;

        $instance = wp_parse_args( (array) $instance, array( 
            &#39;title&#39; =&gt; __( &#39;Instagram&#39;, &#39;avia_framework&#39; ), 
            &#39;username&#39; =&gt; &#39;&#39;, 
            &#39;size&#39; =&gt; &#39;large&#39;, 
            &#39;link&#39; =&gt; __( &#39;Follow Me!&#39;, &#39;avia_framework&#39; ), 
            &#39;number&#39; =&gt; 9, 
            &#39;target&#39; =&gt; &#39;lightbox&#39; , 
            &#39;columns&#39; =&gt; 3 ) 
        );

        $title = esc_attr( $instance[&#39;title&#39;] );
        $username = esc_attr( $instance[&#39;username&#39;] );
        $number = absint( $instance[&#39;number&#39;] );
        if($number &gt; 12) $number = 12;
        $size = esc_attr( $instance[&#39;size&#39;] );
        $target = esc_attr( $instance[&#39;target&#39;] );
        $link = esc_attr( $instance[&#39;link&#39;] );
        $columns = esc_attr( $instance[&#39;columns&#39;] );
        ?&gt;
        &lt;p&gt;&lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id( &#39;title&#39; ); ?&gt;&quot;&gt;&lt;?php _e( &#39;Title&#39;, &#39;avia_framework&#39; ); ?&gt;: &lt;input class=&quot;widefat&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id( &#39;title&#39; ); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name( &#39;title&#39; ); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php echo $title; ?&gt;&quot; /&gt;&lt;/label&gt;&lt;/p&gt;
        &lt;p&gt;&lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id( &#39;username&#39; ); ?&gt;&quot;&gt;&lt;?php _e( &#39;Username&#39;, &#39;avia_framework&#39; ); ?&gt;: &lt;input class=&quot;widefat&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id( &#39;username&#39; ); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name( &#39;username&#39; ); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php echo $username; ?&gt;&quot; /&gt;&lt;/label&gt;&lt;/p&gt;
        &lt;p&gt;&lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id( &#39;number&#39; ); ?&gt;&quot;&gt;&lt;?php _e( &#39;Number of photos (maximum 12)&#39;, &#39;avia_framework&#39; ); ?&gt;: &lt;input class=&quot;widefat&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id( &#39;number&#39; ); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name( &#39;number&#39; ); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php echo $number; ?&gt;&quot; /&gt;&lt;/label&gt;&lt;/p&gt;
        &lt;p&gt;&lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id( &#39;columns&#39; ); ?&gt;&quot;&gt;&lt;?php _e( &#39;Number of columns&#39;, &#39;avia_framework&#39; ); ?&gt;: &lt;input class=&quot;widefat&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id( &#39;columns&#39; ); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name( &#39;columns&#39; ); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php echo $columns; ?&gt;&quot; /&gt;&lt;/label&gt;&lt;/p&gt;
        &lt;p&gt;&lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id( &#39;size&#39; ); ?&gt;&quot;&gt;&lt;?php _e( &#39;Photo size&#39;, &#39;avia_framework&#39; ); ?&gt;:&lt;/label&gt;
            &lt;select id=&quot;&lt;?php echo $this-&gt;get_field_id( &#39;size&#39; ); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name( &#39;size&#39; ); ?&gt;&quot; class=&quot;widefat&quot;&gt;
                &lt;option value=&quot;thumbnail&quot; &lt;?php selected( &#39;thumbnail&#39;, $size ) ?&gt;&gt;&lt;?php _e( &#39;Thumbnail&#39;, &#39;avia_framework&#39; ); ?&gt;&lt;/option&gt;
                &lt;option value=&quot;small&quot; &lt;?php selected( &#39;small&#39;, $size ) ?&gt;&gt;&lt;?php _e( &#39;Small&#39;, &#39;avia_framework&#39; ); ?&gt;&lt;/option&gt;
                &lt;option value=&quot;large&quot; &lt;?php selected( &#39;large&#39;, $size ) ?&gt;&gt;&lt;?php _e( &#39;Large&#39;, &#39;avia_framework&#39; ); ?&gt;&lt;/option&gt;
                &lt;option value=&quot;original&quot; &lt;?php selected( &#39;original&#39;, $size ) ?&gt;&gt;&lt;?php _e( &#39;Original&#39;, &#39;avia_framework&#39; ); ?&gt;&lt;/option&gt;
            &lt;/select&gt;
        &lt;/p&gt;
        &lt;p&gt;&lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id( &#39;target&#39; ); ?&gt;&quot;&gt;&lt;?php _e( &#39;Open links in&#39;, &#39;avia_framework&#39; ); ?&gt;:&lt;/label&gt;
            &lt;select id=&quot;&lt;?php echo $this-&gt;get_field_id( &#39;target&#39; ); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name( &#39;target&#39; ); ?&gt;&quot; class=&quot;widefat&quot;&gt;
                &lt;option value=&quot;lightbox&quot; &lt;?php selected( &#39;lightbox&#39;, $target ) ?&gt;&gt;&lt;?php _e( &#39;Lightbox&#39;, &#39;avia_framework&#39; ); ?&gt;&lt;/option&gt;
                &lt;option value=&quot;_self&quot; &lt;?php selected( &#39;_self&#39;, $target ) ?&gt;&gt;&lt;?php _e( &#39;Current window (_self)&#39;, &#39;avia_framework&#39; ); ?&gt;&lt;/option&gt;
                &lt;option value=&quot;_blank&quot; &lt;?php selected( &#39;_blank&#39;, $target ) ?&gt;&gt;&lt;?php _e( &#39;New window (_blank)&#39;, &#39;avia_framework&#39; ); ?&gt;&lt;/option&gt;
            &lt;/select&gt;
        &lt;/p&gt;
        &lt;p&gt;&lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id( &#39;link&#39; ); ?&gt;&quot;&gt;&lt;?php _e( &#39;Link text&#39;, &#39;avia_framework&#39; ); ?&gt;: &lt;input class=&quot;widefat&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id( &#39;link&#39; ); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name( &#39;link&#39; ); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php echo $link; ?&gt;&quot; /&gt;&lt;/label&gt;&lt;/p&gt;
        &lt;?php
    &#125;

    function update( $new_instance, $old_instance ) &#123;
        $instance = $old_instance;
        $instance[&#39;title&#39;] = strip_tags( $new_instance[&#39;title&#39;] );
        $instance[&#39;username&#39;] = trim( strip_tags( $new_instance[&#39;username&#39;] ) );
        $instance[&#39;number&#39;] = ! absint( $new_instance[&#39;number&#39;] ) ? 9 : $new_instance[&#39;number&#39;];
        $instance[&#39;columns&#39;] = ! absint( $new_instance[&#39;columns&#39;] ) ? 3 : $new_instance[&#39;columns&#39;];

        if($instance[&#39;columns&#39;] &gt; 6) $instance[&#39;columns&#39;] = 6;
        if($instance[&#39;columns&#39;] &lt; 1) $instance[&#39;columns&#39;] = 1;


        $instance[&#39;size&#39;] = ( ( $new_instance[&#39;size&#39;] == &#39;thumbnail&#39; || $new_instance[&#39;size&#39;] == &#39;large&#39; || $new_instance[&#39;size&#39;] == &#39;small&#39; || $new_instance[&#39;size&#39;] == &#39;original&#39; ) ? $new_instance[&#39;size&#39;] : &#39;large&#39; );
        $instance[&#39;target&#39;] = ( ( $new_instance[&#39;target&#39;] == &#39;_self&#39; || $new_instance[&#39;target&#39;] == &#39;_blank&#39;|| $new_instance[&#39;target&#39;] == &#39;lightbox&#39; ) ? $new_instance[&#39;target&#39;] : &#39;_self&#39; );
        $instance[&#39;link&#39;] = strip_tags( $new_instance[&#39;link&#39;] );
        return $instance;
    &#125;

        // based on https://gist.github.com/cosmocatalano/4544576
    function scrape_instagram( $username, $slice = 9 ) &#123;

        $username = strtolower( $username );
        $username = str_replace( &#39;@&#39;, &#39;&#39;, $username );
        $transient_prefix = &quot;u&quot;;

        if ( false === ( $instagram = get_transient( &#39;av_insta2-&#39; . $transient_prefix . &#39;-&#39; . sanitize_title_with_dashes( $username ) ) ) ) &#123;

            //$remote = wp_remote_get( &#39;http://instagram.com/&#39;.trim( $username ) );
            $remote = wp_remote_get( &#39;https://www.instagram.com/&#39;.trim( $username ), array( &#39;sslverify&#39; =&gt; false, &#39;timeout&#39; =&gt; 60 ) );

            if ( is_wp_error( $remote ) )
                return new WP_Error( &#39;site_down&#39;, __( &#39;Unable to communicate with Instagram.&#39;, &#39;avia_framework&#39; ) );

            if ( 200 != wp_remote_retrieve_response_code( $remote ) )
                return new WP_Error( &#39;invalid_response&#39;, __( &#39;Instagram did not return a 200.&#39;, &#39;avia_framework&#39; ) );

            $shards = explode( &#39;window._sharedData = &#39;, $remote[&#39;body&#39;] );
            $insta_json = explode( &#39;;&lt;/script&gt;&#39;, $shards[1] );
            $insta_array = json_decode( $insta_json[0], TRUE );

            if ( ! $insta_array )
                return new WP_Error( &#39;bad_json&#39;, __( &#39;Instagram has returned invalid data.&#39;, &#39;avia_framework&#39; ) );

            if ( isset( $insta_array[&#39;entry_data&#39;][&#39;ProfilePage&#39;][0][&#39;graphql&#39;][&#39;user&#39;][&#39;edge_owner_to_timeline_media&#39;][&#39;edges&#39;] ) ) &#123;
                $images = $insta_array[&#39;entry_data&#39;][&#39;ProfilePage&#39;][0][&#39;graphql&#39;][&#39;user&#39;][&#39;edge_owner_to_timeline_media&#39;][&#39;edges&#39;];
            &#125; else &#123;
                return new WP_Error( &#39;bad_json_2&#39;, __( &#39;Instagram has returned invalid data.&#39;, &#39;avia_framework&#39; ) );
            &#125;

            if ( ! is_array( $images ) )
                return new WP_Error( &#39;bad_array&#39;, __( &#39;Instagram has returned invalid data.&#39;, &#39;avia_framework&#39; ) );

            $instagram = array();

            foreach ( $images as $image ) &#123;

                // see https://github.com/stevenschobert/instafeed.js/issues/549
                //$image[&#39;thumbnail_src&#39;] = preg_replace( &quot;/^https:/i&quot;, &quot;&quot;, $image[&#39;thumbnail_src&#39;] );
                $image[&#39;thumbnail&#39;] = preg_replace( &#39;/^https?\:/i&#39;, &#39;&#39;, $image[&#39;node&#39;][&#39;thumbnail_resources&#39;][0][&#39;src&#39;] );
                $image[&#39;small&#39;] = preg_replace( &#39;/^https?\:/i&#39;, &#39;&#39;, $image[&#39;node&#39;][&#39;thumbnail_resources&#39;][2][&#39;src&#39;] );
                $image[&#39;large&#39;] = preg_replace( &#39;/^https?\:/i&#39;, &#39;&#39;, $image[&#39;node&#39;][&#39;thumbnail_resources&#39;][4][&#39;src&#39;] );
                $image[&#39;display_src&#39;] = preg_replace( &#39;/^https?\:/i&#39;, &#39;&#39;, $image[&#39;node&#39;][&#39;display_url&#39;] );

                if ( $image[&#39;node&#39;][&#39;is_video&#39;] == true ) &#123;
                    $type = &#39;video&#39;;
                &#125; else &#123;
                    $type = &#39;image&#39;;
                &#125;

                $caption = __( &#39;Instagram Image&#39;, &#39;avia_framework&#39; );
                if ( ! empty( $image[&#39;node&#39;][&#39;edge_media_to_caption&#39;][&#39;edges&#39;][0][&#39;node&#39;][&#39;text&#39;] ) ) &#123;
                    $caption = wp_kses( $image[&#39;node&#39;][&#39;edge_media_to_caption&#39;][&#39;edges&#39;][0][&#39;node&#39;][&#39;text&#39;], array() );
                &#125;

                $instagram[] = array(
                    &#39;description&#39;   =&gt; $caption,
                    &#39;link&#39;          =&gt; trailingslashit( &#39;//instagram.com/p/&#39; . $image[&#39;node&#39;][&#39;shortcode&#39;] ),
                    &#39;time&#39;          =&gt; $image[&#39;node&#39;][&#39;taken_at_timestamp&#39;],
                    &#39;comments&#39;      =&gt; $image[&#39;node&#39;][&#39;edge_media_to_comment&#39;][&#39;count&#39;],
                    &#39;likes&#39;         =&gt; $image[&#39;node&#39;][&#39;edge_liked_by&#39;][&#39;count&#39;],
                    &#39;thumbnail&#39;     =&gt; preg_replace( &#39;/^https?\:/i&#39;, &#39;&#39;, $image[&#39;node&#39;][&#39;thumbnail_resources&#39;][0][&#39;src&#39;] ),
                    &#39;small&#39;         =&gt; preg_replace( &#39;/^https?\:/i&#39;, &#39;&#39;, $image[&#39;node&#39;][&#39;thumbnail_resources&#39;][2][&#39;src&#39;] ),
                    &#39;large&#39;         =&gt; preg_replace( &#39;/^https?\:/i&#39;, &#39;&#39;, $image[&#39;node&#39;][&#39;thumbnail_resources&#39;][4][&#39;src&#39;] ),
                    &#39;original&#39;      =&gt; preg_replace( &#39;/^https?\:/i&#39;, &#39;&#39;, $image[&#39;node&#39;][&#39;display_url&#39;] ),
                    &#39;type&#39;          =&gt; $type,
                    &#39;id&#39;            =&gt; $image[&#39;node&#39;][&#39;id&#39;]
                );
            &#125;

            // do not set an empty transient - should help catch private or empty accounts
            if ( ! empty( $instagram ) ) &#123;
                $instagram = base64_encode( serialize( $instagram ) );
                set_transient( &#39;av_insta2-&#39; . $transient_prefix . &#39;-&#39; . sanitize_title_with_dashes( $username ), $instagram, apply_filters( &#39;null_instagram_cache_time&#39;, HOUR_IN_SECONDS * 2 ) );
            &#125;
        &#125;

        if ( ! empty( $instagram ) ) &#123;

            $instagram = unserialize( base64_decode( $instagram ) );
            return array_slice( $instagram, 0, $slice );

        &#125; else &#123;

            return new WP_Error( &#39;no_images&#39;, __( &#39;Instagram did not return any images.&#39;, &#39;avia_framework&#39; ) );

        &#125;
    &#125;

    function images_only( $media_item ) &#123;

        if ( $media_item[&#39;type&#39;] == &#39;image&#39; )
            return true;

        return false;
    &#125;
&#125;</code></pre>
<p>文件下载地址：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1DnPU4BiC4WBrrJteUYIokg">https://pan.baidu.com/s/1DnPU4BiC4WBrrJteUYIokg</a>  密码：7p3e</p>
<p>这样写显得很愚蠢，只是担心分享链接失效，当然我们还可以通过文件对比来找到差异，这里罗列了几个，给大家做个参考，相比于旧的，新的这个文件这里是：</p>
<pre><code>function scrape_instagram( $username, $slice = 9 ) &#123;

    $username = strtolower( $username );
    $username = str_replace( &#39;@&#39;, &#39;&#39;, $username );
    $transient_prefix = &quot;u&quot;;

    if ( false === ( $instagram = get_transient( &#39;av_insta2-&#39; . $transient_prefix . &#39;-&#39; . sanitize_title_with_dashes( $username ) ) ) ) &#123;

        //$remote = wp_remote_get( &#39;http://instagram.com/&#39;.trim( $username ) );</code></pre>
<p>而旧的是：</p>
<pre><code>function scrape_instagram( $username, $slice = 9 ) &#123;

    $username = strtolower( $username );
    $username = str_replace( &#39;@&#39;, &#39;&#39;, $username );

    if ( false === ( $instagram = get_transient( &#39;av_insta1-&#39;.sanitize_title_with_dashes( $username ) ) ) ) &#123;</code></pre>
<hr>
<p>新的文件有个地方是：</p>
<pre><code>if ( $image[&#39;node&#39;][&#39;is_video&#39;] == true ) &#123;
        $type = &#39;video&#39;;
    &#125; else &#123;
        $type = &#39;image&#39;;
    &#125;</code></pre>
<p>旧的文件是：</p>
<pre><code>if ( $image[&#39;is_video&#39;] == true ) &#123;
        $type = &#39;video&#39;;
    &#125; else &#123;
        $type = &#39;image&#39;;
    &#125;</code></pre>
<hr>
<p>新的文件有个地方是：</p>
<pre><code>if ( ! empty( $instagram ) ) &#123;
        $instagram = base64_encode( serialize( $instagram ) );
        set_transient( &#39;av_insta2-&#39; . $transient_prefix . &#39;-&#39; . sanitize_title_with_dashes( $username ), $instagram, apply_filters( &#39;null_instagram_cache_time&#39;, HOUR_IN_SECONDS * 2 ) );
    &#125;</code></pre>
<p>旧的文件是：</p>
<pre><code>if ( ! empty( $instagram ) ) &#123;
        $instagram = base64_encode( serialize( $instagram ) );
        set_transient( &#39;av_insta1-&#39;.sanitize_title_with_dashes( $username ), $instagram, apply_filters( &#39;null_instagram_cache_time&#39;, HOUR_IN_SECONDS*2 ) );
    &#125;</code></pre>
<hr>
<p>新的文件有个是：</p>
<pre><code>extract($args, EXTR_SKIP);
if(empty($instance[&#39;url&#39;])) return;
$url        = $instance[&#39;url&#39;];
$title = empty($instance[&#39;title&#39;]) ? &#39;&#39; : apply_filters(&#39;widget_title&#39;, $instance[&#39;title&#39;]);
$height     = 151; 
$faces      = &quot;true&quot;;
$extraClass = &quot;&quot;;
$style      = &quot;&quot;;</code></pre>
<p>旧的文件是：</p>
<pre><code>extract($args, EXTR_SKIP);
if(empty($instance[&#39;url&#39;])) return;
$url         = $instance[&#39;url&#39;];
$title         = isset($instance[&#39;title&#39;]) ? $instance[&#39;title&#39;] : &quot;&quot;; 
$height     = 151; 
$faces         = &quot;true&quot;;
$extraClass = &quot;&quot;;
$style         = &quot;&quot;;</code></pre>
<hr>
<p>新文件有个是：</p>
<pre><code>if ( !empty( $title ) ) &#123; echo $before_title . $title . $after_title; &#125;;

echo &quot;&lt;div class=&#39;av_facebook_widget_wrap &#123;$extraClass&#125;&#39; &#123;$style&#125;&gt;&quot;;
echo &#39;&lt;div class=&quot;fb-page&quot; data-width=&quot;500&quot; data-href=&quot;&#39;.$url.&#39;&quot; data-small-header=&quot;false&quot; data-adapt-container-width=&quot;true&quot; data-hide-cover=&quot;false&quot; data-show-facepile=&quot;true&quot; data-show-posts=&quot;false&quot;&gt;&lt;div class=&quot;fb-xfbml-parse-ignore&quot;&gt;&lt;/div&gt;&lt;/div&gt;&#39;;
echo &quot;&lt;/div&gt;&quot;;
echo $after_widget;
add_action(&#39;wp_footer&#39;, array( $this,&#39;fb_js&#39; ));</code></pre>
<p>旧文件是：</p>
<pre><code>if ( !empty( $title ) ) &#123; echo $before_title . $title . $after_title; &#125;;

echo &quot;&lt;div class=&#39;av_facebook_widget_wrap &#123;$extraClass&#125;&#39; &#123;$style&#125;&gt;&quot;;
echo &#39;&lt;div class=&quot;fb-page&quot; data-href=&quot;&#39;.$url.&#39;&quot; data-small-header=&quot;false&quot; data-adapt-container-width=&quot;true&quot; data-hide-cover=&quot;false&quot; data-show-facepile=&quot;true&quot; data-show-posts=&quot;false&quot;&gt;&lt;div class=&quot;fb-xfbml-parse-ignore&quot;&gt;&lt;/div&gt;&lt;/div&gt;&#39;;
echo &quot;&lt;/div&gt;&quot;;
echo $after_widget;
add_action(&#39;wp_footer&#39;, array( $this,&#39;fb_js&#39; ));</code></pre>
<hr>
<p>新文件有个是：</p>
<pre><code>js.src = &quot;//connect.facebook.net/&#39;. $langcode .&#39;/sdk.js#xfbml=1&amp;version=v2.7&quot;;</code></pre>
<p>旧文件是：</p>
<pre><code>js.src = &quot;//connect.facebook.net/&#39;. $langcode .&#39;/sdk.js#xfbml=1&amp;version=v2.4&quot;;</code></pre>
<hr>
<p>新的文件有个是：</p>
<pre><code>if(apply_filters(&#39;avia_google_maps_widget_load_api&#39;, true, $avia_config[&#39;g_maps_widget_active&#39;]))
&#123;   
    $api_key = avia_get_option(&#39;gmap_api&#39;);
    $api_url = av_google_maps::api_url( $api_key );

    wp_register_script( &#39;avia-google-maps-api&#39;, $api_url, array(&#39;jquery&#39;), NULL, true);
    wp_enqueue_script( &#39;avia-google-maps-api&#39; );
&#125;</code></pre>
<p>旧的文件是：</p>
<pre><code>if(apply_filters(&#39;avia_google_maps_widget_load_api&#39;, true, $avia_config[&#39;g_maps_widget_active&#39;]))
&#123;
    wp_register_script( &#39;avia-google-maps-api&#39;, $prefix.&#39;://maps.googleapis.com/maps/api/js?v=3.exp&#39;, array(&#39;jquery&#39;), &#39;1&#39;, false);
    wp_enqueue_script( &#39;avia-google-maps-api&#39; );
&#125;</code></pre>
<p>更新一下，虽然把这个文件替换了，但是引起了另外一个问题，就是后台进不去了，访问/wp-admin的时候，一篇空白。</p>
<p>后来根据排查，发现还是这个文件引起的原因，这个时候，不得不把旧的文件恢复，然后把新添加的这个重命名了一下，然后在本地打开这两个文件，逐一对比，后来发现问题的所在：</p>
<p>引起后来进不去的原因在于：</p>
<pre><code>    function helper_print_google_maps_scripts()
    &#123;

        $api_key = avia_get_option(&#39;gmap_api&#39;);
        $api_url = av_google_maps::api_url( $api_key );

        wp_register_script( &#39;avia-google-maps-api&#39;, $api_url, array(&#39;jquery&#39;), NULL, true);

        $load_google_map_api = apply_filters(&#39;avf_load_google_map_api&#39;, true, &#39;avia_google_map_widget&#39;);

        if($load_google_map_api) wp_enqueue_script( &#39;avia-google-maps-api&#39; );

        $is_widget_edit_page = in_array(basename($_SERVER[&#39;PHP_SELF&#39;]), array(&#39;widgets.php&#39;));
        if($is_widget_edit_page)
        &#123;
            wp_register_script( &#39;avia-google-maps-widget&#39;, AVIA_JS_URL.&#39;conditional_load/avia_google_maps_widget.js&#39;, array( &#39;jquery&#39;,&#39;media-upload&#39;,&#39;media-views&#39; ), &#39;1.0.0&#39;, true);
            wp_enqueue_script( &#39;avia-google-maps-widget&#39; );

            $args = array(
                &#39;toomanyrequests&#39;   =&gt; __(&quot;Too many requests at once, please refresh the page to complete geocoding&quot;,&#39;avia_framework&#39;),
                &#39;latitude&#39;          =&gt; __(&quot;Latitude and longitude for&quot;,&#39;avia_framework&#39;),
                &#39;notfound&#39;          =&gt; __(&quot;couldn&#39;t be found by Google, please add them manually&quot;,&#39;avia_framework&#39;),
                &#39;insertaddress&#39;     =&gt; __(&quot;Please insert a valid address in the fields above&quot;,&#39;avia_framework&#39;)
            );

            if($load_google_map_api) wp_localize_script( &#39;avia-google-maps-api&#39;, &#39;AviaMapTranslation&#39;, $args );
        &#125;
    &#125;</code></pre>
<p>这个截代码是在新添加的那个里面，原始的那个是：</p>
<pre><code>    function helper_print_google_maps_scripts()
    &#123;
        $prefix  = is_ssl() ? &quot;https&quot; : &quot;http&quot;;
        $api_key = avia_get_option(&#39;gmap_api&#39;);
        $api_url = $prefix.&#39;://maps.google.com/maps/api/js?v=3.27&#39;;

        if($api_key != &quot;&quot;)&#123;
           $api_url .= &quot;&amp;key=&quot; .$api_key;
        &#125;

        wp_register_script( &#39;avia-google-maps-api&#39;, $api_url, array(&#39;jquery&#39;), NULL, true);


        $load_google_map_api = apply_filters(&#39;avf_load_google_map_api&#39;, true, &#39;avia_google_map_widget&#39;);

        if($load_google_map_api) wp_enqueue_script( &#39;avia-google-maps-api&#39; );

        $is_widget_edit_page = in_array(basename($_SERVER[&#39;PHP_SELF&#39;]), array(&#39;widgets.php&#39;));
        if($is_widget_edit_page)
        &#123;
            wp_register_script( &#39;avia-google-maps-widget&#39;, AVIA_JS_URL.&#39;conditional_load/avia_google_maps_widget.js&#39;, array( &#39;jquery&#39;,&#39;media-upload&#39;,&#39;media-views&#39; ), &#39;1.0.0&#39;, true);
            wp_enqueue_script( &#39;avia-google-maps-widget&#39; );

            $args = array(
                &#39;toomanyrequests&#39;    =&gt; __(&quot;Too many requests at once, please refresh the page to complete geocoding&quot;,&#39;avia_framework&#39;),
                &#39;latitude&#39;            =&gt; __(&quot;Latitude and longitude for&quot;,&#39;avia_framework&#39;),
                &#39;notfound&#39;            =&gt; __(&quot;couldn&#39;t be found by Google, please add them manually&quot;,&#39;avia_framework&#39;),
                &#39;insertaddress&#39;     =&gt; __(&quot;Please insert a valid address in the fields above&quot;,&#39;avia_framework&#39;)
            );

            if($load_google_map_api) wp_localize_script( &#39;avia-google-maps-api&#39;, &#39;AviaMapTranslation&#39;, $args );
        &#125;
    &#125;</code></pre>
<p>我在逐一覆盖的时候，当覆盖到这里的时候，刷新后台，发现打不开了，于是这个就没有被替换。</p>
<p>可是前台的instagram小工具还是显示不出内容来。于是我继续往下对比，发现当把新文件的这个：</p>
<pre><code>if ( isset( $insta_array[&#39;entry_data&#39;][&#39;ProfilePage&#39;][0][&#39;graphql&#39;][&#39;user&#39;][&#39;edge_owner_to_timeline_media&#39;][&#39;edges&#39;] ) ) &#123;
    $images = $insta_array[&#39;entry_data&#39;][&#39;ProfilePage&#39;][0][&#39;graphql&#39;][&#39;user&#39;][&#39;edge_owner_to_timeline_media&#39;][&#39;edges&#39;];
&#125; else &#123;
    return new WP_Error( &#39;bad_json_2&#39;, __( &#39;Instagram has returned invalid data.&#39;, &#39;avia_framework&#39; ) );
&#125;</code></pre>
<p>覆盖原始文件的：</p>
<pre><code>if ( isset( $insta_array[&#39;entry_data&#39;][&#39;ProfilePage&#39;][0][&#39;user&#39;][&#39;media&#39;][&#39;nodes&#39;] ) ) &#123;
$images = $insta_array[&#39;entry_data&#39;][&#39;ProfilePage&#39;][0][&#39;user&#39;][&#39;media&#39;][&#39;nodes&#39;];
&#125; else &#123;
return new WP_Error( &#39;bad_json_2&#39;, __( &#39;Instagram has returned invalid data.&#39;, &#39;avia_framework&#39; ) );
&#125;</code></pre>
<p>的时候，发现前台也能够显示Instagram的内容了，于是大功告成。</p>
<p>从这里我们可以发现其实我们也可以快速定位的：直接在前台报错的语句：</p>
<blockquote>
<p>Instagram has returned invalid data</p>
</blockquote>
<p>就可以找到问题根源了。</p>
<p>总体就是这些差异，这些对比很显然已经超出了这篇文章的写作初衷，但是希望给大家一个启发，就是如果需要文件覆盖的时候，我们不妨这样想：把这两个文件进行对比，发现差异，然后剖析差异，最后找出造成的原因。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://helongquan.github.io/2018/04/11/%E8%A7%A3%E5%86%B3wordpress%E5%85%88%E5%BC%B9%E5%87%BA%E8%81%94%E7%B3%BB%E8%A1%A8%E5%8D%95%E5%BC%B9%E7%AA%97%E5%90%8E%E8%AE%BF%E9%97%AE%E8%B5%84%E6%BA%90%E7%9A%84%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="泉哥">
      <meta itemprop="description" content="日记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鸢尾花序">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/04/11/%E8%A7%A3%E5%86%B3wordpress%E5%85%88%E5%BC%B9%E5%87%BA%E8%81%94%E7%B3%BB%E8%A1%A8%E5%8D%95%E5%BC%B9%E7%AA%97%E5%90%8E%E8%AE%BF%E9%97%AE%E8%B5%84%E6%BA%90%E7%9A%84%E9%97%AE%E9%A2%98/" class="post-title-link" itemprop="url">采用popup maker插件解决wordpress先弹出联系表单弹窗后访问资源的问题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-04-11 16:27:08" itemprop="dateCreated datePublished" datetime="2018-04-11T16:27:08+08:00">2018-04-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 11:53:00" itemprop="dateModified" datetime="2020-10-11T11:53:00+08:00">2020-10-11</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>前一阵子，有个客户需要一个这样的需求，想让别人访问自己的下载中心或者是某个页面先发送电邮后才能访问资源或者是下载资源，并且再次访问后不能经常性的弹出窗口让填电邮。</p>
<p>笔者在这里分解了下这个问题：</p>
<ol>
<li>弹窗</li>
<li>联系表单</li>
<li>会话控制（session或者是cookie）</li>
<li>支持全局控制和局部控制（可以访问网站的任意页面或者文章都会弹出窗口，也可以让指定的页面或者文章弹出窗口）。</li>
<li>必须要填写电邮才能访问，不填写的话打死都不让访问，而且刷新也没有，还得显示窗口。</li>
<li>联系表单填写完毕后重定向到某个地方或者当前页面</li>
</ol>
<p>分解后，我想到的好几种方案都感觉不太合适，或者说是不够完美，因为下载中心有很多个资源，如果下载每个资源都弹出一个窗口的话，我估计用户会疯了的。</p>
<p>然后采用wordpress的模板文件，笔者曾经采取的是新建一个模板文件，然后针对下载中心进行个性化开发。采用session，这个倒是没问题，联系表单这个问题也不大，可以采用脚本的形式，不需要经过数据库。至于弹窗嘛，也可以采用js的方式实现，但是要做到能够指定某些页面可以弹出窗口，或者全部窗口都弹出，这个工作量以及维护难度还是有的。</p>
<p>还有就是，必须要填写电邮才能访问，不填写不能访问，这个也是一个棘手的问题，资深人士除外，因此，从成本的角度考虑，因为这个是个例，需求不普遍，实现起来没有太大的价值，因此摒弃了这种方式。</p>
<p>下面我们进入重点，笔者这里采取的是插件的方式：<a target="_blank" rel="noopener" href="https://wordpress.org/plugins/popup-maker/">popup maker</a></p>
<p>通过对这个插件的了解，几乎是全是为这个需求量身定做的。先去安装吧，安装完成后，我们会看到：</p>
<p><img src="https://i.imgur.com/MZbLPyJ.jpg"></p>
<p>已经有了Popup Maker这个选项了，我们进入到里面，新建一个：</p>
<p><img src="https://i.imgur.com/EH6gMRL.jpg"></p>
<p>接着往下，我们会看到有个设置的地方，这个是针对我们新建的这个弹窗的一些行为和显示方式：</p>
<p><img src="https://i.imgur.com/kPBqiMM.jpg"></p>
<p>这个写得很清楚，左边有（triggers触发器，Targeting目标，Display显示方式，close弹窗关闭方式），右边就是相关的设置项。</p>
<p>如果不想让弹窗每次都弹出，这个需要设置cookie，这个cookie是跟某个触发器结合的，以上截图的那个是点击打开的时候有cookie，比如以下这个：</p>
<p><img src="https://i.imgur.com/RyTOez0.jpg"></p>
<p>这个是自动弹出窗口，比如我们在访问下载中心的时候，1000ms后弹出一个联系表单，不填写表单天王老子都不让访问，绑定的事件是下面的那个框中的，这个可以根据自己的需要进行设置。我做一个简单的解说，这里就是（弹窗关闭、表单发送成功或者表单已经提交过）后启用cookie，如果再次访问的时候，就不需要再次弹出窗口了。这里也有一个时效性性，这里默认是一个月，如果一个月以后再来访问，又会弹出一个窗口要你填写联系表单里的信息，当然这个可以根据自己的需求进行设定。</p>
<p>好的，针对支持全局控制和局部控制（可以访问网站的任意页面或者文章都会弹出窗口，也可以让指定的页面或者文章弹出窗口）这个问题，直接在Display那里设定就好了。当我们完成这些设置后，我们如何运用呢？</p>
<p>我们新建一个页面，然后来到添加文本那里：</p>
<p><img src="https://i.imgur.com/9I1pX7V.jpg"></p>
<p>这里就是添加一个文本编辑，然后我们看到：</p>
<p><img src="https://i.imgur.com/i1n3FxC.jpg"></p>
<p>然后添加一个Subscription Form表单，这个就是所说的联系表单了。是这个插件内置的，貌似不能添加更多的字段。</p>
<p><img src="https://i.imgur.com/OnNqajH.jpg"></p>
<p>然后进入这里，对这个进行设定。这里里面可以进行一些设定包括电邮发送后的重定向和，表单的样式，以及弹窗等问题。</p>
<p>如果是添加Popup Trigger的时候，这里就是添加我们新建的那些popup，或者是自定义的，来张截图吧：</p>
<p><img src="https://i.imgur.com/Hdl6Qw2.jpg"></p>
<p>看到了吧，这个就是说在新建的页面中我们，我们就可以调用新建的弹窗。至于弹窗的行为以及cookie不是在这里设置的，而是在创建弹窗的那里设置的。</p>
<p>具体的其他知识可以去官网了解。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://helongquan.github.io/2018/03/30/wordpress%E7%9A%84woocommerce%E7%9A%84%E8%B4%AD%E7%89%A9%E8%BD%A6%E8%B7%9F%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C%E6%94%BE%E5%9C%A8%E4%B8%80%E8%B5%B7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="泉哥">
      <meta itemprop="description" content="日记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鸢尾花序">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/03/30/wordpress%E7%9A%84woocommerce%E7%9A%84%E8%B4%AD%E7%89%A9%E8%BD%A6%E8%B7%9F%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C%E6%94%BE%E5%9C%A8%E4%B8%80%E8%B5%B7/" class="post-title-link" itemprop="url">wordpress的woocommerce的购物车跟登录注册放在一起</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-03-30 12:09:12" itemprop="dateCreated datePublished" datetime="2018-03-30T12:09:12+08:00">2018-03-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 11:53:13" itemprop="dateModified" datetime="2020-10-11T11:53:13+08:00">2020-10-11</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>一个客户需求：把购物车的icon跟wordpress的用户登录注册按钮放在同一排，这个其实前面写过类似的教程，感觉有很多bug，但是值得参考。今天这里再次出发，把这个进一步的深化了一下。</p>
<p>看下做好后的效果：</p>
<p><img src="https://i.imgur.com/gQU0i7F.jpg"></p>
<p>这个怎么办呢？</p>
<p>材料：wordpress、woocommerce、enfold主题</p>
<p>先找到控制购物车显示的地方的文件：<code>enfold/config-woocommerce/config.php</code></p>
<p>大概在1815行的位置，这个位置具体看主题，我们就可以看到woocommerce的logo的显示位置了，找到这个函数<code>avia_woocommerce_cart_dropdown</code>：</p>
<pre><code>function avia_woocommerce_cart_dropdown()
&#123;
    global $woocommerce, $avia_config;
    $cart_subtotal = $woocommerce-&gt;cart-&gt;get_cart_subtotal();
    $link = $woocommerce-&gt;cart-&gt;get_cart_url();
    $id = &quot;&quot;;
    $added = wc_get_notices(&#39;success&#39;);
    $trigger = !empty($added) ? &quot;av-display-cart-on-load&quot; : &quot;&quot;;

    if(avia_get_option(&#39;cart_icon&#39;) == &quot;always_display_menu&quot;)
    &#123;
        $id = &#39;id=&quot;menu-item-shop&quot;&#39;;
    &#125;    

    $output = &quot;&quot;;
    $output .= &quot;&lt;ul &#123;$id&#125; class = &#39;cart_dropdown &#123;$trigger&#125;&#39; data-success=&#39;&quot;.__(&#39;was added to the cart&#39;, &#39;avia_framework&#39;).&quot;&#39;&gt;&lt;li class=&#39;cart_dropdown_first noprint&#39;&gt;&quot;;
    $output .= &quot;&lt;a class=&#39;cart_dropdown_link&#39; href=&#39;&quot;.$link.&quot;&#39;&gt;&lt;span &quot;.av_icon_string(&#39;cart&#39;).&quot;&gt;&lt;/span&gt;&lt;span class=&#39;av-cart-counter&#39;&gt;0&lt;/span&gt;&lt;span class=&#39;avia_hidden_link_text&#39;&gt;&quot;.__(&#39;Shopping Cart&#39;,&#39;avia_framework&#39;).&quot;&lt;/span&gt;&lt;/a&gt;&lt;!--&lt;span class=&#39;cart_subtotal&#39;&gt;&quot;.$cart_subtotal.&quot;&lt;/span&gt;--&gt;&quot;;
    $output .= &quot;&lt;div class=&#39;dropdown_widget dropdown_widget_cart&#39;&gt;&lt;div class=&#39;avia-arrow&#39;&gt;&lt;/div&gt;&quot;;
    $output .= &#39;&lt;div class=&quot;widget_shopping_cart_content&quot;&gt;&lt;/div&gt;&#39;;
    $output .= &quot;&lt;/div&gt;&quot;;
    $output .= &quot;&lt;/li&gt;&lt;/ul&gt;&quot;;


    echo $output;

&#125;</code></pre>
<p>这个就是控制wooocommerce安装后logo显示在主题上的位置.</p>
<p>这个时候我们只需要把用户注册登录的代码加入进去即可，用户登录注册的代码如下：</p>
<pre><code>&lt;div class=&quot;wemng&quot;&gt;
    &lt;?php if ( is_user_logged_in() ) &#123; ?&gt;
    &lt;?php
    $current_user = wp_get_current_user();
    ?&gt;
    &lt;span&gt;
    &lt;a href=&quot;&lt;?php echo wp_logout_url(); ?&gt;&quot;&gt;&lt;i class=&quot;fa fa-sign-out&quot;&gt;&lt;/i&gt;Log out&lt;/a&gt;&lt;/span&gt;
    &lt;?php &#125; else &#123; ?&gt;
    &lt;span&gt;&lt;a href=&quot;/wp-login.php&quot; title=&quot;Members Area Login&quot; rel=&quot;home&quot;&gt;&lt;i class=&quot;fa fa-user&quot;&gt;&lt;/i&gt;Sign in&lt;/a&gt;&lt;/span&gt;
    &lt;?php &#125; ?&gt;
&lt;/div&gt;</code></pre>
<p>最后，加入完成的代码如下：</p>
<pre><code>function avia_woocommerce_cart_dropdown()
&#123;
    global $woocommerce, $avia_config;
    $cart_subtotal = $woocommerce-&gt;cart-&gt;get_cart_subtotal();
    $link = $woocommerce-&gt;cart-&gt;get_cart_url();
    $id = &quot;&quot;;
    $added = wc_get_notices(&#39;success&#39;);
    $trigger = !empty($added) ? &quot;av-display-cart-on-load&quot; : &quot;&quot;;

    if(avia_get_option(&#39;cart_icon&#39;) == &quot;always_display_menu&quot;)
    &#123;
        $id = &#39;id=&quot;menu-item-shop&quot;&#39;;
    &#125;    

    $output = &quot;&quot;;

    ?&gt;

            &lt;?php if ( is_user_logged_in() ) &#123; ?&gt;
            &lt;?php
            $current_user = wp_get_current_user();
            ?&gt;
    &lt;?php
    $output .=&quot;&lt;div class=&#39;gouwuchedabao&#39;&gt;&lt;div class=&#39;ttre&#39;&gt;&lt;span class=&#39;logouts&#39;&gt;&lt;a href=&#39;/wp-login.php?action=logout&#39;&gt;&quot;;
    ?&gt;
    &lt;?php
    $output .=&quot;&lt;i class=&#39;fa fa-sign-out&#39; style=&#39;display: none&#39;&gt;&lt;/i&gt;Log out&lt;/a&gt;&lt;/span&gt;&lt;/div&gt;&quot;;
    ?&gt;
            &lt;?php &#125; else &#123; ?&gt;
    &lt;?php
    $output .=&quot;&lt;div class=&#39;gouwuchedabao&#39;&gt;&lt;div class=&#39;ttre&#39;&gt;&lt;span class=&#39;logouts&#39;&gt;&lt;a href=&#39;/wp-login.php&#39; title=&#39;Members Area Login&#39; rel=&#39;home&#39;&gt;&lt;i class=&#39;fa fa-user&#39; style=&#39;display: none&#39;&gt;&lt;/i&gt;Sign in&lt;/a&gt;&lt;/span&gt;&lt;/div&gt;&quot;;
    ?&gt;
            &lt;?php &#125; ?&gt;

    &lt;?php

    $output .= &quot;&lt;ul &#123;$id&#125; class = &#39;cart_dropdown &#123;$trigger&#125; mbp&#39; data-success=&#39;&quot;.__(&#39;was added to the cart&#39;, &#39;avia_framework&#39;).&quot;&#39;&gt;&lt;li class=&#39;cart_dropdown_first&#39;&gt;&quot;;
    $output .= &quot;&lt;a class=&#39;cart_dropdown_link&#39; href=&#39;&quot;.$link.&quot;&#39;&gt;&lt;span &quot;.av_icon_string(&#39;cart&#39;).&quot; class=&#39;gouwuche&#39;&gt;&quot;;

    $output .=&quot;&lt;img class=&#39;noctitopimg&#39; src=&#39;http://toq.nocticlub.com/wp-content/themes/nocti/images/cart.png&#39;&gt;&lt;i class=&#39;fa fa-shopping-cart &#39; style=&#39;display:none&#39;&gt;&lt;/i&gt; Bag&lt;/span&gt;&lt;span class=&#39;av-cart-counter&#39;&gt;0&lt;/span&gt;&lt;span class=&#39;avia_hidden_link_text&#39;&gt;&quot;.__(&#39;Shopping Cart&#39;,&#39;avia_framework&#39;).&quot;&lt;/span&gt;&lt;/a&gt;&lt;!--&lt;span class=&#39;cart_subtotal&#39;&gt;&quot;.$cart_subtotal.&quot;&lt;/span&gt;--&gt;&quot;;
    $output .= &quot;&lt;div class=&#39;dropdown_widget dropdown_widget_cart&#39;&gt;&lt;div class=&#39;avia-arrow&#39;&gt;&lt;/div&gt;&quot;;
    $output .= &#39;&lt;div class=&quot;widget_shopping_cart_content&quot;&gt;&lt;/div&gt;&#39;;
    $output .= &quot;&lt;/div&gt;&quot;;
    $output .= &quot;&lt;/li&gt;&lt;/ul&gt;&lt;/div&gt;&quot;;


    echo $output;

&#125;</code></pre>
<p>相应的css代码如下：</p>
<pre><code>.gouwuche:before&#123;
content:&quot;&quot;;
display:none !important;
&#125;
.gouwuche img&#123;
    width: 19px;
    height: 19px;
    display: inline-block;
    margin-bottom: -2px;
&#125;
.phone-info .alignlefts a &#123;
    padding: 0px 0px 0px 10px;
    color: #4fc4d3 !important;
&#125;
.phone-info span&#123;
    line-height: 7px !important;
&#125;
.phone-info&gt;.wemng&gt;span&#123;
    border: 1px solid #ccc;
    padding: 7px 8px;
    margin: 0px 0px;
    border-radius: 0px;
&#125;
#header_meta .container &#123;
    max-width: 100% !important;
&#125;
.mbp&#123;
    right: -60px;
    width: 90px !important;
    line-height: 24px;
&#125;
.ttre&#123;
    position: absolute;
    right: 100px;
    top: -30px;
&#125;
.cart_dropdown &#123;
    border-width: 0px !important;
&#125;
.gouwuchedabao&#123;
    position: relative;
    top: 50px;
&#125;
.noctitopimg&#123;
width:20px !important;
&#125;
.mbp .cart_dropdown_link&#123;
    font-size:12px !important;
    background: transparent;
&#125;

@media (max-width:767px)&#123;

.demgn_img img &#123;
    margin: 20px auto 0px auto !important;
&#125;
.last_footer, .conetlist &#123;
    text-align: center;
    font-size: 13px;
    margin: 25px auto 0px auto;
    word-break: break-word;
    word-wrap: break-word;
&#125;
.pprm &#123;
    padding: 0px 10px !important;
&#125;

.phone-info&#123;
text-align:left !important;
&#125;
.ttre &#123;
    position: absolute;
    right: 7px;
    top: -50px;
    z-index:999;
&#125;
&#125;</code></pre>
<p>可能还不完善，css具体的样式根据自己的需求自己调试，功能上的问题基本搞定。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://helongquan.github.io/2018/03/29/wordpress%E4%BD%BF%E7%94%A8session%E7%9A%84%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="泉哥">
      <meta itemprop="description" content="日记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鸢尾花序">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/03/29/wordpress%E4%BD%BF%E7%94%A8session%E7%9A%84%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">wordpress使用session的笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-03-29 16:00:00" itemprop="dateCreated datePublished" datetime="2018-03-29T16:00:00+08:00">2018-03-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 11:53:14" itemprop="dateModified" datetime="2020-10-11T11:53:14+08:00">2020-10-11</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>来一场头脑风暴吧，wordpress的用户是否登录的判断：</p>
<p><strong>判断用户是否登录：</strong></p>
<pre><code>&lt;?php  
$current_user = wp_get_current_user();  
if ( 0 == $current_user-&gt;ID ) &#123;  
// Not logged in.  
&#125; else &#123;  
// Logged in.  
&#125;  
?&gt;</code></pre>
<p>判断用户是否登录，如果登录了就显示登录的部分，如果没有就显示没有登录的信息。</p>
<hr>
<p><strong>通过session控制登录密码输入错误的次数，超出次数就跳转到空白页面，相关代码：</strong></p>
<pre><code>define(&#39;count_num&#39;,&#39;4&#39;);//访问最大次数
define(&#39;count_time&#39;,&#39;3600&#39;);//访问最大时间
session_start();//开启session
$now_time = time();
//判断session存在，赋值
if ($_SESSION)&#123;
 $last_time = $_SESSION[&#39;last_time&#39;];
 $times = $_SESSION[&#39;times&#39;] + 1;
 $_SESSION[&#39;times&#39;] = $times;
&#125;else&#123;
 $last_time = $now_time;
 $times = 1;
 $_SESSION[&#39;times&#39;] = $times;
 $_SESSION[&#39;last_time&#39;] = $last_time;
&#125;
//开始时间判断，如果超过时间次数，则退出程序
if(($now_time - $last_time) &lt; count_time)&#123; if ($times&gt;=count_num)&#123;
exit;
&#125;
&#125;else&#123;
 $times = 0;
 $_SESSION[&#39;last_time&#39;] = $now_time;
 $_SESSION[&#39;times&#39;] = $times;
&#125;</code></pre>
<p>把这个代码放入wp-login.php的顶部即可完成一个针对wordpress的后台登录账号密码输入错误的次数限制。</p>
<hr>
<p>后面会继续补充</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://helongquan.github.io/2018/03/28/%E8%BE%93%E5%87%BAwordpress%E4%B8%AD%E7%9A%84woocommerce%E7%9A%84%E7%BB%93%E7%AE%97%E9%A1%B5%E9%9D%A2%E7%9A%84%E4%B8%AA%E4%BA%BA%E4%BF%A1%E6%81%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="泉哥">
      <meta itemprop="description" content="日记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鸢尾花序">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/03/28/%E8%BE%93%E5%87%BAwordpress%E4%B8%AD%E7%9A%84woocommerce%E7%9A%84%E7%BB%93%E7%AE%97%E9%A1%B5%E9%9D%A2%E7%9A%84%E4%B8%AA%E4%BA%BA%E4%BF%A1%E6%81%AF/" class="post-title-link" itemprop="url">输出wordpress中的woocommerce的结算页面的个人信息</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-03-28 18:05:02" itemprop="dateCreated datePublished" datetime="2018-03-28T18:05:02+08:00">2018-03-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 11:52:56" itemprop="dateModified" datetime="2020-10-11T11:52:56+08:00">2020-10-11</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>情况是这样的，我的一个客户需要在woocommmerce的结算页面成交后的thankyou.php页面生成PI表单，大家不用管这个PI表单是个什么鬼。先来个截图：</p>
<p><img src="https://i.imgur.com/fAzRkZX.png"></p>
<p>根据截图，可以看到，里面有商家设定好的信息，也有网站用户的信息，而网站用户的信息不是一成不变的，而是不同用户填写的信息是不一样的。</p>
<p>这里不得不说笔者当初的一个愚蠢的想法，最开始我是直接通过在functions.php中添加自定义个人的信息，比如：</p>
<pre><code>add_filter( &#39;user_contactmethods&#39;, &#39;wpdaxue_add_contact_fields&#39; );
function wpdaxue_add_contact_fields( $contactmethods ) &#123;
    $contactmethods[&#39;yingyezhucehao&#39;] = &#39;营业注册号&#39;;
    $contactmethods[&#39;fapiaodizhi&#39;] = &#39;发票地址&#39;;
    $contactmethods[&#39;dianhuahaoma&#39;] = &#39;电话号码&#39;;
    $contactmethods[&#39;personalfacebook&#39;] = &#39;Facebook首页地址&#39;;
    $contactmethods[&#39;jinjilianxiren&#39;] = &#39;紧急联系人&#39;;
    $contactmethods[&#39;jinjidianhua&#39;] = &#39;紧急联系人电话&#39;;
    $contactmethods[&#39;yingyezhucehao&#39;] = &#39;营业注册号&#39;;
    $contactmethods[&#39;companyname&#39;] = &#39;Company Name&#39;;
    $contactmethods[&#39;building&#39;] = &#39;Building/House Number&#39;;
    $contactmethods[&#39;street&#39;] = &#39;Street&#39;;
    $contactmethods[&#39;city&#39;] = &#39;Town/City&#39;;
    $contactmethods[&#39;province&#39;] = &#39;County/Province&#39;;
    $contactmethods[&#39;state&#39;] = &#39;State/Province&#39;;
    $contactmethods[&#39;postal_code&#39;] = &#39;ZIP/Postal Code&#39;;
    $contactmethods[&#39;telephone&#39;] = &#39;Tel.&#39;;
    $contactmethods[&#39;whatsapp&#39;] = &#39;Whatsapp&#39;;
    $contactmethods[&#39;skype&#39;] = &#39;Skype&#39;;
    $contactmethods[&#39;email&#39;] = &#39;E-mail&#39;;
    $contactmethods[&#39;website&#39;] = &#39;Website&#39;;
    $contactmethods[&#39;contacter&#39;] = &#39;Person/Department to contact&#39;;
    $contactmethods[&#39;contacter_tel&#39;] = &#39;Contact Tel. Number&#39;;

    unset( $contactmethods[&#39;yim&#39;] );
    unset( $contactmethods[&#39;aim&#39;] );
    unset( $contactmethods[&#39;jabber&#39;] );
    return $contactmethods;
&#125;</code></pre>
<p>加了这个之后，我们就可以在网站的后台的个人资料里面添加我们自定义的信息了，然后可以通过获取这些信息的字段进行获取。</p>
<pre><code>&lt;?php global $current_user;
      echo &#39;Username: &#39; . $current_user-&gt;user_login . &quot;\n&quot;;
      echo &#39;User email: &#39; . $current_user-&gt;user_email . &quot;\n&quot;;
      echo &#39;User first name: &#39; . $current_user-&gt;user_firstname . &quot;\n&quot;;
      echo &#39;User last name: &#39; . $current_user-&gt;user_lastname . &quot;\n&quot;;
      echo &#39;User display name: &#39; . $current_user-&gt;display_name . &quot;\n&quot;;
      echo &#39;User ID: &#39; . $current_user-&gt;ID . &quot;\n&quot;;
      echo &#39;&lt;td&gt;Company Name:&#39; . $current_user-&gt;companyname . &#39;&lt;/td&gt;&#39;;
      echo &#39;&lt;td&gt;Add:&#39; . $current_user-&gt;building .&#39;&lt;/td&gt;&#39;;
?&gt;</code></pre>
<p>直接这样就可以把当前用户的信息进行打印输出。</p>
<p>可是这个是需要每个用户登录后，要逐个在自己的个人中心填写的，大家都知道不是每个人都有耐心和兴趣填写这些信息。而且很重要的地方在于，对于普通用户在woocommerce商城注册登录后是不能登录后台的，只能进入到商城的个人中心，在商城的控制台那里是没法添加这个信息的，所以如果我们尝试采用这个方式实现在woocommerce的结算页面输出用户的个人信息（公司名，地址，用户名，电邮，电话等等），将会犯下很严重的战略性错误。</p>
<p>因此，正确的做法应该是直接获取结算页面填写的信息，可是这个在数据库里面找不对应的字段存储，经过排查发现这个数据是保存在了json格式里。</p>
<p><img src="https://i.imgur.com/PO0cDPg.png"></p>
<p>在截图的红色框框中，让我找到了一线生机，就是下面的电话和电邮，这个电话和电邮恰恰是在结算页面填写的时候输入的，好了我们顺藤摸瓜，在<code>order-details-customer.php</code>页面中，它的路径：<code>enfold/woocommerce/order/</code></p>
<p>打开后我们找到控制这个红色框框的代码：</p>
<pre><code>&lt;address class=&quot;ncoti_add&quot;&gt;
    &lt;?php echo ( $address = $order-&gt;get_formatted_billing_address() ) ? $address : __( &#39;N/A&#39;, &#39;&lt;span&gt;woocommerce&lt;/span&gt;&#39; ); ?&gt;
    &lt;div class=&quot;wwet&quot;&gt;
        &lt;?php if ( $order-&gt;get_billing_phone() ) : ?&gt;
            &lt;p class=&quot;woocommerce-customer-details--phone&quot;&gt;&lt;i class=&quot;fa fa-phone&quot;&gt;&lt;/i&gt; &lt;?php echo esc_html( $order-&gt;get_billing_phone() ); ?&gt;&lt;/p&gt;
        &lt;?php endif; ?&gt;
        &lt;?php if ( $order-&gt;get_billing_email() ) : ?&gt;
            &lt;p class=&quot;woocommerce-customer-details--email&quot;&gt;&lt;i class=&quot;fa fa-envelope&quot;&gt;&lt;/i&gt; &lt;?php echo esc_html( $order-&gt;get_billing_email() ); ?&gt;&lt;/p&gt;
        &lt;?php endif; ?&gt;
    &lt;/div&gt;
&lt;/address&gt;</code></pre>
<p>里面有两个是用来显示电邮和电话的。</p>
<pre><code>&lt;?php echo esc_html( $order-&gt;get_billing_phone() ); ?&gt;   //输出账单的电话

&lt;?php echo esc_html( $order-&gt;get_billing_email() ); ?&gt;   //输出账单中的电邮</code></pre>
<p>所以这个时候，我们只需要把这两个代码放在我么需要输出的地方就行了。同样的我要输出结算页面中的地址和公司名称和用户名称的代码如下：</p>
<pre><code>&lt;?php echo esc_html( $order-&gt;get_billing_company() ); ?&gt;   //当前用户的公司名称
&lt;?php echo esc_html( $order-&gt;get_billing_address_1() ); ?&gt;   //当前用户在结算页面填写第一送货地址
&lt;?php echo esc_html( $order-&gt;get_billing_address_2() ); ?&gt;   //当前用户在结算页面填写第二送货地址，也就是备选地址
$current_user-&gt;display_name   //当前用户逇姓名，这个当然还可以根据上面的写法来</code></pre>
<p>这里我贴一点我弄个的一个：</p>
<pre><code>&lt;?php 
    echo &quot;&lt;table&gt;&quot;;
    echo &quot;&lt;tr class=&#39;nopaddings&#39;&gt;&quot;;
    echo &#39;&lt;td&gt;&lt;h3&gt;To&lt;/h3&gt;&lt;/td&gt;&#39;;
    echo &quot;&lt;/tr&gt;&quot;;
    echo &quot;&lt;tr&gt;&quot;;
    echo &#39;&lt;td&gt;To:&#39; . $current_user-&gt;display_name . &#39;&lt;/td&gt;&#39;;
    echo &quot;&lt;/tr&gt;&quot;;
    echo &quot;&lt;tr&gt;&quot;;
        echo &#39;&lt;td&gt;Company Name:&#39;
        ?&gt;
    &lt;?php echo esc_html( $order-&gt;get_billing_company() ); ?&gt;
    &lt;?php echo &#39;&lt;/td&gt;&#39;;
        echo &quot;&lt;/tr&gt;&quot;;
        echo &quot;&lt;tr&gt;&quot;;
        echo &#39;&lt;td&gt;Add:&#39;
        ?&gt;
    &lt;?php echo esc_html( $order-&gt;get_billing_address_1() ); ?&gt;
    &lt;?php echo &#39;&lt;/td&gt;&#39;;
        echo &quot;&lt;/tr&gt;&quot;;
        echo &quot;&lt;tr&gt;&quot;;
        echo &#39;&lt;td&gt;E-mail:&#39;
        ?&gt;
        &lt;?php echo esc_html( $order-&gt;get_billing_email() ); ?&gt;
        &lt;?php echo &#39;&lt;/td&gt;&#39;;
        echo &quot;&lt;/tr&gt;&quot;;
        echo &quot;&lt;tr&gt;&quot;;
        echo &#39;&lt;td&gt;Tel:&#39;
        ?&gt;
    &lt;?php echo esc_html( $order-&gt;get_billing_phone() ); ?&gt;
        &lt;?php echo &#39;&lt;/td&gt;&#39;;
    echo &quot;&lt;/tr&gt;&quot;;
    echo &quot;&lt;/table&gt;&quot;;
 ?&gt;</code></pre>
<p>这里是以表格的方式输出。</p>
<p>这里我再列出结算页面的一些其他的把：</p>
<pre><code>&lt;?php echo esc_html( $order-&gt;get_billing_company() ); ?&gt;   //当前用户的公司名称
&lt;?php echo esc_html( $order-&gt;get_billing_address_1() ); ?&gt;   //当前用户在结算页面填写第一送货地址
&lt;?php echo esc_html( $order-&gt;get_billing_address_2() ); ?&gt;   //当前用户在结算页面填写第二送货地址，也就是备选地址
&lt;?php echo esc_html( $order-&gt;get_billing_city() ); ?&gt;   //账单地址的所在城市
&lt;?php echo esc_html( $order-&gt;get_billing_state() ); ?&gt;   //账单地址的所在州
&lt;?php echo esc_html( $order-&gt;get_billing_postcode() ); ?&gt;   //账单地址的所在邮编
&lt;?php echo esc_html( $order-&gt;get_billing_country() ); ?&gt;   //账单地址的所在国家
&lt;?php echo esc_html( $order-&gt;get_billing_first_name() ); ?&gt;   //账单地址的第一个名称
&lt;?php echo esc_html( $order-&gt;get_billing_last_name() ); ?&gt;   //账单用户名的第二个名称
&lt;?php echo esc_html( $order-&gt;get_billing_email() ); ?&gt;   //账单地址的电邮地址
&lt;?php echo esc_html( $order-&gt;get_billing_phone() ); ?&gt;   //手机号码</code></pre>
<p>是这个网址给了我的启发：<a target="_blank" rel="noopener" href="https://devework.com/woocommerce-custom-override-checkout-fields.html">https://devework.com/woocommerce-custom-override-checkout-fields.html</a></p>
<p>这里说一个很重要的思路：就是如果不知道这个怎么输出的或者是不知道这个怎么实现的，不妨就地取材，找到跟自己需求相似的代码，然后推而广之，去尝试。如果想要了解更多信息，可以去了解下关于woocommerce的api。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/22/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/22/">22</a><span class="page-number current">23</span><a class="page-number" href="/page/24/">24</a><span class="space">&hellip;</span><a class="page-number" href="/page/43/">43</a><a class="extend next" rel="next" href="/page/24/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">泉哥</p>
  <div class="site-description" itemprop="description">日记</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">424</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">25</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">400</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">泉哥</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"helongquan.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="日记">
<meta property="og:type" content="website">
<meta property="og:title" content="鸢尾花序">
<meta property="og:url" content="https://helongquan.github.io/page/12/index.html">
<meta property="og:site_name" content="鸢尾花序">
<meta property="og:description" content="日记">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="泉哥">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://helongquan.github.io/page/12/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>鸢尾花序</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">鸢尾花序</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-schedule">

    <a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>Schedule</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://helongquan.github.io/2018/09/07/magento1.x%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91%E4%B8%AD%E4%BD%BF%E7%94%A8jquery%E5%AE%9E%E7%8E%B0img%E7%9A%84data-src%E5%B1%9E%E6%80%A7%E8%BE%BE%E5%88%B0%E6%87%92%E5%8A%A0%E8%BD%BD%E7%9A%84%E7%9B%AE%E7%9A%84%EF%BC%8C%E4%BB%A5%E5%8F%8A%E5%9C%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A8%A1%E5%9D%97%E4%B8%AD%E5%8A%A0%E8%BD%BDjs%E7%9A%84%E5%90%84%E7%A7%8D%E6%96%B9%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="泉哥">
      <meta itemprop="description" content="日记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鸢尾花序">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/09/07/magento1.x%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91%E4%B8%AD%E4%BD%BF%E7%94%A8jquery%E5%AE%9E%E7%8E%B0img%E7%9A%84data-src%E5%B1%9E%E6%80%A7%E8%BE%BE%E5%88%B0%E6%87%92%E5%8A%A0%E8%BD%BD%E7%9A%84%E7%9B%AE%E7%9A%84%EF%BC%8C%E4%BB%A5%E5%8F%8A%E5%9C%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A8%A1%E5%9D%97%E4%B8%AD%E5%8A%A0%E8%BD%BDjs%E7%9A%84%E5%90%84%E7%A7%8D%E6%96%B9%E6%B3%95/" class="post-title-link" itemprop="url">magento1.x模块开发中使用jquery实现img的data-src属性达到懒加载的目的，以及在自定义模块中加载js的各种方法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-09-07 10:56:38" itemprop="dateCreated datePublished" datetime="2018-09-07T10:56:38+08:00">2018-09-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 11:57:59" itemprop="dateModified" datetime="2020-10-11T11:57:59+08:00">2020-10-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/magento1/" itemprop="url" rel="index"><span itemprop="name">magento1</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>笔者在完成一个：<a href="https://helongquan.github.io/2018/09/07/%E4%BD%BF%E7%94%A8jquery%E5%AE%9E%E7%8E%B0img%E7%9A%84data-src%E5%B1%9E%E6%80%A7%E8%BE%BE%E5%88%B0%E6%87%92%E5%8A%A0%E8%BD%BD%E7%9A%84%E7%9B%AE%E7%9A%84/">https://helongquan.github.io/2018/09/07/%E4%BD%BF%E7%94%A8jquery%E5%AE%9E%E7%8E%B0img%E7%9A%84data-src%E5%B1%9E%E6%80%A7%E8%BE%BE%E5%88%B0%E6%87%92%E5%8A%A0%E8%BD%BD%E7%9A%84%E7%9B%AE%E7%9A%84/</a>的时候，突然想到，如何能够把这个应用到magento的模块开发中，这样对于获取图片，不就可以减少加载速度了吗？来吧！</p>
<p>说明：笔者以下的引用都是以自定义模块（fan）来做讲解的。</p>
<h2 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h2><p>为了节省篇幅，笔者这里假设你已经创建了一个模块，并且添加了相应的数据。具体的方法，可以在本站点找到创建防伪码功能，以及在后台添加防伪码的模块开发教程。笔者在后台添加若干的内容：</p>
<p><img src="https://i.imgur.com/tyy6h0m.png"></p>
<p>数据表：fan</p>
<p><img src="https://i.imgur.com/77ozQQf.png"></p>
<p>然后，笔者创建了一个模块，然后通过浏览器来获取这个内容，并显示在前台：</p>
<p><img src="https://i.imgur.com/9CNNHtW.png"></p>
<p>笔者就是想要在这个显示的这个列表的时候，采用懒加载，那么我们就不得不对这个模块引入jquery，本来嘛magento这个主题已经有了jquery，但是不起作用，因此不得不对这个模块再进行一次引用，好了这个有个重要的概念：<strong>在模块中引入js</strong>，方法如下：</p>
<h3 id="在模块中引入外部js文件"><a href="#在模块中引入外部js文件" class="headerlink" title="在模块中引入外部js文件"></a>在模块中引入外部js文件</h3><p>1.首先找到这个模块的布局文件，地址：app/design/frontend/yourtheme/default/layout/fan.xml<br>这个fan.xml就是笔者在创建模块的时候，在前台的布局文件，我们打开这个文件。</p>
<p>代码：</p>
<pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;layout version=&quot;0.1.0&quot;&gt;
    &lt;default&gt;
    &lt;/default&gt;
    &lt;fan_index_index&gt;
        &lt;reference name=&quot;root&quot;&gt;
            &lt;action method=&quot;setTemplate&quot;&gt;&lt;template&gt;page/2columns-left.phtml&lt;/template&gt;&lt;/action&gt;
        &lt;/reference&gt;
        &lt;reference name=&quot;content&quot;&gt;
            &lt;block type=&quot;fan/fan&quot; name=&quot;fan&quot; template=&quot;fan/fan.phtml&quot; /&gt;
        &lt;/reference&gt;
    &lt;/fan_index_index&gt;
    &lt;fan_index_view&gt;
        &lt;reference name=&quot;content&quot;&gt;
            &lt;block type=&quot;fan/fan&quot; name=&quot;fan&quot; template=&quot;fan/view.phtml&quot; /&gt;
        &lt;/reference&gt;
    &lt;/fan_index_view&gt;
&lt;/layout&gt;</code></pre>
<p>原来是有东西在里面的，我们不管，我们需要添加如下代码进去：</p>
<pre><code>&lt;reference name=&quot;head&quot;&gt;
    &lt;action method=&quot;addJs&quot;&gt;
        &lt;script&gt;jquery-3.2.1.min.js&lt;/script&gt;
    &lt;/action&gt;
&lt;/reference&gt;</code></pre>
<p>这个代码意思就是加载在magento网站根目录下的js文件夹里自己添加进去的<code>jquery-3.2.1.min.js</code>文件。</p>
<p>添加后的fan.xml如下：</p>
<pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;layout version=&quot;0.1.0&quot;&gt;
    &lt;default&gt;
    &lt;/default&gt;
    &lt;fan_index_index&gt;
        &lt;reference name=&quot;root&quot;&gt;
            &lt;action method=&quot;setTemplate&quot;&gt;&lt;template&gt;page/2columns-left.phtml&lt;/template&gt;&lt;/action&gt;
        &lt;/reference&gt;
        &lt;reference name=&quot;head&quot;&gt;
            &lt;action method=&quot;addJs&quot;&gt;
                &lt;script&gt;jquery-3.2.1.min.js&lt;/script&gt;
            &lt;/action&gt;
        &lt;/reference&gt;
        &lt;reference name=&quot;content&quot;&gt;
            &lt;block type=&quot;fan/fan&quot; name=&quot;fan&quot; template=&quot;fan/fan.phtml&quot; /&gt;
        &lt;/reference&gt;
    &lt;/fan_index_index&gt;
    &lt;fan_index_view&gt;
        &lt;reference name=&quot;content&quot;&gt;
            &lt;block type=&quot;fan/fan&quot; name=&quot;fan&quot; template=&quot;fan/view.phtml&quot; /&gt;
        &lt;/reference&gt;
    &lt;/fan_index_view&gt;
&lt;/layout&gt;</code></pre>
<p>当然，经过笔者的实践发现，这样添加也是可以的：</p>
<pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;layout version=&quot;0.1.0&quot;&gt;
    &lt;default&gt;
        &lt;reference name=&quot;head&quot;&gt;
            &lt;action method=&quot;addJs&quot;&gt;
                &lt;script&gt;jquery-3.1.1.min.js&lt;/script&gt;
            &lt;/action&gt;
        &lt;/reference&gt;
    &lt;/default&gt;
    &lt;fan_index_index&gt;
        &lt;reference name=&quot;root&quot;&gt;
            &lt;action method=&quot;setTemplate&quot;&gt;&lt;template&gt;page/2columns-left.phtml&lt;/template&gt;&lt;/action&gt;
        &lt;/reference&gt;
        &lt;reference name=&quot;content&quot;&gt;
            &lt;block type=&quot;fan/fan&quot; name=&quot;fan&quot; template=&quot;fan/fan.phtml&quot; /&gt;
        &lt;/reference&gt;
    &lt;/fan_index_index&gt;
    &lt;fan_index_view&gt;
        &lt;reference name=&quot;content&quot;&gt;
            &lt;block type=&quot;fan/fan&quot; name=&quot;fan&quot; template=&quot;fan/view.phtml&quot; /&gt;
        &lt;/reference&gt;
    &lt;/fan_index_view&gt;
&lt;/layout&gt;</code></pre>
<p>为了区分，笔者这里引入的是<code>jquery-3.1.1.min.js</code>，这里的js放置的位置是在网站根目录下的js文件夹中。</p>
<h2 id="另外一种方法引入js：引入在skin这个目录下的主题下的js文件夹中的js"><a href="#另外一种方法引入js：引入在skin这个目录下的主题下的js文件夹中的js" class="headerlink" title="另外一种方法引入js：引入在skin这个目录下的主题下的js文件夹中的js"></a>另外一种方法引入js：引入在skin这个目录下的主题下的js文件夹中的js</h2><p>那么可不可以引用放在其他地方的js呢？无论是从管理方便还是基于个人习惯出发，这种可能性是存在的，答案是可以引用放在其他地方的。接下来我们来引用放在skin目录下的js文件夹中的js文件。</p>
<p>经过实践发现，如果我们想要引入一个外部位于skin目录下的js，比如jquery，那么我们要把这个js放在基础模板中的js文件夹下（magento_root/skin/frontend/base/default/js/jquery-3.1.1.min.js）,而不是我们自己的主题下的js文件夹下，这个地方要注意。我们怎么做呢？</p>
<p>首先，你可以在你的主题 local.xml 中添加自定义的JS文件，该文件位于：/app/design/frontend/yourtheme/default/layout/local.xml，打开，然后添加代码：</p>
<pre><code>&lt;layout version=&quot;0.1.0&quot;&gt;
    &lt;default&gt;
        &lt;reference name=&quot;head&quot;&gt;
            &lt;action method=&quot;addItem&quot;&gt;&lt;type&gt;skin_js&lt;/type&gt;&lt;name&gt;js/jquery-3.1.1.min.js&lt;/name&gt;&lt;/action&gt;
        &lt;/reference&gt;
    &lt;/default&gt;
&lt;/layout&gt;</code></pre>
<p>如果你固执己见，就想把这js加在自己当前所用的这个主题比如：porto主题，那么我们先把jquery-3.1.1.min.js粘贴放在这个主题的js目录下，然后对上面的这个代码做个修改：</p>
<pre><code>&lt;layout version=&quot;0.1.0&quot;&gt;
    &lt;default&gt;
        &lt;reference name=&quot;head&quot;&gt;
            &lt;action method=&quot;addItem&quot;&gt;&lt;type&gt;skin_js&lt;/type&gt;&lt;name&gt;../../porto/default/js/jquery-3.1.1.min.js&lt;/name&gt;&lt;/action&gt;
        &lt;/reference&gt;
    &lt;/default&gt;
&lt;/layout&gt;</code></pre>
<h2 id="好的，关于各种引入js的方法在自定义模块中已经完毕，我们继续回到正题，接着往下看。"><a href="#好的，关于各种引入js的方法在自定义模块中已经完毕，我们继续回到正题，接着往下看。" class="headerlink" title="好的，关于各种引入js的方法在自定义模块中已经完毕，我们继续回到正题，接着往下看。"></a>好的，关于各种引入js的方法在自定义模块中已经完毕，我们继续回到正题，接着往下看。</h2><p>添加完毕后，我们来到控制这个内容显示的fan.phtml文件，地址：app/design/frontend/yourtheme/default/template/fan/fan.phtml</p>
<p>原来的代码：</p>
<pre><code>&lt;h3&gt;&lt;?php echo $this-&gt;__(&#39;Voodoo最新防伪码列表&#39;) ?&gt;&lt;/h3&gt;
&lt;table class=&quot;biaoge&quot;&gt;
    &lt;tr&gt;
        &lt;td&gt;缩略图&lt;/td&gt;
        &lt;td&gt;防伪码&lt;/td&gt;
        &lt;td&gt;品牌商&lt;/td&gt;
        &lt;td&gt;负责人&lt;/td&gt;
        &lt;td&gt;公司名称&lt;/td&gt;
        &lt;td&gt;文件名&lt;/td&gt;
    &lt;/tr&gt;
    &lt;?php foreach($this-&gt;getNewsList() as $item): ?&gt;
        &lt;tr&gt;
            &lt;td&gt;
                &lt;?php if (pathinfo($item[&#39;filename&#39;])[&#39;extension&#39;] != &#39;pdf&#39;):?&gt;
                &lt;img src=&quot;&lt;?php echo Mage::getBaseUrl(&#39;media&#39;) . &#39;fan/&#39;.$item[&#39;filename&#39;] ?&gt;&quot; alt=&quot;&lt;?php echo $item[&#39;bianma&#39;]?&gt;&quot; width=&quot;64&quot; height=&quot;64&quot;/&gt;
                &lt;?php else:?&gt;
                &lt;a href=&quot;&lt;?php echo Mage::getBaseUrl(&#39;media&#39;) . &#39;fan/&#39;.$item[&#39;filename&#39;] ?&gt;&quot; download&gt;&lt;img src=&quot;http://www.tanzrepdelhi.com/images/pdficon.png&quot; alt=&quot;&lt;?php echo $item[&#39;bianma&#39;]?&gt;&quot; width=&quot;64&quot; height=&quot;64&quot;/&gt;&lt;/a&gt;
                &lt;?php endif; ?&gt;
            &lt;/td&gt;
            &lt;td&gt;
                &lt;h5&gt;&lt;?php echo $item[&#39;bianma&#39;] ?&gt;&lt;/h5&gt;
            &lt;/td&gt;
            &lt;td&gt;
                &lt;h5&gt;&lt;?php echo $item[&#39;brand&#39;] ?&gt;&lt;/h5&gt;
            &lt;/td&gt;
            &lt;td&gt;
                &lt;h5&gt;&lt;?php echo $item[&#39;user&#39;] ?&gt;&lt;/h5&gt;
            &lt;/td&gt;
            &lt;td&gt;
                &lt;h5&gt;&lt;?php echo $item[&#39;company&#39;] ?&gt;&lt;/h5&gt;
            &lt;/td&gt;
            &lt;td&gt;
                &lt;h5&gt;&lt;?php echo $item[&#39;filename&#39;] ?&gt;&lt;/h5&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
    &lt;?php endforeach; ?&gt;
&lt;/table&gt;

&lt;style&gt;
    input.input-text &#123;
        width: 100% !important;
    &#125;
    .yt_main_inner select&#123;
        width: 100%;
        margin-bottom: 20px;
    &#125;
    input[type=&quot;submit&quot;]&#123;
        width: 150px;
        margin-bottom: 20px;
        background: #444444;
        color: #fff;
        border: 0px;
    &#125;
    .biaoge td,.biaoge th&#123;
        padding:8px 10px;
        border:1px solid #ccc;
    &#125;
    .biaoge tr td:first-child&#123;
        width:80px;
    &#125;
    .biaoge tr:first-child&#123;
        background: #666;
        color: #fff;
    &#125;
    .biaoge img&#123;
        width: 100%;
    &#125;
    .biaoge&#123;
        border-collapse:collapse !important;
        border: 1px solid;
        width: 100%;
    &#125;
&lt;/style&gt;</code></pre>
<p>我们需要对这个代码进行修改，第一个地方，我们找到img那里，</p>
<pre><code>&lt;img src=&quot;&lt;?php echo Mage::getBaseUrl(&#39;media&#39;) . &#39;fan/&#39;.$item[&#39;filename&#39;] ?&gt;&quot; alt=&quot;&lt;?php echo $item[&#39;bianma&#39;]?&gt;&quot; width=&quot;64&quot; height=&quot;64&quot;/&gt;</code></pre>
<p>改成，</p>
<pre><code>&lt;img src=&quot;&lt;?php echo Mage::getBaseUrl(&#39;media&#39;) . &#39;fan/loading.gif&#39; ?&gt;&quot; data-src=&quot;&lt;?php echo Mage::getBaseUrl(&#39;media&#39;) . &#39;fan/&#39;.$item[&#39;filename&#39;] ?&gt;&quot; alt=&quot;&lt;?php echo $item[&#39;bianma&#39;]?&gt;&quot; width=&quot;64&quot; height=&quot;64&quot;/&gt;</code></pre>
<p>这里自己需要在目录添加一个加载的gif(loading.gif)，尽量弄小点就行。</p>
<p>地址：magento_root/media/fan/loading.gif</p>
<p>然后，在这个文件最下面添加js代码：</p>
<pre><code>&lt;script&gt;
    start();
    $(window).on(&#39;scroll&#39;, function() &#123;
        start();
    &#125;)

    function start() &#123;
        //.not(&#39;[data-isLoaded]&#39;)选中已加载的图片不需要重新加载，确定哪个范围内的图片需要这个功能，这里是container里的所有图片
        $(&#39;.biaoge img&#39;).not(&#39;[data-isLoaded]&#39;).each(function() &#123;
            var $node = $(this);
            if (isShow($node)) &#123;
                loadImg($node);
            &#125;
        &#125;)
    &#125;

    //判断一个元素是不是出现在窗口(视野)
    function isShow($node) &#123;
        return $node.offset().top &lt;= $(window).height() + $(window).scrollTop();
    &#125;
    //加载图片
    function loadImg($img) &#123;
        //.attr(值)
        //.attr(属性名称,值)
        $img.attr(&#39;src&#39;, $img.attr(&#39;data-src&#39;)); //把data-src的值 赋值给src
        $img.attr(&#39;data-isLoaded&#39;, 1); //已加载的图片做标记
    &#125;
&lt;/script&gt;</code></pre>
<p>由于我们只对这个表格里面的内容进行懒加载，所以我们找到这个：<code>.biaoge img</code>，然后控制如果出现在视口范围里的图片就显示，否则都显示loading.gif这个图片。</p>
<p><img src="https://i.imgur.com/OY6XwfC.png"></p>
<p>看到了吗，左边的那个是已经显示出来的东西，右边笔者选择后面还没有显示的地方，里面的img的属性标签src的地址还是loading.gif图片，这事因为我们还没滑动到这张图片的位置，这样就大大减少了整个页面的加载时间。</p>
<p>添加后的fan.phtml代码如下：</p>
<pre><code>&lt;h3&gt;&lt;?php echo $this-&gt;__(&#39;Voodoo最新防伪码列表&#39;) ?&gt;&lt;/h3&gt;
&lt;table class=&quot;biaoge&quot;&gt;
    &lt;tr&gt;
        &lt;td&gt;缩略图&lt;/td&gt;
        &lt;td&gt;防伪码&lt;/td&gt;
        &lt;td&gt;品牌商&lt;/td&gt;
        &lt;td&gt;负责人&lt;/td&gt;
        &lt;td&gt;公司名称&lt;/td&gt;
        &lt;td&gt;文件名&lt;/td&gt;
    &lt;/tr&gt;
    &lt;?php foreach($this-&gt;getNewsList() as $item): ?&gt;
        &lt;tr&gt;
            &lt;td&gt;
                &lt;?php if (pathinfo($item[&#39;filename&#39;])[&#39;extension&#39;] != &#39;pdf&#39;):?&gt;
                &lt;img src=&quot;&lt;?php echo Mage::getBaseUrl(&#39;media&#39;) . &#39;fan/loading.gif&#39; ?&gt;&quot; data-src=&quot;&lt;?php echo Mage::getBaseUrl(&#39;media&#39;) . &#39;fan/&#39;.$item[&#39;filename&#39;] ?&gt;&quot; alt=&quot;&lt;?php echo $item[&#39;bianma&#39;]?&gt;&quot; width=&quot;64&quot; height=&quot;64&quot;/&gt;
                &lt;?php else:?&gt;
                &lt;a href=&quot;&lt;?php echo Mage::getBaseUrl(&#39;media&#39;) . &#39;fan/&#39;.$item[&#39;filename&#39;] ?&gt;&quot; download&gt;&lt;img src=&quot;http://www.tanzrepdelhi.com/images/pdficon.png&quot; alt=&quot;&lt;?php echo $item[&#39;bianma&#39;]?&gt;&quot; width=&quot;64&quot; height=&quot;64&quot;/&gt;&lt;/a&gt;
                &lt;?php endif; ?&gt;
            &lt;/td&gt;
            &lt;td&gt;
                &lt;h5&gt;&lt;?php echo $item[&#39;bianma&#39;] ?&gt;&lt;/h5&gt;
            &lt;/td&gt;
            &lt;td&gt;
                &lt;h5&gt;&lt;?php echo $item[&#39;brand&#39;] ?&gt;&lt;/h5&gt;
            &lt;/td&gt;
            &lt;td&gt;
                &lt;h5&gt;&lt;?php echo $item[&#39;user&#39;] ?&gt;&lt;/h5&gt;
            &lt;/td&gt;
            &lt;td&gt;
                &lt;h5&gt;&lt;?php echo $item[&#39;company&#39;] ?&gt;&lt;/h5&gt;
            &lt;/td&gt;
            &lt;td&gt;
                &lt;h5&gt;&lt;?php echo $item[&#39;filename&#39;] ?&gt;&lt;/h5&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
    &lt;?php endforeach; ?&gt;
&lt;/table&gt;

&lt;style&gt;
    input.input-text &#123;
        width: 100% !important;
    &#125;
    .yt_main_inner select&#123;
        width: 100%;
        margin-bottom: 20px;
    &#125;
    input[type=&quot;submit&quot;]&#123;
        width: 150px;
        margin-bottom: 20px;
        background: #444444;
        color: #fff;
        border: 0px;
    &#125;
    .biaoge td,.biaoge th&#123;
        padding:8px 10px;
        border:1px solid #ccc;
    &#125;
    .biaoge tr td:first-child&#123;
        width:80px;
    &#125;
    .biaoge tr:first-child&#123;
        background: #666;
        color: #fff;
    &#125;
    .biaoge img&#123;
        width: 100%;
    &#125;
    .biaoge&#123;
        border-collapse:collapse !important;
        border: 1px solid;
        width: 100%;
    &#125;
&lt;/style&gt;

&lt;script&gt;
    start();
    $(window).on(&#39;scroll&#39;, function() &#123;
        start();
    &#125;)

    function start() &#123;
        //.not(&#39;[data-isLoaded]&#39;)选中已加载的图片不需要重新加载，确定哪个范围内的图片需要这个功能，这里是container里的所有图片
        $(&#39;.biaoge img&#39;).not(&#39;[data-isLoaded]&#39;).each(function() &#123;
            var $node = $(this);
            if (isShow($node)) &#123;
                loadImg($node);
            &#125;
        &#125;)
    &#125;

    //判断一个元素是不是出现在窗口(视野)
    function isShow($node) &#123;
        return $node.offset().top &lt;= $(window).height() + $(window).scrollTop();
    &#125;
    //加载图片
    function loadImg($img) &#123;
        //.attr(值)
        //.attr(属性名称,值)
        $img.attr(&#39;src&#39;, $img.attr(&#39;data-src&#39;)); //把data-src的值 赋值给src
        $img.attr(&#39;data-isLoaded&#39;, 1); //已加载的图片做标记
    &#125;
&lt;/script&gt;</code></pre>
<p><strong>其实，这个问题就是四点：</strong></p>
<ol>
<li>对特定模块引入外部资源（js/css，这里引入的主要是js的库文件，css的话，直接写在这个模板文件里面即可），由于模块不是在后台中的页面那里添加，因此没法从网站的后台page那里的design那里引入外部文件，所以这个值得深入了解。</li>
<li>然后就是确定好需要懒加载的范围，笔者确定的是在<code>.biaoge</code>这个class下的所有图片。</li>
<li>添加相应的js代码</li>
<li>把img标签那里做个修改，添加data-src这个属性，并且把真正的图片引用地址放在这个里面，而在src这个里面只需要放置一张小的图片作为填充即可，为了体验度好点，笔者这里用的是一张类似加载的gif图，你不必跟我一样。</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://helongquan.github.io/2018/09/07/%E4%BD%BF%E7%94%A8jquery%E5%AE%9E%E7%8E%B0img%E7%9A%84data-src%E5%B1%9E%E6%80%A7%E8%BE%BE%E5%88%B0%E6%87%92%E5%8A%A0%E8%BD%BD%E7%9A%84%E7%9B%AE%E7%9A%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="泉哥">
      <meta itemprop="description" content="日记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鸢尾花序">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/09/07/%E4%BD%BF%E7%94%A8jquery%E5%AE%9E%E7%8E%B0img%E7%9A%84data-src%E5%B1%9E%E6%80%A7%E8%BE%BE%E5%88%B0%E6%87%92%E5%8A%A0%E8%BD%BD%E7%9A%84%E7%9B%AE%E7%9A%84/" class="post-title-link" itemprop="url">使用jquery实现img的data-src属性达到懒加载的目的</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-09-07 09:11:31" itemprop="dateCreated datePublished" datetime="2018-09-07T09:11:31+08:00">2018-09-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 11:58:04" itemprop="dateModified" datetime="2020-10-11T11:58:04+08:00">2020-10-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/javascript/" itemprop="url" rel="index"><span itemprop="name">javascript</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>一、什么是图片懒加载？</strong></p>
<blockquote>
<p>当访问一个页面的时候，先把img元素或是其他元素的背景图片路径替换成一张大小为1*1px图片的路径（这样就只需请求一次），当图片出现在浏览器的可视区域内时，才设置图片真正的路径，让图片显示出来。这就是图片懒加载。</p>
</blockquote>
<blockquote>
<p>通俗一点：<br>1、就是创建一个自定义属性data-src存放真正需要显示的图片路径，而img自带的src放一张大小为1 * 1px的图片路径。</p>
<p>2、当页面滚动直至此图片出现在可视区域时，用js取到该图片的data-src的值赋给src。</p>
<p>ps：自定义属性可以取任何名字</p>
</blockquote>
<p><strong>二、需要了解的问题</strong></p>
<blockquote>
<p>1、如何加载图片？</p>
<p>2、如何判断一个元素出现在视野中？</p>
</blockquote>
<p><strong>如何加载图片？</strong></p>
<p>只需要把data-src中的地址放到src的里面就好了。</p>
<p>代码：</p>
<pre><code>function loadImg($img)&#123;
//.attr(值)
//.attr(属性名称,值)
$img.attr(&#39;src&#39;, $img.attr(&#39;data-src&#39;)) //把data-src的值 赋值给src
$img.attr(&#39;data-isLoaded&#39;, 1) //已加载过的图片做标记
&#125;</code></pre>
<p>废话少说，直接上demo:</p>
<pre><code>&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;title&gt;Document&lt;/title&gt;
    &lt;script src=&quot;https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js&quot;&gt;&lt;/script&gt;
    &lt;style&gt;
    .container &#123;
        max-width: 900px;
        margin: 0 auto;
        display: block;
    &#125;
    .container:after &#123;
        content: &#39;&#39;;
        display: block;
        clear: both;
    &#125;
    h1 &#123;
        clear: both;
    &#125;
    &lt;/style&gt;
&lt;/head&gt;

&lt;body&gt;
    &lt;div class=&quot;container&quot;&gt;
        &lt;img src=&quot;img/loading.gif&quot; alt=&quot;1&quot; data-src=&quot;img/g1.jpg&quot;&gt;
        &lt;img src=&quot;img/loading.gif&quot; alt=&quot;2&quot; data-src=&quot;img/g2.jpg&quot;&gt;
        &lt;img src=&quot;img/loading.gif&quot; alt=&quot;3&quot; data-src=&quot;img/g3.jpg&quot;&gt;
        &lt;h1&gt;你好&lt;/h1&gt;
    &lt;/div&gt;
    &lt;script&gt;
    start();
    $(window).on(&#39;scroll&#39;, function() &#123;
        start();
    &#125;)

    function start() &#123;
        //.not(&#39;[data-isLoaded]&#39;)选中已加载的图片不需要重新加载，确定哪个范围内的图片需要这个功能，这里是container里的所有图片
        $(&#39;.container img&#39;).not(&#39;[data-isLoaded]&#39;).each(function() &#123;
            var $node = $(this);
            if (isShow($node)) &#123;
                loadImg($node);
            &#125;
        &#125;)
    &#125;

    //判断一个元素是不是出现在窗口(视野)
    function isShow($node) &#123;
        return $node.offset().top &lt;= $(window).height() + $(window).scrollTop();
    &#125;
    //加载图片
    function loadImg($img) &#123;
        //.attr(值)
        //.attr(属性名称,值)
        $img.attr(&#39;src&#39;, $img.attr(&#39;data-src&#39;)); //把data-src的值 赋值给src
        $img.attr(&#39;data-isLoaded&#39;, 1); //已加载的图片做标记
    &#125;
    &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
<p><strong>说明一下：</strong></p>
<p>当我们打这个demo的时候，看到的是第一张图片，这个在打开第一张图片的时候，利用开发者工具我们可以看到如下截图：</p>
<p><img src="https://i.imgur.com/16dFNJz.png"></p>
<p>这个就说明当视口显示第一张图片的时候，第二张和第三张还没出现，那么就保持loading.gif，这样就节省了加载的时间，当我们继续往下滑直到出现第二张图片的时候，此时第三张图片还没出现在视口，我们通过开发者工具看到如下的截图：</p>
<p><img src="https://i.imgur.com/fLiPI7U.png"></p>
<p>当然，我们继续滑动到下面，看到第三张图片的时候，自然而然第三张的loading.gif也会被g3.jpg取代，这样就实现了懒加载，滑动到那个位置才加载，这篇文章参考了这个作者：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/moxiaowohuwei/p/7908877.html">https://www.cnblogs.com/moxiaowohuwei/p/7908877.html</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://helongquan.github.io/2018/09/04/%E5%9F%BA%E4%BA%8Ewordpress%E7%9A%84%E9%98%B2%E4%BC%AA%E7%A0%81%E6%9F%A5%E8%AF%A2%E5%A4%9A%E9%87%8D%E6%90%9C%E7%B4%A2%E8%BF%87%E6%BB%A4%E5%8A%9F%E8%83%BD%EF%BC%8C%E4%BB%A5%E5%8F%8A%E9%99%90%E5%88%B6%E8%BE%93%E5%85%A5%E6%A1%86%E7%9A%84%E8%BE%93%E5%85%A5%E5%AD%97%E7%AC%A6%E7%B1%BB%E5%9E%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="泉哥">
      <meta itemprop="description" content="日记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鸢尾花序">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/09/04/%E5%9F%BA%E4%BA%8Ewordpress%E7%9A%84%E9%98%B2%E4%BC%AA%E7%A0%81%E6%9F%A5%E8%AF%A2%E5%A4%9A%E9%87%8D%E6%90%9C%E7%B4%A2%E8%BF%87%E6%BB%A4%E5%8A%9F%E8%83%BD%EF%BC%8C%E4%BB%A5%E5%8F%8A%E9%99%90%E5%88%B6%E8%BE%93%E5%85%A5%E6%A1%86%E7%9A%84%E8%BE%93%E5%85%A5%E5%AD%97%E7%AC%A6%E7%B1%BB%E5%9E%8B/" class="post-title-link" itemprop="url">基于wordpress的防伪码（序列码）查询多重搜索过滤功能升级，以及限制输入框的输入字符类型</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-09-04 20:58:31" itemprop="dateCreated datePublished" datetime="2018-09-04T20:58:31+08:00">2018-09-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 11:58:04" itemprop="dateModified" datetime="2020-10-11T11:58:04+08:00">2020-10-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/wordpress/" itemprop="url" rel="index"><span itemprop="name">wordpress</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>这个我以wordpress默认的主题enfold主题为例，我在主题根目录下新建一个模板文件，命名为：防伪码添加，文件名为fanweima_add.php，然后在主题目录下新建一个fanweima文件夹.</p>
<p>在enfold主题下新建目录：wordpress/wp-content/themes/enfold/fanweima，在这个文件夹里面新建两个php文件：license_save.php和config.php</p>
<p>准备材料：数据库，数据表（wp_license），其中数据表的字段如下：</p>
<pre><code>CREATE TABLE `wp_license` (
  `id` int(16) unsigned NOT NULL AUTO_INCREMENT COMMENT &#39;9&#39;,
  `name` char(20) CHARACTER SET utf8 COLLATE utf8_unicode_ci NOT NULL,
  `brand` varchar(300) CHARACTER SET utf8 COLLATE utf8_unicode_ci NOT NULL,
  `fuzeren` varchar(20) CHARACTER SET utf8 COLLATE utf8_unicode_ci DEFAULT NULL,
  `diqu` varchar(200) CHARACTER SET utf8 COLLATE utf8_unicode_ci DEFAULT NULL,
  `chanpin` varchar(200) CHARACTER SET utf8 COLLATE utf8_unicode_ci DEFAULT NULL,
  `baozhiqi` varchar(16) CHARACTER SET utf8 COLLATE utf8_unicode_ci DEFAULT NULL,
  `attachment` varchar(255) CHARACTER SET utf8 COLLATE utf8_unicode_ci DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `id` (`id`)
) ENGINE=MyISAM AUTO_INCREMENT=64 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_520_ci;</code></pre>
<p>数据填充：</p>
<pre><code>INSERT INTO `wp_license` VALUES (&#39;41&#39;, &#39;34567&#39;, &#39;bishen&#39;, &#39;ryhrym&#39;, &#39;深圳&#39;, &#39;tjnyemr&#39;, &#39;34&#39;, &#39;http://test.nocy.com/wp-content/uploads/2018/03/blogging.jpg&#39;);
INSERT INTO `wp_license` VALUES (&#39;42&#39;, &#39;444&#39;, &#39;bishen&#39;, &#39;iuytre&#39;, &#39;广州&#39;, &#39;wefhjgn&#39;, &#39;56&#39;, &#39;http://test.nocy.com/wp-content/uploads/2018/06/How.pdf&#39;);
INSERT INTO `wp_license` VALUES (&#39;43&#39;, &#39;555&#39;, &#39;nocti&#39;, &#39;dfgh&#39;, &#39;广州&#39;, &#39;dfb&#39;, &#39;34&#39;, &#39;http://test.nocety.com/wp-content/uploads/2018/03/59ddc2f9d4dad6.36536291.jpg&#39;);
INSERT INTO `wp_license` VALUES (&#39;62&#39;, &#39;112233&#39;, &#39;克朗&#39;, &#39;张杰&#39;, &#39;北京&#39;, &#39;布丁奶茶&#39;, &#39;1&#39;, &#39;http://110.com&#39;);
INSERT INTO `wp_license` VALUES (&#39;45&#39;, &#39;666&#39;, &#39;aolan&#39;, &#39;sdtfghjhk&#39;, &#39;珠海&#39;, &#39;sdfghj&#39;, &#39;75&#39;, &#39;http://test.noctiuniversity.com/wp-content/uploads/2018/07/How.pdf&#39;);
INSERT INTO `wp_license` VALUES (&#39;46&#39;, &#39;7766&#39;, &#39;hanhe&#39;, &#39;erhgrw&#39;, &#39;上海&#39;, &#39;wegrwrf&#39;, &#39;89&#39;, &#39;http://localhost:8080/wordpress/wp-content/uploads/2018/07/test1.pdf&#39;);
INSERT INTO `wp_license` VALUES (&#39;47&#39;, &#39;789&#39;, &#39;bishen&#39;, &#39;bgferfg&#39;, &#39;珠海&#39;, &#39;fggsfgnh&#39;, &#39;987&#39;, &#39;http://localhost:8080/wordpress/wp-content/uploads/2018/07/1.jpg&#39;);
INSERT INTO `wp_license` VALUES (&#39;48&#39;, &#39;1010&#39;, &#39;nocti&#39;, &#39;zhagnsan&#39;, &#39;深圳&#39;, &#39;存在主义&#39;, &#39;3&#39;, &#39;https://pan.baidu.com/s/1-gPSEDW5TQy-g-J2BZYpGg&#39;);
INSERT INTO `wp_license` VALUES (&#39;49&#39;, &#39;1011&#39;, &#39;bishen&#39;, &#39;zhagnsan&#39;, &#39;深圳&#39;, &#39;生命的重建&#39;, &#39;2&#39;, &#39;https://pan.baidu.com/s/1viMuKI1KH1L6tzX9Fd9Smw&#39;);
INSERT INTO `wp_license` VALUES (&#39;50&#39;, &#39;1012&#39;, &#39;nocti&#39;, &#39;zhagnsan&#39;, &#39;广州&#39;, &#39;angm&#39;, &#39;3&#39;, &#39;https://pan.baidu.com/s/1EAaR0bbAj9g-QatzVFPMZA&#39;);
INSERT INTO `wp_license` VALUES (&#39;51&#39;, &#39;1013&#39;, &#39;hanhe&#39;, &#39;zhangsan&#39;, &#39;广州&#39;, &#39;水生生物学&#39;, &#39;4&#39;, &#39;https://pan.baidu.com/s/1ZL3fjahxI48YOsLTFrJ_KQ&#39;);
INSERT INTO `wp_license` VALUES (&#39;63&#39;, &#39;3467&#39;, &#39;肯德基&#39;, &#39;肯先生&#39;, &#39;美国&#39;, &#39;鸡腿&#39;, &#39;1&#39;, &#39;http://www.nocnrg.com&#39;);</code></pre>
<p>好的，准备工作完成后，我们进入正题。</p>
<p>文件结构我们准备好了，我们就先来说license_add.php的文件内容。</p>
<h2 id="license-add-php文件"><a href="#license-add-php文件" class="headerlink" title="license_add.php文件"></a>license_add.php文件</h2><p>我们找到内容显示区的代码，大概是在main标签里面：</p>
<pre><code>&lt;!-- 新添加的信息 开始 --&gt;
&lt;div class=&quot;entry-content&quot;&gt;
    &lt;br&gt;
    &lt;form action=&quot;&lt;?php bloginfo(&#39;template_url&#39;); ?&gt;/fanweima/license_save.php&quot; method=&quot;post&quot;&gt;
      &lt;div class=&quot;form-group&quot;&gt;
        &lt;label for=&quot;fanweimaname&quot;&gt;序列码&lt;/label&gt;
        &lt;input type=&quot;text&quot; class=&quot;form-control&quot; id=&quot;fanweimaname&quot; name=&quot;name&quot; placeholder=&quot;输入防伪码&quot; onkeyup=&quot;this.value=this.value.replace(/[^\d]/g,&#39;&#39;) &quot; onafterpaste=&quot;this.value=this.value.replace(/[^\d]/g,&#39;&#39;) &quot; required&gt;
      &lt;/div&gt;
      &lt;div class=&quot;form-group&quot;&gt;
        &lt;label for=&quot;pingpaishang&quot;&gt;品牌&lt;/label&gt;
        &lt;input type=&quot;text&quot; class=&quot;form-control&quot; id=&quot;pingpaishang&quot; name=&quot;brand&quot; placeholder=&quot;输入品牌商&quot; onkeyup=&quot;value=value.replace(/[^a-zA-Z]/g, &#39;&#39;)&quot; required&gt;
      &lt;/div&gt;
      &lt;div class=&quot;form-group&quot;&gt;
        &lt;label&gt;负责人&lt;/label&gt;
        &lt;input type=&quot;text&quot; class=&quot;form-control&quot; name=&quot;fuzeren&quot; placeholder=&quot;负责人&quot; onkeyup=&quot;value=value.replace(/[^a-zA-Z]/g, &#39;&#39;)&quot; required&gt;
      &lt;/div&gt;
      &lt;div class=&quot;form-group&quot;&gt;
        &lt;label&gt;地区&lt;/label&gt;
        &lt;input type=&quot;text&quot; class=&quot;form-control&quot; name=&quot;diqu&quot; placeholder=&quot;地区&quot; onkeyup=&quot;value=value.replace(/[^a-zA-Z]/g, &#39;&#39;)&quot; required&gt;
      &lt;/div&gt;
      &lt;div class=&quot;form-group&quot;&gt;
        &lt;label&gt;产品名称&lt;/label&gt;
        &lt;input type=&quot;text&quot; class=&quot;form-control&quot; name=&quot;chanpin&quot; placeholder=&quot;产品名称&quot; onkeyup=&quot;value=value.replace(/[^a-zA-Z]/g, &#39;&#39;)&quot; required&gt;
      &lt;/div&gt;
      &lt;div class=&quot;form-group&quot;&gt;
        &lt;label&gt;保质期&lt;/label&gt;
        &lt;input type=&quot;text&quot; class=&quot;form-control&quot; name=&quot;baozhiqi&quot; placeholder=&quot;保质期&quot; required&gt;
      &lt;/div&gt;
      &lt;div class=&quot;form-group&quot;&gt;
          &lt;label&gt;检测报告地址&lt;/label&gt;
        &lt;input type=&quot;url&quot; class=&quot;form-control&quot; id=&quot;exampleInputFile1&quot; name=&quot;news_file&quot; required&gt;
      &lt;/div&gt;
      &lt;button type=&quot;submit&quot; class=&quot;btn btn-default&quot;&gt;Submit&lt;/button&gt;
    &lt;/form&gt;

&lt;/div&gt;

&lt;!-- 新添加的信息 结束 --&gt;</code></pre>
<p>这里做个说明，为什么要对这些输入框添加一些东西呢？</p>
<h2 id="不同服务器数据库的乱码"><a href="#不同服务器数据库的乱码" class="headerlink" title="不同服务器数据库的乱码"></a>不同服务器数据库的乱码</h2><p>在这个地方需要说一点，因为笔者测试是在本地服务器，随时可以修改数据库的配置文件，可是如果笔者没有服务器的权限，没法进入到数据库的配置文件中（公司的服务器用的是虚拟主机，虚拟主机是没法去自定义设置这些服务器配置文件的），那么就显得无能为力了，所以这个地方可能会出现乱码的情况，要么是当前端页面添加防伪码的时候有中文字符，添加成功后，到数据库中一看变成了乱码了；要么是数据表里面是中文，可是查询防伪码的时候，显示到前台的时候中文字符变成乱码，那么解决mysql的乱码的终极解决发方案是什么呢？请往下看：</p>
<p>修改mysql配置文件/etc/my.cnf，由于笔者是在本地的wampp server里面测试的，所以这里的是my.ini，打开后把以下的代码加进入，如果原本有就设置成如下即可。</p>
<pre><code>[mysqld]
character-set-server=utf8 
[client]
default-character-set=utf8 
[mysql]
default-character-set=utf8</code></pre>
<p>请注意这几个参数配置的位置，不然可能会启动不起来mysql服务：</p>
<p><img src="https://i.imgur.com/htYxlvQ.png"></p>
<p>OK。这下如果你重启mysql服务也会发现它的字符集是utf8.</p>
<pre><code>show variables like &#39;%char%&#39;;</code></pre>
<p><img src="https://i.imgur.com/gcnCwaH.png"></p>
<p>而且我们创建表的时候不需要指定字符编码,它默认就是utf8;</p>
<pre><code>drop database wordpress;
create database wordpress;
use wordpress;
create table wp_license(name varchar(11));
show create table wp_license \G;</code></pre>
<p>我们就可以看到：</p>
<p><img src="https://i.imgur.com/ibqyutM.png"></p>
<hr>
<p>好的，我们回到这个form里面的输入框的过滤问题上来，这里笔者想让防伪码的输入框只能输入整数，而且是必填，那么：</p>
<pre><code>&lt;input type=&quot;text&quot; class=&quot;form-control&quot; id=&quot;fanweimaname&quot; name=&quot;name&quot; placeholder=&quot;输入防伪码&quot; onkeyup=&quot;this.value=this.value.replace(/[^\d]/g,&#39;&#39;) &quot; onafterpaste=&quot;this.value=this.value.replace(/[^\d]/g,&#39;&#39;) &quot; required&gt;</code></pre>
<p>添加了</p>
<pre><code>onkeyup=&quot;this.value=this.value.replace(/[^\d]/g,&#39;&#39;) &quot; onafterpaste=&quot;this.value=this.value.replace(/[^\d]/g,&#39;&#39;) &quot;</code></pre>
<p>这个的意思就是只能输入整数。不能输入字母和其他字符。</p>
<p>又比如，品牌的那个输入框那里，由于笔者不知道要是在线上测试的时候虚拟主机的mysql是否支持中文字符，所以为了保险起见，统一不能输入中文，只能输入英文字符或者数字，</p>
<pre><code>&lt;input type=&quot;text&quot; class=&quot;form-control&quot; id=&quot;pingpaishang&quot; name=&quot;brand&quot; placeholder=&quot;输入品牌商&quot; onkeyup=&quot;value=value.replace(/[^a-zA-Z]/g, &#39;&#39;)&quot; required&gt;</code></pre>
<p>控制不能输入中文的代码：</p>
<pre><code>onkeyup=&quot;value=value.replace(/[^a-zA-Z]/g, &#39;&#39;)&quot;</code></pre>
<p>添加了这个后，用户及时想输入中文也不行了，这样就会统一输入英文，确保任何情况下都不会变成乱码了，当然了，如果能够支持中文，这个就不必添加这个过滤功能了。</p>
<p>接着还需要说明的一个地方的是，最后的那个检测报告地址，这里是需要输入链接地址的，所以呢，如果不进行一个过滤，大家估计都误以为随便输入即可，所以这里写成如下：</p>
<pre><code>&lt;input type=&quot;url&quot; class=&quot;form-control&quot; id=&quot;exampleInputFile1&quot; name=&quot;news_file&quot; required&gt;</code></pre>
<p>即，输入类型为url</p>
<pre><code>type=&quot;url&quot;</code></pre>
<p>那么这里的输入框就只能输入url地址了，如果不符合的话，那么就不能提交。</p>
<p>为了确保数据表的字段记录信息的完整性，笔者这里对每个输入框都进行了强制性必填设置，即在<code>input</code>的后面添加一个属性<code>required</code>，这样就确保用户能够把每一项填写完才能顺利提交。</p>
<hr>
<p>这个是表单在前台显示的效果，截图如下：</p>
<p><img src="https://i.imgur.com/wzPIKGE.png"></p>
<p>这个就是这个模板文件的作用，我们将向license_save.php文件提交，代码：</p>
<pre><code>&lt;?php bloginfo(&#39;template_url&#39;); ?&gt;/fanweima/license_save.php</code></pre>
<p>这里采用绝对路径。</p>
<p>好的，我们来到fanweima文件夹中。</p>
<h2 id="config-php文件"><a href="#config-php文件" class="headerlink" title="config.php文件"></a>config.php文件</h2><p>这个文件很简单，就是连接数据库的文件，之所以把这几个环节分别放在不同的文件，这样做是为了条理清晰，分工明确，便于排错。好的，这个文件中的全部代码如下：</p>
<pre><code>&lt;?php 

//获取当前文件所在目录
$gen=$_SERVER[&#39;DOCUMENT_ROOT&#39;];
require_once(&quot;$gen/wordpress/wp-config.php&quot;);
//如果笔者不是用的是子目录存放wordpress网站，那么应该用如下方式：
//require_once(&quot;$gen/wp-config.php&quot;);

//链接mysql服务器 开始
$connection = mysqli_connect(DB_HOST, DB_USER, DB_PASSWORD);
mysqli_select_db($connection, DB_NAME);
//设置字符编码
@mysqli_query(&#39;SET NAMES UTF8&#39;);
?&gt;</code></pre>
<p>这里做个说明，由于笔者这里采用的是二级目录存放的wordpress网站程序，所以这里的配置文件地址是：<code>$gen/wordpress/wp-config.php</code>，如果是放在根目录下的话就是：<code>$gen/wp-config.php</code>，这个要注意下就行了。</p>
<p>这个文件分两部分，第一部分就是连接wordpress网站的配置文件，这样我们就不需要输入数据库账号密码了，这样相对来说是比较安全的。然后就是连接服务器，接着就是连上数据库，最后是设置字符编码。完事！</p>
<h2 id="license-save-php文件"><a href="#license-save-php文件" class="headerlink" title="license_save.php文件"></a>license_save.php文件</h2><p>全部代码如下：</p>
<pre><code>&lt;?php 
    //引用数据库链接文件
    require(&quot;config.php&quot;); 
    $name = $_POST[&quot;name&quot;];
    $brand = $_POST[&quot;brand&quot;];
    $fuzeren = $_POST[&quot;fuzeren&quot;];
    $diqu = $_POST[&quot;diqu&quot;];
    $chanpin = $_POST[&quot;chanpin&quot;];
    $baozhiqi = $_POST[&quot;baozhiqi&quot;];
    $file_name=$_POST[&quot;news_file&quot;];
    //下面是读取数据库数据
    // $sql = &quot;select id,name,brand from wp_fanweima order by id desc limit &quot;.$num.&quot;,3&quot;;
    $sql=&quot;insert into wp_license values(null,&#39;$name&#39;,&#39;$brand&#39;,&#39;$fuzeren&#39;,&#39;$diqu&#39;,&#39;$chanpin&#39;,&#39;$baozhiqi&#39;,&#39;$file_name&#39;)&quot;;
    $result = mysqli_query($connection,$sql) or die(mysqli_error($connection));
    //确保弹窗里的文字不是乱码
    header(&#39;Content-Type: text/html; charset=utf-8&#39;);
    echo &quot;&lt;script&gt;alert(&#39;序列码添加成功!&#39;);location.href=&#39;&quot;.$_SERVER[&quot;HTTP_REFERER&quot;].&quot;&#39;;&lt;/script&gt;&quot;;
    mysqli_close($connection); //关闭数据库
?&gt;</code></pre>
<p>这个也做一个简单的讲解，第一个是引入数据库连接的文件，这个文件的路径就是在同目录中的config.php文件，只有连接上数据库才能对数据库进行查询。好的，连接成功后，把license_add.php中的表单里的字段获取，接着把数据插入数据表（<code>wp_license</code>）中，这里需要提醒的是这个<code>mysqli_query</code>，在我以前使用纯php写的一个系统中貌似只需一个字段就行了，这里需要有两个字段，否则会报错，这里需要注意。参数一是连接信息，参数二是数据添加结果。当然，我们还可以进一步的对这个数据添加完善，比如做一个判断，如果记录受影响条数大于1的话，提示添加成功，否则添加失败，由于这里是用于的测试的，所以没有说得那么详细。</p>
<p>好的最后的结果，截图说明：</p>
<p><img src="https://i.imgur.com/Cel7FTf.png"></p>
<p><img src="https://i.imgur.com/3EAJth6.png"></p>
<p>数据库中截图：</p>
<p><img src="https://i.imgur.com/WLmfrI0.png"></p>
<p>这个就是在前台添加了一条防伪码记录，然后在数据表中查看已经成功添加了。</p>
<h2 id="查询防伪码"><a href="#查询防伪码" class="headerlink" title="查询防伪码"></a>查询防伪码</h2><p>关于防伪码查询的文章已经在前面的文章说过了，大家可以参考笔者写的另外一篇关于在wordpress上添加防伪码功能的文章。本文作为升级版进行讲解。</p>
<p>在主题目录下创建一个防伪码查询模板文件，由于笔者采用的是enfold主题的，所以笔者复制其中一个页面模板（page.php）文件，然后命名成另外一个名字：license_search_3.php（名字大家根据心情来吧），模板名称：</p>
<pre><code>&lt;?php
/**
 *
    Template Name: 序列码查询二重过滤搜索
 *</code></pre>
<p>然后在紧随这个后面，在添加自定义代码的位置之前添加如下代码：</p>
<pre><code>&lt;!-- 添加自定义数据库连接信息 开始 --&gt;
&lt;?php
$genmul=$_SERVER[&#39;DOCUMENT_ROOT&#39;];
require_once(&quot;$genmul/wordpress/wp-config.php&quot;);

//链接mysql服务器 开始
$connection = mysqli_connect(DB_HOST, DB_USER, DB_PASSWORD);
mysqli_select_db($connection, DB_NAME);
//链接mysql服务器 结束

?&gt;
&lt;!-- 添加自定义数据库连接信息 结束 --&gt;</code></pre>
<p>这个代码是用来连接数据库的。有了这个才能够查询数据库，这个很重要。</p>
<p>接着，还是一样的，在<code>&lt;main&gt;&lt;/main&gt;</code>代码之间添加如下代码：</p>
<pre><code>&lt;style&gt;
    .list-group&#123;
        margin:0px;
        margin-bottom: 20px;
    &#125;
    a&#123;
        text-decoration: none !important;
        font-size: 12px;
    &#125;
    .form-control .fenge&#123;
        display: flex !important;
    &#125;
    .form-control .neirong&#123;
        flex:1;
    &#125;
    .form-control .neirong:first-child&#123;
        margin-right:5px;
    &#125;
    .form-control .neirong:last-child&#123;
        margin-left:5px;
    &#125;
    .form-control input&#123;
        padding:8px 15px;
    &#125;
    .list-group-item&#123;
        border:1px solid #aaa !important;
        padding:8px 15px;
        border-bottom: 0px !important;
    &#125;
    .list-group-item:last-child&#123;
        border-bottom: 1px solid #aaa !important;
    &#125;
    .neirong input&#123;
        padding:9px !important;
    &#125;
    .list-group-item a&#123;
        background: #719430;
        padding: 5px 15px;
        border-radius: 3px;
        color: #fff;
    &#125;
    @media (max-width:767px)&#123;
    .form-control .fenge&#123;
        display: grid !important;
    &#125;
    .form-control .neirong&#123;
        margin:5px;
    &#125;
    &#125;
&lt;/style&gt;
&lt;br&gt;
&lt;form action=&quot;#&quot; method=&quot;post&quot; class=&quot;form-control&quot;&gt;
    &lt;div class=&quot;fenge&quot;&gt;
        &lt;div class=&quot;neirong&quot;&gt;
            &lt;input type=&quot;text&quot; name=&quot;license&quot; placeholder=&quot;输入序列码&quot; onkeyup=&quot;this.value=this.value.replace(/[^\d]/g,&#39;&#39;) &quot; onafterpaste=&quot;this.value=this.value.replace(/[^\d]/g,&#39;&#39;)&quot; value=&quot;&quot;&gt;
        &lt;/div&gt;
        &lt;div class=&quot;neirong&quot;&gt;
            &lt;select class=&quot;form-control&quot; name=&quot;brand&quot;&gt;
                &lt;option value=&#39;&#39; disabled selected style=&#39;display:none;&#39;&gt;请选择品牌&lt;/option&gt;
                &lt;?php
                    $query_Brand = &quot;SELECT DISTINCT(brand) FROM `wp_license`&quot;;
                    $result_set = mysqli_query($connection, $query_Brand ) or die(mysqli_error($connection));
                    while ($row=mysqli_fetch_array($result_set)) &#123;
                ?&gt;
                    &lt;option value=&quot;&lt;?php echo $row[&#39;brand&#39;];?&gt;&quot;&gt;&lt;?php echo $row[&#39;brand&#39;];?&gt;&lt;/option&gt;
                &lt;?php
                &#125;
                ?&gt;
            &lt;/select&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;查询&quot;&gt;
&lt;/form&gt;

&lt;?php
if (@($_POST[&#39;license&#39;] !== null || $_POST[&#39;brand&#39;] !== null)) &#123;

    $url = home_url();
    $localtime=date(&#39;Y-m-d H:i:s&#39;,time());
    $license=$_POST[&quot;license&quot;];
    $brand=$_POST[&quot;brand&quot;];
    if (empty($license)) &#123;
        $query_Recordset1 = &quot;SELECT * FROM `wp_license` where brand = &#39;$brand&#39;&quot;;
        $Recordset1 = mysqli_query($connection, $query_Recordset1 ) or die(mysqli_error($connection));
        // 记得要注释下面这行，否则查询出来的记录数会少一条：更多可以参考这个网址https://zhidao.baidu.com/question/575162854.html
        // $row_Recordset1 = mysqli_fetch_assoc($Recordset1);
        while ($row=mysqli_fetch_array($Recordset1)) &#123;
        ?&gt;
        &lt;ul class=&quot;list-group&quot;&gt;
        &lt;li class=&quot;list-group-item&quot;&gt;您的序列码为：&lt;?php echo $row[&quot;name&quot;];?&gt;&lt;/li&gt;
        &lt;li class=&quot;list-group-item&quot;&gt;码伪码所属品牌商：&lt;?php echo $row[&quot;brand&quot;] ?&gt;&lt;/li&gt;
        &lt;li class=&quot;list-group-item&quot;&gt;序列码负责人：&lt;?php echo $row[&quot;fuzeren&quot;] ?&gt;&lt;/li&gt;
        &lt;li class=&quot;list-group-item&quot;&gt;所属地区：&lt;?php echo $row[&quot;diqu&quot;] ?&gt;&lt;/li&gt;
        &lt;li class=&quot;list-group-item&quot;&gt;产品名称：&lt;?php echo $row[&quot;chanpin&quot;] ?&gt;&lt;/li&gt;
        &lt;?php
            if ( is_user_logged_in() ) &#123;
                echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;产品检测报告下载：&lt;a  style=&quot;background:red&quot; href=&quot;&#39;.$row[&quot;attachment&quot;].&#39;&quot;&gt;预览&lt;/a&gt; &lt;a href=&quot;&#39;.$row[&quot;attachment&quot;].&#39;&quot; download&gt;下载&lt;/a&gt;&lt;/li&gt;&#39;;
            &#125;
            else&#123;
                echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;产品检测报告下载：&lt;a href=&quot;&#39;.$url.&#39;/wp-login.php&quot;&gt;请登录&lt;/a&gt;&lt;/li&gt;&#39;;
            &#125;
        ?&gt;
        &lt;li class=&quot;list-group-item&quot;&gt;序列码查询时间：&lt;?php echo $localtime; ?&gt;&lt;/li&gt;
        &lt;/ul&gt;
        &lt;?php &#125; ?&gt;
    &lt;?php &#125;
    elseif(empty($brand))&#123;
        $query_Recordset1 = &quot;SELECT * FROM `wp_license` where name =$license&quot;;
        $Recordset1 = mysqli_query($connection, $query_Recordset1 ) or die(mysqli_error($connection));
        $row_Recordset1 = mysqli_fetch_assoc($Recordset1);
        $totalRows_Recordset1 = mysqli_num_rows($Recordset1);
        if ($totalRows_Recordset1 &lt;= 0) &#123;
            echo &quot;请注意！这个序列码无效&lt;br&gt;&quot;;
        &#125;
        else&#123;
            echo &#39;&lt;ul class=&quot;list-group&quot;&gt;&#39;;
            echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;您的序列码为：&#39;.$row_Recordset1[&quot;name&quot;].&#39;&lt;/li&gt;&#39;;
            echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;码伪码所属品牌商：&#39;.$row_Recordset1[&quot;brand&quot;].&#39;&lt;/li&gt;&#39;;
            echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;序列码负责人：&#39;.$row_Recordset1[&quot;fuzeren&quot;].&#39;&lt;/li&gt;&#39;;
            echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;所属地区：&#39;.$row_Recordset1[&quot;diqu&quot;].&#39;&lt;/li&gt;&#39;;
            echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;产品名称：&#39;.$row_Recordset1[&quot;chanpin&quot;].&#39;&lt;/li&gt;&#39;;
            if ( is_user_logged_in() ) &#123;
                echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;产品检测报告下载：&lt;a  style=&quot;background:red&quot; href=&quot;&#39;.$row_Recordset1[&quot;attachment&quot;].&#39;&quot;&gt;预览&lt;/a&gt; &lt;a href=&quot;&#39;.$row_Recordset1[&quot;attachment&quot;].&#39;&quot; download&gt;下载&lt;/a&gt;&lt;/li&gt;&#39;;
            &#125;
            else&#123;
                echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;产品检测报告下载：&lt;a href=&quot;&#39;.$url.&#39;/wp-login.php&quot;&gt;请登录&lt;/a&gt;&lt;/li&gt;&#39;;
            &#125;
            echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;序列码查询时间：&#39;.$localtime.&#39;&lt;/li&gt;&#39;;
            echo &#39;&lt;/ul&gt;&#39;;
            // $delete_requested = &quot;DELETE FROM wp_license WHERE name =$license&quot;;
            // $Recordset2 = mysqli_query($connection, $delete_requested ) or die(mysqli_error($connection));
        &#125;
    &#125;else&#123;
        $query_Recordset1 = &quot;SELECT * FROM `wp_license` where name =$license and brand = &#39;$brand&#39;&quot;;
        $Recordset1 = mysqli_query($connection, $query_Recordset1 ) or die(mysqli_error($connection));
        $row_Recordset1 = mysqli_fetch_assoc($Recordset1);
        $totalRows_Recordset1 = mysqli_num_rows($Recordset1);
        if ($totalRows_Recordset1 &lt;= 0) &#123;
            echo &quot;请注意！这个序列码无效&lt;br&gt;&quot;;
        &#125;
        else&#123;
            echo &#39;&lt;ul class=&quot;list-group&quot;&gt;&#39;;
            echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;您的序列码为：&#39;.$row_Recordset1[&quot;name&quot;].&#39;&lt;/li&gt;&#39;;
            echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;码伪码所属品牌商：&#39;.$row_Recordset1[&quot;brand&quot;].&#39;&lt;/li&gt;&#39;;
            echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;序列码负责人：&#39;.$row_Recordset1[&quot;fuzeren&quot;].&#39;&lt;/li&gt;&#39;;
            echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;所属地区：&#39;.$row_Recordset1[&quot;diqu&quot;].&#39;&lt;/li&gt;&#39;;
            echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;产品名称：&#39;.$row_Recordset1[&quot;chanpin&quot;].&#39;&lt;/li&gt;&#39;;
            if ( is_user_logged_in() ) &#123;
                echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;产品检测报告下载：&lt;a  style=&quot;background:red&quot; href=&quot;&#39;.$row_Recordset1[&quot;attachment&quot;].&#39;&quot;&gt;预览&lt;/a&gt; &lt;a href=&quot;&#39;.$row_Recordset1[&quot;attachment&quot;].&#39;&quot; download&gt;下载&lt;/a&gt;&lt;/li&gt;&#39;;
            &#125;
            else&#123;
                echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;产品检测报告下载：&lt;a href=&quot;&#39;.$url.&#39;/wp-login.php&quot;&gt;请登录&lt;/a&gt;&lt;/li&gt;&#39;;
            &#125;
            echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;序列码查询时间：&#39;.$localtime.&#39;&lt;/li&gt;&#39;;
            echo &#39;&lt;/ul&gt;&#39;;
            // $delete_requested = &quot;DELETE FROM wp_license WHERE name =$license&quot;;
            // $Recordset2 = mysqli_query($connection, $delete_requested ) or die(mysqli_error($connection));
        &#125;
    &#125;  
&#125;
else&#123;
    echo &quot;你没有输入任何内容&quot;;
    return &#39;&#39;;
&#125;
?&gt;</code></pre>
<p>这个里面呢，笔者就讲解一点：</p>
<pre><code>&lt;select class=&quot;form-control&quot; name=&quot;brand&quot;&gt;
    &lt;option value=&#39;&#39; disabled selected style=&#39;display:none;&#39;&gt;请选择品牌&lt;/option&gt;
    &lt;?php
        $query_Brand = &quot;SELECT DISTINCT(brand) FROM `wp_license`&quot;;
        $result_set = mysqli_query($connection, $query_Brand ) or die(mysqli_error($connection));
        while ($row=mysqli_fetch_array($result_set)) &#123;
    ?&gt;
        &lt;option value=&quot;&lt;?php echo $row[&#39;brand&#39;];?&gt;&quot;&gt;&lt;?php echo $row[&#39;brand&#39;];?&gt;&lt;/option&gt;
    &lt;?php
    &#125;
    ?&gt;
&lt;/select&gt;</code></pre>
<p>这个是获取字段值列表的一个方法，这里就是获取数据表<code>wp_license</code>中<code>brand</code>这个字段的去重后条目列表。</p>
<pre><code>$query_Brand = &quot;SELECT DISTINCT(brand) FROM `wp_license`&quot;;</code></pre>
<p>接着，就是连接服务器的数据库进行查询，</p>
<pre><code>$result_set = mysqli_query($connection, $query_Brand ) or die(mysqli_error($connection));</code></pre>
<p>把查询结果保存在变量 <code>$result_set </code>中。然后采用php的方法<code>mysqli_fetch_array</code>，这个方法说明如下：</p>
<pre><code>语法
mysql_fetch_array(data,array_type)</code></pre>
<table class="dataintable"><tbody><tr><th>参数</th><th>描述</th></tr><tr><td><i>data</i></td><td>可选。规定要使用的数据指针。该数据指针是 mysql_query() 函数产生的结果。</td></tr><tr><td><i>array_type</i></td><td><p>可选。规定返回哪种结果。可能的值：</p><ul class="listintable"><li>MYSQL_ASSOC - 关联数组</li><li>MYSQL_NUM - 数字数组</li><li>MYSQL_BOTH - 默认。同时产生关联和数字数组</li></ul></td></tr></tbody></table>

<p>所以，这里的data就是<code>$result_set</code>，第二个参数我们不填就是默认了。</p>
<p>接着就是通过while语句进行循环遍历了，这里有个问题就是在下拉框就会显示第一个option的选项来，这个不合理，所以笔者在这个前面添加了一个，</p>
<pre><code>&lt;option value=&#39;&#39; disabled selected style=&#39;display:none;&#39;&gt;请选择品牌&lt;/option&gt;</code></pre>
<p>这个就是把这个作为第一行，然后禁用并且隐藏，添加后的效果就是：</p>
<p><img src="https://i.imgur.com/BglzORn.png"></p>
<p>这个来源的于这个：</p>
<pre><code>&lt;select&gt;
    &lt;option value=&#39;&#39; disabled selected style=&#39;display:none;&#39;&gt;Please Choose&lt;/option&gt;
    &lt;option value=&#39;苹果&#39;&gt;苹果&lt;/option&gt;
    &lt;option value=&#39;梨子&#39;&gt;梨子&lt;/option&gt;
&lt;/select&gt;</code></pre>
<p>效果如下：</p>
<select>
<option value='' disabled selected style='display:none;'>请选择</option>
<option value='苹果'>苹果</option>
<option value='梨子'>梨子</option>
</select>

<p>还有，这里笔者用了一个判断：</p>
<pre><code>@($_POST[&#39;license&#39;] !== null || $_POST[&#39;brand&#39;] !== null)</code></pre>
<p>因为是当前页提交，当前页显示，所以这里需要来个判断，不然第一次打开的时候，就会提示你的提交为空，这样用户体验不好，这里添加一个<code>@</code>也是为了把报错信息隐藏掉。免得输出在前台。</p>
<p>好吧言归正传，这个里面笔者有写样式代码，有写html代码，最后的那部分是php代码，大家可以仔细分析下是如何实现的，其实很简单。在php代码里有个判断语句，作为不同的情况采用不同的查询方法，呈现不同的查询结果。值得提醒的是有序列码的情况，由于序列码是独一无二的，所以，就不会出现多条记录的情况。而当序列码为空的情况，就会出现多个记录的情况，这个时候，笔者采用的是while语句的方法来通过循环的形式呈现结果，如下代码片段：</p>
<pre><code>if (empty($license)) &#123;
    $query_Recordset1 = &quot;SELECT * FROM `wp_license` where brand = &#39;$brand&#39;&quot;;
    $Recordset1 = mysqli_query($connection, $query_Recordset1 ) or die(mysqli_error($connection));
    // 记得要注释下面这行，否则查询出来的记录数会少一条：https://zhidao.baidu.com/question/575162854.html
    // $row_Recordset1 = mysqli_fetch_assoc($Recordset1);
    // $totalRows_Recordset1 = mysqli_num_rows($Recordset1);
    while ($row=mysqli_fetch_array($Recordset1)) &#123;
    ?&gt;
    &lt;ul class=&quot;list-group&quot;&gt;
    &lt;li class=&quot;list-group-item&quot;&gt;您的序列码为：&lt;?php echo $row[&quot;name&quot;];?&gt;&lt;/li&gt;
    &lt;li class=&quot;list-group-item&quot;&gt;码伪码所属品牌商：&lt;?php echo $row[&quot;brand&quot;] ?&gt;&lt;/li&gt;
    &lt;li class=&quot;list-group-item&quot;&gt;序列码负责人：&lt;?php echo $row[&quot;fuzeren&quot;] ?&gt;&lt;/li&gt;
    &lt;li class=&quot;list-group-item&quot;&gt;所属地区：&lt;?php echo $row[&quot;diqu&quot;] ?&gt;&lt;/li&gt;
    &lt;li class=&quot;list-group-item&quot;&gt;产品名称：&lt;?php echo $row[&quot;chanpin&quot;] ?&gt;&lt;/li&gt;
    &lt;?php
        if ( is_user_logged_in() ) &#123;
            echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;产品检测报告下载：&lt;a  style=&quot;background:red&quot; href=&quot;&#39;.$row[&quot;attachment&quot;].&#39;&quot;&gt;预览&lt;/a&gt; &lt;a href=&quot;&#39;.$row[&quot;attachment&quot;].&#39;&quot; download&gt;下载&lt;/a&gt;&lt;/li&gt;&#39;;
        &#125;
        else&#123;
            echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;产品检测报告下载：&lt;a href=&quot;&#39;.$url.&#39;/wp-login.php&quot;&gt;请登录&lt;/a&gt;&lt;/li&gt;&#39;;
        &#125;
    ?&gt;
    &lt;li class=&quot;list-group-item&quot;&gt;序列码查询时间：&lt;?php echo $localtime; ?&gt;&lt;/li&gt;
    &lt;/ul&gt;
    &lt;?php &#125; ?&gt;
&lt;?php &#125;</code></pre>
<p>在这个地方笔者就遇到一个bug，每次查询出来的结果总是少一条，后来发现：</p>
<pre><code>$row_Recordset1 = mysqli_fetch_assoc($Recordset1);</code></pre>
<p>这个事实上是，<code>mysqli_fetch_assoc</code>从结果集中取得一行作为关联数组，这里说明一下这个函数：</p>
<blockquote>
<p>返回根据从结果集取得的行生成的关联数组，如果没有更多行，则返回 false。</p>
</blockquote>
<blockquote>
<p>mysql_fetch_assoc()将数据作为关联索引储存，用字段名作为键名。如果结果中的两个或以上的列具有相同字段名，最后一列将优先。要访问同名的其它列，必须用该列的数字索引或给该列起个别名。对有别名的列，不能再用原来的列名访问其内容。</p>
</blockquote>
<p>了解更多的话：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/blogforly/p/5910191.html">https://www.cnblogs.com/blogforly/p/5910191.html</a></p>
<p>里面还有这样两条代码：</p>
<pre><code>$delete_requested = &quot;DELETE FROM wp_license WHERE name =$license&quot;;
$Recordset2 = mysqli_query($connection, $delete_requested ) or die(mysqli_error($connection));</code></pre>
<p>这个被笔者注释了，这个就是要实现防伪码每次查询后，就不能第二次查询了，这里用的是查询一条就删除一条的方式。</p>
<p>笔者这里采用的是在当前页面实现，所以在form的action的那里用的是<code>#</code>。</p>
<p>好的，说道这里就差不多了，这里实现了防伪码的添加和查询。</p>
<p>作为更加深入的探索，笔者还实现了三重搜索过滤功能的，笔者这里复制上面的license_search_3.php的文件，然后命名为：license_search_2.php，完整码如下：</p>
<pre><code>&lt;?php
/**
 *
    Template Name: 序列码查询三重过滤搜索
 *
 * This is the template that displays all pages by default.
 * Please note that this is the WordPress construct of pages and that
 * other &quot;pages&quot; on your WordPress site will use a different template.
 *
 * @package WordPress
 * @subpackage Twenty_Fifteen
 * @since Twenty Fifteen 1.0
 */

if ( !defined(&#39;ABSPATH&#39;) )&#123; die(); &#125;

    global $avia_config;

    /*
     * get_header is a basic wordpress function, used to retrieve the header.php file in your theme directory.
     */
     get_header();


      if( get_post_meta(get_the_ID(), &#39;header&#39;, true) != &#39;no&#39;) echo avia_title();

      do_action( &#39;ava_after_main_title&#39; );
?&gt;

&lt;!-- 添加自定义数据库连接信息 开始 --&gt;
&lt;?php
$genmul=$_SERVER[&#39;DOCUMENT_ROOT&#39;];
require_once(&quot;$genmul/wordpress/wp-config.php&quot;);
// 如果我们采用的不是子目录方式（wordpress放在服务器的wordrpess的文件夹下），就采用如下方式：
// require_once(&quot;$genmul/wp-config.php&quot;);
// 方式二 结束

//链接mysql服务器 开始
$connection = mysqli_connect(DB_HOST, DB_USER, DB_PASSWORD);
mysqli_select_db($connection, DB_NAME);
//链接mysql服务器 结束

?&gt;
&lt;!-- 添加自定义数据库连接信息 结束 --&gt;


&lt;div class=&#39;container_wrap container_wrap_first main_color &lt;?php avia_layout_class( &#39;main&#39; ); ?&gt;&#39;&gt;

            &lt;div class=&#39;container license2&#39;&gt;

                &lt;main class=&#39;template-page content  &lt;?php avia_layout_class( &#39;content&#39; ); ?&gt; units&#39; &lt;?php avia_markup_helper(array(&#39;context&#39; =&gt; &#39;content&#39;,&#39;post_type&#39;=&gt;&#39;page&#39;));?&gt;&gt;

                    &lt;?php
                    /* Run the loop to output the posts.
                    * If you want to overload this in a child theme then include a file
                    * called loop-page.php and that will be used instead.
                    */

                    $avia_config[&#39;size&#39;] = avia_layout_class( &#39;main&#39; , false) == &#39;fullsize&#39; ? &#39;entry_without_sidebar&#39; : &#39;entry_with_sidebar&#39;;
                    get_template_part( &#39;includes/loop&#39;, &#39;page&#39; );
                    ?&gt;


                    &lt;style&gt;
                        .license2 .list-group&#123;
                            margin:0px;
                            margin-bottom: 20px;
                        &#125;
                        .license2 a&#123;
                            text-decoration: none !important;
                            font-size: 12px;
                        &#125;
                        .license2 .form-control .fenge&#123;
                            display: flex !important;
                        &#125;
                        .license2 .form-control .neirong&#123;
                            flex:1;
                        &#125;
                        .license2 .form-control .neirong:first-child&#123;
                            margin-right:5px;
                        &#125;
                        .license2 .form-control .neirong:last-child&#123;
                            margin-left:5px;
                        &#125;
                        .license2 .form-control input&#123;
                            padding:8px 15px;
                        &#125;
                        .license2 .list-group-item&#123;
                            border:1px solid #aaa !important;
                            padding:8px 15px;
                            border-bottom: 0px !important;
                        &#125;
                        .license2 .list-group-item:last-child&#123;
                            border-bottom: 1px solid #aaa !important;
                        &#125;
                        .neirong input&#123;
                            padding:9px !important;
                        &#125;
                        .license2 .list-group-item a&#123;
                            background: #719430;
                            padding: 5px 15px;
                            border-radius: 3px;
                            color: #fff;
                        &#125;
                        @media (max-width:767px)&#123;
                        .license2 .form-control .fenge&#123;
                            display: grid !important;
                        &#125;
                        .license2 .form-control .neirong&#123;
                            margin:5px;
                        &#125;
                        &#125;
                    &lt;/style&gt;


                    &lt;br&gt;
                    &lt;form action=&quot;#&quot; method=&quot;post&quot; class=&quot;form-control&quot;&gt;
                        &lt;div class=&quot;fenge&quot;&gt;
                            &lt;div class=&quot;neirong&quot;&gt;
                                &lt;input type=&quot;text&quot; name=&quot;license&quot; placeholder=&quot;输入序列码&quot;&gt;
                            &lt;/div&gt;
                            &lt;div class=&quot;neirong&quot;&gt;
                                &lt;select class=&quot;form-control&quot; name=&quot;brand&quot;&gt;
                                    &lt;option value=&#39;&#39; disabled selected style=&#39;display:none;&#39;&gt;请选择品牌&lt;/option&gt;
                                    &lt;?php
                                        $query_Brand = &quot;SELECT DISTINCT(brand) FROM `wp_license`&quot;;
                                        $result_brand = mysqli_query($connection, $query_Brand ) or die(mysqli_error($connection));
                                        while ($row=mysqli_fetch_array($result_brand)) &#123;
                                    ?&gt;
                                        &lt;option value=&quot;&lt;?php echo $row[&#39;brand&#39;];?&gt;&quot;&gt;&lt;?php echo $row[&#39;brand&#39;];?&gt;&lt;/option&gt;
                                    &lt;?php
                                    &#125;
                                    ?&gt;
                                &lt;/select&gt;
                            &lt;/div&gt;
                            &lt;div class=&quot;neirong&quot;&gt;
                                &lt;select class=&quot;form-control&quot; name=&quot;diqu&quot;&gt;
                                    &lt;option value=&#39;&#39; disabled selected style=&#39;display:none;&#39;&gt;请选择地区&lt;/option&gt;
                                    &lt;?php
                                        $query_Diqu = &quot;SELECT DISTINCT(diqu) FROM `wp_license`&quot;;
                                        $result_diqu = mysqli_query($connection, $query_Diqu ) or die(mysqli_error($connection));
                                        while ($rr=mysqli_fetch_array($result_diqu)) &#123;
                                    ?&gt;
                                        &lt;option value=&quot;&lt;?php echo $rr[&#39;diqu&#39;];?&gt;&quot;&gt;&lt;?php echo $rr[&#39;diqu&#39;];?&gt;&lt;/option&gt;
                                    &lt;?php
                                    &#125;
                                    ?&gt;
                                &lt;/select&gt;
                            &lt;/div&gt;
                        &lt;/div&gt;
                        &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;查询&quot;&gt;
                    &lt;/form&gt;

                    &lt;?php
                    if (@($_POST[&#39;license&#39;] !== null || $_POST[&#39;brand&#39;] !== null || $_POST[&#39;diqu&#39;] !== null)) &#123;

                        $url = home_url();
                        $localtime=date(&#39;Y-m-d H:i:s&#39;,time());
                        $license=$_POST[&quot;license&quot;];
                        $brand=$_POST[&quot;brand&quot;];
                        $diqu=$_POST[&quot;diqu&quot;];
                        if (($license == null) &amp;&amp; ($brand != null) &amp;&amp; ($diqu != null)) &#123;
                            $query_Recordset1 = &quot;SELECT * FROM `wp_license` where brand = &#39;$brand&#39; and diqu = &#39;$diqu&#39;&quot;;
                            $Recordset1 = mysqli_query($connection, $query_Recordset1 ) or die(mysqli_error($connection));
                            $totalRows_Recordset4 = mysqli_num_rows($Recordset1);
                            if ($totalRows_Recordset4 &lt;= 0) &#123;
                                echo &quot;请注意！这个序列码无效aa&lt;br&gt;&quot;;
                                // exit;
                            &#125;else&#123;
                                while ($row=mysqli_fetch_array($Recordset1)) &#123;
                                ?&gt;
                                &lt;ul class=&quot;list-group&quot;&gt;
                                &lt;li class=&quot;list-group-item&quot;&gt;序列码：&lt;?php echo $row[&quot;name&quot;];?&gt;&lt;/li&gt;
                                &lt;li class=&quot;list-group-item&quot;&gt;防伪码所属品牌商：&lt;?php echo $row[&quot;brand&quot;] ?&gt;&lt;/li&gt;
                                &lt;li class=&quot;list-group-item&quot;&gt;序列码负责人：&lt;?php echo $row[&quot;fuzeren&quot;] ?&gt;&lt;/li&gt;
                                &lt;li class=&quot;list-group-item&quot;&gt;所属地区：&lt;?php echo $row[&quot;diqu&quot;] ?&gt;&lt;/li&gt;
                                &lt;li class=&quot;list-group-item&quot;&gt;产品名称：&lt;?php echo $row[&quot;chanpin&quot;] ?&gt;&lt;/li&gt;
                                &lt;?php
                                    if ( is_user_logged_in() ) &#123;
                                        echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;产品检测报告下载：&lt;a style=&quot;background:red&quot; href=&quot;&#39;.$row[&quot;attachment&quot;].&#39;&quot;&gt;预览&lt;/a&gt; &lt;a href=&quot;&#39;.$row[&quot;attachment&quot;].&#39;&quot; downloaded&gt;下载&lt;/a&gt;&lt;/li&gt;&#39;;
                                    &#125;
                                    else&#123;
                                        echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;产品检测报告下载：&lt;a href=&quot;&#39;.$url.&#39;/wp-login.php&quot;&gt;请登录&lt;/a&gt;&lt;/li&gt;&#39;;
                                    &#125;
                                ?&gt;
                                &lt;li class=&quot;list-group-item&quot;&gt;序列码查询时间：&lt;?php echo $localtime ?&gt;&lt;/li&gt;
                                &lt;/ul&gt;
                                &lt;?php &#125; ?&gt;
                        &lt;?php &#125; ?&gt;
                        &lt;?php &#125;
                        elseif (($brand == null) &amp;&amp; ($license != null) &amp;&amp; ($diqu != null)) &#123;
                            $query_Recordset1 = &quot;SELECT * FROM `wp_license` where name =&#39;$license&#39; and diqu = &#39;$diqu&#39;&quot;;
                            $Recordset1 = mysqli_query($connection, $query_Recordset1 ) or die(mysqli_error($connection));
                            $row_Recordset2 = mysqli_fetch_assoc($Recordset1);
                            $totalRows_Recordset4 = mysqli_num_rows($Recordset1);
                            if ($totalRows_Recordset4 &lt;= 0) &#123;
                                echo &quot;请注意！这个序列码无效wetreh&lt;br&gt;&quot;;
                                // exit;
                            &#125;else&#123;
                                echo &#39;&lt;ul class=&quot;list-group&quot;&gt;&#39;;
                                echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;您的序列码为：&#39;.$row_Recordset2[&quot;name&quot;].&#39;&lt;/li&gt;&#39;;
                                echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;码伪码所属品牌商：&#39;.$row_Recordset2[&quot;brand&quot;].&#39;&lt;/li&gt;&#39;;
                                echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;序列码负责人：&#39;.$row_Recordset2[&quot;fuzeren&quot;].&#39;&lt;/li&gt;&#39;;
                                echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;所属地区：&#39;.$row_Recordset2[&quot;diqu&quot;].&#39;&lt;/li&gt;&#39;;
                                echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;产品名称：&#39;.$row_Recordset2[&quot;chanpin&quot;].&#39;&lt;/li&gt;&#39;;
                                if (is_user_logged_in()) &#123;
                                    echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;产品检测报告下载：&lt;a style=&quot;background:red&quot; href=&quot;&#39;.$row_Recordset2[&quot;attachment&quot;].&#39;&quot;&gt;预览&lt;/a&gt; &lt;a href=&quot;&#39;.$row_Recordset2[&quot;attachment&quot;].&#39;&quot; download&gt;下载&lt;/a&gt;&lt;/li&gt;&#39;;
                                &#125;
                                else&#123;
                                    echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;产品检测报告下载：&lt;a href=&quot;&#39;.$url.&#39;/wp-login.php&quot;&gt;请登录&lt;/a&gt;&lt;/li&gt;&#39;;
                                &#125;
                                echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;序列码查询时间：&#39;.$localtime.&#39;&lt;/li&gt;&#39;;
                                echo &#39;&lt;/ul&gt;&#39;;
                            &#125;
                        &#125;
                        elseif (($diqu == null) &amp;&amp; ($license != null) &amp;&amp; ($brand != null)) &#123;
                            $query_Recordset1 = &quot;SELECT * FROM `wp_license` where name =&#39;$license&#39; and brand = &#39;$brand&#39;&quot;;
                            $Recordset1 = mysqli_query($connection, $query_Recordset1) or die(mysqli_error($connection));
                            $row_Recordset2 = mysqli_fetch_assoc($Recordset1);
                            $totalRows_Recordset2 = mysqli_num_rows($Recordset1);
                            if ($totalRows_Recordset2 &lt;= 0) &#123;
                                echo &quot;请注意！这个序列码无效www&lt;br&gt;&quot;;
                                // exit;
                            &#125;else&#123;
                                echo &#39;&lt;ul class=&quot;list-group&quot;&gt;&#39;;
                                echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;您的序列码为：&#39;.$row_Recordset2[&quot;name&quot;].&#39;&lt;/li&gt;&#39;;
                                echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;码伪码所属品牌商：&#39;.$row_Recordset2[&quot;brand&quot;].&#39;&lt;/li&gt;&#39;;
                                echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;序列码负责人：&#39;.$row_Recordset2[&quot;fuzeren&quot;].&#39;&lt;/li&gt;&#39;;
                                echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;所属地区：&#39;.$row_Recordset2[&quot;diqu&quot;].&#39;&lt;/li&gt;&#39;;
                                echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;产品名称：&#39;.$row_Recordset2[&quot;chanpin&quot;].&#39;&lt;/li&gt;&#39;;
                                if (is_user_logged_in()) &#123;
                                    echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;产品检测报告下载：&lt;a style=&quot;background:red&quot; href=&quot;&#39;.$row_Recordset2[&quot;attachment&quot;].&#39;&quot;&gt;预览&lt;/a&gt; &lt;a href=&quot;&#39;.$row_Recordset2[&quot;attachment&quot;].&#39;&quot; download&gt;下载&lt;/a&gt;&lt;/li&gt;&#39;;
                                &#125;
                                else&#123;
                                    echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;产品检测报告下载：&lt;a href=&quot;&#39;.$url.&#39;/wp-login.php&quot;&gt;请登录&lt;/a&gt;&lt;/li&gt;&#39;;
                                &#125;
                                echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;序列码查询时间：&#39;.$localtime.&#39;&lt;/li&gt;&#39;;
                                echo &#39;&lt;/ul&gt;&#39;;
                            &#125;
                        &#125;
                        elseif (($brand == null) &amp;&amp; ($diqu == null) &amp;&amp; ($license != null)) &#123;
                            $query_Recordset1 = &quot;SELECT * FROM `wp_license` where name = $license&quot;;

                            $Recordset1 = mysqli_query($connection, $query_Recordset1 ) or die(mysqli_error($connection));
                            $row_Recordset1 = mysqli_fetch_assoc($Recordset1);
                            $totalRows_Recordset4 = mysqli_num_rows($Recordset1);
                            if ($totalRows_Recordset4 &lt;= 0) &#123;
                                echo &quot;请注意！这个序列码无效,没有品牌&lt;br&gt;&quot;;
                                // exit;
                            &#125;else&#123;
                                echo &#39;&lt;ul class=&quot;list-group&quot;&gt;&#39;;
                                echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;序列码为：&#39;.$row_Recordset1[&quot;name&quot;].&#39;&lt;/li&gt;&#39;;
                                echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;防伪码所属品牌商：&#39;.$row_Recordset1[&quot;brand&quot;].&#39;&lt;/li&gt;&#39;;
                                echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;序列码负责人：&#39;.$row_Recordset1[&quot;fuzeren&quot;].&#39;&lt;/li&gt;&#39;;
                                echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;所属地区：&#39;.$row_Recordset1[&quot;diqu&quot;].&#39;&lt;/li&gt;&#39;;
                                echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;产品名称：&#39;.$row_Recordset1[&quot;chanpin&quot;].&#39;&lt;/li&gt;&#39;;
                                if ( is_user_logged_in() ) &#123;
                                    echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;产品检测报告下载：&lt;a style=&quot;background:red&quot; href=&quot;&#39;.$row_Recordset1[&quot;attachment&quot;].&#39;&quot;&gt;预览&lt;/a&gt; &lt;a href=&quot;&#39;.$row_Recordset1[&quot;attachment&quot;].&#39;&quot; download&gt;下载&lt;/a&gt;&lt;/li&gt;&#39;;
                                &#125;
                                else&#123;
                                    echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;产品检测报告下载：&lt;a href=&quot;&#39;.$url.&#39;/wp-login.php&quot;&gt;请登录&lt;/a&gt;&lt;/li&gt;&#39;;
                                &#125;
                                echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;序列码查询时间：&#39;.$localtime.&#39;&lt;/li&gt;&#39;;
                                echo &#39;&lt;/ul&gt;&#39;;
                                // $delete_requested = &quot;DELETE FROM wp_license WHERE name =$license&quot;;
                                // $Recordset2 = mysqli_query($connection, $delete_requested ) or die(mysqli_error($connection));
                            &#125;
                        &#125;
                        elseif (($brand != null) &amp;&amp; ($license == null) &amp;&amp; ($diqu == null)) &#123;
                            $query_Recordset1 = &quot;SELECT * FROM `wp_license` where brand = &#39;$brand&#39;&quot;;
                            $Recordset1 = mysqli_query($connection, $query_Recordset1 ) or die(mysqli_error($connection));
                            $totalRows_Recordset4 = mysqli_num_rows($Recordset1);
                            if ($totalRows_Recordset4 &lt;= 0) &#123;
                                echo &quot;请注意！这个序列码无效app&lt;br&gt;&quot;;
                                exit;
                            &#125;else&#123;
                                while ($row=mysqli_fetch_array($Recordset1)) &#123;
                                ?&gt;
                                &lt;ul class=&quot;list-group&quot;&gt;
                                &lt;li class=&quot;list-group-item&quot;&gt;序列码：&lt;?php echo $row[&quot;name&quot;];?&gt;&lt;/li&gt;
                                &lt;li class=&quot;list-group-item&quot;&gt;防伪码所属品牌商：&lt;?php echo $row[&quot;brand&quot;] ?&gt;&lt;/li&gt;
                                &lt;li class=&quot;list-group-item&quot;&gt;序列码负责人：&lt;?php echo $row[&quot;fuzeren&quot;] ?&gt;&lt;/li&gt;
                                &lt;li class=&quot;list-group-item&quot;&gt;所属地区：&lt;?php echo $row[&quot;diqu&quot;] ?&gt;&lt;/li&gt;
                                &lt;li class=&quot;list-group-item&quot;&gt;产品名称：&lt;?php echo $row[&quot;chanpin&quot;] ?&gt;&lt;/li&gt;
                                &lt;?php
                                    if ( is_user_logged_in() ) &#123;
                                        echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;产品检测报告下载：&lt;a style=&quot;background:red&quot; href=&quot;&#39;.$row[&quot;attachment&quot;].&#39;&quot;&gt;预览&lt;/a&gt; &lt;a href=&quot;&#39;.$row[&quot;attachment&quot;].&#39;&quot; downloaded&gt;下载&lt;/a&gt;&lt;/li&gt;&#39;;
                                    &#125;
                                    else&#123;
                                        echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;产品检测报告下载：&lt;a href=&quot;&#39;.$url.&#39;/wp-login.php&quot;&gt;请登录&lt;/a&gt;&lt;/li&gt;&#39;;
                                    &#125;
                                ?&gt;
                                &lt;li class=&quot;list-group-item&quot;&gt;序列码查询时间：&lt;?php echo $localtime; ?&gt;&lt;/li&gt;
                                &lt;/ul&gt;
                                &lt;?php &#125; ?&gt;
                        &lt;?php &#125; ?&gt;
                        &lt;?php &#125;
                        elseif (($diqu != null) &amp;&amp; ($license == null) &amp;&amp; ($brand == null)) &#123;
                            $query_Recordset1 = &quot;SELECT * FROM `wp_license` where diqu = &#39;$diqu&#39;&quot;;
                            $Recordset1 = mysqli_query($connection, $query_Recordset1 ) or die(mysqli_error($connection));
                            $totalRows_Recordset4 = mysqli_num_rows($Recordset1);
                            if ($totalRows_Recordset4 &lt;= 0) &#123;
                                echo &quot;请注意！这个序列码无效ama&lt;br&gt;&quot;;
                                // exit;
                            &#125;else&#123;
                                while ($row=mysqli_fetch_array($Recordset1)) &#123;
                                ?&gt;
                                &lt;ul class=&quot;list-group&quot;&gt;
                                &lt;li class=&quot;list-group-item&quot;&gt;序列码：&lt;?php echo $row[&quot;name&quot;];?&gt;&lt;/li&gt;
                                &lt;li class=&quot;list-group-item&quot;&gt;防伪码所属品牌商：&lt;?php echo $row[&quot;brand&quot;] ?&gt;&lt;/li&gt;
                                &lt;li class=&quot;list-group-item&quot;&gt;序列码负责人：&lt;?php echo $row[&quot;fuzeren&quot;] ?&gt;&lt;/li&gt;
                                &lt;li class=&quot;list-group-item&quot;&gt;所属地区：&lt;?php echo $row[&quot;diqu&quot;] ?&gt;&lt;/li&gt;
                                &lt;li class=&quot;list-group-item&quot;&gt;产品名称：&lt;?php echo $row[&quot;chanpin&quot;] ?&gt;&lt;/li&gt;
                                &lt;?php
                                    if ( is_user_logged_in() ) &#123;
                                        echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;产品检测报告下载：&lt;a style=&quot;background:red&quot; href=&quot;&#39;.$row[&quot;attachment&quot;].&#39;&quot;&gt;预览&lt;/a&gt; &lt;a href=&quot;&#39;.$row[&quot;attachment&quot;].&#39;&quot; downloaded&gt;下载&lt;/a&gt;&lt;/li&gt;&#39;;
                                    &#125;
                                    else&#123;
                                        echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;产品检测报告下载：&lt;a href=&quot;&#39;.$url.&#39;/wp-login.php&quot;&gt;请登录&lt;/a&gt;&lt;/li&gt;&#39;;
                                    &#125;
                                ?&gt;
                                &lt;li class=&quot;list-group-item&quot;&gt;序列码查询时间：&lt;?php echo $localtime; ?&gt;&lt;/li&gt;
                                &lt;/ul&gt;
                                &lt;?php &#125; ?&gt;
                        &lt;?php &#125; ?&gt;
                        &lt;?php &#125;
                        else&#123;
                            $query_Recordset2 = &quot;SELECT * FROM `wp_license` where name = &#39;$license&#39; and brand = &#39;$brand&#39; and diqu = &#39;$diqu&#39;&quot;;
                            $Recordset2 = mysqli_query($connection, $query_Recordset2 ) or die(mysqli_error($connection));
                            $row_Recordset2 = mysqli_fetch_assoc($Recordset2);
                            $totalRows_Recordset2 = mysqli_num_rows($Recordset2);
                            if ($totalRows_Recordset2 &lt;= 0) &#123;
                                echo &quot;请注意！这个序列码无效qqw&lt;br&gt;&quot;;
                                // exit;
                            &#125;else&#123;
                                echo &#39;&lt;ul class=&quot;list-group&quot;&gt;&#39;;
                                echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;您的序列码为：&#39;.$row_Recordset2[&quot;name&quot;].&#39;&lt;/li&gt;&#39;;
                                echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;码伪码所属品牌商：&#39;.$row_Recordset2[&quot;brand&quot;].&#39;&lt;/li&gt;&#39;;
                                echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;序列码负责人：&#39;.$row_Recordset2[&quot;fuzeren&quot;].&#39;&lt;/li&gt;&#39;;
                                echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;所属地区：&#39;.$row_Recordset2[&quot;diqu&quot;].&#39;&lt;/li&gt;&#39;;
                                echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;产品名称：&#39;.$row_Recordset2[&quot;chanpin&quot;].&#39;&lt;/li&gt;&#39;;
                                if (is_user_logged_in()) &#123;
                                    echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;产品检测报告下载：&lt;a style=&quot;background:red&quot; href=&quot;&#39;.$row_Recordset2[&quot;attachment&quot;].&#39;&quot;&gt;预览&lt;/a&gt; &lt;a href=&quot;&#39;.$row_Recordset2[&quot;attachment&quot;].&#39;&quot; download&gt;下载&lt;/a&gt;&lt;/li&gt;&#39;;
                                &#125;
                                else&#123;
                                    echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;产品检测报告下载：&lt;a href=&quot;&#39;.$url.&#39;/wp-login.php&quot;&gt;请登录&lt;/a&gt;&lt;/li&gt;&#39;;
                                &#125;
                                echo &#39;&lt;li class=&quot;list-group-item&quot;&gt;序列码查询时间：&#39;.$localtime.&#39;&lt;/li&gt;&#39;;
                                echo &#39;&lt;/ul&gt;&#39;;
                            &#125;
                        &#125;

                    &#125;
                    else&#123;
                        echo &quot;你没有输入任何内容&quot;;
                        return &#39;&#39;;
                    &#125;
                    ?&gt;




                &lt;!--end content--&gt;
                &lt;/main&gt;

                &lt;?php

                //get the sidebar
                $avia_config[&#39;currently_viewing&#39;] = &#39;page&#39;;
                get_sidebar();

                ?&gt;

            &lt;/div&gt;&lt;!--end container--&gt;

        &lt;/div&gt;&lt;!-- close default .container_wrap element --&gt;


&lt;?php get_footer(); ?&gt;</code></pre>
<p>上面已经说了很多了，笔者就不啰嗦了，这里只说一点：</p>
<p>笔者在进行测试的时候发现，这个在序列码为空的情况下，其他两个非空的情况下查不出东西，足足折腾了三个小时，后来发现笔者把<code>==</code>的否定形式写成了<code>!==</code></p>
<p>后来纠正了一下，把</p>
<pre><code>($brand == null) &amp;&amp; ($license !== null) &amp;&amp; ($diqu != null)</code></pre>
<p>中的都改成了</p>
<pre><code>($brand == null) &amp;&amp; ($license != null) &amp;&amp; ($diqu != null)</code></pre>
<p>后面终于正常了，其实呢笔者这样实现一个三重过滤功能是比较低级水平的，可是笔者只能先实现了，后面再进行升级，看下如何用更少的代码实现这个功能。最后的效果：</p>
<p><img src="https://i.imgur.com/wuR1Rt7.png"></p>
<p><img src="https://i.imgur.com/Bo9EqCY.png"></p>
<p>代码笔者已经打包上传到云盘了，大家可以在这里下载：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1ve-HVXmP-8vDQAusR_N76Q">https://pan.baidu.com/s/1ve-HVXmP-8vDQAusR_N76Q</a>，密码：8nz7</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://helongquan.github.io/2018/09/03/magento%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91%E4%B9%8B%E5%85%88%E7%99%BB%E5%BD%95%E6%89%8D%E8%83%BD%E6%9F%A5%E7%9C%8B%E5%86%85%E5%AE%B9%EF%BC%8C%E5%B9%B6%E4%B8%94%E7%99%BB%E5%BD%95%E5%90%8E%E8%B7%B3%E5%9B%9E%E5%88%B0%E5%BD%93%E5%89%8D%E9%A1%B5%E9%9D%A2%EF%BC%8C%E4%BB%A5%E5%8F%8A%E4%B8%BA%E9%A1%B5%E9%9D%A2%E6%B7%BB%E5%8A%A0%E8%81%94%E7%B3%BB%E8%A1%A8%E5%8D%95%E5%8A%9F%E8%83%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="泉哥">
      <meta itemprop="description" content="日记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鸢尾花序">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/09/03/magento%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91%E4%B9%8B%E5%85%88%E7%99%BB%E5%BD%95%E6%89%8D%E8%83%BD%E6%9F%A5%E7%9C%8B%E5%86%85%E5%AE%B9%EF%BC%8C%E5%B9%B6%E4%B8%94%E7%99%BB%E5%BD%95%E5%90%8E%E8%B7%B3%E5%9B%9E%E5%88%B0%E5%BD%93%E5%89%8D%E9%A1%B5%E9%9D%A2%EF%BC%8C%E4%BB%A5%E5%8F%8A%E4%B8%BA%E9%A1%B5%E9%9D%A2%E6%B7%BB%E5%8A%A0%E8%81%94%E7%B3%BB%E8%A1%A8%E5%8D%95%E5%8A%9F%E8%83%BD/" class="post-title-link" itemprop="url">magento模块开发之先登录才能查看内容，并且登录后跳回到当前页面，以及为页面添加联系表单功能</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-09-03 18:26:54" itemprop="dateCreated datePublished" datetime="2018-09-03T18:26:54+08:00">2018-09-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 11:58:01" itemprop="dateModified" datetime="2020-10-11T11:58:01+08:00">2020-10-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/magento1/" itemprop="url" rel="index"><span itemprop="name">magento1</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>笔者想要实现这样一个系列功能：有些内容，笔者需要先让用户登录后才能查看，没有登录的情况下显示的是一段文本：先登录。然后用户就需要点击登录链接进行登录，登录完毕后会自动跳转回到那个页面去，我想这个对用户体验是良好的。</p>
<p>实现方式如下：</p>
<h2 id="找到目标"><a href="#找到目标" class="headerlink" title="找到目标"></a>找到目标</h2><p>比如我们对自己自定义模块的某个地方，为了方便说明，笔者这里就拿现成的一个自定义模块（Counter）来进行演示吧。</p>
<p>我们找到这个模块对应的模板文件：app/design/frontend/yourtheme/default/template/counter/counter.phtml，打开</p>
<p>这里笔者添加之前是这样的：</p>
<p><img src="https://i.imgur.com/uZYZRK1.png"></p>
<p>就是一个计算器来的。</p>
<p>我们在这个控制显示这个表单的地方的代码前面添加一个判断：如果没有登录，那么就显示一段含有引导用户登录的文本。</p>
<pre><code>&lt;?php
    // 登录后跳转回当前页代码
    Mage::getSingleton(&#39;customer/session&#39;)-&gt;setBeforeAuthUrl(Mage::helper(&#39;core/url&#39;)-&gt;getCurrentUrl());
    //获取magento首页地址，由于笔者这里用的是一个子目录，所以这样获取会更加靠谱
    $home_url = Mage::helper(&#39;core/url&#39;)-&gt;getHomeUrl();
    //添加一个判断，如果用户没有登录的话，就显示花括号里的内容，并且使用exit语句实现跳出。
    if(!(Mage::getSingleton( &#39;customer/session&#39; )-&gt;isLoggedIn())) &#123;
        echo &#39;&lt;div&gt;使用计算器先登录。点击 &lt;a href=&quot;&#39;.$home_url.&#39;customer/account/login/&quot; class=&quot;light-blue&quot;&gt;马上登录&lt;/a&gt;&lt;/div&gt;&#39;;
        exit;
    &#125;
?&gt;

&lt;form action=&quot;&lt;?php echo Mage::getUrl(&#39;counter&#39;) ?&gt;&quot; method=&quot;post&quot; id=&quot;orderreport-form&quot;&gt;
&lt;fieldset&gt;
    &lt;ul&gt;
    ...
&lt;/form&gt;</code></pre>
<p>这里做个说明，里面的form里的内容就是笔者在添加这个功能之前的状态，实现这个功能的代码是前面的那部分：</p>
<pre><code>&lt;?php
    // 登录后跳转回当前页代码
    Mage::getSingleton(&#39;customer/session&#39;)-&gt;setBeforeAuthUrl(Mage::helper(&#39;core/url&#39;)-&gt;getCurrentUrl());
    //获取magento首页地址，由于笔者这里用的是一个子目录，所以这样获取会更加靠谱
    $home_url = Mage::helper(&#39;core/url&#39;)-&gt;getHomeUrl();
    //添加一个判断，如果用户没有登录的话，就显示花括号里的内容，并且使用exit语句实现跳出。
    if(!(Mage::getSingleton( &#39;customer/session&#39; )-&gt;isLoggedIn())) &#123;
        echo &#39;&lt;div&gt;使用计算器先登录。点击 &lt;a href=&quot;&#39;.$home_url.&#39;customer/account/login/&quot; class=&quot;light-blue&quot;&gt;马上登录&lt;/a&gt;&lt;/div&gt;&#39;;
        exit;
    &#125;
?&gt;</code></pre>
<p>里面已经做了注释，跳转回当前页的代码就是由如下代码控制：</p>
<pre><code>Mage::getSingleton(&#39;customer/session&#39;)-&gt;setBeforeAuthUrl(Mage::helper(&#39;core/url&#39;)-&gt;getCurrentUrl());</code></pre>
<p>由于笔者这里采用的是子目录：<a target="_blank" rel="noopener" href="http://www.mydomain.com/magento">http://www.mydomain.com/magento</a>.</p>
<p>如果</p>
<pre><code>&lt;div&gt;使用计算器先登录。点击 &lt;a href=&quot;&#39;.$home_url.&#39;customer/account/login/&quot; class=&quot;light-blue&quot;&gt;马上登录&lt;/a&gt;&lt;/div&gt;</code></pre>
<p>这个里面的链接地址写成：</p>
<pre><code>&lt;a href=&quot;/customer/account/login/&quot; class=&quot;light-blue&quot;&gt;马上登录&lt;/a&gt;</code></pre>
<p>是不行的，这样的地址就会变成是：<a target="_blank" rel="noopener" href="http://www.mydomain.com/customer/account/login/%EF%BC%8C%E8%80%8C%E6%88%91%E4%BB%AC%E7%9C%9F%E6%AD%A3%E6%83%B3%E8%A6%81%E7%9A%84%E5%9C%B0%E5%9D%80%E6%98%AF%EF%BC%9Ahttp://www.mydomain.com/magento/customer/account/login/%E3%80%82">http://www.mydomain.com/customer/account/login/，而我们真正想要的地址是：http://www.mydomain.com/magento/customer/account/login/。</a></p>
<p>因此，为了获取首页地址，那么我们就要给这个定义一个变量（<code>$home_url</code>）或者不用变量直接写也行。</p>
<pre><code>$home_url = Mage::helper(&#39;core/url&#39;)-&gt;getHomeUrl();</code></pre>
<p>接着就是弄一个判断，判断用户是否登录，代码如下：</p>
<pre><code>Mage::getSingleton( &#39;customer/session&#39; )-&gt;isLoggedIn()</code></pre>
<p>那么没有登录就是前面加一个<code>!</code>，加入到if语句中就是：</p>
<pre><code>if(!(Mage::getSingleton( &#39;customer/session&#39; )-&gt;isLoggedIn())) &#123;
    echo &#39;&lt;div&gt;使用计算器先登录。点击 &lt;a href=&quot;&#39;.$home_url.&#39;customer/account/login/&quot; class=&quot;light-blue&quot;&gt;马上登录&lt;/a&gt;&lt;/div&gt;&#39;;
    exit;
&#125;</code></pre>
<p>如果你是一个很仔细的读者，那么一定会看到这个后面还有一个：</p>
<pre><code>exit;</code></pre>
<p>如果笔者不加这个会有什么后果，后果就是这个判断执行完了后，还会继续执行后面form里面的内容，效果如下：</p>
<p><img src="https://i.imgur.com/EXBgip1.png"></p>
<p>看到没，并存了。</p>
<p>如果，我们添加了，那么如果用户没有登录的话，输入地址：<a target="_blank" rel="noopener" href="http://localhost:8080/sm_market/counter/inex/index%EF%BC%8C%E5%B0%B1%E4%BC%9A%E6%98%BE%E7%A4%BA%EF%BC%9A">http://localhost:8080/sm_market/counter/inex/index，就会显示：</a></p>
<p><img src="https://i.imgur.com/QVxPLOn.png"></p>
<p>好的，如果我们点击这个里面的<code>马上登录</code>链接，我们就会跳转到登录页面，当我们登录成功后，会回到我们登录后的结果：</p>
<p><img src="https://i.imgur.com/R5lITq4.png"></p>
<p>这样就便于控制，只针对登录用户提供的服务了。</p>
<h2 id="在页面中添加联系表单"><a href="#在页面中添加联系表单" class="headerlink" title="在页面中添加联系表单"></a>在页面中添加联系表单</h2><p>作为补充讲解，笔者如果想要在一个静态页面中添加联系表单，有没有快捷的方法呢？答案是有的。</p>
<p>我们在magento后台添加一个页面，然后在content那里，添加：</p>
<pre><code>&#123;&#123;block type="core/template" name="contactForm" form_action="/contacts/index/post" template="contacts/form.phtml"&#125;&#125;</code></pre>
<p>这个就是调用magento的联系表单的页面的代码。</p>
<p>我们就可以在这个页面中看到内容了：</p>
<p><img src="https://i.imgur.com/SHi9oBG.png"></p>
<p>这样感觉是不是很方便，当然还有通过布局文件的方式添加联系表单，这里不在本文的讲解范围，请移步到笔者另外一篇文章。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://helongquan.github.io/2018/09/01/magento%E6%A8%A1%E5%9D%97%E9%87%8D%E5%86%99%E4%B9%8B%E5%9C%A8%E7%94%A8%E6%88%B7%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E6%B7%BB%E5%8A%A0%E7%94%A8%E6%88%B7%E5%8F%96%E6%B6%88%E8%AE%A2%E5%8D%95%E5%8A%9F%E8%83%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="泉哥">
      <meta itemprop="description" content="日记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鸢尾花序">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/09/01/magento%E6%A8%A1%E5%9D%97%E9%87%8D%E5%86%99%E4%B9%8B%E5%9C%A8%E7%94%A8%E6%88%B7%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E6%B7%BB%E5%8A%A0%E7%94%A8%E6%88%B7%E5%8F%96%E6%B6%88%E8%AE%A2%E5%8D%95%E5%8A%9F%E8%83%BD/" class="post-title-link" itemprop="url">magento模块重写之在用户个人中心添加用户取消订单功能</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-09-01 16:19:08" itemprop="dateCreated datePublished" datetime="2018-09-01T16:19:08+08:00">2018-09-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 11:58:01" itemprop="dateModified" datetime="2020-10-11T11:58:01+08:00">2020-10-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/magento1/" itemprop="url" rel="index"><span itemprop="name">magento1</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在Magento的用户面板中，并没有取消订单的功能，为了使用户可以取消订单，可以新建一个模块，这里将使用<code>MagentoBoy_Example</code>作为例子。</p>
<h2 id="1-建立模块文件："><a href="#1-建立模块文件：" class="headerlink" title="1 建立模块文件："></a>1 建立模块文件：</h2><p>file:/app/etc/modules/<code>MagentoBoy_Example.xml</code></p>
<p>代码：</p>
<pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;config&gt;
    &lt;modules&gt;
        &lt;MagentoBoy_Example&gt;
            &lt;active&gt;true&lt;/active&gt;
            &lt;codePool&gt;local&lt;/codePool&gt;
            &lt;depends&gt;
                &lt;Mage_Sales /&gt;
            &lt;/depends&gt;
        &lt;/MagentoBoy_Example&gt;
    &lt;/modules&gt;
&lt;/config&gt;</code></pre>
<p>并添加配置文件：</p>
<p>file:/app/code/local/MagentoBoy/Example/etc/config.xml</p>
<p>代码：</p>
<pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;config&gt;
    &lt;modules&gt;
        &lt;MagentoBoy_Example&gt;
            &lt;version&gt;0.1.0&lt;/version&gt;
        &lt;/MagentoBoy_Example&gt;
    &lt;/modules&gt;
&lt;/config&gt;</code></pre>
<h2 id="2-扩展Mage-Sales-OrderController控制器"><a href="#2-扩展Mage-Sales-OrderController控制器" class="headerlink" title="2 扩展Mage_Sales_OrderController控制器"></a>2 扩展<code>Mage_Sales_OrderController</code>控制器</h2><p>因为在Account Dashboard和My Orders页面都会显示Order表格，需要扩展<code>Mage_Sales_OrderController</code>控制器，添加cancel和recentCancel方法:</p>
<p>file:/app/code/local/MagentoBoy/Example/controllers/OrderController.php</p>
<p>代码：</p>
<pre><code>&lt;?php

require_once &#39;Mage/Sales/controllers/OrderController.php&#39;;

class MagentoBoy_Example_OrderController extends Mage_Sales_OrderController
&#123;
    protected function _cancelAction()
    &#123;
        if (!$this-&gt;_loadValidOrder()) &#123;
            return;
        &#125;
        $order = Mage::registry(&#39;current_order&#39;);

        if ($order-&gt;canCancel())
        &#123;
            $order-&gt;cancel();
            $order-&gt;setStatus(&#39;canceled&#39;);
            $order-&gt;save();
            $order-&gt;sendOrderUpdateEmail();
        &#125;

        $session = Mage::getSingleton(&#39;core/session&#39;);
        $session-&gt;addSuccess(&#39;The order has been canceld.&#39;);
    &#125;

    public function cancelAction()
    &#123;
        $this-&gt;_cancelAction();
        $this-&gt;_redirect(&#39;*/*/history&#39;);
    &#125;

    public function recentCancelAction()
    &#123;
        $this-&gt;_cancelAction();
        $this-&gt;_redirect(&#39;customer/account&#39;);
    &#125;
&#125;</code></pre>
<p>并修改配置文件config.xml重写控制器：</p>
<pre><code>&lt;config&gt;
    &lt;frontend&gt;
        &lt;routers&gt;
            &lt;sales&gt;
                &lt;args&gt;
                    &lt;modules&gt;
                        &lt;MagentoBoy_Example before=&quot;Mage_Sales&quot;&gt;MagentoBoy_Example&lt;/MagentoBoy_Example&gt;
                    &lt;/modules&gt;
                &lt;/args&gt;
            &lt;/sales&gt;
        &lt;/routers&gt;
    &lt;/frontend&gt;
&lt;/config&gt;</code></pre>
<h2 id="3-扩展Mage-Sales-Block-Order-Recent和Mage-Sales-Block-Order-History"><a href="#3-扩展Mage-Sales-Block-Order-Recent和Mage-Sales-Block-Order-History" class="headerlink" title="3 扩展Mage_Sales_Block_Order_Recent和Mage_Sales_Block_Order_History"></a>3 扩展<code>Mage_Sales_Block_Order_Recent</code>和<code>Mage_Sales_Block_Order_History</code></h2><p>为了在Order页面中添加取消订单的链接，需要扩展这两个Block，添加getCancelUrl()函数:</p>
<p>file:/app/code/local/MagentoBoy/Example/Block/Order/Recent.php</p>
<p>代码：</p>
<pre><code>&lt;?php

class MagentoBoy_Example_Block_Order_Recent extends Mage_Sales_Block_Order_Recent
&#123;
    public function getCancelUrl($order)
    &#123;
        return $this-&gt;getUrl(&#39;sales/order/recentcancel&#39;, array(&#39;order_id&#39; =&gt; $order-&gt;getId()));
    &#125;
&#125;</code></pre>
<p>file:/app/code/local/MagentoBoy/Example/Block/Order/History.php</p>
<p>代码：</p>
<pre><code>&lt;?php

class MagentoBoy_Example_Block_Order_History extends Mage_Sales_Block_Order_History
&#123;
    public function getCancelUrl($order)
    &#123;
        return $this-&gt;getUrl(&#39;*/*/cancel&#39;, array(&#39;order_id&#39; =&gt; $order-&gt;getId()));
    &#125;
&#125;</code></pre>
<p>并修改配置文件config.xml重写Block</p>
<pre><code>&lt;config&gt;
    &lt;global&gt;
        &lt;blocks&gt;
            &lt;sales&gt;
                &lt;rewrite&gt;
                    &lt;order_recent&gt;MagentoBoy_Example_Block_Order_Recent&lt;/order_recent&gt;
                    &lt;order_history&gt;MagentoBoy_Example_Block_Order_History&lt;/order_history&gt;
                &lt;/rewrite&gt;
            &lt;/sales&gt;
        &lt;/blocks&gt;
    &lt;/global&gt;
&lt;/config&gt;</code></pre>
<h2 id="4-添加Layout文件"><a href="#4-添加Layout文件" class="headerlink" title="4 添加Layout文件"></a>4 添加Layout文件</h2><p>file:/app/design/frontend/default/default/layout/example.xml</p>
<pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;layout&gt;
    &lt;customer_account_index&gt;
        &lt;reference name=&quot;customer_account_dashboard_top&quot;&gt;
            &lt;action method=&quot;setTemplate&quot;&gt;
                &lt;template&gt;example/order/recent.phtml&lt;/template&gt;
            &lt;/action&gt;
        &lt;/reference&gt;
    &lt;/customer_account_index&gt;

    &lt;sales_order_history&gt;
        &lt;reference name=&quot;sales.order.history&quot;&gt;
            &lt;action method=&quot;setTemplate&quot;&gt;
                &lt;template&gt;example/order/history.phtml&lt;/template&gt;
            &lt;/action&gt;
        &lt;/reference&gt;
    &lt;/sales_order_history&gt;
&lt;/layout&gt;</code></pre>
<p>从这个布局文件可以看出，我们需要在template目录下，创建目录：example/order，然后新建两个文件recent.phtml、history.phtml.</p>
<p>并修改配置文件config.xml添加layout文件</p>
<pre><code>&lt;config&gt;
    &lt;frontend&gt;
        &lt;layout&gt;
            &lt;updates&gt;
                &lt;example&gt;
                    &lt;file&gt;example.xml&lt;/file&gt;
                &lt;/example&gt;
            &lt;/updates&gt;
        &lt;/layout&gt;
    &lt;/frontend&gt;
&lt;/config&gt;</code></pre>
<p>经过逐步添加后的模块（example）配置文件（<strong>etc/config.xml</strong>）的完整代码如下：</p>
<pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;config&gt;
    &lt;modules&gt;
        &lt;MagentoBoy_Example&gt;
            &lt;version&gt;0.1.0&lt;/version&gt;
        &lt;/MagentoBoy_Example&gt;
    &lt;/modules&gt;
    &lt;frontend&gt;
        &lt;routers&gt;
            &lt;sales&gt;
                &lt;args&gt;
                    &lt;modules&gt;
                        &lt;MagentoBoy_Example before=&quot;Mage_Sales&quot;&gt;MagentoBoy_Example&lt;/MagentoBoy_Example&gt;
                    &lt;/modules&gt;
                &lt;/args&gt;
            &lt;/sales&gt;
        &lt;/routers&gt;
        &lt;layout&gt;
            &lt;updates&gt;
                &lt;example&gt;
                    &lt;file&gt;example.xml&lt;/file&gt;
                &lt;/example&gt;
            &lt;/updates&gt;
        &lt;/layout&gt;
    &lt;/frontend&gt;
    &lt;global&gt;
        &lt;blocks&gt;
            &lt;sales&gt;
                &lt;rewrite&gt;
                    &lt;order_recent&gt;MagentoBoy_Example_Block_Order_Recent&lt;/order_recent&gt;
                    &lt;order_history&gt;MagentoBoy_Example_Block_Order_History&lt;/order_history&gt;
                &lt;/rewrite&gt;
            &lt;/sales&gt;
        &lt;/blocks&gt;
    &lt;/global&gt;
&lt;/config&gt;</code></pre>
<h2 id="5-修改模板文件"><a href="#5-修改模板文件" class="headerlink" title="5 修改模板文件"></a>5 修改模板文件</h2><p>复制/app/design/frontend/yourtheme/default/template/sales/order目录下的recent.phtml和history.phtml到<br>/app/design/frontend/yourtheme/default/template/example/order/下。</p>
<p>并且修改recent.phtml和history.phtml这两个文件。分别打开这两个文件，在：</p>
<pre><code>&lt;?php if ($this-&gt;helper(&#39;sales/reorder&#39;)-&gt;canReorder($_order)) : ?&gt;
    &lt;span class=&quot;separator&quot;&gt;|&lt;/span&gt; &lt;a href=&quot;getReorderUrl($_order) ?&gt;&quot; class=&quot;link-reorder&quot;&gt;&lt;?php echo $this-&gt;__(&#39;Reorder&#39;) ?&gt;&lt;/a&gt;
&lt;?php endif ?&gt;</code></pre>
<p>后面添加代码：</p>
<pre><code>&lt;?php if ($_order-&gt;canCancel()) : ?&gt;
    &lt;span class=&quot;separator&quot;&gt;|&lt;/span&gt; &lt;a href=&quot;&lt;?php echo $this-&gt;getCancelUrl($_order) ?&gt;&quot;&gt;&lt;?php echo $this-&gt;__(&#39;取消&#39;) ?&gt;&lt;/a&gt;
&lt;?php endif ?&gt;</code></pre>
<p>最后的效果：</p>
<p><img src="https://i.imgur.com/uFqUt5p.png"></p>
<p>从截图可以看到，已经完成的订单是没有取消的选项的，还没完成的订单都是可以取消的。如果用户取消后，网站管理员在后台就可以看到这个订单处于被取消状态。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://helongquan.github.io/2018/08/31/javascript%E5%AE%9E%E7%8E%B0%E4%B8%8D%E5%90%8Cip%E8%AE%BF%E9%97%AE%E4%B8%8D%E5%90%8C%E7%9A%84%E7%BD%91%E5%9D%80%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="泉哥">
      <meta itemprop="description" content="日记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鸢尾花序">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/08/31/javascript%E5%AE%9E%E7%8E%B0%E4%B8%8D%E5%90%8Cip%E8%AE%BF%E9%97%AE%E4%B8%8D%E5%90%8C%E7%9A%84%E7%BD%91%E5%9D%80%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/" class="post-title-link" itemprop="url">javascript实现不同ip访问不同的网址的解决方案</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-08-31 09:08:05" itemprop="dateCreated datePublished" datetime="2018-08-31T09:08:05+08:00">2018-08-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 11:57:57" itemprop="dateModified" datetime="2020-10-11T11:57:57+08:00">2020-10-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/javascript/" itemprop="url" rel="index"><span itemprop="name">javascript</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>这个是采用纯JavaScript实现的，因此首先我们需要获取到用户的IP地址，如何获取呢？</p>
<p>这里，我们可以采用第三方的IP获取api，这里笔者采用的是搜狐的。</p>
<pre><code>&lt;script src=&quot;http://pv.sohu.com/cityjson?ie=utf-8&quot;&gt;&lt;/script&gt;</code></pre>
<p>访问这个后，我们就能获取客户端的IP。然后就是对当前客户的IP与json数据里面的进行匹配，如果能够匹配得上，那么就会跳转到匹配得上的url字段的地址。</p>
<p>js代码如下：</p>
<pre><code>&lt;script&gt;
    var clientip=returnCitySN[&quot;cip&quot;];
    // 根据业务需求手动添加IP与URL的映射对象
    var rules = [
        &#123;&quot;ip&quot;:&quot;116.25.248.22&quot;,&quot;url&quot;:&quot;http://www.163.com&quot;&#125;,
        &#123;&quot;ip&quot;:&quot;113.118.185.33&quot;,&quot;url&quot;:&quot;http://www.taobao.com&quot;&#125;,
        &#123;&quot;ip&quot;:&quot;14.155.19.89&quot;,&quot;url&quot;:&quot;http://www.baidu.com&quot;&#125;,
        &#123;&quot;ip&quot;:&quot;116.24.82.242&quot;,&quot;url&quot;:&quot;http://www.pucti.org&quot;&#125;,
        &#123;&quot;ip&quot;:&quot;14.155.19.81&quot;,&quot;url&quot;:&quot;http://www.haba.com&quot;&#125;,
        &#123;&quot;ip&quot;:&quot;113.88.108.15&quot;,&quot;url&quot;:&quot;http://www.126.cn&quot;&#125;
    ];
    // console.log(rules.length);

    var flag = 0;
    for (var i = 0; i &lt; rules.length; i++) &#123;
        j = clientip;
        if (j == rules[i].ip) &#123;
            flag = 1;
            window.location.href = rules[i].url;
        &#125;
    &#125;
    // 不符合IP映射规则的默认跳转地址，这里默认写www.pucti.cn,可以改成自己的
    if (flag == 0) &#123;
        window.location.href=&quot;http://www.pucti.cn&quot;;
    &#125;
&lt;/script&gt;</code></pre>
<p>这里运用了一个很重要的概念：flag（标记标量）</p>
<p>就是，先标记为0，然后执行一个循环，如果json数据里面的跟客户当前IP有匹配的，那么就会跳转到对应的url字段所对应的地址，然后紧接着对标记变量进行自增，也就是1.</p>
<p>通俗地说，也就是要是能够匹配，那么就把flag标记成1，否则flag就维持0.</p>
<p>当循环完毕后，就进入下一个if语句中，所以当维持0，那么跳转到默认的，否则这个跳转已经在前面的for语句中执行了。最后笔者粘贴一下这方案的完整代码：</p>
<pre><code>&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;title&gt;Document&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;!-- 从第三方接口中获取用户IP地址 --&gt;
    &lt;script src=&quot;http://pv.sohu.com/cityjson?ie=utf-8&quot;&gt;&lt;/script&gt;
    &lt;script&gt;
        var clientip=returnCitySN[&quot;cip&quot;];
        // 根据业务需求手动添加IP与URL的映射对象
        var rules = [
            &#123;&quot;ip&quot;:&quot;116.25.248.22&quot;,&quot;url&quot;:&quot;http://www.163.com&quot;&#125;,
            &#123;&quot;ip&quot;:&quot;113.118.185.33&quot;,&quot;url&quot;:&quot;http://www.taobao.com&quot;&#125;,
            &#123;&quot;ip&quot;:&quot;14.155.19.89&quot;,&quot;url&quot;:&quot;http://www.baidu.com&quot;&#125;,
            &#123;&quot;ip&quot;:&quot;116.24.82.242&quot;,&quot;url&quot;:&quot;http://www.pucti.org&quot;&#125;,
            &#123;&quot;ip&quot;:&quot;14.155.19.81&quot;,&quot;url&quot;:&quot;http://www.haba.com&quot;&#125;,
            &#123;&quot;ip&quot;:&quot;113.88.108.15&quot;,&quot;url&quot;:&quot;http://www.126.cn&quot;&#125;
        ];
        // console.log(rules.length);

        var flag = 0;
        for (var i = 0; i &lt; rules.length; i++) &#123;
            j = clientip;
            if (j == rules[i].ip) &#123;
                flag = 1;
                window.location.href = rules[i].url;
            &#125;
        &#125;
        // 不符合IP映射规则的默认跳转地址，这里默认写www.pucti.cn,可以改成自己的
        if (flag == 0) &#123;
            window.location.href=&quot;http://www.pucti.cn&quot;;
        &#125;
    &lt;/script&gt;

&lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>其实，根据ip的方式进行跳转有很多方式，为啥选择这种方式呢？主要是考虑方便开发，前面的那个rules数组（我们可以把这个rules数组的东西放在一个json文件里面），里面的格式就是json格式，那么我们就可以通过一些方式从一个数据接口那里或者这个包含ip和url的数据，然后直接读取这个json格式的数据文件，我们就可以进行做相应的跳转了，如果我们采用其他的方式进行跳转就没那么方便。</p>
<h2 id="额外知识补充"><a href="#额外知识补充" class="headerlink" title="额外知识补充"></a>额外知识补充</h2><p>通常，我们很多需求来自根据区域的IP进行相应的跳转，实现的js代码如下：</p>
<pre><code>&lt;!-- 根据区域IP进行跳转 --&gt;
&lt;script src=&quot;http://int.dpool.sina.com.cn/iplookup/iplookup.php?format=js&quot; charset=&quot;GB2312&quot;&gt;&lt;/script&gt;
&lt;script type=text/javascript&gt;
 alert(&quot;你的IP是：&quot; + remote_ip_info.province);
 if(remote_ip_info.province ==&quot;安徽&quot; || remote_ip_info.province ==&quot;江苏&quot;)&#123;
  window.location.href=&quot;http://www.pucti.cn&quot;;
 &#125;else if(remote_ip_info.province ==&quot;江西&quot; || remote_ip_info.province ==&quot;广西&quot;)&#123;
  window.location.href=&quot;https://www.baidu.com&quot;;
 &#125;else if(remote_ip_info.province ==&quot;Hong Kong&quot; || remote_ip_info.province ==&quot;澳门&quot;)&#123;
  window.location.href=&quot;http://www.taobao.com&quot;;
 &#125;else if(remote_ip_info.start ==&quot;116.25.249.58&quot; || remote_ip_info.end ==&quot;116.25.248.36&quot;)&#123;
  window.location.href=&quot;http://www.163.com&quot;;
 &#125;else&#123;
  window.location.href=&quot;http://www.jd.com&quot;;
 &#125;
&lt;/script&gt;</code></pre>
<p>当然还有采用php的方式，这里也做个简单的demo.</p>
<pre><code>&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;title&gt;Document&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;

    &lt;?php
    $ip = $_SERVER[&quot;REMOTE_ADDR&quot;];
    // echo $ip;
    if ($ip = &quot;116.24.83.13&quot;) &#123;
        header(&quot;location: http://www.haba.com&quot;);
        //exit;
    &#125;else&#123;
        header(&quot;location: http://www.pucti.cn&quot;);
        //exit;
    &#125;
    ?&gt;

&lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>当然，也可以采用switch (expression)的方式，类似如下：</p>
<pre><code>&lt;?php
switch ($x)
&#123;
case 1:
  echo &quot;Number 1&quot;;
  break;
case 2:
  echo &quot;Number 2&quot;;
  break;
case 3:
  echo &quot;Number 3&quot;;
  break;
default:
  echo &quot;No number between 1 and 3&quot;;
&#125;
?&gt;</code></pre>
<p>不同方法各有优缺点，大家根据自己的需求采用不同的方案。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://helongquan.github.io/2018/08/22/%E5%9C%A8magento%E7%9A%84%E9%A1%B5%E9%9D%A2%E4%B8%AD%E5%BC%95%E5%85%A5js%E5%92%8Ccss%EF%BC%8C%E4%BB%A5%E5%8F%8A%E7%A7%BB%E9%99%A4%E4%B8%8D%E5%BF%85%E8%A6%81%E7%9A%84js%E5%BC%95%E5%85%A5%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="泉哥">
      <meta itemprop="description" content="日记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鸢尾花序">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/08/22/%E5%9C%A8magento%E7%9A%84%E9%A1%B5%E9%9D%A2%E4%B8%AD%E5%BC%95%E5%85%A5js%E5%92%8Ccss%EF%BC%8C%E4%BB%A5%E5%8F%8A%E7%A7%BB%E9%99%A4%E4%B8%8D%E5%BF%85%E8%A6%81%E7%9A%84js%E5%BC%95%E5%85%A5%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/" class="post-title-link" itemprop="url">在magento的页面中引入js和css，以及移除不必要的js引入问题的解决方案</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-08-22 14:50:06" itemprop="dateCreated datePublished" datetime="2018-08-22T14:50:06+08:00">2018-08-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 11:58:04" itemprop="dateModified" datetime="2020-10-11T11:58:04+08:00">2020-10-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/magento1/" itemprop="url" rel="index"><span itemprop="name">magento1</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>曾几何时，笔者在折腾magento1.x的时候，想要引入外部的一些js库，比如bootstrap，layerui等等这些框架，我们该怎么做呢？忘记在wordpress中采用的方法。我们开始吧</p>
<h2 id="引入js和css"><a href="#引入js和css" class="headerlink" title="引入js和css"></a>引入js和css</h2><p>比如笔者在magento后台新建了一个页面：test page one</p>
<p>然后，来到design这里。</p>
<p><img src="https://i.imgur.com/znXcsU2.png"></p>
<p>在后面添加代码（笔者这里以layui这个框架为例）：</p>
<pre><code>&lt;reference name=&quot;head&quot;&gt;
    &lt;!-- 添加css layui.css 文件在 /skin/frontend/主题包文件夹/主题文件夹/css --&gt;
    &lt;action method=&quot;addCss&quot;&gt;&lt;stylesheet&gt;css/layui/css/layui.css&lt;/stylesheet&gt;&lt;/action&gt;
    &lt;!-- 添加layui.js 文件在 /skin/frontend/主题包文件夹/主题文件夹/js --&gt;
    &lt;action method=&quot;addItem&quot;&gt;&lt;type&gt;skin_js&lt;/type&gt;&lt;name&gt;js/layui/layui.js&lt;/name&gt;&lt;/action&gt;
&lt;/reference&gt;</code></pre>
<p>好的，这里添加完成后我们来到源码位置：</p>
<pre><code>magento_root/skin/frontend/yourtheme/default/js/        //这个是js目录
magento_root/skin/frontend/yourtheme/default/css/     //这个是css目录</code></pre>
<p>我们顺腾摸瓜，找到这个目录把下载好的layui文件夹放入这两个目录，这里需要说明下，因为layui这个东西css的目录和js目录的相对位置需要一致，所以笔者不得不这样重复放置在两个目录下。</p>
<p>好的，我们添加完毕后，我们打开这个页面的前台。查看源码：</p>
<p><img src="https://i.imgur.com/C7Uldh5.png"></p>
<p>我们搜索layui.js</p>
<p><img src="https://i.imgur.com/9fAnYpr.png"></p>
<p>这样，我们就做的了在这个页面中引入了css和js了。为了验证这个是否生效，我们去layui的官网找一个示例代码放入这个页面的content区：</p>
<pre><code>&lt;button class=&quot;layui-btn layui-btn-fluid&quot;&gt;流体按钮（最大化适应）&lt;/button&gt;
&lt;hr&gt;
&lt;div class=&quot;layui-collapse&quot;&gt;
  &lt;div class=&quot;layui-colla-item&quot;&gt;
    &lt;h2 class=&quot;layui-colla-title&quot;&gt;杜甫&lt;/h2&gt;
    &lt;div class=&quot;layui-colla-content layui-show&quot;&gt;内容区域&lt;/div&gt;
  &lt;/div&gt;
  &lt;div class=&quot;layui-colla-item&quot;&gt;
    &lt;h2 class=&quot;layui-colla-title&quot;&gt;李清照&lt;/h2&gt;
    &lt;div class=&quot;layui-colla-content layui-show&quot;&gt;内容区域&lt;/div&gt;
  &lt;/div&gt;
  &lt;div class=&quot;layui-colla-item&quot;&gt;
    &lt;h2 class=&quot;layui-colla-title&quot;&gt;鲁迅&lt;/h2&gt;
    &lt;div class=&quot;layui-colla-content layui-show&quot;&gt;内容区域&lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;script&gt;
//注意：折叠面板 依赖 element 模块，否则无法进行功能性操作
layui.use(&#39;element&#39;, function()&#123;
  var element = layui.element;

  //…
&#125;);
&lt;/script&gt;</code></pre>
<p>我们在前台看到的效果：</p>
<p><img src="https://i.imgur.com/e9UqGzQ.png"></p>
<p>为了有更大的对比，我们来到首页，然后查看首页的源代码，然后Ctrl+F，是没法搜索到layui.js和layui.css的，因为我们仅仅是在test page one这个页面中引入了而已。</p>
<h2 id="移除js"><a href="#移除js" class="headerlink" title="移除js"></a>移除js</h2><p>好的，我们进一步来操作一下，test page one这个页面内容本身不多，其实没有要引入太多的不必要的js，以免影响页面的加载速度,那么这个时候我们怎么处理呢？</p>
<p>其实也很简单，我们在test page one这个页面的design那里，加入代码（笔者这里以移除prototype.js为例）：</p>
<pre><code>&lt;reference name=&quot;head&quot;&gt;
    &lt;!-- 删除js 此prototype.js文件在magento根目录的 js文件夹 --&gt;
    &lt;action method=&quot;removeItem&quot;&gt;&lt;type&gt;js&lt;/type&gt;&lt;name&gt;prototype/prototype.js&lt;/name&gt;&lt;/action&gt;
&lt;/reference&gt;</code></pre>
<p>当然这个可以跟前面的引入js和css那里写在一起的，像这样，</p>
<pre><code>&lt;reference name=&quot;head&quot;&gt;
    &lt;!-- 添加css layui.css 文件在 /skin/frontend/主题包文件夹/主题文件夹/css --&gt;
    &lt;action method=&quot;addCss&quot;&gt;&lt;stylesheet&gt;css/layui/css/layui.css&lt;/stylesheet&gt;&lt;/action&gt;
    &lt;!-- 添加layui.js 文件在 /skin/frontend/主题包文件夹/主题文件夹/js --&gt;
    &lt;action method=&quot;addItem&quot;&gt;&lt;type&gt;skin_js&lt;/type&gt;&lt;name&gt;js/layui/layui.js&lt;/name&gt;&lt;/action&gt;
    &lt;!-- 删除js 此prototype.js文件在magento根目录的 js文件夹 --&gt;
    &lt;action method=&quot;removeItem&quot;&gt;&lt;type&gt;js&lt;/type&gt;&lt;name&gt;prototype/prototype.js&lt;/name&gt;&lt;/action&gt;
&lt;/reference&gt;</code></pre>
<p>大家注意移除和引入的写法是有点不一样的，目录也不一样。</p>
<p>好的，添加完毕后，我们再次查看test page one这个页面的源代码，搜索prototype.js，我们将找不到这个js文件的引用了，因为被我们移除了，这个时候，我们再来到首页，然后查看首页的源代码，这个搜索prototype.js，这个时候我们是可以找到的。</p>
<hr>
<h2 id="引入静态模块然后在页面这边引入针对静态模块的样式表"><a href="#引入静态模块然后在页面这边引入针对静态模块的样式表" class="headerlink" title="引入静态模块然后在页面这边引入针对静态模块的样式表"></a>引入静态模块然后在页面这边引入针对静态模块的样式表</h2><p>这里，我们继续前面的来，比如笔者想在test page one这个页面引入一个叫做static block 1的静态模块。</p>
<pre><code>Block Title *    static block 1
Identifier *     static-block-1</code></pre>
<p>操作方法，在test page one这个页面的design那里添加如下代码：</p>
<pre><code>&lt;reference name=&quot;root&quot;&gt;
      &lt;block type=&quot;cms/block&quot; name=&quot;myelement&quot;&gt;
          &lt;action method=&quot;setBlockId&quot;&gt;&lt;block_id&gt;static-block-1&lt;/block_id&gt;&lt;/action&gt;
      &lt;/block&gt;
&lt;/reference&gt;</code></pre>
<p>然后，我们看下这个test page one页面是用的什么布局结构：比如这里笔者选择的是<code>2 columns with left bar</code>，好的，我们就找到这个模板文件：magento_root/app/design/frontend/yourtheme/default/template/page/2columns-left.phtml</p>
<p>然后，通过开发者工具，找到显示内容区的位置，然后大致确定添加代码的位置，添加如下代码：</p>
<pre><code>&lt;!-- add new custom block start--&gt;
&lt;?php if( $this-&gt;getChildHtml(&#39;myelement&#39;) )&#123;?&gt;
  &lt;div&gt;
      &lt;?php
       echo $this-&gt;getChildHtml(&#39;myelement&#39;)
       ?&gt;
  &lt;/div&gt;
&lt;?php &#125;?&gt;
&lt;!-- add new custom block end--&gt;</code></pre>
<p>好的，这样就完成了一个引入静态模块到一个页面，然后，通过一个判断函数来判断，如果有这个静态模块的引入，那么就加载这个静态模块。</p>
<p>好的，我们再来对这个静态模块添加一些内容：</p>
<pre><code>&lt;div class=&quot;element-blue&quot;&gt;
      &lt;h3&gt;Static Block 1&lt;/h3&gt;
      &lt;p&gt;This is blue static element 1 &lt;/p&gt;
&lt;/div&gt;</code></pre>
<p>这个时候，在前台显示的内容是没有样式的。我们需要把样式放在一个叫做custom.css的样式表中。</p>
<pre><code>file:magento_root/skin/frontend/yourtheme/default/css/custom.css</code></pre>
<p>在这个目录下新建这个文件，然后加上代码：</p>
<pre><code>.element-blue&#123;
    background:#8BC34A;
    padding:15px;
    color:#fff;
&#125;</code></pre>
<p>浅绿色背景，白色字体，有15像素的内边距。</p>
<p>好的，接下来我们就要在test page one页面引入这个自定义的样式表了，还记得前面说的引入样式表的方法吧，我们在test page one页面的design那里加入代码：</p>
<pre><code>&lt;reference name=&quot;head&quot;&gt;
    &lt;!-- 添加css custom.css 文件在 /skin/frontend/主题包文件夹/主题文件夹/css --&gt;
    &lt;action method=&quot;addCss&quot;&gt;&lt;stylesheet&gt;css/custom.css&lt;/stylesheet&gt;&lt;/action&gt;
&lt;/reference&gt;</code></pre>
<p>然后保存，刷新这个页面的前台，</p>
<p><img src="https://i.imgur.com/uspyztc.png"></p>
<p>果然达到了预期。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://helongquan.github.io/2018/08/20/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Magento-%E7%AC%AC%E4%B8%83%E7%AB%A0-%E8%87%AA%E5%AE%9A%E4%B9%89Magento%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="泉哥">
      <meta itemprop="description" content="日记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鸢尾花序">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/08/20/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Magento-%E7%AC%AC%E4%B8%83%E7%AB%A0-%E8%87%AA%E5%AE%9A%E4%B9%89Magento%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE/" class="post-title-link" itemprop="url">深入理解Magento(第七章)自定义magento后台定制以及自定义系统后台配置</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-08-20 14:30:27" itemprop="dateCreated datePublished" datetime="2018-08-20T14:30:27+08:00">2018-08-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 11:58:05" itemprop="dateModified" datetime="2020-10-11T11:58:05+08:00">2020-10-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/magento1/" itemprop="url" rel="index"><span itemprop="name">magento1</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>原文地址：<a target="_blank" rel="noopener" href="https://alanstorm.com/custom_magento_system_configuration/">https://alanstorm.com/custom_magento_system_configuration/</a></p>
<p>中文地址：<a target="_blank" rel="noopener" href="http://justcoding.iteye.com/blog/1590230">http://justcoding.iteye.com/blog/1590230</a></p>
<h2 id="第七章-–-自定义Magento系统配置"><a href="#第七章-–-自定义Magento系统配置" class="headerlink" title="第七章 – 自定义Magento系统配置"></a>第七章 – 自定义Magento系统配置</h2><p>Magento拥有十分强大的后台管理系统。作为一名开发人员，这套后台管理系统可以让你的用户简单直接的配置Magento系统或者你创建的模块。和Magento的其他功能一样，你第一次使用这套管理系统的时候可能觉得很麻烦，但是一旦你上手了，你会发现它强大的功能是那么吸引人。那么让我们开始吧。我们这一章的例子依然是基于Helloworld模块。</p>
<h2 id="添加系统配置文件"><a href="#添加系统配置文件" class="headerlink" title="添加系统配置文件"></a>添加系统配置文件</h2><p>首先我们要为模块添加一个系统配置文件。这个文件和“config.xml”是不搭界的 app/code/local/Magentotutorial/Helloworld/etc/system.xml 和全局配置（global config）相似，系统配置也是单独存储的。我们可以通过下面这段代码来获取系统配置文件</p>
<p>Php代码</p>
<pre><code>//header(&#39;Content-Type: text/xml&#39;);          
header(&#39;Content-Type: text/plain&#39;);          
echo $config = Mage::getConfig()  
-&gt;loadModulesConfiguration(&#39;system.xml&#39;)         
-&gt;getNode()  
-&gt;asXML();
exit;</code></pre>
<p>你可以把这段代码放到任何执行函数（Action Method）中。“loadModulesConfiguration”方法会搜索所有配置好的模块的“etc”文件夹，寻找以传入的参数为名字的文件，在这个例子中是“system.xml”。Magento有很多不同的配置文件，比如api.xml， wsdl.xml， wsdl2.xml， convert.xml， compilation.xml， install.xml。你可以为你创建的模块创建这些配置文件。</p>
<h2 id="添加一个标签页"><a href="#添加一个标签页" class="headerlink" title="添加一个标签页"></a>添加一个标签页</h2><p>我们首先在后台系统管理页面添加一个标签页（Tab）。标签页就是后台“System-&gt;Configuration”页面左侧的导航栏。默认的标签页有General，Catalog，Customers，Sales，Services等等。我们来创建一个新的标签页叫做“Hello Config”。创建如下文件</p>
<pre><code>Location: app/code/local/Magentotutorial/Helloworld/etc/system.xml</code></pre>
<p>Xml代码</p>
<pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;config&gt;  
    &lt;tabs&gt;  
        &lt;helloconfig translate=&quot;label&quot; module=&quot;helloworld&quot;&gt;  
            &lt;label&gt;Hello Config&lt;/label&gt;  
            &lt;sort_order&gt;99999&lt;/sort_order&gt;  
        &lt;/helloconfig&gt;  
    &lt;/tabs&gt;  
&lt;/config&gt; </code></pre>
<p>我们来解释一下各个节点（Tag）的意思。【译者注：由于Tab和Tag中文翻译都是标签，所以这里我把Tag翻译成节点，以免混淆】 “<code>&lt;helloconfig&gt;</code>”就是我们要添加的标签页的定义节点，“helloconfig”是节点的ID。你可以任意命名这个ID，但是 必须全局唯一，也就是不能和别人用同样的ID。这个ID是用来唯一标示你的标签页的。“module=helloworld”，意思是这个标签页属于哪个模块。“<code>&lt;label&gt;</code>”节点的内容是标签的名字，也就是要显示在界面上的名字。“<code>&lt;sort_order&gt;</code>”指明了这个标签页显示的位置。</p>
<p>打开后台“System-&gt;Configuration”，你会看到如下错误</p>
<pre><code>Fatal error: Class &#39;Mage_Helloworld_Helper_Data&#39; not found in….  </code></pre>
<h2 id="Magento-Helper简介"><a href="#Magento-Helper简介" class="headerlink" title="Magento Helper简介"></a>Magento Helper简介</h2><p>正如许多其他的PHP MVC系统一样，Magento也有帮助类（Helper Classes）。这些类用来提供一些不适合放在模型，视图或者控制器中的功能。Magento的帮助类也是采用分组类名的机制。也就是说我们可以覆盖默认的帮助类，同时我们需要在config.xml中指定帮助类的基类名。</p>
<p>Magento系统默认模块有一个默认的帮助类。正如我们上面的异常显示，我们的Helloworld模块并没有指定一个默认的帮助类。下面让我们来添加一个。修改config.xml</p>
<pre><code>File: app/code/local/Magentotutorial/Helloworld/etc/config.xml</code></pre>
<p>Xml代码</p>
<pre><code>&lt;!– … –&gt;  
&lt;global&gt;
        &lt;helpers&gt;
            &lt;helloworld&gt;
                &lt;class&gt;Magentotutorial_Helloworld_Helper&lt;/class&gt;
            &lt;/helloworld&gt;
        &lt;/helpers&gt;
    &lt;/global&gt;
&lt;!– … –&gt;   </code></pre>
<p>你现在应该对这类配置相当熟悉了。“<code>&lt;helloworld&gt;</code>”节点就是模块的名字，“<code>&lt;class&gt;</code>”就是帮助类的基类名，命名方式如下 </p>
<pre><code>Packagename_Modulename_Helper</code></pre>
<p>帮助类是通过全局对象Mage的静态方法“helper”来装载的。</p>
<p>Php代码</p>
<pre><code>Mage::helper(&#39;helloworld/foo&#39;)   </code></pre>
<p>根据我们的配置，上面这行代码将会装载以下类</p>
<pre><code>File:app/code/local/Magentotutorial/Helloworld/Helper/Foo.php

class Magentotutorial_Helloworld_Helper_Foo</code></pre>
<p>我们上面说过Magento默认每个模块有一个帮助类“data”</p>
<p>Php代码</p>
<pre><code>Mage::helper(&#39;helloworld&#39;);
Mage::helper(&#39;helloworld/data&#39;);</code></pre>
<p>上面这两行代码是等价的，都会装载以下类</p>
<pre><code>File:app/code/local/Magentotutorial/Helloworld/Helper/Data.php

class Magentotutorial_Helloworld_Helper_Data</code></pre>
<p>下面我们来创建我们的帮助类</p>
<pre><code>File: app/code/local/Magentotutorial/Helloworld/Helper/Data.php</code></pre>
<p>Php代码</p>
<pre><code>&lt;?php 
class Magentotutorial_Helloworld_Helper_Data extends Mage_Core_Helper_Abstract  
&#123;

&#125;
 ?&gt;   </code></pre>
<p>清空Magento缓存，重新装载页面，你会发现错误不见了，但是我们的标签页还是没有出来。如果你好奇帮助类究竟能干什么，建议你去看看“<code>Mage_Core_Helper_Abstract</code>”类。</p>
<h2 id="添加新的段"><a href="#添加新的段" class="headerlink" title="添加新的段"></a>添加新的段</h2><p>好了，帮助类的介绍到此结束。下面我们来看看为什么我们的标签页不显示出来。在Magento中，每一个标签页都包含很多段（section）。举个例子，“Advanced”标签页默认包含“Admin, System, Advanced, Developer”四个段。如果一个标签页不包含任何段，那么这个标签页不会被显示出来。下面我们在system.xml中添加 “<code>&lt;section&gt;</code>”节点<code>Location: app/code/local/Magentotutorial/Helloworld/etc/system.xml</code></p>
<p>Xml代码</p>
<pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;config&gt;  
    &lt;tabs&gt;  
        &lt;helloconfig translate=&quot;label&quot; module=&quot;helloworld&quot;&gt;  
            &lt;label&gt;Hello Config&lt;/label&gt;  
            &lt;sort_order&gt;99999&lt;/sort_order&gt;  
        &lt;/helloconfig&gt;  
    &lt;/tabs&gt;  
    &lt;sections&gt;  
        &lt;helloworld_options translate=&quot;label&quot; module=&quot;helloworld&quot;&gt;  
            &lt;label&gt;Hello World Config Options&lt;/label&gt;  
            &lt;tab&gt;helloconfig&lt;/tab&gt;  
            &lt;frontend_type&gt;text&lt;/frontend_type&gt;  
            &lt;sort_order&gt;1000&lt;/sort_order&gt;  
            &lt;show_in_default&gt;1&lt;/show_in_default&gt;  
            &lt;show_in_website&gt;1&lt;/show_in_website&gt;  
            &lt;show_in_store&gt;1&lt;/show_in_store&gt;                     
        &lt;/helloworld_options&gt;  
    &lt;/sections&gt;      
&lt;/config&gt;   </code></pre>
<p>这里有些节点你应该很熟悉，就不多解释了，来讲讲以前没见过的。</p>
<h2 id="什么是-lt-helloworld-options-gt-？"><a href="#什么是-lt-helloworld-options-gt-？" class="headerlink" title="什么是&lt;helloworld_options /&gt;？"></a>什么是<code>&lt;helloworld_options /&gt;</code>？</h2><p>和前面的<code>&lt;hellowconfig&gt;</code>相似，这个节点是用来唯一标示你的段，“<code>helloworld_options</code>”就是段的ID，可以随意取名，只要不重复就好。</p>
<h2 id="什么是-lt-frontend-type-gt-？"><a href="#什么是-lt-frontend-type-gt-？" class="headerlink" title="什么是&lt;frontend_type /&gt;？"></a>什么是<code>&lt;frontend_type /&gt;</code>？</h2><p>这个节点有点搞。“<code>&lt;frontend_type /&gt;</code>”在配置文件的其他部分有用（稍后会讲），放在这里其实没什么作用。但是核心模块在此处的配置文件都包含这个节点，所以我们也把它添加进去。类型有如下：</p>
<pre><code>allowspecific
export
image
import
label
multiselect
obscure
password
select
text
textarea
time</code></pre>
<h2 id="什么是-lt-show-in-default-gt-，-lt-show-in-website-gt-，-lt-show-in-store-gt-？"><a href="#什么是-lt-show-in-default-gt-，-lt-show-in-website-gt-，-lt-show-in-store-gt-？" class="headerlink" title="什么是&lt;show_in_default /&gt;，&lt; show_in_website /&gt;，&lt;show_in_store /&gt;？"></a>什么是<code>&lt;show_in_default /&gt;</code>，<code>&lt; show_in_website /&gt;</code>，<code>&lt;show_in_store /&gt;</code>？</h2><p>这些节点的值是布尔类型的，0或者1。这些标签是用来控制在不同的环境下，当前段是否应该显示。</p>
<p>好了，我们已经配置好段了，清空缓存，再一次刷新页面，你应该看到“HELLO CONFIG”标签页显示出来了。</p>
<h2 id="访问控制"><a href="#访问控制" class="headerlink" title="访问控制"></a>访问控制</h2><p>如果你刚才点了我们创建的标签页下面的“Hello World Config Options”，你大概会很失望。什么都没有显示出来，连左边的导航栏都没有了。这是因为“Adminhtml”在权限控制列表（Access Control List, ACL）中找不到我们创建的段的权限信息。【译者注：Adminhtml就是Magento的后台管理系统，属于Magento的一个核心模块】</p>
<p>ACL是一个很复杂的话题，但是我会介绍一些最基本的概念，以便于理解Magento的权限控制。这部分内容和上下文关系不大，如果你不感兴趣，可以直接跳到本节结尾，复制一段XML到你的config.xml就行了。</p>
<p>在Magento中，对于有些资源的访问时有限制的。用户必须先经过认证才能访问相关资源。在这里，资源（Resource）是一个广义的概念，它可能是 指一个页面，也可能是一个功能。Magento的系统配置功能（System Config）就是需要认证才能访问的资源。</p>
<p>任何一个资源都是通过一个URI来标识。比如说“web”配置段（属于后台管理General标签页）的URI是</p>
<pre><code>admin/system/config/web</code></pre>
<p>我们“<code>helloworld_options</code>”段的URI是</p>
<pre><code>admin/system/config/helloworld_options</code></pre>
<p>当一个用户访问一个受保护的资源的时候，后台管理系统（Adminhtml）的执行控制器会执行以下步骤</p>
<ol>
<li>为用户正在访问的资源生成一个URI</li>
<li>根据ACL系统检查该用户是否有权限访问指定的资源</li>
<li>如果用户拥有访问权限，那么进行用户指定的操作。否则，跳转到相应的错误页面（也可能是停止操作或者显示空白页面）。</li>
</ol>
<p>对于那些感兴趣的人，这是<code>_isSectionAllowed</code>在以下控制器的方法中的系统配置部分完成的</p>
<pre><code>app/code/core/Mage/Adminhtml/controllers/System/ConfigController.php</code></pre>
<p>如果你去“System -&gt; Permissions -&gt; Roles”页面，点击“Add New Role”按钮，你会看到所有系统的资源都以树形结构显示在页面上。</p>
<h2 id="添加ACL权限"><a href="#添加ACL权限" class="headerlink" title="添加ACL权限"></a>添加ACL权限</h2><p>刚才说ACL中没有我们配置段的信息，那么我们来创建一个。请注意，如果你是创建一个新的段，那么你需要创建一个新的权限，如果你在已有的段上添加内容，你不需要创建权限。</p>
<p>在config.xml中，添加以下内容</p>
<pre><code>File: app/code/local/Magentotutorial/Helloworld/etc/config.xml </code></pre>
<p>Xml代码</p>
<pre><code>&lt;config&gt;     
    &lt;!– … –&gt;  
    &lt;adminhtml&gt;  
        &lt;acl&gt;  
            &lt;resources&gt;  
                &lt;admin&gt;  
                    &lt;children&gt;  
                        &lt;system&gt;  
                            &lt;children&gt;  
                                &lt;config&gt;  
                                    &lt;children&gt;  
                                        &lt;helloworld_options&gt;  
                                            &lt;title&gt;Store Hello World Module Section&lt;/title&gt;  
                                        &lt;/helloworld_options&gt;  
                                    &lt;/children&gt;  
                                &lt;/config&gt;  
                            &lt;/children&gt;  
                        &lt;/system&gt;  
                    &lt;/children&gt;  
                &lt;/admin&gt;  
            &lt;/resources&gt;  
        &lt;/acl&gt;  
    &lt;/adminhtml&gt;  
    &lt;!– … –&gt;  
&lt;/config&gt;   </code></pre>
<p>让我们来分析一下这段代码。所有的资源定义都包含在如下代码中</p>
<p>Xml代码</p>
<pre><code>&lt;adminhtml&gt;  
    &lt;acl&gt;  
        &lt;resources&gt;  
        &lt;/resource&gt;  
    &lt;/acl&gt;  
&lt;/adminhtml&gt;   </code></pre>
<p>在<code>&lt;resources&gt;</code>节点下面，每一个子节点都是URI的一部分，比如</p>
<p>Xml代码</p>
<pre><code>&lt;admin&gt;  
    &lt;children&gt;  
        &lt;system&gt;  
            &lt;children&gt;   </code></pre>
<p>代表URI</p>
<pre><code>admin/system</code></pre>
<p>最后一个节点</p>
<p>Xml代码</p>
<pre><code>&lt;helloworld_options&gt;
    &lt;title&gt;Store Hello World Module Section&lt;/title&gt;
&lt;/helloworld_options&gt;</code></pre>
<p>这里<code>&lt;title&gt;</code>的内容将会在后台权限管理的时候显示出来，也就是我们定义的权限的名字。</p>
<p>清空Magento缓存，刷新页面，你应该能看到我们创建的配置段了.</p>
<p><img src="https://i.imgur.com/HG7Cqdj.png"></p>
<p>标准的后台管理页面，但是主体内容是空的，只有一个“Save Config”按钮。你可能需要重新登录后台管理才能看到正确的页面。那是因为后台管理有一些额外的缓存。【译者注：我们添加了权限以后，管理员是默认拥有该权限的，所以我们用管理员登录后台管理系统就能访问我们创建的段】</p>
<p>请注意，不知道出于什么原因，Magento把<code>&lt;adminhtml /&gt;</code>部分从全局配置中删掉了。所以，我们不能用之前创建的Configviewer来查看这部分内容。我正在研究Magento把<code>&lt;adminhtml /&gt;</code>存在哪里了。</p>
<h2 id="添加组"><a href="#添加组" class="headerlink" title="添加组"></a>添加组</h2><p>【译者注：按照逻辑，这里应该讲的内容是添加选项。Mageto中，选项是按照组（Group）来划分的，所以我们在添加选项之前得先添加组。】修改system.xml</p>
<pre><code>Location: app/code/local/Magentotutorial/Helloworld/etc/system.xml</code></pre>
<p>Xml代码</p>
<pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;config&gt;  
    &lt;tabs&gt;  
        &lt;helloconfig translate=&quot;label&quot; module=&quot;helloworld&quot;&gt;  
            &lt;label&gt;Hello Config&lt;/label&gt;  
            &lt;sort_order&gt;99999&lt;/sort_order&gt;  
        &lt;/helloconfig&gt;  
    &lt;/tabs&gt;  
    &lt;sections&gt;  
        &lt;helloworld_options translate=&quot;label&quot; module=&quot;helloworld&quot;&gt;  
            &lt;label&gt;Hello World Config Options&lt;/label&gt;  
            &lt;tab&gt;helloconfig&lt;/tab&gt;  
            &lt;frontend_type&gt;text&lt;/frontend_type&gt;  
            &lt;sort_order&gt;1000&lt;/sort_order&gt;  
            &lt;show_in_default&gt;1&lt;/show_in_default&gt;  
            &lt;show_in_website&gt;1&lt;/show_in_website&gt;  
            &lt;show_in_store&gt;1&lt;/show_in_store&gt;  
            &lt;groups&gt;  
                &lt;messages translate=&quot;label&quot;&gt;  
                    &lt;label&gt;Demo Of Config Fields&lt;/label&gt;  
                    &lt;frontend_type&gt;text&lt;/frontend_type&gt;  
                    &lt;sort_order&gt;1&lt;/sort_order&gt;  
                    &lt;show_in_default&gt;1&lt;/show_in_default&gt;  
                    &lt;show_in_website&gt;1&lt;/show_in_website&gt;  
                    &lt;show_in_store&gt;1&lt;/show_in_store&gt;  
                &lt;/messages&gt;  
            &lt;/groups&gt;  
        &lt;/helloworld_options&gt;  
    &lt;/sections&gt;      
&lt;/config&gt;   </code></pre>
<p>这里也没什么好解释的。刷新一下页面看看你就什么都明白了。</p>
<p><img src="https://i.imgur.com/6drbyeJ.png"></p>
<h2 id="添加配置选项"><a href="#添加配置选项" class="headerlink" title="添加配置选项"></a>添加配置选项</h2><p>最后，我们要添加每一个单独的配置选项。配置选项是以<code>&lt;fields /&gt;</code>节点的形式添加到<messages />节点下面的。</p>
<p>Xml代码</p>
<pre><code>&lt;!– … –&gt;  
&lt;messages translate=&quot;label&quot;&gt;  
    &lt;label&gt;Demo Of Config Fields&lt;/label&gt;  
    &lt;frontend_type&gt;text&lt;/frontend_type&gt;  
    &lt;sort_order&gt;1&lt;/sort_order&gt;  
    &lt;show_in_default&gt;1&lt;/show_in_default&gt;  
    &lt;show_in_website&gt;1&lt;/show_in_website&gt;  
    &lt;show_in_store&gt;1&lt;/show_in_store&gt;  
    &lt;fields&gt;  
        &lt;hello_message&gt;  
            &lt;label&gt;Message&lt;/label&gt;  
            &lt;frontend_type&gt;text&lt;/frontend_type&gt;  
            &lt;sort_order&gt;1&lt;/sort_order&gt;  
            &lt;show_in_default&gt;1&lt;/show_in_default&gt;  
            &lt;show_in_website&gt;1&lt;/show_in_website&gt;  
            &lt;show_in_store&gt;1&lt;/show_in_store&gt;  
        &lt;/hello_message&gt;  
    &lt;/fields&gt;  
&lt;/messages&gt;  
&lt;!– … –&gt;   </code></pre>
<p>这里有一个节点需要说明，“<code>&lt;frontend_type&gt;</code>”，刚才说这个节点没什么用。但是这里有用了，这个节点说明了这个选项的数据类 型。你可以把它换成别的类型，比如“time”。这里支持大部分默认的Varien定义的数据类型（lib/Varien/Data/Form /Element）。这个有点像是工厂（Factory）设计模式。让我们把类型改成“select”。你会看到一个下拉框，但是没有选项。我们来添加选项。首先我们要添加一个源模型（Source Model）</p>
<p>Xml代码</p>
<pre><code>&lt;hello_message&gt;  
    &lt;label&gt;Message&lt;/label&gt;  
    &lt;frontend_type&gt;select&lt;/frontend_type&gt;  
    &lt;!– adding a source model –&gt;  
    &lt;source_model&gt;helloworld/words&lt;/source_model&gt;                            
    &lt;sort_order&gt;1&lt;/sort_order&gt;  
    &lt;show_in_default&gt;1&lt;/show_in_default&gt;  
    &lt;show_in_website&gt;1&lt;/show_in_website&gt;  
    &lt;show_in_store&gt;1&lt;/show_in_store&gt;                     
&lt;/hello_message&gt;</code></pre>
<p>“<code>&lt;source_model&gt;</code>”定义了源模型的URI。和我们以前创建的模型一样，源模型也是一个模型，为“select”提供了默认的数据。这就意味着我们需要确保我们的模块配置文件config.xml中为这个模块的模型做了相关的配置。</p>
<pre><code>File: app/code/local/Magentotutorial/Helloworld/etc/config.xml</code></pre>
<p>xml代码：</p>
<pre><code>&lt;config&gt;    
    &lt;!-- ... --&gt;
    &lt;global&gt;
    &lt;!-- ... --&gt;
        &lt;models&gt;
            &lt;!-- ... --&gt;
            &lt;helloworld&gt;
                &lt;class&gt;Alanstormdotcom_Helloworld_Model&lt;/class&gt;
            &lt;/helloworld&gt;    
            &lt;!-- ... --&gt;
        &lt;/models&gt;
    &lt;/global&gt;
&lt;/config&gt;</code></pre>
<p>记住：这个很重要，笔者就是在这里看了中文翻译版，结果翻译的那个人是故意留下bug还是，忘记翻译了，导致我足足找了半天的原因，后来发现原来是没有在模块的配置文件中为这个东西做配置。报错如下：</p>
<blockquote>
<p>Fatal error: Call to a member function toOptionArray() on a non-object in…</p>
</blockquote>
<p>根据上面的<code>&lt;source_model&gt;</code>的URI定义，我们要创建以下文件</p>
<pre><code>File: app/code/local/Magentotutorial/Helloworld/Model/Words.php</code></pre>
<p>Php代码</p>
<pre><code>&lt;?php 
class Magentotutorial_Helloworld_Model_Words&#123; 
    public function toOptionArray()
    &#123;  
        return array(
            array(&#39;value&#39;=&gt;1, &#39;label&#39;=&gt;Mage::helper(&#39;helloworld&#39;)-&gt;__(&#39;Hello&#39;)),
            array(&#39;value&#39;=&gt;2, &#39;label&#39;=&gt;Mage::helper(&#39;helloworld&#39;)-&gt;__(&#39;Goodbye&#39;)),
            array(&#39;value&#39;=&gt;3, &#39;label&#39;=&gt;Mage::helper(&#39;helloworld&#39;)-&gt;__(&#39;Yes&#39;)),
            array(&#39;value&#39;=&gt;4, &#39;label&#39;=&gt;Mage::helper(&#39;helloworld&#39;)-&gt;__(&#39;No&#39;)),
        );
    &#125;
&#125;
 ?&gt;   </code></pre>
<p><strong>源模型</strong>提供了一个方法“toOptionsArray”，返回的数据时用来填充我们之前定义的配置选项的。这个方法在运行时会被“initFields”调用。“initFields”在以下类中定义</p>
<pre><code>app/code/core/Mage/Adminhtml/Block/System/Config/Form.php</code></pre>
<p>我们这里调用了帮助类的翻译函数（__）来获取数据。虽然不是很必要，但调用翻译函数总是一个好习惯。说不定哪天你要将模块翻译成日文呢。【译者注：值得 注意的是我们这里创建的模型不需要继承任何父类，只需要拥有“toOptionArray”方法就可以了。】</p>
<h2 id="什么是-lt-frontend-class-gt-？"><a href="#什么是-lt-frontend-class-gt-？" class="headerlink" title="什么是&lt;frontend_class/&gt;？"></a>什么是<code>&lt;frontend_class/&gt;</code>？</h2><p>别犯傻，这里的<code>&lt;frontend_class/&gt;</code>不是组的类名，这个标签是用来修改html的标签的class的，例如某个字段配置如下，就拿前面的select那个来说吧：</p>
<pre><code>&lt;good_message&gt;  
    &lt;label&gt;Good Message select:&lt;/label&gt;
    &lt;frontend_type&gt;select&lt;/frontend_type&gt;
    &lt;frontend_class&gt;free-method&lt;/frontend_class&gt;
    &lt;source_model&gt;helloworld/words&lt;/source_model&gt;
    &lt;sort_order&gt;1&lt;/sort_order&gt;
    &lt;show_in_default&gt;1&lt;/show_in_default&gt;
    &lt;show_in_website&gt;1&lt;/show_in_website&gt;
    &lt;show_in_store&gt;1&lt;/show_in_store&gt;
&lt;/good_message&gt;</code></pre>
<p>这里是下拉框的那个添加了一个class为free-method的，我们来到后台的这个下拉框那里，用开发者工具查看下代码：</p>
<p><img src="https://i.imgur.com/k8oV1rz.png"></p>
<p>select的代码如下：</p>
<pre><code>&lt;select class=&quot;free-method&quot;&gt;</code></pre>
<hr>
<p>如果我们想要在这个组下面添加更多的配置选项呢？怎么操作，很简单，把前面的配置选项那里：</p>
<pre><code>&lt;!– … –&gt;  
&lt;messages translate=&quot;label&quot;&gt;  
    &lt;label&gt;Demo Of Config Fields&lt;/label&gt;  
    &lt;frontend_type&gt;text&lt;/frontend_type&gt;  
    &lt;sort_order&gt;1&lt;/sort_order&gt;  
    &lt;show_in_default&gt;1&lt;/show_in_default&gt;  
    &lt;show_in_website&gt;1&lt;/show_in_website&gt;  
    &lt;show_in_store&gt;1&lt;/show_in_store&gt;  
    &lt;fields&gt;  
        &lt;hello_message&gt;  
            &lt;label&gt;Message&lt;/label&gt;  
            &lt;frontend_type&gt;text&lt;/frontend_type&gt;  
            &lt;sort_order&gt;1&lt;/sort_order&gt;  
            &lt;show_in_default&gt;1&lt;/show_in_default&gt;  
            &lt;show_in_website&gt;1&lt;/show_in_website&gt;  
            &lt;show_in_store&gt;1&lt;/show_in_store&gt;  
        &lt;/hello_message&gt;  
    &lt;/fields&gt;  
&lt;/messages&gt;  
&lt;!– … –&gt; </code></pre>
<p>改成：</p>
<pre><code>&lt;!– … –&gt;  
&lt;messages translate=&quot;label&quot;&gt;  
    &lt;label&gt;Demo Of Config Fields&lt;/label&gt;  
    &lt;frontend_type&gt;text&lt;/frontend_type&gt;  
    &lt;sort_order&gt;1&lt;/sort_order&gt;  
    &lt;show_in_default&gt;1&lt;/show_in_default&gt;  
    &lt;show_in_website&gt;1&lt;/show_in_website&gt;  
    &lt;show_in_store&gt;1&lt;/show_in_store&gt;  
    &lt;fields&gt;  
        &lt;hello_message&gt;  
            &lt;label&gt;Message&lt;/label&gt;  
            &lt;frontend_type&gt;text&lt;/frontend_type&gt;  
            &lt;sort_order&gt;1&lt;/sort_order&gt;  
            &lt;show_in_default&gt;1&lt;/show_in_default&gt;  
            &lt;show_in_website&gt;1&lt;/show_in_website&gt;  
            &lt;show_in_store&gt;1&lt;/show_in_store&gt;  
        &lt;/hello_message&gt;
        &lt;dianyou_message&gt;  
            &lt;label&gt;Good Message email:&lt;/label&gt;
            &lt;frontend_type&gt;text&lt;/frontend_type&gt;
            &lt;validate&gt;validate-email&lt;/validate&gt;
            &lt;sort_order&gt;1&lt;/sort_order&gt;
            &lt;show_in_default&gt;1&lt;/show_in_default&gt;
            &lt;show_in_website&gt;1&lt;/show_in_website&gt;
            &lt;show_in_store&gt;1&lt;/show_in_store&gt;
        &lt;/dianyou_message&gt;            
    &lt;/fields&gt;  
&lt;/messages&gt;  
&lt;!– … –&gt; </code></pre>
<p>就是复制其中一份<code>&lt;hello_message&gt;</code>，把它的标签名字改成其他的名字，只要不跟别的标签名冲突即可，笔者这里改成<code>&lt;dianyou_message&gt;</code>，而且作为补充，大家可能看到了这里有个新添加的：</p>
<pre><code>&lt;validate&gt;validate-email&lt;/validate&gt;</code></pre>
<p>这个是用来验证电邮的，就是输入的内容格式如果不符合电邮格式的，那么点击保存的时候，是不能保存的，在网站后台，找到这个字段所在的地方，用开发者工具检查，对应的html的代码如下：</p>
<pre><code>&lt;input type=&quot;text&quot; class=&quot;validate-email&quot; /&gt;</code></pre>
<p>好的，我们在添加了这个之后，我们刷新后台，最终效果图：</p>
<p><img src="https://i.imgur.com/N3uFY58.png"></p>
<p>当然，还有很多精彩的标签的应用，强烈建议大家看原文（英文版）,以下摘录点原文看下，别人是何等的耐心和专业。</p>
<hr>
<h2 id="lt-depends-gt"><a href="#lt-depends-gt" class="headerlink" title="&lt;depends/&gt;"></a><code>&lt;depends/&gt;</code></h2><p><code>&lt;depends/&gt;</code> allows you specify that your configuration field should only be displayed when another confgiruation field in the same group has a specific value.</p>
<p>For example, the Paypal Express System Configuration has the following select defined.</p>
<pre><code>&lt;specificcountry translate=&quot;label&quot;&gt;
    &lt;label&gt;Countries Payment Applicable From&lt;/label&gt;
    &lt;frontend_type&gt;multiselect&lt;/frontend_type&gt;
    &lt;sort_order&gt;110&lt;/sort_order&gt;
    &lt;source_model&gt;adminhtml/system_config_source_country&lt;/source_model&gt;
    &lt;show_in_default&gt;1&lt;/show_in_default&gt;
    &lt;show_in_website&gt;1&lt;/show_in_website&gt;
    &lt;show_in_store&gt;0&lt;/show_in_store&gt;
    &lt;depends&gt;&lt;allowspecific&gt;1&lt;/allowspecific&gt;&lt;/depends&gt;
&lt;/specificcountry&gt;</code></pre>
<p>You’ll notice the</p>
<pre><code>&lt;depends&gt;&lt;allowspecific&gt;1&lt;/allowspecific&gt;&lt;/depends&gt;</code></pre>
<p>This is telling the system that if the <code>&lt;allowspecific&gt;</code> field (defined with the following)</p>
<pre><code>&lt;allowspecific translate=&quot;label&quot;&gt;
   &lt;label&gt;Payment Applicable From&lt;/label&gt;
   &lt;frontend_type&gt;select&lt;/frontend_type&gt;
   &lt;sort_order&gt;100&lt;/sort_order&gt;       &lt;source_model&gt;adminhtml/system_config_source_payment_allspecificcountries&lt;/source_model&gt;
   &lt;show_in_default&gt;1&lt;/show_in_default&gt;
   &lt;show_in_website&gt;1&lt;/show_in_website&gt;
   &lt;show_in_store&gt;0&lt;/show_in_store&gt;
&lt;/allowspecific&gt;</code></pre>
<p>has a value of “1”, then the <code>&lt;specificcountry&gt;</code> field should be displayed. This happens instantly via some behind the scenes Javascript.</p>
<p>While it appears to work with any fields that send out on onchange event, the core Magento system only uses this function where the parent field is a select. If you’re paranoid about forward compatibility, I’d apply the same restriction to your own System Configuration fields, as it’s hard to tell where the core Magento team may take this feature in the future.</p>
<h2 id="lt-source-model-gt"><a href="#lt-source-model-gt" class="headerlink" title="&lt;source_model/&gt;"></a><code>&lt;source_model/&gt;</code></h2><p>The <code>&lt;source_model/&gt;</code> tag specifies a Model class (in URI/Grouped Class Name format) to populate a field’s default options. As of Magento Community Edition 1.4x, it works with selects and multi-selects. In addition to the standard Magento Grouped Class Name, an extended syntax of</p>
<pre><code>module/modelname::methodName</code></pre>
<p>is supported. The system will instantiate a Model with getModel(‘module/modelname’) and call its methodName method to retrieve an array of value/label paris to use for the source. If the method name is left off, the toOptionArray method will be called by default.</p>
<h2 id="lt-frontend-model-gt"><a href="#lt-frontend-model-gt" class="headerlink" title="&lt;frontend_model/&gt;"></a><code>&lt;frontend_model/&gt;</code></h2><p>By default, Magento Form Elements are rendered with the Block class</p>
<pre><code>Mage_Adminhtml_Block_System_Config_Form_Field</code></pre>
<p>However, if you want to use a custom renderer for your System Configuration field, you can specify a different block class (in URI/Grouped Class Name form) with the <code>&lt;frontend_model/&gt;</code> tag.</p>
<p>For example, the <code>last_update</code> field in the adminnotification group</p>
<pre><code>&lt;last_update translate=&quot;label&quot;&gt;
    &lt;label&gt;Last update&lt;/label&gt;
    &lt;frontend_type&gt;label&lt;/frontend_type&gt;
    &lt;frontend_model&gt;adminhtml/system_config_form_field_notification&lt;/frontend_model&gt;
    &lt;sort_order&gt;3&lt;/sort_order&gt;
    &lt;show_in_default&gt;1&lt;/show_in_default&gt;
    &lt;show_in_website&gt;0&lt;/show_in_website&gt;
    &lt;show_in_store&gt;0&lt;/show_in_store&gt;
&lt;/last_update&gt; </code></pre>
<p>specifies that a field renderer of <code>adminhtml/system_config_form_field_notification</code> should be used. This translates into the following class</p>
<pre><code>File: app/code/core/Mage/Adminhtml/Block/System/Config/Form/Field/Notification.php

class Mage_Adminhtml_Block_System_Config_Form_Field_Notification extends Mage_Adminhtml_Block_System_Config_Form_Field
&#123;
    protected function _getElementHtml(Varien_Data_Form_Element_Abstract $element)
    &#123;
        $element-&gt;setValue(Mage::app()-&gt;loadCache(&#39;admin_notifications_lastcheck&#39;));
        $format = Mage::app()-&gt;getLocale()-&gt;getDateTimeFormat(Mage_Core_Model_Locale::FORMAT_TYPE_MEDIUM);
        return Mage::app()-&gt;getLocale()-&gt;date(intval($element-&gt;getValue()))-&gt;toString($format);
    &#125;
&#125;</code></pre>
<p>The core team is overriding the <code>_getElementHtml</code> method to ensure that any entered date will be displayed with the same format.</p>
<h2 id="lt-backend-model-gt"><a href="#lt-backend-model-gt" class="headerlink" title="&lt;backend_model/&gt;"></a><code>&lt;backend_model/&gt;</code></h2><p>Once a form is submitted to Magento, its values must be saved. For System Configuration fields, this is normally handeled with the Model class</p>
<pre><code>Mage_Core_Model_Config_Data</code></pre>
<p>However, there may be times where you want your System Configuration to use a different backend model. The <code>&lt;backend_model/&gt;</code> tag allows you to specify a different Model class (using URI/Grouped Class Name format).</p>
<p>Most often this isn’t because you want to save where the data is stored, but rather because you want to perform some additional action when a field is saved. By extending the <code>Mage_Core_Model_Config_Data</code> class with your own model and defining a <code>_beforeSave</code> and/or <code>_afterSave</code> method on your model, you can take additional action anytime a config value is changed.</p>
<p>For example, consider the import field in the tablerate group</p>
<pre><code>&lt;import translate=&quot;label&quot;&gt;
    &lt;label&gt;Import&lt;/label&gt;
    &lt;frontend_type&gt;import&lt;/frontend_type&gt;
    &lt;backend_model&gt;adminhtml/system_config_backend_shipping_tablerate&lt;/backend_model&gt;
    &lt;sort_order&gt;6&lt;/sort_order&gt;
    &lt;show_in_default&gt;0&lt;/show_in_default&gt;
    &lt;show_in_website&gt;1&lt;/show_in_website&gt;
    &lt;show_in_store&gt;0&lt;/show_in_store&gt;
&lt;/import&gt;</code></pre>
<p>The Grouped Class Name <code>adminhtml/system_config_backend_shipping_tablerate</code> translates to the following class</p>
<pre><code>class Mage_Adminhtml_Model_System_Config_Backend_Shipping_Tablerate extends Mage_Core_Model_Config_Data
&#123;
    public function _afterSave()
    &#123;
        Mage::getResourceModel(&#39;shipping/carrier_tablerate&#39;)-&gt;uploadAndImport($this);
    &#125;
&#125;</code></pre>
<p>Here the core team is hooking into the <code>_afterSave</code> method (which is called after a model is saved) to update the shipping/carrier_tablerate Model with information from the just uploaded file.</p>
<pre><code>&lt;upload_dir/&gt; and &lt;base_url/&gt;</code></pre>
<p>Both these tags are used with System Configuration fields that use the <code>&lt;frontend_type&gt;image&lt;/frontend_type&gt;</code> field with a <code>&lt;backend_model&gt;adminhtml/system_config_backend_image&lt;/backend_model&gt;</code> backend model. These determine both</p>
<ol>
<li>Where the image file is uploaded</li>
<li>The base URI path used when rendering an <code>&lt;img&gt;</code> tag</li>
</ol>
<p>First, let’s cover the <code>&lt;upload_dir/&gt;</code> tag</p>
<pre><code>&lt;upload_dir config=&quot;system/filesystem/media&quot; scope_info=&quot;1&quot;&gt;sales/store/logo&lt;/upload_dir&gt;</code></pre>
<p>There’s three things being set by the above.</p>
<ol>
<li>The base image upload path</li>
<li>The path, from the base, where this specific image field should be uploaded</li>
<li>Whether or not the current config scope should be appended to the path</li>
</ol>
<p>The <strong>base image upload path</strong> is set with the config attribute (<code>system/filesystem/media above</code>). This specifies a System Configuration path. That is, the base image upload path isn’t <code>system/filesystem/media</code>, but it’s the value of the Magento System Configuration at <code>system/filesystem/media</code> (which resolves to <code>&#123;&#123;root_dir&#125;&#125;/media</code> in a default Community Edition install)</p>
<p>Once the base image upload path is found, we need to append the sub-directory this specific image should be uploaded to. To get this we append the value of the <code>&lt;upload_dir/&gt;</code>‘s text node</p>
<pre><code>sales/store/logo</code></pre>
<p>to the value of the base image upload path, which will give us something like this</p>
<pre><code>/path/to/magento/install/media/sales/store/logo</code></pre>
<p>Finally, if the <code>scope</code> attribute is set to “1”, the current Configuration Scope will be transformed into a path. If you were uploading an image with the scope set to default, you’d get a path like</p>
<pre><code>/path/to/magento/install/media/sales/store/logo/default</code></pre>
<p>However, if you were uploading an image with the scope set to a specific store, you’d end up with a path like</p>
<pre><code>/path/to/magento/install/media/sales/store/logo/stores/5</code></pre>
<p>where “5” is the ID of the store scope you’re currently at.</p>
<p>When we upload an image, only the scope and image name portion of the path get saved to the config. This means we need to tell the System what the base URL should be for our image.</p>
<pre><code>&lt;base_url type=&quot;media&quot; scope_info=&quot;1&quot;&gt;sales/store/logo&lt;/base_url&gt;</code></pre>
<p>The scope_info and text node function the same as <code>&lt;upload_dir/&gt;</code>‘s. Where <code>&lt;base_url/&gt;</code> differs is in setting the base of the image URI (which is going to, naturally, be different than the local base file system path).</p>
<p>As you’ve likely intuited, the base path is set using the type attribute. The configured value will be passed into the getBaseUrl method on the global Mage object to set the base URL for the image. The the above example, that would look something like</p>
<pre><code>Mage::getBaseUrl(&#39;media&#39;)</code></pre>
<p>You can see the actual code that does this in the <code>Mage_Adminhtml_Block_System_Config_Form_Field_Image</code> class.</p>
<pre><code>class Mage_Adminhtml_Block_System_Config_Form_Field_Image extends Varien_Data_Form_Element_Image
&#123;
    //...

    protected function _getUrl()
    &#123;
        $url = parent::_getUrl();

        $config = $this-&gt;getFieldConfig();
        /* @var $config Varien_Simplexml_Element */
        if (!empty($config-&gt;base_url)) &#123;
            $el = $config-&gt;descend(&#39;base_url&#39;);
            $urlType = empty($el[&#39;type&#39;]) ? &#39;link&#39; : (string)$el[&#39;type&#39;];
            $url = Mage::getBaseUrl($urlType) . (string)$config-&gt;base_url . &#39;/&#39; . $url;
        &#125;

        return $url;
    &#125;

    //...
&#125;</code></pre>
<p>Finally, it’s important to note that this base URL is not used consistently throughout Magento to create a final URL for a configured image. From what I’ve seen this is only used to create an image preview within the System Configuration admin itself.</p>
<hr>
<p>以上是摘录了<a target="_blank" rel="noopener" href="https://alanstorm.com/">alan storm</a>的部分内容</p>
<h2 id="在已有的配置段或者组中添加数据"><a href="#在已有的配置段或者组中添加数据" class="headerlink" title="在已有的配置段或者组中添加数据"></a>在已有的配置段或者组中添加数据</h2><p>除了新建一个标签页，或者配置段，你也可以利用已有的标签页和配置段，向里面添加内容。比如我们添加以下代码到system.xml</p>
<pre><code>File: app/code/local/Magentotutorial/Helloworld/etc/system.xml</code></pre>
<p>Xml代码</p>
<pre><code>&lt;config&gt;  
    &lt;!– … –&gt;  
    &lt;sections&gt;  
        &lt;!– … –&gt;  
        &lt;general&gt;  
            &lt;groups&gt;  
                &lt;example&gt;  
                    &lt;label&gt;添加组的示例,来自Helloworld模块&lt;/label&gt;  
                    &lt;frontend_type&gt;text&lt;/frontend_type&gt;  
                    &lt;sort_order&gt;1&lt;/sort_order&gt;  
                    &lt;show_in_default&gt;1&lt;/show_in_default&gt;  
                    &lt;show_in_website&gt;1&lt;/show_in_website&gt;  
                    &lt;show_in_store&gt;1&lt;/show_in_store&gt;                     
                &lt;/example&gt;  
            &lt;/groups&gt;  
        &lt;/general&gt;  
        &lt;!– … –&gt;  
    &lt;/section&gt;  
&lt;/config&gt;  </code></pre>
<p>刷新页面，你会在“General”标签页下面看到一个新的组，叫做“<code>添加组的示例,来自Helloworld模块</code>”。</p>
<p><img src="https://i.imgur.com/u5SEt8a.png"></p>
<h2 id="如何获得配置数据"><a href="#如何获得配置数据" class="headerlink" title="如何获得配置数据"></a>如何获得配置数据</h2><p>到目前为止，我们只是讲了如何设置Magento，可以让用户可以配置我们的模块。现在让我们来看看如何获取用户的配置数据。</p>
<p>Php代码</p>
<pre><code>Mage::getStoreConfig(&#39;helloworld_options/messages/hello_message&#39;);   </code></pre>
<p>上面这行代码就可以获取我们上面配置的那个“select”选项的数据。这个函数的参数是我们要获取的数据的URI，格式如下</p>
<pre><code>section_name/group_name/field_name</code></pre>
<p>你也可以通过以下代码来获取一个组或者段的所有值</p>
<p>Php代码</p>
<pre><code>Mage::getStoreConfig(&#39;helloworld_options/messages&#39;);  
Mage::getStoreConfig(&#39;helloworld_options&#39;);   </code></pre>
<p>最后，如果你想获取针对某个特定店面（store）的数据，你可以传入store ID</p>
<p>Php代码</p>
<pre><code>Mage::getStoreConfig(&#39;helloworld_options&#39;,1);  </code></pre>
<p>比如笔者把这个在后天添加的配置显示到前台页面中去，我们该怎么运用呢？</p>
<p>举例，这里笔者想要在网站的头部显示后台设置的两个内容，当然，肯定是先找到头部的模板文件，笔者这里是header1.phtml，打开这个文件，然后在最前面添加：</p>
<pre><code>&lt;?php 
echo Mage::getStoreConfig(&#39;helloworld_options/messages/hello_message&#39;);
echo &quot;&lt;br/&gt;&quot;;
echo Mage::getStoreConfig(&#39;helloworld_options/messages/good_message&#39;);
echo &quot;&lt;br/&gt;&quot;;
echo Mage::getStoreConfig(&#39;helloworld_options/messages/dianyou_message&#39;);
 ?&gt;</code></pre>
<p>记住：这里添加的是helloworld_options中的messages这个下面的<code>hello_message</code>、<code>good_message</code>和<code>dianyou_message</code>这三个，那么我们就找到这三个在后台的设置选项那里填写一些内容试试。</p>
<p><img src="https://i.imgur.com/0YZtPxt.png"></p>
<p>我们刷新下前台任何页面，看下效果：</p>
<p><img src="https://i.imgur.com/Dg76d8m.png"></p>
<p>这里我们看到已经出现了内容，第二个显示的是一个下拉框的内容的值，不是hello，而是1，那是因为我们在Words.php里面的那个数组那里，我们把label为hello的值对应成1（<code>array(&#39;value&#39;=&gt;1, &#39;label&#39;=&gt;Mage::helper(&#39;helloworld&#39;)-&gt;__(&#39;Hello&#39;))</code>），因此，已经达到我们想要的效果了。</p>
<p>这个时候，我们还可以进一步的扩展一下，这里显示的全是组message的东西，那能不能多添加几个与massage彼此并列的那种呢？答案是：可以的。</p>
<p>笔者添加了一些，总体如下：</p>
<pre><code>&lt;sections&gt;
    &lt;helloworld_options translate=&quot;label&quot; module=&quot;helloworld&quot;&gt;
        &lt;label&gt;Hello World Config Options&lt;/label&gt;
        &lt;tab&gt;helloconfig&lt;/tab&gt;
        &lt;frontend_type&gt;text&lt;/frontend_type&gt;
        &lt;sort_order&gt;1000&lt;/sort_order&gt;
        &lt;show_in_default&gt;1&lt;/show_in_default&gt;
        &lt;show_in_website&gt;1&lt;/show_in_website&gt;
        &lt;show_in_store&gt;1&lt;/show_in_store&gt;
        &lt;groups&gt;  
            &lt;messages translate=&quot;label&quot;&gt;  
                &lt;label&gt;Demo Of Config Fields&lt;/label&gt;  
                &lt;frontend_type&gt;text&lt;/frontend_type&gt;  
                &lt;sort_order&gt;1&lt;/sort_order&gt;  
                &lt;show_in_default&gt;1&lt;/show_in_default&gt;  
                &lt;show_in_website&gt;1&lt;/show_in_website&gt;  
                &lt;show_in_store&gt;1&lt;/show_in_store&gt;
                &lt;fields&gt;
                    &lt;hello_message&gt;
                        &lt;label&gt;Hello Message&lt;/label&gt;  
                        &lt;frontend_type&gt;text&lt;/frontend_type&gt;
                        &lt;sort_order&gt;1&lt;/sort_order&gt;
                        &lt;show_in_default&gt;1&lt;/show_in_default&gt;
                        &lt;show_in_website&gt;1&lt;/show_in_website&gt;
                        &lt;show_in_store&gt;1&lt;/show_in_store&gt;  
                    &lt;/hello_message&gt;
                    &lt;good_message&gt;  
                        &lt;label&gt;Good Message select:&lt;/label&gt;
                        &lt;frontend_type&gt;select&lt;/frontend_type&gt;
                        &lt;frontend_class&gt;free-method&lt;/frontend_class&gt;
                        &lt;source_model&gt;helloworld/words&lt;/source_model&gt;
                        &lt;sort_order&gt;1&lt;/sort_order&gt;
                        &lt;show_in_default&gt;1&lt;/show_in_default&gt;
                        &lt;show_in_website&gt;1&lt;/show_in_website&gt;
                        &lt;show_in_store&gt;1&lt;/show_in_store&gt;
                    &lt;/good_message&gt;
                    &lt;dianyou_message&gt;  
                        &lt;label&gt;Good Message email:&lt;/label&gt;
                        &lt;frontend_type&gt;text&lt;/frontend_type&gt;
                        &lt;validate&gt;validate-email&lt;/validate&gt;
                        &lt;sort_order&gt;1&lt;/sort_order&gt;
                        &lt;show_in_default&gt;1&lt;/show_in_default&gt;
                        &lt;show_in_website&gt;1&lt;/show_in_website&gt;
                        &lt;show_in_store&gt;1&lt;/show_in_store&gt;
                    &lt;/dianyou_message&gt;
                &lt;/fields&gt;
            &lt;/messages&gt;
            &lt;allowspecific translate=&quot;label&quot;&gt;
               &lt;label&gt;Payment Applicable From&lt;/label&gt;
               &lt;frontend_type&gt;select&lt;/frontend_type&gt;
               &lt;sort_order&gt;100&lt;/sort_order&gt;
               &lt;source_model&gt;adminhtml/system_config_source_payment_allspecificcountries&lt;/source_model&gt;
               &lt;show_in_default&gt;1&lt;/show_in_default&gt;
               &lt;show_in_website&gt;1&lt;/show_in_website&gt;
               &lt;show_in_store&gt;0&lt;/show_in_store&gt;
            &lt;/allowspecific&gt;
            &lt;specificcountry translate=&quot;label&quot;&gt;
                &lt;label&gt;Countries Payment Applicable From&lt;/label&gt;
                &lt;frontend_type&gt;multiselect&lt;/frontend_type&gt;
                &lt;sort_order&gt;110&lt;/sort_order&gt;
                &lt;source_model&gt;adminhtml/system_config_source_country&lt;/source_model&gt;
                &lt;show_in_default&gt;1&lt;/show_in_default&gt;
                &lt;show_in_website&gt;1&lt;/show_in_website&gt;
                &lt;show_in_store&gt;0&lt;/show_in_store&gt;
                &lt;depends&gt;&lt;allowspecific&gt;1&lt;/allowspecific&gt;&lt;/depends&gt;
            &lt;/specificcountry&gt;
            &lt;last_update translate=&quot;label&quot;&gt;
                &lt;label&gt;Last update&lt;/label&gt;
                &lt;frontend_type&gt;label&lt;/frontend_type&gt;
                &lt;frontend_model&gt;adminhtml/system_config_form_field_notification&lt;/frontend_model&gt;
                &lt;sort_order&gt;1&lt;/sort_order&gt;
                &lt;show_in_default&gt;1&lt;/show_in_default&gt;
                &lt;show_in_website&gt;0&lt;/show_in_website&gt;
                &lt;show_in_store&gt;0&lt;/show_in_store&gt;
            &lt;/last_update&gt;
            &lt;import translate=&quot;label&quot;&gt;
                &lt;label&gt;Import&lt;/label&gt;
                &lt;frontend_type&gt;import&lt;/frontend_type&gt;
                &lt;backend_model&gt;adminhtml/system_config_backend_shipping_tablerate&lt;/backend_model&gt;
                &lt;sort_order&gt;1&lt;/sort_order&gt;
                &lt;show_in_default&gt;0&lt;/show_in_default&gt;
                &lt;show_in_website&gt;1&lt;/show_in_website&gt;
                &lt;show_in_store&gt;0&lt;/show_in_store&gt;
            &lt;/import&gt;
        &lt;/groups&gt;
    &lt;/helloworld_options&gt;
&lt;/sections&gt;</code></pre>
<p>根据以上的知识，相信这个不难理解，其实就是新添加了多个组：allowspecific、specificcountry、last_update、import</p>
<p>目前这些组里面还没有东西：</p>
<p><img src="https://i.imgur.com/UZhMBPa.png"></p>
<p>如果想要有东西，也需要向message这个组那样，添加一些字段：<code>field</code>，里面添加一些东西即可，可以参照massage这个组。</p>
<p>我们进一步上溯一级，如果我们想要tab这个添加多个子下属呢？把这个：</p>
<p><img src="https://i.imgur.com/HG7Cqdj.png"></p>
<p>下面添加一个：</p>
<p><img src="https://i.imgur.com/m2eDXA2.png"></p>
<p>这个也很简单，把</p>
<pre><code>&lt;helloworld_options translate=&quot;label&quot; module=&quot;helloworld&quot;&gt;
...
&lt;/helloworld_options&gt;</code></pre>
<p>这个复制一份跟这个放在同级，然后修改一下标签名，笔者这里改成了：</p>
<pre><code>&lt;hello_options translate=&quot;label&quot; module=&quot;helloworld&quot;&gt;
            &lt;label&gt;Hello 2 World Config Options&lt;/label&gt;
            &lt;tab&gt;helloconfig&lt;/tab&gt;
            &lt;frontend_type&gt;text&lt;/frontend_type&gt;
            &lt;sort_order&gt;1001&lt;/sort_order&gt;
            &lt;show_in_default&gt;1&lt;/show_in_default&gt;
            &lt;show_in_website&gt;1&lt;/show_in_website&gt;
            &lt;show_in_store&gt;1&lt;/show_in_store&gt;
            ...
&lt;/hello_options&gt;</code></pre>
<p>这里说明下：label名称改成了Hello 2 World Config Options，方便区分，tab这个名字不能修改，为什么呢，大家看下system.xml就知道了。</p>
<pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;config&gt;
    &lt;tabs&gt;
        &lt;helloconfig translate=&quot;label&quot; module=&quot;helloworld&quot;&gt;
            &lt;label&gt;Hello Config&lt;/label&gt;
            &lt;sort_order&gt;99999&lt;/sort_order&gt;
        &lt;/helloconfig&gt;
    &lt;/tabs&gt;
    ....</code></pre>
<p>既然，我们是在hello config这个tab下添加子目录，那么必须得是<code>&lt;tab&gt;helloconfig&lt;/tab&gt;</code>，然后我们记得要把复制过来的组的标签名修改下，免得冲突了。然后清除下缓存，退出一下登录（不然，会变成404的），然后重新登录，就可以看到新添加的那个了（Hello 2 World Config Options），然后点击进去，就可以看到有东西了。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这里我们讲了如何在Magento的后台管理中添加个性化的配置。我们也顺便介绍了帮助类的使用和ACL基础。这里最重要的内容是后台配置的层级 结构，标签页包含了配置段，配置段包含了组，组包含了配置选项。我们将在以后的章节中介绍系统配置的高级内容，包括自定义格式，数据验证等等。完成了这篇文章的吸收后，相信我们能够做到在magento后台自定义配置的内容了，也能够理解那些标签的用法和意思了。建议大家结合笔者的其他的几篇关于magento开发的文章阅读，这篇文章是在已经创建了Helloworld的基础上进行实践的。希望大家先去创建这样的一个模块再来阅读本篇文章。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://helongquan.github.io/2018/08/20/%E5%A6%82%E4%BD%95%E6%8A%8A%E5%AD%97%E5%86%99%E5%A5%BD%E7%9A%84%E4%B8%80%E4%BA%9B%E4%B8%AA%E4%BA%BA%E5%BF%83%E5%BE%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="泉哥">
      <meta itemprop="description" content="日记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鸢尾花序">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/08/20/%E5%A6%82%E4%BD%95%E6%8A%8A%E5%AD%97%E5%86%99%E5%A5%BD%E7%9A%84%E4%B8%80%E4%BA%9B%E4%B8%AA%E4%BA%BA%E5%BF%83%E5%BE%97/" class="post-title-link" itemprop="url">如何把字写好的一些个人心得</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-08-20 09:25:36" itemprop="dateCreated datePublished" datetime="2018-08-20T09:25:36+08:00">2018-08-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 11:58:05" itemprop="dateModified" datetime="2020-10-11T11:58:05+08:00">2020-10-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%BF%83%E5%BE%97/" itemprop="url" rel="index"><span itemprop="name">心得</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ol>
<li>写的字要搭配合理，每个部位的比例要合适，比如“<code>别</code>”这个字，如果左边跟右边搭配不合适，左边少，右边多，或者左边跟右边一样多，都会给人感觉不是很合理的搭配，这个字注定了左边占比要大于右边。这样才显得好看。</li>
<li>上下比例好适中，符合一个字标准的结构，比如“<code>贡</code>”这个字，如果上面比下面还要窄，那么就会很丑，如果上面太宽了，也不好。根据笔者的观察，这个字下面部分的宽度跟上面那部分最上面的那一横宽度一样是比较好看的。这个就需要一个把握了，因此，长期没有对一个字审美的习惯性把握的人，总会犯这样或那样的错误。</li>
<li>竖这个笔画要注意，这个笔画一定要直，不能斜了，斜了这个字基本就不好看了。比如：<code>中</code>这个字，其实这个字的精髓就在这一竖这里，这一竖在这个字的横向是中间位置，然后就是像一把利剑那样竖下来。</li>
<li>对于有交叉的情况，交叉要交叉得合理，不能只交叉一点点，交叉得要到位。比如：<code>级</code>这个字，这个字右边的下面有个交叉的地方，这个地方如果这一捺写得很短，那么这个字就不好看。</li>
<li>如果有框框的情况，要记得确保里面要饱满，但又不能太拥挤了，这是为何呢？如果里面填充得不合理，会显得很空，比如：<code>南</code>这个字，如果里面的那个类似人民币符号的部分写得很小的话，这个字就显得很空，又比如：<code>有</code>这个字，如果里面的<code>月</code>这个部分写得很小，那么这个字就不好看，如果写得太大，会把里面撑满，也不好看。</li>
<li>对于宝盖头系列的，个人认为要宽得充分点，不能小气，就像一个人戴帽子那样，如果帽子比头还要小，那么就显得不合理了。比如：<code>合</code>这个字。这个字上面的部分如果还没盖住下面的部分的时候，就显得不好看，当然也不能盖住得超出太多了。</li>
<li>横这个笔画也要用好用巧，横这个笔画通常可以不用写得太直了，有点点微微的斜角会显得更好看，记住：是微微的倾斜，当然也可以不倾斜。</li>
</ol>
<p><strong>作为最后的忠告：</strong>其实更多的是需要我们在生活中学习，在日常的书法中找到精髓，有了以上的这些，起码你不会在看的一份书法展的时候，变得很迷茫而不知道如何欣赏别人的作品，同时，也知道如何弥补自己IDE不足和欣赏别人的字体来获取进一步的提升，我想这是很重要的。</p>
<p>本文会持续更新：2018/8/20 10:00:21 </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://helongquan.github.io/2018/08/18/Magento%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3-%E5%9B%9B%EF%BC%89Magento%E5%B8%83%E5%B1%80%E3%80%81%E5%9D%97-%E3%80%81%E6%A8%A1%E6%9D%BF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="泉哥">
      <meta itemprop="description" content="日记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鸢尾花序">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/08/18/Magento%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3-%E5%9B%9B%EF%BC%89Magento%E5%B8%83%E5%B1%80%E3%80%81%E5%9D%97-%E3%80%81%E6%A8%A1%E6%9D%BF/" class="post-title-link" itemprop="url">Magento开发文档(四）Magento布局、块 、模板</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-08-18 11:06:13" itemprop="dateCreated datePublished" datetime="2018-08-18T11:06:13+08:00">2018-08-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 11:58:00" itemprop="dateModified" datetime="2020-10-11T11:58:00+08:00">2020-10-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/magento1/" itemprop="url" rel="index"><span itemprop="name">magento1</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>原文地址：<a target="_blank" rel="noopener" href="https://devdocs.magento.com/guides/m1x/magefordev/mage-for-dev-4.html">https://devdocs.magento.com/guides/m1x/magefordev/mage-for-dev-4.html</a></p>
<p>刚入门magento的开发者容易吧布局和视图给混淆. 本文将看看Magento的Layout/Block的做法, 并告诉您如何将其融入Magento的MVC的世界观。</p>
<p>与许多流行的MVC系统相比，Magento的执行控制器不通过数据对象到视图或在视图对象中设置属性（只有少数例外）。相反，视图组件直接引用系统模型来获得它需要显示的信息。</p>
<p>这样的设计决策的后果之一是，视图分成块和模板。块是PHP对象，模板是包含HTML和PHP（在这里PHP作为模板语言）“原始”的PHP文件（带.phtml扩展名）的组合。每一个块都和一个唯一的模板文件绑定。在模板文件phtml中，“$this”就是指该模板文件对应的块对象。</p>
<p>来一个快速的例子吧：</p>
<pre><code>app/design/frontend/base/default/template/catalog/product/list.phtml</code></pre>
<p>你将会看到下列的php代码：</p>
<pre><code>&lt;?php $_productCollection=$this-&gt;getLoadedProductCollection() ?&gt;
&lt;?php if(!$_productCollection-&gt;count()): ?&gt; &lt;div class=&quot;note-msg&quot;&gt;
    &lt;?php echo $this-&gt;__(&quot;There are no products matching the selection.&quot;) ?&gt;
&lt;/div&gt; &lt;?php else: ?&gt;
...</code></pre>
<p><code>getLoadedProductCollection</code> 方法可以在该模板的Block的类中找到。<code>Mage_Catalog_Block_Product_List</code>找到下面的地址，</p>
<pre><code>File: app/code/core/Mage/Catalog/Block/Product/List.php</code></pre>
<p>打开这个文件，我们找到下列这段代码：</p>
<pre><code>...
public function getLoadedProductCollection()
&#123;
    return $this-&gt;_getProductCollection();
&#125;
...</code></pre>
<p>块的<code>_getProductCollection</code>方法实例化模型，并读取它们的数据，其结果返回给模板。</p>
<h2 id="嵌套块"><a href="#嵌套块" class="headerlink" title="嵌套块"></a>嵌套块</h2><p>Magento 把视图分离成块和模板的真正强大之处在于“<code>getChildHtml</code>”方法。这个方法可以让你实现在块中嵌套块的功能。顶层的块调用第二层的块，然后是第三层……这就是 Magento如何输出 HTML的。让我们来看一下单列的顶层模板</p>
<pre><code>File: app/design/frontend/base/default/template/page/1column.phtml</code></pre>
<p>打开这个文件，</p>
<pre><code>&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Strict//EN&quot; &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd&quot;&gt;  
&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot; xml:lang=&quot;&lt;?php echo $this-&gt;getLang() ?&gt;&quot; lang=&quot;&lt;?php echo $this-&gt;getLang() ?&gt;&quot;&gt;  
&lt;head&gt;  
&lt;?php echo $this-&gt;getChildHtml(&#39;head&#39;) ?&gt;  
&lt;/head&gt;  
&lt;body&lt;?php echo $this-&gt;getBodyClass()?&#39; class=&quot;&#39;.$this-&gt;getBodyClass().&#39;&quot;&#39;:&#39;&#39; ?&gt;&gt;  
&lt;?php echo $this-&gt;getChildHtml(&#39;after_body_start&#39;) ?&gt;  
&lt;div class=&quot;wrapper&quot;&gt;  
    &lt;?php echo $this-&gt;getChildHtml(&#39;global_notices&#39;) ?&gt;  
    &lt;div class=&quot;page&quot;&gt;  
        &lt;?php echo $this-&gt;getChildHtml(&#39;header&#39;) ?&gt;  
        &lt;div class=&quot;main-container col1-layout&quot;&gt;  
            &lt;div class=&quot;main&quot;&gt;  
                &lt;?php echo $this-&gt;getChildHtml(&#39;breadcrumbs&#39;) ?&gt;  
                &lt;div class=&quot;col-main&quot;&gt;  
                    &lt;?php echo $this-&gt;getChildHtml(&#39;global_messages&#39;) ?&gt;  
                    &lt;?php echo $this-&gt;getChildHtml(&#39;content&#39;) ?&gt;  
                &lt;/div&gt;  
            &lt;/div&gt;  
        &lt;/div&gt;  
        &lt;?php echo $this-&gt;getChildHtml(&#39;footer&#39;) ?&gt;  
        &lt;?php echo $this-&gt;getChildHtml(&#39;before_body_end&#39;) ?&gt;  
    &lt;/div&gt;  
&lt;/div&gt;  
&lt;?php echo $this-&gt;getAbsoluteFooter() ?&gt;  
&lt;/body&gt;  
&lt;/html&gt;</code></pre>
<p>我们可以看到这个模板里面很多地调用了“$this-&gt;getChildHtml(…)”。每次调用都会引入另外一个块的HTML内容，直到最底层的块。</p>
<h2 id="布局对象"><a href="#布局对象" class="headerlink" title="布局对象"></a>布局对象</h2><p>看到这里，你可能有这样的疑问</p>
<ul>
<li>Magento怎么知道在一个页面上要用那些块？</li>
<li>Magento怎么知道哪一个块是顶层块？</li>
<li>“<code>$this-&gt;getChildHtml(…)</code>”里面的参数是什么意思？块的名字吗？</li>
</ul>
<p>Magento引入了布局对象（Layout Object）来解决上面的那些问题。布局对象（或者说布局文件）就是一个XML文件，定义了一个页面包含了哪些块，并且定义了哪个块是顶层块。</p>
<p>在第二章的时候我们在执行方法（Action Method）里面直接输出了HTML内容。现在我们要为我们的Hello World模块创建一个简单的HTML模板。首先我们要创建如下文件 </p>
<p>首先，在如下路径创建一个文件：local.xml</p>
<pre><code>app/design/frontend/yourtheme/default/layout/local.xml</code></pre>
<p>文件内容如下：</p>
<pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;layout version=&quot;0.1.0&quot;&gt;
   &lt;default&gt;
        &lt;reference name=&quot;root&quot;&gt;
            &lt;block type=&quot;page/html&quot; name=&quot;root&quot; output=&quot;toHtml&quot; template=&quot;magentotutorial/helloworld/simple_page.phtml&quot; /&gt;
        &lt;/reference&gt;
    &lt;/default&gt;
&lt;/layout&gt;</code></pre>
<p>然后，在以下目录创建一个文件：simple_page.phtml</p>
<pre><code>app/design/frontend/yourtheme/default/template/magentotutorial/helloworld/simple_page.phtml</code></pre>
<p>文件内容如下：</p>
<pre><code>&lt;!DOCTYPE&gt;
&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;
&lt;head&gt;
    &lt;title&gt;Hello World&lt;/title&gt;
    &lt;style type=&quot;text/css&quot;&gt;
        body &#123;
            background-color:#f00;
        &#125;
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;

&lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>最后，我们要在执行控制器里面调用布局文件，开始输出HTML。修改执行方法如下</p>
<pre><code>public function indexAction() &#123;  
    //remove our previous echo  
    //echo &#39;Hello Index!&#39;;  
    $this-&gt;loadLayout();  
    $this-&gt;renderLayout();  
&#125;</code></pre>
<p>清空Magento缓存，访问URL “<a target="_blank" rel="noopener" href="http://exmaple.com/helloworld/index/index%E2%80%9D%E3%80%82%E4%BD%A0%E5%BA%94%E8%AF%A5%E7%9C%8B%E5%88%B0%E4%B8%80%E4%B8%AA%E7%BA%AF%E7%BA%A2%E8%89%B2%E8%83%8C%E6%99%AF%E7%9A%84%E9%A1%B5%E9%9D%A2%E3%80%82%E8%BF%99%E4%B8%AA%E9%A1%B5%E9%9D%A2%E7%9A%84%E6%BA%90%E4%BB%A3%E7%A0%81%E5%BA%94%E8%AF%A5%E5%92%8C%E6%88%91%E4%BB%AC%E5%88%9B%E5%BB%BA%E7%9A%84%E6%96%87%E4%BB%B6%E2%80%9Csimple_page.phtml%E2%80%9D%E4%B8%80%E6%A8%A1%E4%B8%80%E6%A0%B7%E3%80%82">http://exmaple.com/helloworld/index/index”。你应该看到一个纯红色背景的页面。这个页面的源代码应该和我们创建的文件“simple_page.phtml”一模一样。</a></p>
<h2 id="这到底发生什么事？"><a href="#这到底发生什么事？" class="headerlink" title="这到底发生什么事？"></a>这到底发生什么事？</h2><p>也许你看到这里一头雾水，没关系，我们来慢慢解释。首先你得安装一个 <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/17i8JMR_4adeWGy3SCKgsnw">Layout Viewer</a> 模块（密码：tbzd），这和我们第一章讲的 <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1F1bwCnfV4V5o5ARxRjorDQ">Config Viewer</a> 模块（密码：jjlh）很相似，都是查看Magento的内部信息。安装完这个模块之后【译者注：你需要参照第一章的内容，为这个模块创建“<code>app/etc/modules/Magentotutorial_Layoutviewer.xml</code>”】，打开如下URL  <a target="_blank" rel="noopener" href="http://example.com/helloworld/index/index?showLayout=page">http://example.com/helloworld/index/index?showLayout=page</a> 你看到的是你正在请求的页面的布局文件。它是由<code>&lt;block /&gt;</code>，<code>&lt;reference /&gt;</code>和<code>&lt;remove /&gt;</code>组成的。当你在执行方法中调用“loadLayout”时，Magento会做如下处理生成这个布局文件为每一个<code>&lt;block /&gt;</code>和<code>&lt;reference /&gt;</code>标签实例化一个块对象。</p>
<p>块对象的类名是通过标签的name属性来查找的。这些块对象被存储在布局对象的<code>_blocks</code>数组中如果<code>&lt;block /&gt;</code>标签包含了output属性，那么这个块的名字和output属性的值会被添加到布局对象的<code>_output</code>数组中然后，当你在执行方法中调用“<code>renderLayout</code>”方法时，Magento会遍历<code>_output</code>数组中所有的块名字，从<code>_blocks</code>数组中获得该名字的块，并调用块对象中使用output属性的值作为名字的函数。这个函数往往是“<code>toHtml</code>”。这个output属性也告诉Magento这里就是输出HTML的起点，也就是顶层块。【译者注：直接阅读Layout类的代码应该比较容易理解这里的逻辑 <code>File: app/code/core/Mage/Core/Model/Layout.php</code></p>
<pre><code>public function getOutput()  
&#123;  
    $out = &#39;&#39;;  
    if (!emptyempty($this-&gt;_output)) &#123;          
        foreach ($this-&gt;_output as $callback) &#123;  
            $out .= $this-&gt;getBlock($callback[0])-&gt;$callback[1]();  
        &#125;  
    &#125;  
    return $out;  
&#125;  </code></pre>
<p>从这里我们也可以看出，一个页面的布局文件时可以拥有多个顶层块。</p>
<p>下面我们要讲解块对象是如何被实例化的，这个布局文件时如何被生成的，最后我们将动手做一个例子来实践这一章讲的内容。</p>
<h2 id="实例化块对象"><a href="#实例化块对象" class="headerlink" title="实例化块对象"></a>实例化块对象</h2><p>在布局文件中，<code>&lt;block /&gt;</code>和<code>&lt;reference /&gt;</code>标签有一个“type”属性，这个属性其实是一个URI</p>
<pre><code>&lt;block type=&quot;page/html&quot; ...
&lt;block type=&quot;page/template_links&quot; ...</code></pre>
<p>Magento就是通过这个URI是用来查找块对应的类名。这个URI分为两部分，第一部分“page”是用来在全局配置中查找一个基本类名，第二部分“html”或者“<code>template_link</code>”将被添加到基本类名后面生成一个具体的将被实例化的类名。</p>
<p>我们以“<code>page/html</code>”为例。首先Magento在以下目录找到全局配置节点，</p>
<pre><code>app/code/core/Mage/Page/etc/config.xml</code></pre>
<p>打开文件，找到，</p>
<pre><code>&lt;page&gt;
    &lt;class&gt;Mage_Page_Block&lt;/class&gt;
&lt;/page&gt;</code></pre>
<p>这里我们拿到了一个基本类名“<code>Mage_Page_Block</code>”，然后添加URI的第二部分“html”到基本类名后面，我们就得到最终的块对象的类名 “<code>Mage_Page_Block_Html</code>”。块的类名在Magento中被称为“分组类名”（Grouped Class Names），这些类都用相似的方法被实例化。如果我们创建一个与现有块同名的块，则新块实例将替换原始实例。这就是我们在上面的local.xml文件中所做的。</p>
<pre><code>&lt;layout version=&quot;0.1.0&quot;&gt;
    &lt;default&gt;
        &lt;block type=&quot;page/html&quot; name=&quot;root&quot; output=&quot;toHtml&quot; template=&quot;magentotutorial/helloworld/simple_page.phtml&quot; /&gt;
    &lt;/default&gt;
&lt;/layout&gt;</code></pre>
<p>name为root的块已替换为我们的Block。</p>
<h2 id="lt-block-gt-和-lt-reference-gt-的区别"><a href="#lt-block-gt-和-lt-reference-gt-的区别" class="headerlink" title="&lt;block /&gt;和&lt;reference /&gt;的区别"></a><code>&lt;block /&gt;</code>和<code>&lt;reference /&gt;</code>的区别</h2><p>我们上面提到<code>&lt;block /&gt;</code>和<code>&lt;reference /&gt;</code>都会实例化块对象，那么它们究竟有什么区别呢？ <code>&lt;reference /&gt;</code>在布局文件中是用来表示替换一个已经存在的块，举个例子</p>
<pre><code>&lt;block type=&quot;page/html&quot; name=&quot;root&quot; output=&quot;toHtml&quot; template=&quot;page/2columns-left.phtml&quot;&gt;  
    &lt;!-- ... sub blocks ... --&gt;  
&lt;/block&gt;  
&lt;!-- ... --&gt;  
&lt;reference name=&quot;root&quot;&gt;  
    &lt;block type=&quot;page/someothertype&quot; name=&quot;root&quot; template=&quot;path/to/some/other/template&quot; /&gt;  
    &lt;!-- ... sub blocks ... --&gt;  
    &lt;/block&gt;  
&lt;/reference&gt;</code></pre>
<p>Magento首先创建了一个名叫“root”的块。然后，它有发现了一个引用（reference）的名字也叫“root”，Magento会把原来那个“root”块替换成<code>&lt;reference /&gt;</code>标签里面的那个块。</p>
<p>再来看看我们之前创建那个local.xml</p>
<pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;layout version=&quot;0.1.0&quot;&gt;
   &lt;default&gt;
        &lt;reference name=&quot;root&quot;&gt;
            &lt;block type=&quot;page/html&quot; name=&quot;root&quot; output=&quot;toHtml&quot; template=&quot;magentotutorial/helloworld/simple_page.phtml&quot; /&gt;
        &lt;/reference&gt;
    &lt;/default&gt;
&lt;/layout&gt;</code></pre>
<p>在这里，块“root”被我们用<code>&lt;reference /&gt;</code>替换了，指向了一个不同的模板文件。</p>
<h2 id="布局文件是如何生成的"><a href="#布局文件是如何生成的" class="headerlink" title="布局文件是如何生成的"></a>布局文件是如何生成的</h2><p>现在我们对布局文件已经有所了解了，但是这个布局文件是那里来的呢？要回答这个问题，我们得引入Magento中的另外两个概念，操作（<strong>Handle</strong>）和包布局（<strong>Package Layout</strong>）。</p>
<h2 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h2><p>Magento会为每一个页面请求生成几个不同的操作。我们的Layout View模块可以显示这些操作。在浏览器上输入如下地址：</p>
<pre><code>http://example.com/helloworld/index/index?showLayout=handles</code></pre>
<p>你应该看到类似如下列表的内容（显示的内容和你的网站配置有关）</p>
<pre><code>default

STORE_bare_us

THEME_frontend_default_default

helloworld_index_index

customer_logged_out</code></pre>
<p>它们每一个都是一个操作的名字。我们可以在Magento系统的不同的地方配置操作。在这里我们需要关注两个操作 “default” 和 “<code>helloworld_index_index</code>”。“default”操作是Magento的默认处理器，参与每一个请求的处理。 “<code>helloworld_index_index</code>”操作的名字是frontname （helloworld）加上执行控制器的名字（index）再加上执行方法的名字（index）。这说明执行控制器的每一个执行方法都有一个相应的操作。</p>
<p>我们说过“index”是Magento默认的执行控制器和执行方法的名字，所以以下请求的操作名字也是“<code>helloworld_index_index</code>”。</p>
<pre><code>http://example.com/helloworld/?showLayout=handles</code></pre>
<h2 id="包布局"><a href="#包布局" class="headerlink" title="包布局"></a>包布局</h2><p>包布局和我们以前讲过的全局配置有些相似。它是一个巨大的XML文档包含了Magento所有的布局配置。我们可以通过以Layout View模块来查看包布局，请求一下URL</p>
<pre><code>http://example.com/helloworld/index/index?showLayout=package</code></pre>
<p>你可能要等一会儿才能看到输出，因为文件很大。如果你的浏览器在渲染XML的时候卡死了，建议你换成text格式的。</p>
<pre><code>http://example.com/helloworld/index/index?showLayout=package&amp;showLayoutFormat=text</code></pre>
<p>假设你选择的是XML格式输出，那么你应该看到一个巨大的XML文件，这就是包布局。这个文件时Magento动态生成的，合并了当前主题（theme）下面所有的布局文件。如果你用的是默认安装的话，这些布局文件在以下目录</p>
<pre><code>app/design/frontend/base/default/layout/</code></pre>
<p>其实在全局配置文件中，有一个<code>&lt;updates /&gt;</code>节点下面定义了所有将被装载的布局文件</p>
<p>Xml代码</p>
<pre><code>&lt;layout&gt;  
    &lt;updates&gt;  
        &lt;core&gt;  
            &lt;file&gt;core.xml&lt;/file&gt;  
        &lt;/core&gt;  
        &lt;page&gt;  
            &lt;file&gt;page.xml&lt;/file&gt;  
        &lt;/page&gt;  
        ...  
    &lt;/updates&gt;  
&lt;/layout&gt;  </code></pre>
<p>当这些文件被装载以后，Magento还会装载最后一个布局文件：<strong>local.xml</strong>，也就是我们之前新建的那个文件。我们可以通过这个文件来<strong>定制</strong>Magento的布局。</p>
<h2 id="结合操作和包布局"><a href="#结合操作和包布局" class="headerlink" title="结合操作和包布局"></a>结合操作和包布局</h2><p>在包布局文件中，我们可以看到一些熟悉的标签<code>&lt;block /&gt;</code>，<code>&lt;reference /&gt;</code>等等，但是他们都包含在一下这些标签中</p>
<p>Xml代码</p>
<pre><code>&lt;default /&gt;  
&lt;catalogsearch_advanced_index /&gt;  
etc...  </code></pre>
<p>这些就是操作标签。对于每个特定的请求来说，针对这个请求的布局文件是由包布局中所有和这个请求相关的操作标签组成的。比如我们上面的例子，和请求相关的操作标签如下</p>
<p>Xml代码</p>
<pre><code>&lt;default /&gt;  
&lt;STORE_bare_us /&gt;  
&lt;THEME_frontend_default_default /&gt;  
&lt;helloworld_index_index /&gt;  
&lt;customer_logged_out /&gt;  </code></pre>
<p>所以，通过在浏览器中请求如下地址：</p>
<pre><code>http://example.com/helloworld/index/index</code></pre>
<p>布局文件就是包布局中上面这些标签的内容组合。在包布局文件中，还有一个标签<code>&lt;update /&gt;</code>值得我们注意。我们可以通过这个标签引入另外一个操作标签。比如</p>
<p>Xml代码</p>
<pre><code>&lt;customer_account_index&gt;
    &lt;!-- ... --&gt;  
    &lt;update handle=&quot;customer_account&quot;/&gt;  
    &lt;!-- ... --&gt;  
&lt;/customer_account_index&gt;</code></pre>
<p>这段代码的意思是，如果一个请求包含了“<code>customer_acount_index</code>”操作，那么这个请求的布局文件也应该包含“<code>customer_account</code>”操作标签下面的<code>&lt;block /&gt;</code>和<code>&lt;reference /&gt;</code>。</p>
<h2 id="更新我们的例子"><a href="#更新我们的例子" class="headerlink" title="更新我们的例子"></a>更新我们的例子</h2><p>好了，理论讲完了，让我们来修改我们的例子，把这一章的内容实践一下。我们重新来看local.xml</p>
<p>Xml代码</p>
<pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;layout version=&quot;0.1.0&quot;&gt;
   &lt;default&gt;
        &lt;reference name=&quot;root&quot;&gt;
            &lt;block type=&quot;page/html&quot; name=&quot;root&quot; output=&quot;toHtml&quot; template=&quot;magentotutorial/helloworld/simple_page.phtml&quot; /&gt;
        &lt;/reference&gt;
    &lt;/default&gt;
&lt;/layout&gt;</code></pre>
<p>我们用一个引用（reference）覆盖了名为“root”的块。然后定义了一个新的块，指向了一个不同的模板文件。我们把这个引用放在<code>&lt;default /&gt;</code>操作标签下面，那就说明这个Layout将对所有的请求有效。如果你访问Magento自带的一些页面，比如aboutus，contact us页面，你会发现报错或者空白，要么就是和我们“hello world”例子的红色背景，但这并不是我们想要的效果。我们来修改一下local.xml，让我们的模板仅对“hello world”的请求有效。</p>
<p>Xml代码</p>
<pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;layout version=&quot;0.1.0&quot;&gt;
   &lt;helloworld_index_index&gt;
        &lt;reference name=&quot;root&quot;&gt;
            &lt;block type=&quot;page/html&quot; name=&quot;root&quot; output=&quot;toHtml&quot; template=&quot;magentotutorial/helloworld/simple_page.phtml&quot; /&gt;
        &lt;/reference&gt;
    &lt;/helloworld_index_index&gt;
&lt;/layout&gt;</code></pre>
<p>我们把操作标签换成了“<code>helloworld_index_index</code>”。清空Magento缓存，重新访问Magento的各个页面，你应该发现都恢复了正常，但是针对”hello world”模块的请求页面还是我们自定义的那个：一片红色背景。</p>
<p>目前我们只实现了一个“index”执行函数，现在我们来实现“goodbye”执行函数。修改我们的执行控制器（IndexController.php）代码如下</p>
<p>Php代码</p>
<pre><code>public function goodbyeAction() &#123;  
    $this-&gt;loadLayout();  
    $this-&gt;renderLayout();           
&#125;        </code></pre>
<p>但是你访问一下页面的时候你还是会看到Magento的默认布局</p>
<pre><code>http://example.com/helloworld/index/goodbye</code></pre>
<p>那是因为我们没有为这个请求定义布局。我们需要在local.xml中添加“<code>helloworld_index_goodbye</code>”标签。由于 “index”请求和“goodbye”请求我们要套用的布局是一样的，所以我们将用<code>&lt;update&gt;</code>标签来重用已有的配置</p>
<p>Xml代码</p>
<pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;layout version=&quot;0.1.0&quot;&gt;
   &lt;helloworld_index_index&gt;
        &lt;reference name=&quot;root&quot;&gt;
            &lt;block type=&quot;page/html&quot; name=&quot;root&quot; output=&quot;toHtml&quot; template=&quot;magentotutorial/helloworld/simple_page.phtml&quot; /&gt;
        &lt;/reference&gt;
    &lt;/helloworld_index_index&gt;
    &lt;helloworld_index_goodbye&gt;  
        &lt;update handle=&quot;helloworld_index_index&quot; /&gt;  
    &lt;/helloworld_index_goodbye&gt;
&lt;/layout&gt;</code></pre>
<p>清空Magento缓存，请求以下两个URL</p>
<pre><code>http://example.com/helloworld/index/index

http://example.com/helloworld/index/goodbye</code></pre>
<p>你将会得到两个完全相同的页面。</p>
<h2 id="开始输出和getChildHtml方法"><a href="#开始输出和getChildHtml方法" class="headerlink" title="开始输出和getChildHtml方法"></a>开始输出和getChildHtml方法</h2><p>在Magento默认的配置下，HTML输出是从名为“root”的块开始（其实是因为这个块拥有output属性【译者注：<strong>任何一个拥有 output属性的块都是顶层块，在拥有多个顶层块的情况下Magento将按照块定义的先后顺序输出HTML</strong>】）。我们覆盖了“root”块的模板<br>template=”magentotutorial/helloworld/simple_page.phtml”</p>
<p>模板文件的查找路径是当前主题（theme）的根目录，Magento默认设置时这里</p>
<pre><code>app/design/frontend/yourtheme/default</code></pre>
<h2 id="为页面加入内容"><a href="#为页面加入内容" class="headerlink" title="为页面加入内容"></a>为页面加入内容</h2><p>到目前为止，我们的页面都比较无聊，啥也没有。我们来为页面加点有意义的内容。修改local.xml如下</p>
<p>Xml代码</p>
<pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;layout version=&quot;0.1.0&quot;&gt;
   &lt;helloworld_index_index&gt;
        &lt;reference name=&quot;root&quot;&gt;  
            &lt;block type=&quot;page/html&quot; name=&quot;root&quot; template=&quot;magentotutorial/helloworld/simple_page.phtml&quot;&gt;
                &lt;block type=&quot;customer/form_register&quot; name=&quot;customer_form_register&quot; template=&quot;customer/form/register.phtml&quot;/&gt;  
            &lt;/block&gt;  
        &lt;/reference&gt;
    &lt;/helloworld_index_index&gt;
    &lt;helloworld_index_goodbye&gt;  
        &lt;update handle=&quot;helloworld_index_index&quot; /&gt;  
    &lt;/helloworld_index_goodbye&gt;
&lt;/layout&gt;  </code></pre>
<p>我们在“root”块里面嵌套了一个块“customer_form_register”。这个块是Magento本来就有的，包含了一张用户注册表单。 我们把这个块嵌套进来，那么我们在模板文件里面就能用这个块的内容。使用方法如下，修改simple_page.phtml</p>
<p>Html代码</p>
<pre><code>&lt;body&gt;
    &lt;?php echo $this-&gt;getChildHtml(&#39;customer_form_register&#39;); ?&gt;  
&lt;/body&gt;</code></pre>
<p>这里“<code>getChildHtml</code>”的参数就是要引入的块的名字，使用起来相当方便。清空Magento缓存，刷新hello world页面，你应该在红色背景上看到用户注册表单。Magento还有一个块，叫做“<code>top.links</code>”，让我们把它也加进来。修改simple_page.html</p>
<p>Html代码</p>
<pre><code>&lt;body&gt;
    &lt;h1&gt;Links&lt;/h1&gt;  
    &lt;?php echo $this-&gt;getChildHtml(&#39;top.links&#39;); ?&gt;  
    &lt;?php echo $this-&gt;getChildHtml(&#39;customer_form_register&#39;); ?&gt;  
&lt;/body&gt;</code></pre>
<p>刷新页面，你会发现<h1>Links</h1>显示出来了，但是“top.links”什么都没有显示。那是因为我们并没有把这个块引入到local.xml，所以Magento找不到这个块。“getChildHtml”的参数一定要是当前页面的布局文件中声明过的块。这样的话Magento就可以只实例化需要用到的块，节省了资源，我们也可以根据需要为块设置不同的模板文件。</p>
<p>我们修改local.xml文件如下</p>
<p>Xml代码</p>
<pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;layout version=&quot;0.1.0&quot;&gt;
    &lt;helloworld_index_index&gt;
        &lt;reference name=&quot;root&quot;&gt;  
            &lt;block type=&quot;page/html&quot; name=&quot;root&quot; template=&quot;magentotutorial/helloworld/simple_page.phtml&quot;&gt;
                &lt;block type=&quot;page/template_links&quot; name=&quot;top.links&quot;/&gt;
                &lt;block type=&quot;customer/form_register&quot; name=&quot;customer_form_register&quot; template=&quot;customer/form/register.phtml&quot;/&gt;  
            &lt;/block&gt;  
        &lt;/reference&gt;
    &lt;/helloworld_index_index&gt;

    &lt;helloworld_index_goodbye&gt;  
        &lt;update handle=&quot;helloworld_index_index&quot; /&gt;  
    &lt;/helloworld_index_goodbye&gt;
&lt;/layout&gt;</code></pre>
<p>清空Magento缓存，刷新页面，你会看到一排链接显示出来了。【译者注：如果你细心一点的话你会发现“top.links”块没有template属性，那是因为这个块的类中一定定义了默认的模板</p>
<p>Php代码</p>
<pre><code>protected function _construct() 
&#123;  
    $this-&gt;setTemplate(&#39;page/template/links.phtml&#39;);  
&#125;</code></pre>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这一章我们讲解了布局的基础知识。你可能会觉得这个很复杂，但是你也不必过分担心，因为平常使用Magento是不会用到这些知识的，Magento提供的默认布局应该可以满足大部分需求。对于想要深入研究Magento的开发者来说，理解Magento的布局是至关重要的。布局， 块和模板构成了Magento MVC架构中的View，这也是Magento的特色之一。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/11/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><span class="page-number current">12</span><a class="page-number" href="/page/13/">13</a><span class="space">&hellip;</span><a class="page-number" href="/page/43/">43</a><a class="extend next" rel="next" href="/page/13/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">泉哥</p>
  <div class="site-description" itemprop="description">日记</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">424</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">25</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">400</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">泉哥</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
